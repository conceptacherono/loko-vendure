import { Injectable } from '@angular/core';
import dayjs from 'dayjs';
import { BehaviorSubject, combineLatest } from 'rxjs';
import { distinctUntilChanged, map } from 'rxjs/operators';
import { dayOfWeekIndex } from './constants';
import * as i0 from "@angular/core";
export class DatetimePickerService {
    constructor() {
        this.selectedDatetime$ = new BehaviorSubject(null);
        this.viewingDatetime$ = new BehaviorSubject(dayjs());
        this.min = null;
        this.max = null;
        this.jumping = false;
        this.selected$ = this.selectedDatetime$.pipe(map(value => value && value.toDate()), distinctUntilChanged((a, b) => a?.getTime() === b?.getTime()));
        this.viewing$ = this.viewingDatetime$.pipe(map(value => value.toDate()));
        this.weekStartDayIndex = dayOfWeekIndex['mon'];
        this.calendarView$ = combineLatest(this.viewingDatetime$, this.selectedDatetime$).pipe(map(([viewing, selected]) => this.generateCalendarView(viewing, selected)));
    }
    setWeekStartingDay(weekStartDay) {
        this.weekStartDayIndex = dayOfWeekIndex[weekStartDay];
    }
    setMin(min) {
        if (typeof min === 'string') {
            this.min = dayjs(min);
        }
    }
    setMax(max) {
        if (typeof max === 'string') {
            this.max = dayjs(max);
        }
    }
    selectDatetime(date) {
        let viewingValue;
        let selectedValue = null;
        if (date == null || date === '') {
            viewingValue = dayjs();
        }
        else {
            viewingValue = dayjs(date);
            selectedValue = dayjs(date);
        }
        this.selectedDatetime$.next(selectedValue);
        this.viewingDatetime$.next(viewingValue);
    }
    selectHour(hourOfDay) {
        const current = this.selectedDatetime$.value || dayjs();
        const next = current.hour(hourOfDay);
        this.selectedDatetime$.next(next);
        this.viewingDatetime$.next(next);
    }
    selectMinute(minutePastHour) {
        const current = this.selectedDatetime$.value || dayjs();
        const next = current.minute(minutePastHour);
        this.selectedDatetime$.next(next);
        this.viewingDatetime$.next(next);
    }
    viewNextMonth() {
        this.jumping = false;
        const current = this.viewingDatetime$.value;
        this.viewingDatetime$.next(current.add(1, 'month'));
    }
    viewPrevMonth() {
        this.jumping = false;
        const current = this.viewingDatetime$.value;
        this.viewingDatetime$.next(current.subtract(1, 'month'));
    }
    viewToday() {
        this.jumping = false;
        this.viewingDatetime$.next(dayjs());
    }
    viewJumpDown() {
        this.jumping = true;
        const current = this.viewingDatetime$.value;
        this.viewingDatetime$.next(current.add(1, 'week'));
    }
    viewJumpUp() {
        this.jumping = true;
        const current = this.viewingDatetime$.value;
        this.viewingDatetime$.next(current.subtract(1, 'week'));
    }
    viewJumpRight() {
        this.jumping = true;
        const current = this.viewingDatetime$.value;
        this.viewingDatetime$.next(current.add(1, 'day'));
    }
    viewJumpLeft() {
        this.jumping = true;
        const current = this.viewingDatetime$.value;
        this.viewingDatetime$.next(current.subtract(1, 'day'));
    }
    selectToday() {
        this.jumping = false;
        this.selectDatetime(dayjs());
    }
    selectViewed() {
        this.jumping = false;
        this.selectDatetime(this.viewingDatetime$.value);
    }
    viewMonth(month) {
        this.jumping = false;
        const current = this.viewingDatetime$.value;
        this.viewingDatetime$.next(current.month(month - 1));
    }
    viewYear(year) {
        this.jumping = false;
        const current = this.viewingDatetime$.value;
        this.viewingDatetime$.next(current.year(year));
    }
    generateCalendarView(viewing, selected) {
        if (!viewing.isValid() || (selected && !selected.isValid())) {
            return [];
        }
        const start = viewing.startOf('month');
        const end = viewing.endOf('month');
        const today = dayjs();
        const daysInMonth = viewing.daysInMonth();
        const selectedDayOfMonth = selected && selected.get('date');
        const startDayOfWeek = start.day();
        const startIndex = (7 + (startDayOfWeek - this.weekStartDayIndex)) % 7;
        const calendarView = [];
        let week = [];
        // Add the days at the tail of the previous month
        if (0 < startIndex) {
            const prevMonth = viewing.subtract(1, 'month');
            const daysInPrevMonth = prevMonth.daysInMonth();
            const prevIsCurrentMonth = prevMonth.isSame(today, 'month');
            for (let i = daysInPrevMonth - startIndex + 1; i <= daysInPrevMonth; i++) {
                const thisDay = viewing.subtract(1, 'month').date(i);
                week.push({
                    dayOfMonth: i,
                    selected: false,
                    inCurrentMonth: false,
                    isToday: prevIsCurrentMonth && today.get('date') === i,
                    isViewing: false,
                    disabled: !this.isInBounds(thisDay),
                    select: () => {
                        this.selectDatetime(thisDay);
                    },
                });
            }
        }
        // Add this month's days
        const isCurrentMonth = viewing.isSame(today, 'month');
        for (let i = 1; i <= daysInMonth; i++) {
            if ((i + startIndex - 1) % 7 === 0) {
                calendarView.push(week);
                week = [];
            }
            const thisDay = start.add(i - 1, 'day');
            const isViewingThisMonth = !!selected && selected.isSame(viewing, 'month') && selected.isSame(viewing, 'year');
            week.push({
                dayOfMonth: i,
                selected: i === selectedDayOfMonth && isViewingThisMonth,
                inCurrentMonth: true,
                isToday: isCurrentMonth && today.get('date') === i,
                isViewing: this.jumping && viewing.date() === i,
                disabled: !this.isInBounds(thisDay),
                select: () => {
                    this.selectDatetime(thisDay);
                },
            });
        }
        // Add the days at the start of the next month
        const emptyCellsEnd = 7 - ((startIndex + daysInMonth) % 7);
        if (emptyCellsEnd !== 7) {
            const nextMonth = viewing.add(1, 'month');
            const nextIsCurrentMonth = nextMonth.isSame(today, 'month');
            for (let i = 1; i <= emptyCellsEnd; i++) {
                const thisDay = end.add(i, 'day');
                week.push({
                    dayOfMonth: i,
                    selected: false,
                    inCurrentMonth: false,
                    isToday: nextIsCurrentMonth && today.get('date') === i,
                    isViewing: false,
                    disabled: !this.isInBounds(thisDay),
                    select: () => {
                        this.selectDatetime(thisDay);
                    },
                });
            }
        }
        calendarView.push(week);
        return calendarView;
    }
    isInBounds(date) {
        if (this.min && this.min.isAfter(date)) {
            return false;
        }
        if (this.max && this.max.isBefore(date)) {
            return false;
        }
        return true;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: DatetimePickerService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: DatetimePickerService }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: DatetimePickerService, decorators: [{
            type: Injectable
        }], ctorParameters: () => [] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0ZXRpbWUtcGlja2VyLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvbGliL2NvcmUvc3JjL3NoYXJlZC9jb21wb25lbnRzL2RhdGV0aW1lLXBpY2tlci9kYXRldGltZS1waWNrZXIuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sS0FBSyxNQUFNLE9BQU8sQ0FBQztBQUMxQixPQUFPLEVBQUUsZUFBZSxFQUFFLGFBQWEsRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUNsRSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFFM0QsT0FBTyxFQUFFLGNBQWMsRUFBRSxNQUFNLGFBQWEsQ0FBQzs7QUFJN0MsTUFBTSxPQUFPLHFCQUFxQjtJQVc5QjtRQVBRLHNCQUFpQixHQUFHLElBQUksZUFBZSxDQUFxQixJQUFJLENBQUMsQ0FBQztRQUNsRSxxQkFBZ0IsR0FBRyxJQUFJLGVBQWUsQ0FBYyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBRTdELFFBQUcsR0FBdUIsSUFBSSxDQUFDO1FBQy9CLFFBQUcsR0FBdUIsSUFBSSxDQUFDO1FBQy9CLFlBQU8sR0FBRyxLQUFLLENBQUM7UUFHcEIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUN4QyxHQUFHLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLElBQUksS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQ3JDLG9CQUFvQixDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLE9BQU8sRUFBRSxLQUFLLENBQUMsRUFBRSxPQUFPLEVBQUUsQ0FBQyxDQUNoRSxDQUFDO1FBQ0YsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDekUsSUFBSSxDQUFDLGlCQUFpQixHQUFHLGNBQWMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMvQyxJQUFJLENBQUMsYUFBYSxHQUFHLGFBQWEsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUMsSUFBSSxDQUNsRixHQUFHLENBQUMsQ0FBQyxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQyxDQUM3RSxDQUFDO0lBQ04sQ0FBQztJQUVELGtCQUFrQixDQUFDLFlBQXVCO1FBQ3RDLElBQUksQ0FBQyxpQkFBaUIsR0FBRyxjQUFjLENBQUMsWUFBWSxDQUFDLENBQUM7SUFDMUQsQ0FBQztJQUVELE1BQU0sQ0FBQyxHQUFtQjtRQUN0QixJQUFJLE9BQU8sR0FBRyxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQzFCLElBQUksQ0FBQyxHQUFHLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzFCLENBQUM7SUFDTCxDQUFDO0lBRUQsTUFBTSxDQUFDLEdBQW1CO1FBQ3RCLElBQUksT0FBTyxHQUFHLEtBQUssUUFBUSxFQUFFLENBQUM7WUFDMUIsSUFBSSxDQUFDLEdBQUcsR0FBRyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDMUIsQ0FBQztJQUNMLENBQUM7SUFFRCxjQUFjLENBQUMsSUFBd0M7UUFDbkQsSUFBSSxZQUF5QixDQUFDO1FBQzlCLElBQUksYUFBYSxHQUF1QixJQUFJLENBQUM7UUFDN0MsSUFBSSxJQUFJLElBQUksSUFBSSxJQUFJLElBQUksS0FBSyxFQUFFLEVBQUUsQ0FBQztZQUM5QixZQUFZLEdBQUcsS0FBSyxFQUFFLENBQUM7UUFDM0IsQ0FBQzthQUFNLENBQUM7WUFDSixZQUFZLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzNCLGFBQWEsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDaEMsQ0FBQztRQUVELElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDM0MsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBRUQsVUFBVSxDQUFDLFNBQWlCO1FBQ3hCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLElBQUksS0FBSyxFQUFFLENBQUM7UUFDeEQsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNyQyxJQUFJLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2xDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDckMsQ0FBQztJQUVELFlBQVksQ0FBQyxjQUFzQjtRQUMvQixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsaUJBQWlCLENBQUMsS0FBSyxJQUFJLEtBQUssRUFBRSxDQUFDO1FBQ3hELE1BQU0sSUFBSSxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDNUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNsQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ3JDLENBQUM7SUFFRCxhQUFhO1FBQ1QsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDckIsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQztRQUM1QyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDLENBQUM7SUFDeEQsQ0FBQztJQUVELGFBQWE7UUFDVCxJQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztRQUNyQixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDO1FBQzVDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUMsQ0FBQztJQUM3RCxDQUFDO0lBRUQsU0FBUztRQUNMLElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO1FBQ3JCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQztJQUN4QyxDQUFDO0lBRUQsWUFBWTtRQUNSLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO1FBQ3BCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUM7UUFDNUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFFRCxVQUFVO1FBQ04sSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUM7UUFDcEIsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLEtBQUssQ0FBQztRQUM1QyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLE1BQU0sQ0FBQyxDQUFDLENBQUM7SUFDNUQsQ0FBQztJQUVELGFBQWE7UUFDVCxJQUFJLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQztRQUNwQixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDO1FBQzVDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUN0RCxDQUFDO0lBRUQsWUFBWTtRQUNSLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDO1FBQ3BCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUM7UUFDNUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO0lBQzNELENBQUM7SUFFRCxXQUFXO1FBQ1AsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDckIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFFRCxZQUFZO1FBQ1IsSUFBSSxDQUFDLE9BQU8sR0FBRyxLQUFLLENBQUM7UUFDckIsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVELFNBQVMsQ0FBQyxLQUFhO1FBQ25CLElBQUksQ0FBQyxPQUFPLEdBQUcsS0FBSyxDQUFDO1FBQ3JCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUM7UUFDNUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3pELENBQUM7SUFFRCxRQUFRLENBQUMsSUFBWTtRQUNqQixJQUFJLENBQUMsT0FBTyxHQUFHLEtBQUssQ0FBQztRQUNyQixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxDQUFDO1FBQzVDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ25ELENBQUM7SUFFTyxvQkFBb0IsQ0FBQyxPQUFvQixFQUFFLFFBQTRCO1FBQzNFLElBQUksQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxRQUFRLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLENBQUMsRUFBRSxDQUFDO1lBQzFELE9BQU8sRUFBRSxDQUFDO1FBQ2QsQ0FBQztRQUNELE1BQU0sS0FBSyxHQUFHLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDdkMsTUFBTSxHQUFHLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUNuQyxNQUFNLEtBQUssR0FBRyxLQUFLLEVBQUUsQ0FBQztRQUN0QixNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDMUMsTUFBTSxrQkFBa0IsR0FBRyxRQUFRLElBQUksUUFBUSxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUU1RCxNQUFNLGNBQWMsR0FBRyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDbkMsTUFBTSxVQUFVLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFdkUsTUFBTSxZQUFZLEdBQWlCLEVBQUUsQ0FBQztRQUN0QyxJQUFJLElBQUksR0FBYyxFQUFFLENBQUM7UUFFekIsaURBQWlEO1FBQ2pELElBQUksQ0FBQyxHQUFHLFVBQVUsRUFBRSxDQUFDO1lBQ2pCLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQy9DLE1BQU0sZUFBZSxHQUFHLFNBQVMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUNoRCxNQUFNLGtCQUFrQixHQUFHLFNBQVMsQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBQzVELEtBQUssSUFBSSxDQUFDLEdBQUcsZUFBZSxHQUFHLFVBQVUsR0FBRyxDQUFDLEVBQUUsQ0FBQyxJQUFJLGVBQWUsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO2dCQUN2RSxNQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ3JELElBQUksQ0FBQyxJQUFJLENBQUM7b0JBQ04sVUFBVSxFQUFFLENBQUM7b0JBQ2IsUUFBUSxFQUFFLEtBQUs7b0JBQ2YsY0FBYyxFQUFFLEtBQUs7b0JBQ3JCLE9BQU8sRUFBRSxrQkFBa0IsSUFBSSxLQUFLLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUM7b0JBQ3RELFNBQVMsRUFBRSxLQUFLO29CQUNoQixRQUFRLEVBQUUsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQztvQkFDbkMsTUFBTSxFQUFFLEdBQUcsRUFBRTt3QkFDVCxJQUFJLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxDQUFDO29CQUNqQyxDQUFDO2lCQUNKLENBQUMsQ0FBQztZQUNQLENBQUM7UUFDTCxDQUFDO1FBRUQsd0JBQXdCO1FBQ3hCLE1BQU0sY0FBYyxHQUFHLE9BQU8sQ0FBQyxNQUFNLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxDQUFDO1FBQ3RELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsSUFBSSxXQUFXLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUNwQyxJQUFJLENBQUMsQ0FBQyxHQUFHLFVBQVUsR0FBRyxDQUFDLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUM7Z0JBQ2pDLFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ3hCLElBQUksR0FBRyxFQUFFLENBQUM7WUFDZCxDQUFDO1lBQ0QsTUFBTSxPQUFPLEdBQUcsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3hDLE1BQU0sa0JBQWtCLEdBQ3BCLENBQUMsQ0FBQyxRQUFRLElBQUksUUFBUSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsT0FBTyxDQUFDLElBQUksUUFBUSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsTUFBTSxDQUFDLENBQUM7WUFDeEYsSUFBSSxDQUFDLElBQUksQ0FBQztnQkFDTixVQUFVLEVBQUUsQ0FBQztnQkFDYixRQUFRLEVBQUUsQ0FBQyxLQUFLLGtCQUFrQixJQUFJLGtCQUFrQjtnQkFDeEQsY0FBYyxFQUFFLElBQUk7Z0JBQ3BCLE9BQU8sRUFBRSxjQUFjLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDO2dCQUNsRCxTQUFTLEVBQUUsSUFBSSxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsSUFBSSxFQUFFLEtBQUssQ0FBQztnQkFDL0MsUUFBUSxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUM7Z0JBQ25DLE1BQU0sRUFBRSxHQUFHLEVBQUU7b0JBQ1QsSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQztnQkFDakMsQ0FBQzthQUNKLENBQUMsQ0FBQztRQUNQLENBQUM7UUFFRCw4Q0FBOEM7UUFDOUMsTUFBTSxhQUFhLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxVQUFVLEdBQUcsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDM0QsSUFBSSxhQUFhLEtBQUssQ0FBQyxFQUFFLENBQUM7WUFDdEIsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDMUMsTUFBTSxrQkFBa0IsR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDLEtBQUssRUFBRSxPQUFPLENBQUMsQ0FBQztZQUU1RCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLElBQUksYUFBYSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7Z0JBQ3RDLE1BQU0sT0FBTyxHQUFHLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDO2dCQUNsQyxJQUFJLENBQUMsSUFBSSxDQUFDO29CQUNOLFVBQVUsRUFBRSxDQUFDO29CQUNiLFFBQVEsRUFBRSxLQUFLO29CQUNmLGNBQWMsRUFBRSxLQUFLO29CQUNyQixPQUFPLEVBQUUsa0JBQWtCLElBQUksS0FBSyxDQUFDLEdBQUcsQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDO29CQUN0RCxTQUFTLEVBQUUsS0FBSztvQkFDaEIsUUFBUSxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLENBQUM7b0JBQ25DLE1BQU0sRUFBRSxHQUFHLEVBQUU7d0JBQ1QsSUFBSSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQztvQkFDakMsQ0FBQztpQkFDSixDQUFDLENBQUM7WUFDUCxDQUFDO1FBQ0wsQ0FBQztRQUNELFlBQVksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDeEIsT0FBTyxZQUFZLENBQUM7SUFDeEIsQ0FBQztJQUVPLFVBQVUsQ0FBQyxJQUFpQjtRQUNoQyxJQUFJLElBQUksQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztZQUNyQyxPQUFPLEtBQUssQ0FBQztRQUNqQixDQUFDO1FBQ0QsSUFBSSxJQUFJLENBQUMsR0FBRyxJQUFJLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUM7WUFDdEMsT0FBTyxLQUFLLENBQUM7UUFDakIsQ0FBQztRQUNELE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7OEdBL05RLHFCQUFxQjtrSEFBckIscUJBQXFCOzsyRkFBckIscUJBQXFCO2tCQURqQyxVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgZGF5anMgZnJvbSAnZGF5anMnO1xyXG5pbXBvcnQgeyBCZWhhdmlvclN1YmplY3QsIGNvbWJpbmVMYXRlc3QsIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgZGlzdGluY3RVbnRpbENoYW5nZWQsIG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcbmltcG9ydCB7IGRheU9mV2Vla0luZGV4IH0gZnJvbSAnLi9jb25zdGFudHMnO1xyXG5pbXBvcnQgeyBDYWxlbmRhclZpZXcsIERheUNlbGwsIERheU9mV2VlayB9IGZyb20gJy4vdHlwZXMnO1xyXG5cclxuQEluamVjdGFibGUoKVxyXG5leHBvcnQgY2xhc3MgRGF0ZXRpbWVQaWNrZXJTZXJ2aWNlIHtcclxuICAgIGNhbGVuZGFyVmlldyQ6IE9ic2VydmFibGU8Q2FsZW5kYXJWaWV3PjtcclxuICAgIHNlbGVjdGVkJDogT2JzZXJ2YWJsZTxEYXRlIHwgbnVsbD47XHJcbiAgICB2aWV3aW5nJDogT2JzZXJ2YWJsZTxEYXRlPjtcclxuICAgIHByaXZhdGUgc2VsZWN0ZWREYXRldGltZSQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGRheWpzLkRheWpzIHwgbnVsbD4obnVsbCk7XHJcbiAgICBwcml2YXRlIHZpZXdpbmdEYXRldGltZSQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGRheWpzLkRheWpzPihkYXlqcygpKTtcclxuICAgIHByaXZhdGUgd2Vla1N0YXJ0RGF5SW5kZXg6IG51bWJlcjtcclxuICAgIHByaXZhdGUgbWluOiBkYXlqcy5EYXlqcyB8IG51bGwgPSBudWxsO1xyXG4gICAgcHJpdmF0ZSBtYXg6IGRheWpzLkRheWpzIHwgbnVsbCA9IG51bGw7XHJcbiAgICBwcml2YXRlIGp1bXBpbmcgPSBmYWxzZTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcigpIHtcclxuICAgICAgICB0aGlzLnNlbGVjdGVkJCA9IHRoaXMuc2VsZWN0ZWREYXRldGltZSQucGlwZShcclxuICAgICAgICAgICAgbWFwKHZhbHVlID0+IHZhbHVlICYmIHZhbHVlLnRvRGF0ZSgpKSxcclxuICAgICAgICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKGEsIGIpID0+IGE/LmdldFRpbWUoKSA9PT0gYj8uZ2V0VGltZSgpKSxcclxuICAgICAgICApO1xyXG4gICAgICAgIHRoaXMudmlld2luZyQgPSB0aGlzLnZpZXdpbmdEYXRldGltZSQucGlwZShtYXAodmFsdWUgPT4gdmFsdWUudG9EYXRlKCkpKTtcclxuICAgICAgICB0aGlzLndlZWtTdGFydERheUluZGV4ID0gZGF5T2ZXZWVrSW5kZXhbJ21vbiddO1xyXG4gICAgICAgIHRoaXMuY2FsZW5kYXJWaWV3JCA9IGNvbWJpbmVMYXRlc3QodGhpcy52aWV3aW5nRGF0ZXRpbWUkLCB0aGlzLnNlbGVjdGVkRGF0ZXRpbWUkKS5waXBlKFxyXG4gICAgICAgICAgICBtYXAoKFt2aWV3aW5nLCBzZWxlY3RlZF0pID0+IHRoaXMuZ2VuZXJhdGVDYWxlbmRhclZpZXcodmlld2luZywgc2VsZWN0ZWQpKSxcclxuICAgICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIHNldFdlZWtTdGFydGluZ0RheSh3ZWVrU3RhcnREYXk6IERheU9mV2Vlaykge1xyXG4gICAgICAgIHRoaXMud2Vla1N0YXJ0RGF5SW5kZXggPSBkYXlPZldlZWtJbmRleFt3ZWVrU3RhcnREYXldO1xyXG4gICAgfVxyXG5cclxuICAgIHNldE1pbihtaW4/OiBzdHJpbmcgfCBudWxsKSB7XHJcbiAgICAgICAgaWYgKHR5cGVvZiBtaW4gPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICAgIHRoaXMubWluID0gZGF5anMobWluKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgc2V0TWF4KG1heD86IHN0cmluZyB8IG51bGwpIHtcclxuICAgICAgICBpZiAodHlwZW9mIG1heCA9PT0gJ3N0cmluZycpIHtcclxuICAgICAgICAgICAgdGhpcy5tYXggPSBkYXlqcyhtYXgpO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBzZWxlY3REYXRldGltZShkYXRlOiBEYXRlIHwgc3RyaW5nIHwgZGF5anMuRGF5anMgfCBudWxsKSB7XHJcbiAgICAgICAgbGV0IHZpZXdpbmdWYWx1ZTogZGF5anMuRGF5anM7XHJcbiAgICAgICAgbGV0IHNlbGVjdGVkVmFsdWU6IGRheWpzLkRheWpzIHwgbnVsbCA9IG51bGw7XHJcbiAgICAgICAgaWYgKGRhdGUgPT0gbnVsbCB8fCBkYXRlID09PSAnJykge1xyXG4gICAgICAgICAgICB2aWV3aW5nVmFsdWUgPSBkYXlqcygpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHZpZXdpbmdWYWx1ZSA9IGRheWpzKGRhdGUpO1xyXG4gICAgICAgICAgICBzZWxlY3RlZFZhbHVlID0gZGF5anMoZGF0ZSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICB0aGlzLnNlbGVjdGVkRGF0ZXRpbWUkLm5leHQoc2VsZWN0ZWRWYWx1ZSk7XHJcbiAgICAgICAgdGhpcy52aWV3aW5nRGF0ZXRpbWUkLm5leHQodmlld2luZ1ZhbHVlKTtcclxuICAgIH1cclxuXHJcbiAgICBzZWxlY3RIb3VyKGhvdXJPZkRheTogbnVtYmVyKSB7XHJcbiAgICAgICAgY29uc3QgY3VycmVudCA9IHRoaXMuc2VsZWN0ZWREYXRldGltZSQudmFsdWUgfHwgZGF5anMoKTtcclxuICAgICAgICBjb25zdCBuZXh0ID0gY3VycmVudC5ob3VyKGhvdXJPZkRheSk7XHJcbiAgICAgICAgdGhpcy5zZWxlY3RlZERhdGV0aW1lJC5uZXh0KG5leHQpO1xyXG4gICAgICAgIHRoaXMudmlld2luZ0RhdGV0aW1lJC5uZXh0KG5leHQpO1xyXG4gICAgfVxyXG5cclxuICAgIHNlbGVjdE1pbnV0ZShtaW51dGVQYXN0SG91cjogbnVtYmVyKSB7XHJcbiAgICAgICAgY29uc3QgY3VycmVudCA9IHRoaXMuc2VsZWN0ZWREYXRldGltZSQudmFsdWUgfHwgZGF5anMoKTtcclxuICAgICAgICBjb25zdCBuZXh0ID0gY3VycmVudC5taW51dGUobWludXRlUGFzdEhvdXIpO1xyXG4gICAgICAgIHRoaXMuc2VsZWN0ZWREYXRldGltZSQubmV4dChuZXh0KTtcclxuICAgICAgICB0aGlzLnZpZXdpbmdEYXRldGltZSQubmV4dChuZXh0KTtcclxuICAgIH1cclxuXHJcbiAgICB2aWV3TmV4dE1vbnRoKCkge1xyXG4gICAgICAgIHRoaXMuanVtcGluZyA9IGZhbHNlO1xyXG4gICAgICAgIGNvbnN0IGN1cnJlbnQgPSB0aGlzLnZpZXdpbmdEYXRldGltZSQudmFsdWU7XHJcbiAgICAgICAgdGhpcy52aWV3aW5nRGF0ZXRpbWUkLm5leHQoY3VycmVudC5hZGQoMSwgJ21vbnRoJykpO1xyXG4gICAgfVxyXG5cclxuICAgIHZpZXdQcmV2TW9udGgoKSB7XHJcbiAgICAgICAgdGhpcy5qdW1waW5nID0gZmFsc2U7XHJcbiAgICAgICAgY29uc3QgY3VycmVudCA9IHRoaXMudmlld2luZ0RhdGV0aW1lJC52YWx1ZTtcclxuICAgICAgICB0aGlzLnZpZXdpbmdEYXRldGltZSQubmV4dChjdXJyZW50LnN1YnRyYWN0KDEsICdtb250aCcpKTtcclxuICAgIH1cclxuXHJcbiAgICB2aWV3VG9kYXkoKSB7XHJcbiAgICAgICAgdGhpcy5qdW1waW5nID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy52aWV3aW5nRGF0ZXRpbWUkLm5leHQoZGF5anMoKSk7XHJcbiAgICB9XHJcblxyXG4gICAgdmlld0p1bXBEb3duKCkge1xyXG4gICAgICAgIHRoaXMuanVtcGluZyA9IHRydWU7XHJcbiAgICAgICAgY29uc3QgY3VycmVudCA9IHRoaXMudmlld2luZ0RhdGV0aW1lJC52YWx1ZTtcclxuICAgICAgICB0aGlzLnZpZXdpbmdEYXRldGltZSQubmV4dChjdXJyZW50LmFkZCgxLCAnd2VlaycpKTtcclxuICAgIH1cclxuXHJcbiAgICB2aWV3SnVtcFVwKCkge1xyXG4gICAgICAgIHRoaXMuanVtcGluZyA9IHRydWU7XHJcbiAgICAgICAgY29uc3QgY3VycmVudCA9IHRoaXMudmlld2luZ0RhdGV0aW1lJC52YWx1ZTtcclxuICAgICAgICB0aGlzLnZpZXdpbmdEYXRldGltZSQubmV4dChjdXJyZW50LnN1YnRyYWN0KDEsICd3ZWVrJykpO1xyXG4gICAgfVxyXG5cclxuICAgIHZpZXdKdW1wUmlnaHQoKSB7XHJcbiAgICAgICAgdGhpcy5qdW1waW5nID0gdHJ1ZTtcclxuICAgICAgICBjb25zdCBjdXJyZW50ID0gdGhpcy52aWV3aW5nRGF0ZXRpbWUkLnZhbHVlO1xyXG4gICAgICAgIHRoaXMudmlld2luZ0RhdGV0aW1lJC5uZXh0KGN1cnJlbnQuYWRkKDEsICdkYXknKSk7XHJcbiAgICB9XHJcblxyXG4gICAgdmlld0p1bXBMZWZ0KCkge1xyXG4gICAgICAgIHRoaXMuanVtcGluZyA9IHRydWU7XHJcbiAgICAgICAgY29uc3QgY3VycmVudCA9IHRoaXMudmlld2luZ0RhdGV0aW1lJC52YWx1ZTtcclxuICAgICAgICB0aGlzLnZpZXdpbmdEYXRldGltZSQubmV4dChjdXJyZW50LnN1YnRyYWN0KDEsICdkYXknKSk7XHJcbiAgICB9XHJcblxyXG4gICAgc2VsZWN0VG9kYXkoKSB7XHJcbiAgICAgICAgdGhpcy5qdW1waW5nID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5zZWxlY3REYXRldGltZShkYXlqcygpKTtcclxuICAgIH1cclxuXHJcbiAgICBzZWxlY3RWaWV3ZWQoKSB7XHJcbiAgICAgICAgdGhpcy5qdW1waW5nID0gZmFsc2U7XHJcbiAgICAgICAgdGhpcy5zZWxlY3REYXRldGltZSh0aGlzLnZpZXdpbmdEYXRldGltZSQudmFsdWUpO1xyXG4gICAgfVxyXG5cclxuICAgIHZpZXdNb250aChtb250aDogbnVtYmVyKSB7XHJcbiAgICAgICAgdGhpcy5qdW1waW5nID0gZmFsc2U7XHJcbiAgICAgICAgY29uc3QgY3VycmVudCA9IHRoaXMudmlld2luZ0RhdGV0aW1lJC52YWx1ZTtcclxuICAgICAgICB0aGlzLnZpZXdpbmdEYXRldGltZSQubmV4dChjdXJyZW50Lm1vbnRoKG1vbnRoIC0gMSkpO1xyXG4gICAgfVxyXG5cclxuICAgIHZpZXdZZWFyKHllYXI6IG51bWJlcikge1xyXG4gICAgICAgIHRoaXMuanVtcGluZyA9IGZhbHNlO1xyXG4gICAgICAgIGNvbnN0IGN1cnJlbnQgPSB0aGlzLnZpZXdpbmdEYXRldGltZSQudmFsdWU7XHJcbiAgICAgICAgdGhpcy52aWV3aW5nRGF0ZXRpbWUkLm5leHQoY3VycmVudC55ZWFyKHllYXIpKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdlbmVyYXRlQ2FsZW5kYXJWaWV3KHZpZXdpbmc6IGRheWpzLkRheWpzLCBzZWxlY3RlZDogZGF5anMuRGF5anMgfCBudWxsKTogQ2FsZW5kYXJWaWV3IHtcclxuICAgICAgICBpZiAoIXZpZXdpbmcuaXNWYWxpZCgpIHx8IChzZWxlY3RlZCAmJiAhc2VsZWN0ZWQuaXNWYWxpZCgpKSkge1xyXG4gICAgICAgICAgICByZXR1cm4gW107XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGNvbnN0IHN0YXJ0ID0gdmlld2luZy5zdGFydE9mKCdtb250aCcpO1xyXG4gICAgICAgIGNvbnN0IGVuZCA9IHZpZXdpbmcuZW5kT2YoJ21vbnRoJyk7XHJcbiAgICAgICAgY29uc3QgdG9kYXkgPSBkYXlqcygpO1xyXG4gICAgICAgIGNvbnN0IGRheXNJbk1vbnRoID0gdmlld2luZy5kYXlzSW5Nb250aCgpO1xyXG4gICAgICAgIGNvbnN0IHNlbGVjdGVkRGF5T2ZNb250aCA9IHNlbGVjdGVkICYmIHNlbGVjdGVkLmdldCgnZGF0ZScpO1xyXG5cclxuICAgICAgICBjb25zdCBzdGFydERheU9mV2VlayA9IHN0YXJ0LmRheSgpO1xyXG4gICAgICAgIGNvbnN0IHN0YXJ0SW5kZXggPSAoNyArIChzdGFydERheU9mV2VlayAtIHRoaXMud2Vla1N0YXJ0RGF5SW5kZXgpKSAlIDc7XHJcblxyXG4gICAgICAgIGNvbnN0IGNhbGVuZGFyVmlldzogQ2FsZW5kYXJWaWV3ID0gW107XHJcbiAgICAgICAgbGV0IHdlZWs6IERheUNlbGxbXSA9IFtdO1xyXG5cclxuICAgICAgICAvLyBBZGQgdGhlIGRheXMgYXQgdGhlIHRhaWwgb2YgdGhlIHByZXZpb3VzIG1vbnRoXHJcbiAgICAgICAgaWYgKDAgPCBzdGFydEluZGV4KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IHByZXZNb250aCA9IHZpZXdpbmcuc3VidHJhY3QoMSwgJ21vbnRoJyk7XHJcbiAgICAgICAgICAgIGNvbnN0IGRheXNJblByZXZNb250aCA9IHByZXZNb250aC5kYXlzSW5Nb250aCgpO1xyXG4gICAgICAgICAgICBjb25zdCBwcmV2SXNDdXJyZW50TW9udGggPSBwcmV2TW9udGguaXNTYW1lKHRvZGF5LCAnbW9udGgnKTtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IGRheXNJblByZXZNb250aCAtIHN0YXJ0SW5kZXggKyAxOyBpIDw9IGRheXNJblByZXZNb250aDsgaSsrKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCB0aGlzRGF5ID0gdmlld2luZy5zdWJ0cmFjdCgxLCAnbW9udGgnKS5kYXRlKGkpO1xyXG4gICAgICAgICAgICAgICAgd2Vlay5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICBkYXlPZk1vbnRoOiBpLFxyXG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdGVkOiBmYWxzZSxcclxuICAgICAgICAgICAgICAgICAgICBpbkN1cnJlbnRNb250aDogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgaXNUb2RheTogcHJldklzQ3VycmVudE1vbnRoICYmIHRvZGF5LmdldCgnZGF0ZScpID09PSBpLFxyXG4gICAgICAgICAgICAgICAgICAgIGlzVmlld2luZzogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgZGlzYWJsZWQ6ICF0aGlzLmlzSW5Cb3VuZHModGhpc0RheSksXHJcbiAgICAgICAgICAgICAgICAgICAgc2VsZWN0OiAoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuc2VsZWN0RGF0ZXRpbWUodGhpc0RheSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBBZGQgdGhpcyBtb250aCdzIGRheXNcclxuICAgICAgICBjb25zdCBpc0N1cnJlbnRNb250aCA9IHZpZXdpbmcuaXNTYW1lKHRvZGF5LCAnbW9udGgnKTtcclxuICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8PSBkYXlzSW5Nb250aDsgaSsrKSB7XHJcbiAgICAgICAgICAgIGlmICgoaSArIHN0YXJ0SW5kZXggLSAxKSAlIDcgPT09IDApIHtcclxuICAgICAgICAgICAgICAgIGNhbGVuZGFyVmlldy5wdXNoKHdlZWspO1xyXG4gICAgICAgICAgICAgICAgd2VlayA9IFtdO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IHRoaXNEYXkgPSBzdGFydC5hZGQoaSAtIDEsICdkYXknKTtcclxuICAgICAgICAgICAgY29uc3QgaXNWaWV3aW5nVGhpc01vbnRoID1cclxuICAgICAgICAgICAgICAgICEhc2VsZWN0ZWQgJiYgc2VsZWN0ZWQuaXNTYW1lKHZpZXdpbmcsICdtb250aCcpICYmIHNlbGVjdGVkLmlzU2FtZSh2aWV3aW5nLCAneWVhcicpO1xyXG4gICAgICAgICAgICB3ZWVrLnB1c2goe1xyXG4gICAgICAgICAgICAgICAgZGF5T2ZNb250aDogaSxcclxuICAgICAgICAgICAgICAgIHNlbGVjdGVkOiBpID09PSBzZWxlY3RlZERheU9mTW9udGggJiYgaXNWaWV3aW5nVGhpc01vbnRoLFxyXG4gICAgICAgICAgICAgICAgaW5DdXJyZW50TW9udGg6IHRydWUsXHJcbiAgICAgICAgICAgICAgICBpc1RvZGF5OiBpc0N1cnJlbnRNb250aCAmJiB0b2RheS5nZXQoJ2RhdGUnKSA9PT0gaSxcclxuICAgICAgICAgICAgICAgIGlzVmlld2luZzogdGhpcy5qdW1waW5nICYmIHZpZXdpbmcuZGF0ZSgpID09PSBpLFxyXG4gICAgICAgICAgICAgICAgZGlzYWJsZWQ6ICF0aGlzLmlzSW5Cb3VuZHModGhpc0RheSksXHJcbiAgICAgICAgICAgICAgICBzZWxlY3Q6ICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdERhdGV0aW1lKHRoaXNEYXkpO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICAvLyBBZGQgdGhlIGRheXMgYXQgdGhlIHN0YXJ0IG9mIHRoZSBuZXh0IG1vbnRoXHJcbiAgICAgICAgY29uc3QgZW1wdHlDZWxsc0VuZCA9IDcgLSAoKHN0YXJ0SW5kZXggKyBkYXlzSW5Nb250aCkgJSA3KTtcclxuICAgICAgICBpZiAoZW1wdHlDZWxsc0VuZCAhPT0gNykge1xyXG4gICAgICAgICAgICBjb25zdCBuZXh0TW9udGggPSB2aWV3aW5nLmFkZCgxLCAnbW9udGgnKTtcclxuICAgICAgICAgICAgY29uc3QgbmV4dElzQ3VycmVudE1vbnRoID0gbmV4dE1vbnRoLmlzU2FtZSh0b2RheSwgJ21vbnRoJyk7XHJcblxyXG4gICAgICAgICAgICBmb3IgKGxldCBpID0gMTsgaSA8PSBlbXB0eUNlbGxzRW5kOyBpKyspIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHRoaXNEYXkgPSBlbmQuYWRkKGksICdkYXknKTtcclxuICAgICAgICAgICAgICAgIHdlZWsucHVzaCh7XHJcbiAgICAgICAgICAgICAgICAgICAgZGF5T2ZNb250aDogaSxcclxuICAgICAgICAgICAgICAgICAgICBzZWxlY3RlZDogZmFsc2UsXHJcbiAgICAgICAgICAgICAgICAgICAgaW5DdXJyZW50TW9udGg6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgIGlzVG9kYXk6IG5leHRJc0N1cnJlbnRNb250aCAmJiB0b2RheS5nZXQoJ2RhdGUnKSA9PT0gaSxcclxuICAgICAgICAgICAgICAgICAgICBpc1ZpZXdpbmc6IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgIGRpc2FibGVkOiAhdGhpcy5pc0luQm91bmRzKHRoaXNEYXkpLFxyXG4gICAgICAgICAgICAgICAgICAgIHNlbGVjdDogKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnNlbGVjdERhdGV0aW1lKHRoaXNEYXkpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBjYWxlbmRhclZpZXcucHVzaCh3ZWVrKTtcclxuICAgICAgICByZXR1cm4gY2FsZW5kYXJWaWV3O1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaXNJbkJvdW5kcyhkYXRlOiBkYXlqcy5EYXlqcyk6IGJvb2xlYW4ge1xyXG4gICAgICAgIGlmICh0aGlzLm1pbiAmJiB0aGlzLm1pbi5pc0FmdGVyKGRhdGUpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHRoaXMubWF4ICYmIHRoaXMubWF4LmlzQmVmb3JlKGRhdGUpKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRydWU7XHJcbiAgICB9XHJcbn1cclxuIl19