/**
 * Based on https://github.com/tmmdata/chartist-plugin-tooltip/blob/master/src/scripts/chartist-plugin-tooltip.js
 *
 */
/* global Chartist */
const defaultOptions = {
    currency: undefined,
    currencyPrecision: 2,
    currencyPrecisionFactor: 100,
    currencyFormatCallback: undefined,
    tooltipOffset: {
        x: 0,
        y: -20,
    },
    anchorToPoint: false,
    appendToBody: false,
    class: undefined,
    pointClass: 'ct-point',
};
export function tooltipPlugin(userOptions) {
    return function tooltip(chart) {
        const options = {
            ...defaultOptions,
            ...userOptions,
        };
        const $chart = chart.container;
        let $toolTip = $chart.querySelector('.chartist-tooltip');
        if (!$toolTip) {
            $toolTip = document.createElement('div');
            $toolTip.className = !options.class ? 'chartist-tooltip' : 'chartist-tooltip ' + options.class;
            if (!options.appendToBody) {
                $chart.appendChild($toolTip);
            }
            else {
                document.body.appendChild($toolTip);
            }
        }
        let height = $toolTip.offsetHeight;
        let width = $toolTip.offsetWidth;
        const points = [];
        function getClosestPoint(mouseX) {
            let closestElement = null;
            let closestDistance = Infinity;
            // Iterate through the points array to find the closest element
            for (const point of points) {
                const elementX = point.x;
                const distance = calculateDistance(mouseX, elementX);
                if (distance < closestDistance) {
                    closestElement = point.event;
                    closestDistance = distance;
                }
            }
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            return closestElement;
        }
        chart.on('draw', data => {
            if (data.type === 'point') {
                const element = data.element;
                points[data.index] = {
                    event: data,
                    x: data.element.getNode().getBoundingClientRect().x,
                };
            }
        });
        hide($toolTip);
        function on(event, selector, callback) {
            $chart.addEventListener(event, function (e) {
                if (!selector || hasClass(e.target, selector)) {
                    callback(e);
                }
            }, { passive: true });
        }
        on('mousemove', undefined, (event) => {
            const closestPoint = getClosestPoint(event.clientX);
            if (!closestPoint) {
                return;
            }
            points.forEach(point => point.event.element.removeClass('ct-tooltip-hover'));
            closestPoint.element.addClass('ct-tooltip-hover');
            const $point = closestPoint.element.getNode();
            const meta = closestPoint.meta;
            const value = $point.getAttribute('ct:value');
            const dateFormatter = new Intl.DateTimeFormat(meta.formatOptions.locale);
            const formattedValue = meta.formatOptions.formatValueAs === 'currency'
                ? new Intl.NumberFormat(meta.formatOptions.locale, {
                    style: 'currency',
                    currency: meta.formatOptions.currencyCode,
                    minimumFractionDigits: options.currencyPrecision,
                    maximumFractionDigits: options.currencyPrecision,
                }).format(+(value ?? 0) / options.currencyPrecisionFactor)
                : new Intl.NumberFormat(meta.formatOptions.locale).format(+(value ?? 0));
            const tooltipText = `
            <div class="tooltip-date">${dateFormatter.format(new Date(meta.label))}</div>
            <div class="tooltip-value">${formattedValue}</div>
           `;
            $toolTip.innerHTML = tooltipText;
            setPosition($point);
            show($toolTip);
            // Remember height and width to avoid wrong position in IE
            height = $toolTip.offsetHeight;
            width = $toolTip.offsetWidth;
        });
        on('mouseleave', undefined, () => {
            hide($toolTip);
        });
        function setPosition(element) {
            height = height || $toolTip.offsetHeight;
            width = width || $toolTip.offsetWidth;
            const { x: elX, y: elY, width: elWidth, height: elHeight } = element.getBoundingClientRect();
            const offsetX = -width / 2 + options.tooltipOffset.x;
            const offsetY = -height + options.tooltipOffset.y;
            let anchorX;
            let anchorY;
            if (!options.appendToBody) {
                const box = $chart.getBoundingClientRect();
                const left = elX - box.left - window.pageXOffset;
                const top = elY - box.top - window.pageYOffset;
                $toolTip.style.top = (anchorY || top) + offsetY + 'px';
                $toolTip.style.left = (anchorX || left) + offsetX + 'px';
            }
            else {
                $toolTip.style.top = elY + offsetY + 'px';
                $toolTip.style.left = elX + offsetX + 'px';
            }
        }
    };
}
function show(element) {
    if (!hasClass(element, 'tooltip-show')) {
        element.className = element.className + ' tooltip-show';
    }
}
function hide(element) {
    const regex = new RegExp('tooltip-show' + '\\s*', 'gi');
    element.className = element.className.replace(regex, '').trim();
}
function hasClass(element, className) {
    return (' ' + element.getAttribute('class') + ' ').indexOf(' ' + className + ' ') > -1;
}
function calculateDistance(x1, x2) {
    return Math.abs(x2 - x1);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidG9vbHRpcC1wbHVnaW4uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvbGliL2NvcmUvc3JjL3NoYXJlZC9jb21wb25lbnRzL2NoYXJ0L3Rvb2x0aXAtcGx1Z2luLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7R0FHRztBQUNILHFCQUFxQjtBQUtyQixNQUFNLGNBQWMsR0FBRztJQUNuQixRQUFRLEVBQUUsU0FBUztJQUNuQixpQkFBaUIsRUFBRSxDQUFDO0lBQ3BCLHVCQUF1QixFQUFFLEdBQUc7SUFDNUIsc0JBQXNCLEVBQUUsU0FBUztJQUNqQyxhQUFhLEVBQUU7UUFDWCxDQUFDLEVBQUUsQ0FBQztRQUNKLENBQUMsRUFBRSxDQUFDLEVBQUU7S0FDVDtJQUNELGFBQWEsRUFBRSxLQUFLO0lBQ3BCLFlBQVksRUFBRSxLQUFLO0lBQ25CLEtBQUssRUFBRSxTQUFTO0lBQ2hCLFVBQVUsRUFBRSxVQUFVO0NBQ3pCLENBQUM7QUFFRixNQUFNLFVBQVUsYUFBYSxDQUFDLFdBQTRDO0lBQ3RFLE9BQU8sU0FBUyxPQUFPLENBQUMsS0FBZ0I7UUFDcEMsTUFBTSxPQUFPLEdBQUc7WUFDWixHQUFHLGNBQWM7WUFDakIsR0FBRyxXQUFXO1NBQ2pCLENBQUM7UUFFRixNQUFNLE1BQU0sR0FBSSxLQUFhLENBQUMsU0FBMkIsQ0FBQztRQUMxRCxJQUFJLFFBQVEsR0FBRyxNQUFNLENBQUMsYUFBYSxDQUFDLG1CQUFtQixDQUFtQixDQUFDO1FBQzNFLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQztZQUNaLFFBQVEsR0FBRyxRQUFRLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3pDLFFBQVEsQ0FBQyxTQUFTLEdBQUcsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDLENBQUMsbUJBQW1CLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQztZQUMvRixJQUFJLENB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dGEvY2hhcnRpc3QtcGx1Z2luLXRvb2x0aXAvYmxvYi9tYXN0ZXIvc3JjL3NjcmlwdHMvY2hhcnRpc3QtcGx1Z2luLXRvb2x0aXAuanNcclxuICpcclxuICovXHJcbi8qIGdsb2JhbCBDaGFydGlzdCAqL1xyXG5cclxuaW1wb3J0IHsgRHJhd0V2ZW50LCBMaW5lQ2hhcnQgfSBmcm9tICdjaGFydGlzdCc7XHJcbmltcG9ydCB7IENoYXJ0Rm9ybWF0T3B0aW9ucyB9IGZyb20gJy4vY2hhcnQuY29tcG9uZW50JztcclxuXHJcbmNvbnN0IGRlZmF1bHRPcHRpb25zID0ge1xyXG4gICAgY3VycmVuY3k6IHVuZGVmaW5lZCxcclxuICAgIGN1cnJlbmN5UHJlY2lzaW9uOiAyLFxyXG4gICAgY3VycmVuY3lQcmVjaXNpb25GYWN0b3I6IDEwMCxcclxuICAgIGN1cnJlbmN5Rm9ybWF0Q2FsbGJhY2s6IHVuZGVmaW5lZCxcclxuICAgIHRvb2x0aXBPZmZzZXQ6IHtcclxuICAgICAgICB4OiAwLFxyXG4gICAgICAgIHk6IC0yMCxcclxuICAgIH0sXHJcbiAgICBhbmNob3JUb1BvaW50OiBmYWxzZSxcclxuICAgIGFwcGVuZFRvQm9keTogZmFsc2UsXHJcbiAgICBjbGFzczogdW5kZWZpbmVkLFxyXG4gICAgcG9pbnRDbGFzczogJ2N0LXBvaW50JyxcclxufTtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiB0b29sdGlwUGx1Z2luKHVzZXJPcHRpb25zPzogUGFydGlhbDx0eXBlb2YgZGVmYXVsdE9wdGlvbnM+KSB7XHJcbiAgICByZXR1cm4gZnVuY3Rpb24gdG9vbHRpcChjaGFydDogTGluZUNoYXJ0KSB7XHJcbiAgICAgICAgY29uc3Qgb3B0aW9ucyA9IHtcclxuICAgICAgICAgICAgLi4uZGVmYXVsdE9wdGlvbnMsXHJcbiAgICAgICAgICAgIC4uLnVzZXJPcHRpb25zLFxyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGNvbnN0ICRjaGFydCA9IChjaGFydCBhcyBhbnkpLmNvbnRhaW5lciBhcyBIVE1MRGl2RWxlbWVudDtcclxuICAgICAgICBsZXQgJHRvb2xUaXAgPSAkY2hhcnQucXVlcnlTZWxlY3RvcignLmNoYXJ0aXN0LXRvb2x0aXAnKSBhcyBIVE1MRGl2RWxlbWVudDtcclxuICAgICAgICBpZiAoISR0b29sVGlwKSB7XHJcbiAgICAgICAgICAgICR0b29sVGlwID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XHJcbiAgICAgICAgICAgICR0b29sVGlwLmNsYXNzTmFtZSA9ICFvcHRpb25zLmNsYXNzID8gJ2NoYXJ0aXN0LXRvb2x0aXAnIDogJ2NoYXJ0aXN0LXRvb2x0aXAgJyArIG9wdGlvbnMuY2xhc3M7XHJcbiAgICAgICAgICAgIGlmICghb3B0aW9ucy5hcHBlbmRUb0JvZHkpIHtcclxuICAgICAgICAgICAgICAgICRjaGFydC5hcHBlbmRDaGlsZCgkdG9vbFRpcCk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBkb2N1bWVudC5ib2R5LmFwcGVuZENoaWxkKCR0b29sVGlwKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgaGVpZ2h0ID0gJHRvb2xUaXAub2Zmc2V0SGVpZ2h0O1xyXG4gICAgICAgIGxldCB3aWR0aCA9ICR0b29sVGlwLm9mZnNldFdpZHRoO1xyXG4gICAgICAgIGNvbnN0IHBvaW50czogQXJyYXk8e1xyXG4gICAgICAgICAgICBldmVudDogRHJhd0V2ZW50O1xyXG4gICAgICAgICAgICB4OiBudW1iZXI7XHJcbiAgICAgICAgfT4gPSBbXTtcclxuXHJcbiAgICAgICAgZnVuY3Rpb24gZ2V0Q2xvc2VzdFBvaW50KG1vdXNlWDogbnVtYmVyKTogRHJhd0V2ZW50IHtcclxuICAgICAgICAgICAgbGV0IGNsb3Nlc3RFbGVtZW50OiBEcmF3RXZlbnQgfCBudWxsID0gbnVsbDtcclxuICAgICAgICAgICAgbGV0IGNsb3Nlc3REaXN0YW5jZSA9IEluZmluaXR5O1xyXG5cclxuICAgICAgICAgICAgLy8gSXRlcmF0ZSB0aHJvdWdoIHRoZSBwb2ludHMgYXJyYXkgdG8gZmluZCB0aGUgY2xvc2VzdCBlbGVtZW50XHJcbiAgICAgICAgICAgIGZvciAoY29uc3QgcG9pbnQgb2YgcG9pbnRzKSB7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBlbGVtZW50WCA9IHBvaW50Lng7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBkaXN0YW5jZSA9IGNhbGN1bGF0ZURpc3RhbmNlKG1vdXNlWCwgZWxlbWVudFgpO1xyXG5cclxuICAgICAgICAgICAgICAgIGlmIChkaXN0YW5jZSA8IGNsb3Nlc3REaXN0YW5jZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIGNsb3Nlc3RFbGVtZW50ID0gcG9pbnQuZXZlbnQ7XHJcbiAgICAgICAgICAgICAgICAgICAgY2xvc2VzdERpc3RhbmNlID0gZGlzdGFuY2U7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb25cclxuICAgICAgICAgICAgcmV0dXJuIGNsb3Nlc3RFbGVtZW50ITtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIGNoYXJ0Lm9uKCdkcmF3JywgZGF0YSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChkYXRhLnR5cGUgPT09ICdwb2ludCcpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGVsZW1lbnQgPSBkYXRhLmVsZW1lbnQ7XHJcbiAgICAgICAgICAgICAgICBwb2ludHNbZGF0YS5pbmRleF0gPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZXZlbnQ6IGRhdGEsXHJcbiAgICAgICAgICAgICAgICAgICAgeDogZGF0YS5lbGVtZW50LmdldE5vZGUoKS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS54LFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBoaWRlKCR0b29sVGlwKTtcclxuXHJcbiAgICAgICAgZnVuY3Rpb24gb24oZXZlbnQsIHNlbGVjdG9yLCBjYWxsYmFjaykge1xyXG4gICAgICAgICAgICAkY2hhcnQuYWRkRXZlbnRMaXN0ZW5lcihcclxuICAgICAgICAgICAgICAgIGV2ZW50LFxyXG4gICAgICAgICAgICAgICAgZnVuY3Rpb24gKGUpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIXNlbGVjdG9yIHx8IGhhc0NsYXNzKGUudGFyZ2V0LCBzZWxlY3RvcikpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2soZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIHsgcGFzc2l2ZTogdHJ1ZSB9LFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgb24oJ21vdXNlbW92ZScsIHVuZGVmaW5lZCwgKGV2ZW50OiBNb3VzZUV2ZW50KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGNsb3Nlc3RQb2ludCA9IGdldENsb3Nlc3RQb2ludChldmVudC5jbGllbnRYKTtcclxuICAgICAgICAgICAgaWYgKCFjbG9zZXN0UG9pbnQpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybjtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBwb2ludHMuZm9yRWFjaChwb2ludCA9PiBwb2ludC5ldmVudC5lbGVtZW50LnJlbW92ZUNsYXNzKCdjdC10b29sdGlwLWhvdmVyJykpO1xyXG4gICAgICAgICAgICBjbG9zZXN0UG9pbnQuZWxlbWVudC5hZGRDbGFzcygnY3QtdG9vbHRpcC1ob3ZlcicpO1xyXG5cclxuICAgICAgICAgICAgY29uc3QgJHBvaW50ID0gY2xvc2VzdFBvaW50LmVsZW1lbnQuZ2V0Tm9kZSgpIGFzIEhUTUxFbGVtZW50O1xyXG4gICAgICAgICAgICBjb25zdCBtZXRhOiB7XHJcbiAgICAgICAgICAgICAgICBsYWJlbDogc3RyaW5nO1xyXG4gICAgICAgICAgICAgICAgZm9ybWF0T3B0aW9uczogQ2hhcnRGb3JtYXRPcHRpb25zO1xyXG4gICAgICAgICAgICB9ID0gY2xvc2VzdFBvaW50Lm1ldGE7XHJcbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gJHBvaW50LmdldEF0dHJpYnV0ZSgnY3Q6dmFsdWUnKTtcclxuXHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGVGb3JtYXR0ZXIgPSBuZXcgSW50bC5EYXRlVGltZUZvcm1hdChtZXRhLmZvcm1hdE9wdGlvbnMubG9jYWxlKTtcclxuICAgICAgICAgICAgY29uc3QgZm9ybWF0dGVkVmFsdWUgPVxyXG4gICAgICAgICAgICAgICAgbWV0YS5mb3JtYXRPcHRpb25zLmZvcm1hdFZhbHVlQXMgPT09ICdjdXJyZW5jeSdcclxuICAgICAgICAgICAgICAgICAgICA/IG5ldyBJbnRsLk51bWJlckZvcm1hdChtZXRhLmZvcm1hdE9wdGlvbnMubG9jYWxlLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgc3R5bGU6ICdjdXJyZW5jeScsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVuY3k6IG1ldGEuZm9ybWF0T3B0aW9ucy5jdXJyZW5jeUNvZGUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgbWluaW11bUZyYWN0aW9uRGlnaXRzOiBvcHRpb25zLmN1cnJlbmN5UHJlY2lzaW9uLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIG1heGltdW1GcmFjdGlvbkRpZ2l0czogb3B0aW9ucy5jdXJyZW5jeVByZWNpc2lvbixcclxuICAgICAgICAgICAgICAgICAgICAgIH0pLmZvcm1hdCgrKHZhbHVlID8/IDApIC8gb3B0aW9ucy5jdXJyZW5jeVByZWNpc2lvbkZhY3RvcilcclxuICAgICAgICAgICAgICAgICAgICA6IG5ldyBJbnRsLk51bWJlckZvcm1hdChtZXRhLmZvcm1hdE9wdGlvbnMubG9jYWxlKS5mb3JtYXQoKyh2YWx1ZSA/PyAwKSk7XHJcblxyXG4gICAgICAgICAgICBjb25zdCB0b29sdGlwVGV4dCA9IGBcclxuICAgICAgICAgICAgPGRpdiBjbGFzcz1cInRvb2x0aXAtZGF0ZVwiPiR7ZGF0ZUZvcm1hdHRlci5mb3JtYXQobmV3IERhdGUobWV0YS5sYWJlbCkpfTwvZGl2PlxyXG4gICAgICAgICAgICA8ZGl2IGNsYXNzPVwidG9vbHRpcC12YWx1ZVwiPiR7Zm9ybWF0dGVkVmFsdWV9PC9kaXY+XHJcbiAgICAgICAgICAgYDtcclxuXHJcbiAgICAgICAgICAgICR0b29sVGlwLmlubmVySFRNTCA9IHRvb2x0aXBUZXh0O1xyXG4gICAgICAgICAgICBzZXRQb3NpdGlvbigkcG9pbnQpO1xyXG4gICAgICAgICAgICBzaG93KCR0b29sVGlwKTtcclxuXHJcbiAgICAgICAgICAgIC8vIFJlbWVtYmVyIGhlaWdodCBhbmQgd2lkdGggdG8gYXZvaWQgd3JvbmcgcG9zaXRpb24gaW4gSUVcclxuICAgICAgICAgICAgaGVpZ2h0ID0gJHRvb2xUaXAub2Zmc2V0SGVpZ2h0O1xyXG4gICAgICAgICAgICB3aWR0aCA9ICR0b29sVGlwLm9mZnNldFdpZHRoO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICBvbignbW91c2VsZWF2ZScsIHVuZGVmaW5lZCwgKCkgPT4ge1xyXG4gICAgICAgICAgICBoaWRlKCR0b29sVGlwKTtcclxuICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgZnVuY3Rpb24gc2V0UG9zaXRpb24oZWxlbWVudDogSFRNTEVsZW1lbnQpIHtcclxuICAgICAgICAgICAgaGVpZ2h0ID0gaGVpZ2h0IHx8ICR0b29sVGlwLm9mZnNldEhlaWdodDtcclxuICAgICAgICAgICAgd2lkdGggPSB3aWR0aCB8fCAkdG9vbFRpcC5vZmZzZXRXaWR0aDtcclxuICAgICAgICAgICAgY29uc3QgeyB4OiBlbFgsIHk6IGVsWSwgd2lkdGg6IGVsV2lkdGgsIGhlaWdodDogZWxIZWlnaHQgfSA9IGVsZW1lbnQuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XHJcbiAgICAgICAgICAgIGNvbnN0IG9mZnNldFggPSAtd2lkdGggLyAyICsgb3B0aW9ucy50b29sdGlwT2Zmc2V0Lng7XHJcbiAgICAgICAgICAgIGNvbnN0IG9mZnNldFkgPSAtaGVpZ2h0ICsgb3B0aW9ucy50b29sdGlwT2Zmc2V0Lnk7XHJcbiAgICAgICAgICAgIGxldCBhbmNob3JYO1xyXG4gICAgICAgICAgICBsZXQgYW5jaG9yWTtcclxuXHJcbiAgICAgICAgICAgIGlmICghb3B0aW9ucy5hcHBlbmRUb0JvZHkpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGJveCA9ICRjaGFydC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGxlZnQgPSBlbFggLSBib3gubGVmdCAtIHdpbmRvdy5wYWdlWE9mZnNldDtcclxuICAgICAgICAgICAgICAgIGNvbnN0IHRvcCA9IGVsWSAtIGJveC50b3AgLSB3aW5kb3cucGFnZVlPZmZzZXQ7XHJcblxyXG4gICAgICAgICAgICAgICAgJHRvb2xUaXAuc3R5bGUudG9wID0gKGFuY2hvclkgfHwgdG9wKSArIG9mZnNldFkgKyAncHgnO1xyXG4gICAgICAgICAgICAgICAgJHRvb2xUaXAuc3R5bGUubGVmdCA9IChhbmNob3JYIHx8IGxlZnQpICsgb2Zmc2V0WCArICdweCc7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAkdG9vbFRpcC5zdHlsZS50b3AgPSBlbFkgKyBvZmZzZXRZICsgJ3B4JztcclxuICAgICAgICAgICAgICAgICR0b29sVGlwLnN0eWxlLmxlZnQgPSBlbFggKyBvZmZzZXRYICsgJ3B4JztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgIH07XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNob3coZWxlbWVudCkge1xyXG4gICAgaWYgKCFoYXNDbGFzcyhlbGVtZW50LCAndG9vbHRpcC1zaG93JykpIHtcclxuICAgICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGVsZW1lbnQuY2xhc3NOYW1lICsgJyB0b29sdGlwLXNob3cnO1xyXG4gICAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiBoaWRlKGVsZW1lbnQpIHtcclxuICAgIGNvbnN0IHJlZ2V4ID0gbmV3IFJlZ0V4cCgndG9vbHRpcC1zaG93JyArICdcXFxccyonLCAnZ2knKTtcclxuICAgIGVsZW1lbnQuY2xhc3NOYW1lID0gZWxlbWVudC5jbGFzc05hbWUucmVwbGFjZShyZWdleCwgJycpLnRyaW0oKTtcclxufVxyXG5cclxuZnVuY3Rpb24gaGFzQ2xhc3MoZWxlbWVudCwgY2xhc3NOYW1lKSB7XHJcbiAgICByZXR1cm4gKCcgJyArIGVsZW1lbnQuZ2V0QXR0cmlidXRlKCdjbGFzcycpICsgJyAnKS5pbmRleE9mKCcgJyArIGNsYXNzTmFtZSArICcgJykgPiAtMTtcclxufVxyXG5cclxuZnVuY3Rpb24gY2FsY3VsYXRlRGlzdGFuY2UoeDEsIHgyKSB7XHJcbiAgICByZXR1cm4gTWF0aC5hYnMoeDIgLSB4MSk7XHJcbn1cclxuIl19