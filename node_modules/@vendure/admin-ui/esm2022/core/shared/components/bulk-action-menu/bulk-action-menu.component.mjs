import { ChangeDetectionStrategy, Component, Input, } from '@angular/core';
import { switchMap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "../../../providers/bulk-action-registry/bulk-action-registry.service";
import * as i2 from "@angular/router";
import * as i3 from "../../../data/providers/data.service";
import * as i4 from "@clr/angular";
import * as i5 from "@angular/common";
import * as i6 from "../dropdown/dropdown.component";
import * as i7 from "../dropdown/dropdown-menu.component";
import * as i8 from "../dropdown/dropdown-trigger.directive";
import * as i9 from "../dropdown/dropdown-item.directive";
import * as i10 from "@ngx-translate/core";
export class BulkActionMenuComponent {
    constructor(bulkActionRegistryService, injector, route, dataService, changeDetectorRef) {
        this.bulkActionRegistryService = bulkActionRegistryService;
        this.injector = injector;
        this.route = route;
        this.dataService = dataService;
        this.changeDetectorRef = changeDetectorRef;
        this.userPermissions = [];
        this.onClearSelectionFns = [];
    }
    ngOnInit() {
        const actionsForLocation = this.bulkActionRegistryService.getBulkActionsForLocation(this.locationId);
        this.actions$ = this.selectionManager.selectionChanges$.pipe(switchMap(selection => Promise.all(actionsForLocation.map(async (action) => {
            let display = true;
            let translationVars = {};
            const isVisibleFn = action.isVisible;
            const getTranslationVarsFn = action.getTranslationVars;
            const functionContext = {
                injector: this.injector,
                hostComponent: this.hostComponent,
                route: this.route,
                selection,
            };
            if (typeof isVisibleFn === 'function') {
                display = await isVisibleFn(functionContext);
            }
            if (typeof getTranslationVarsFn === 'function') {
                translationVars = await getTranslationVarsFn(functionContext);
            }
            return { ...action, display, translationVars };
        }))));
        this.subscription = this.dataService.client
            .userStatus()
            .mapStream(({ userStatus }) => {
            this.userPermissions = userStatus.permissions;
        })
            .subscribe();
    }
    ngOnDestroy() {
        this.subscription?.unsubscribe();
    }
    hasPermissions(bulkAction) {
        if (!this.userPermissions) {
            return false;
        }
        if (!bulkAction.requiresPermission) {
            return true;
        }
        if (typeof bulkAction.requiresPermission === 'string') {
            return this.userPermissions.includes(bulkAction.requiresPermission);
        }
        if (typeof bulkAction.requiresPermission === 'function') {
            return bulkAction.requiresPermission(this.userPermissions);
        }
    }
    actionClick(event, action) {
        action.onClick({
            injector: this.injector,
            event,
            route: this.route,
            selection: this.selectionManager.selection,
            hostComponent: this.hostComponent,
            clearSelection: () => this.selectionManager.clearSelection(),
        });
    }
    clearSelection() {
        this.selectionManager.clearSelection();
        this.changeDetectorRef.markForCheck();
        this.onClearSelectionFns.forEach(fn => fn());
    }
    onClearSelection(callback) {
        this.onClearSelectionFns.push(callback);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: BulkActionMenuComponent, deps: [{ token: i1.BulkActionRegistryService }, { token: i0.Injector }, { token: i2.ActivatedRoute }, { token: i3.DataService }, { token: i0.ChangeDetectorRef }], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "17.2.4", type: BulkActionMenuComponent, selector: "vdr-bulk-action-menu", inputs: { locationId: "locationId", selectionManager: "selectionManager", hostComponent: "hostComponent" }, ngImport: i0, template: "<vdr-dropdown *ngIf=\"actions$ | async as actions\">\r\n    <button\r\n        *ngIf=\"actions.length\"\r\n        class=\"btn btn-sm btn-outline mr-2\"\r\n        vdrDropdownTrigger\r\n        [disabled]=\"!selectionManager.selection?.length\"\r\n        [class.hidden]=\"!selectionManager.selection?.length\"\r\n    >\r\n        <clr-icon shape=\"file-group\"></clr-icon>\r\n        {{ 'common.with-selected' | translate: { count:selectionManager.selection.length } }}\r\n        <clr-icon shape=\"ellipsis-vertical\"></clr-icon>\r\n    </button>\r\n    <vdr-dropdown-menu vdrPosition=\"bottom-left\">\r\n        <ng-container *ngIf=\"actions.length; else noActions\">\r\n            <ng-container *ngFor=\"let action of actions\">\r\n                <button\r\n                    *ngIf=\"action.display\"\r\n                    [disabled]=\"!hasPermissions(action)\"\r\n                    type=\"button\"\r\n                    vdrDropdownItem\r\n                    (click)=\"actionClick($event, action)\"\r\n                >\r\n                    <clr-icon\r\n                        *ngIf=\"action.icon\"\r\n                        [attr.shape]=\"action.icon\"\r\n                        [ngClass]=\"action.iconClass || ''\"\r\n                    ></clr-icon>\r\n                    {{ action.label | translate: action.translationVars }}\r\n                </button>\r\n            </ng-container>\r\n        </ng-container>\r\n        <ng-template #noActions>\r\n            <button type=\"button\" disabled vdrDropdownItem>{{ 'common.no-bulk-actions-available' | translate }}</button>\r\n        </ng-template>\r\n    </vdr-dropdown-menu>\r\n</vdr-dropdown>\r\n<button\r\n    class=\"button-small\"\r\n    (click)=\"clearSelection()\"\r\n    [class.hidden]=\"!selectionManager.selection?.length\"\r\n>\r\n    <span>{{ 'common.clear-selection' | translate }}</span>\r\n    <clr-icon shape=\"times\"></clr-icon>\r\n</button>\r\n", styles: [":host{display:inline-flex;align-items:center}button.hidden{display:none}\n"], dependencies: [{ kind: "directive", type: i4.ClrIconCustomTag, selector: "clr-icon" }, { kind: "directive", type: i5.NgClass, selector: "[ngClass]", inputs: ["class", "ngClass"] }, { kind: "directive", type: i5.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "directive", type: i5.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "component", type: i6.DropdownComponent, selector: "vdr-dropdown", inputs: ["manualToggle"] }, { kind: "component", type: i7.DropdownMenuComponent, selector: "vdr-dropdown-menu", inputs: ["vdrPosition", "customClasses"] }, { kind: "directive", type: i8.DropdownTriggerDirective, selector: "[vdrDropdownTrigger]" }, { kind: "directive", type: i9.DropdownItemDirective, selector: "[vdrDropdownItem]" }, { kind: "pipe", type: i5.AsyncPipe, name: "async" }, { kind: "pipe", type: i10.TranslatePipe, name: "translate" }], changeDetection: i0.ChangeDetectionStrategy.OnPush }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: BulkActionMenuComponent, decorators: [{
            type: Component,
            args: [{ selector: 'vdr-bulk-action-menu', changeDetection: ChangeDetectionStrategy.OnPush, template: "<vdr-dropdown *ngIf=\"actions$ | async as actions\">\r\n    <button\r\n        *ngIf=\"actions.length\"\r\n        class=\"btn btn-sm btn-outline mr-2\"\r\n        vdrDropdownTrigger\r\n        [disabled]=\"!selectionManager.selection?.length\"\r\n        [class.hidden]=\"!selectionManager.selection?.length\"\r\n    >\r\n        <clr-icon shape=\"file-group\"></clr-icon>\r\n        {{ 'common.with-selected' | translate: { count:selectionManager.selection.length } }}\r\n        <clr-icon shape=\"ellipsis-vertical\"></clr-icon>\r\n    </button>\r\n    <vdr-dropdown-menu vdrPosition=\"bottom-left\">\r\n        <ng-container *ngIf=\"actions.length; else noActions\">\r\n            <ng-container *ngFor=\"let action of actions\">\r\n                <button\r\n                    *ngIf=\"action.display\"\r\n                    [disabled]=\"!hasPermissions(action)\"\r\n                    type=\"button\"\r\n                    vdrDropdownItem\r\n                    (click)=\"actionClick($event, action)\"\r\n                >\r\n                    <clr-icon\r\n                        *ngIf=\"action.icon\"\r\n                        [attr.shape]=\"action.icon\"\r\n                        [ngClass]=\"action.iconClass || ''\"\r\n                    ></clr-icon>\r\n                    {{ action.label | translate: action.translationVars }}\r\n                </button>\r\n            </ng-container>\r\n        </ng-container>\r\n        <ng-template #noActions>\r\n            <button type=\"button\" disabled vdrDropdownItem>{{ 'common.no-bulk-actions-available' | translate }}</button>\r\n        </ng-template>\r\n    </vdr-dropdown-menu>\r\n</vdr-dropdown>\r\n<button\r\n    class=\"button-small\"\r\n    (click)=\"clearSelection()\"\r\n    [class.hidden]=\"!selectionManager.selection?.length\"\r\n>\r\n    <span>{{ 'common.clear-selection' | translate }}</span>\r\n    <clr-icon shape=\"times\"></clr-icon>\r\n</button>\r\n", styles: [":host{display:inline-flex;align-items:center}button.hidden{display:none}\n"] }]
        }], ctorParameters: () => [{ type: i1.BulkActionRegistryService }, { type: i0.Injector }, { type: i2.ActivatedRoute }, { type: i3.DataService }, { type: i0.ChangeDetectorRef }], propDecorators: { locationId: [{
                type: Input
            }], selectionManager: [{
                type: Input
            }], hostComponent: [{
                type: Input
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVsay1hY3Rpb24tbWVudS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvbGliL2NvcmUvc3JjL3NoYXJlZC9jb21wb25lbnRzL2J1bGstYWN0aW9uLW1lbnUvYnVsay1hY3Rpb24tbWVudS5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi9zcmMvbGliL2NvcmUvc3JjL3NoYXJlZC9jb21wb25lbnRzL2J1bGstYWN0aW9uLW1lbnUvYnVsay1hY3Rpb24tbWVudS5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0gsdUJBQXVCLEVBRXZCLFNBQVMsRUFFVCxLQUFLLEdBR1IsTUFBTSxlQUFlLENBQUM7QUFHdkIsT0FBTyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7Ozs7Ozs7Ozs7QUFpQjNDLE1BQU0sT0FBTyx1QkFBdUI7SUFZaEMsWUFDWSx5QkFBb0QsRUFDcEQsUUFBa0IsRUFDbEIsS0FBcUIsRUFDckIsV0FBd0IsRUFDeEIsaUJBQW9DO1FBSnBDLDhCQUF5QixHQUF6Qix5QkFBeUIsQ0FBMkI7UUFDcEQsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixVQUFLLEdBQUwsS0FBSyxDQUFnQjtRQUNyQixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4QixzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBVmhELG9CQUFlLEdBQWEsRUFBRSxDQUFDO1FBR3ZCLHdCQUFtQixHQUFzQixFQUFFLENBQUM7SUFRakQsQ0FBQztJQUVKLFFBQVE7UUFDSixNQUFNLGtCQUFrQixHQUFHLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyx5QkFBeUIsQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFDckcsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsaUJBQWlCLENBQUMsSUFBSSxDQUN4RCxTQUFTLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FDbEIsT0FBTyxDQUFDLEdBQUcsQ0FDUCxrQkFBa0IsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFDLE1BQU0sRUFBQyxFQUFFO1lBQ2xDLElBQUksT0FBTyxHQUFHLElBQUksQ0FBQztZQUNuQixJQUFJLGVBQWUsR0FBRyxFQUFFLENBQUM7WUFDekIsTUFBTSxXQUFXLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQztZQUNyQyxNQUFNLG9CQUFvQixHQUFHLE1BQU0sQ0FBQyxrQkFBa0IsQ0FBQztZQUN2RCxNQUFNLGVBQWUsR0FBc0M7Z0JBQ3ZELFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtnQkFDdkIsYUFBYSxFQUFFLElBQUksQ0FBQyxhQUFhO2dCQUNqQyxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUs7Z0JBQ2pCLFNBQVM7YUFDWixDQUFDO1lBQ0YsSUFBSSxPQUFPLFdBQVcsS0FBSyxVQUFVLEVBQUUsQ0FBQztnQkFDcEMsT0FBTyxHQUFHLE1BQU0sV0FBVyxDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQ2pELENBQUM7WUFDRCxJQUFJLE9BQU8sb0JBQW9CLEtBQUssVUFBVSxFQUFFLENBQUM7Z0JBQzdDLGVBQWUsR0FBRyxNQUFNLG9CQUFvQixDQUFDLGVBQWUsQ0FBQyxDQUFDO1lBQ2xFLENBQUM7WUFDRCxPQUFPLEVBQUUsR0FBRyxNQUFNLEVBQUUsT0FBTyxFQUFFLGVBQWUsRUFBRSxDQUFDO1FBQ25ELENBQUMsQ0FBQyxDQUNMLENBQ0osQ0FDSixDQUFDO1FBQ0YsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLENBQUMsV0FBVyxDQUFDLE1BQU07YUFDdEMsVUFBVSxFQUFFO2FBQ1osU0FBUyxDQUFDLENBQUMsRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFO1lBQzFCLElBQUksQ0FBQyxlQUFlLEdBQUcsVUFBVSxDQUFDLFdBQVcsQ0FBQztRQUNsRCxDQUFDLENBQUM7YUFDRCxTQUFTLEVBQUUsQ0FBQztJQUNyQixDQUFDO0lBRUQsV0FBVztRQUNQLElBQUksQ0FBQyxZQUFZLEVBQUUsV0FBVyxFQUFFLENBQUM7SUFDckMsQ0FBQztJQUVELGNBQWMsQ0FBQyxVQUFrRDtRQUM3RCxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1lBQ3hCLE9BQU8sS0FBSyxDQUFDO1FBQ2pCLENBQUM7UUFDRCxJQUFJLENBQUMsVUFBVSxDQUFDLGtCQUFrQixFQUFFLENBQUM7WUFDakMsT0FBTyxJQUFJLENBQUM7UUFDaEIsQ0FBQztRQUNELElBQUksT0FBTyxVQUFVLENBQUMsa0JBQWtCLEtBQUssUUFBUSxFQUFFLENBQUM7WUFDcEQsT0FBTyxJQUFJLENBQUMsZUFBZSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsa0JBQWtCLENBQUMsQ0FBQztRQUN4RSxDQUFDO1FBQ0QsSUFBSSxPQUFPLFVBQVUsQ0FBQyxrQkFBa0IsS0FBSyxVQUFVLEVBQUUsQ0FBQztZQUN0RCxPQUFPLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDL0QsQ0FBQztJQUNMLENBQUM7SUFFRCxXQUFXLENBQUMsS0FBaUIsRUFBRSxNQUFrQjtRQUM3QyxNQUFNLENBQUMsT0FBTyxDQUFDO1lBQ1gsUUFBUSxFQUFFLElBQUksQ0FBQyxRQUFRO1lBQ3ZCLEtBQUs7WUFDTCxLQUFLLEVBQUUsSUFBSSxDQUFDLEtBQUs7WUFDakIsU0FBUyxFQUFFLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxTQUFTO1lBQzFDLGFBQWEsRUFBRSxJQUFJLENBQUMsYUFBYTtZQUNqQyxjQUFjLEVBQUUsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLGNBQWMsRUFBRTtTQUMvRCxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQsY0FBYztRQUNWLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxjQUFjLEVBQUUsQ0FBQztRQUN2QyxJQUFJLENBQUMsaUJBQWlCLENBQUMsWUFBWSxFQUFFLENBQUM7UUFDdEMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLE9BQU8sQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFDakQsQ0FBQztJQUVELGdCQUFnQixDQUFDLFFBQW9CO1FBQ2pDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDNUMsQ0FBQzs4R0E3RlEsdUJBQXVCO2tHQUF2Qix1QkFBdUIsd0tDNUJwQyxxNURBNENBOzsyRkRoQmEsdUJBQXVCO2tCQU5uQyxTQUFTOytCQUNJLHNCQUFzQixtQkFHZix1QkFBdUIsQ0FBQyxNQUFNOzRNQUd0QyxVQUFVO3NCQUFsQixLQUFLO2dCQUNHLGdCQUFnQjtzQkFBeEIsS0FBSztnQkFDRyxhQUFhO3NCQUFyQixLQUFLIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcclxuICAgIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxyXG4gICAgQ2hhbmdlRGV0ZWN0b3JSZWYsXHJcbiAgICBDb21wb25lbnQsXHJcbiAgICBJbmplY3RvcixcclxuICAgIElucHV0LFxyXG4gICAgT25EZXN0cm95LFxyXG4gICAgT25Jbml0LFxyXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZSB9IGZyb20gJ0Bhbmd1bGFyL3JvdXRlcic7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5pbXBvcnQgeyBTZWxlY3Rpb25NYW5hZ2VyIH0gZnJvbSAnLi4vLi4vLi4vY29tbW9uL3V0aWxpdGllcy9zZWxlY3Rpb24tbWFuYWdlcic7XHJcbmltcG9ydCB7IERhdGFTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vZGF0YS9wcm92aWRlcnMvZGF0YS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQnVsa0FjdGlvblJlZ2lzdHJ5U2VydmljZSB9IGZyb20gJy4uLy4uLy4uL3Byb3ZpZGVycy9idWxrLWFjdGlvbi1yZWdpc3RyeS9idWxrLWFjdGlvbi1yZWdpc3RyeS5zZXJ2aWNlJztcclxuaW1wb3J0IHtcclxuICAgIEJ1bGtBY3Rpb24sXHJcbiAgICBCdWxrQWN0aW9uRnVuY3Rpb25Db250ZXh0LFxyXG4gICAgQnVsa0FjdGlvbkxvY2F0aW9uSWQsXHJcbn0gZnJvbSAnLi4vLi4vLi4vcHJvdmlkZXJzL2J1bGstYWN0aW9uLXJlZ2lzdHJ5L2J1bGstYWN0aW9uLXR5cGVzJztcclxuXHJcbkBDb21wb25lbnQoe1xyXG4gICAgc2VsZWN0b3I6ICd2ZHItYnVsay1hY3Rpb24tbWVudScsXHJcbiAgICB0ZW1wbGF0ZVVybDogJy4vYnVsay1hY3Rpb24tbWVudS5jb21wb25lbnQuaHRtbCcsXHJcbiAgICBzdHlsZVVybHM6IFsnLi9idWxrLWFjdGlvbi1tZW51LmNvbXBvbmVudC5zY3NzJ10sXHJcbiAgICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcclxufSlcclxuZXhwb3J0IGNsYXNzIEJ1bGtBY3Rpb25NZW51Q29tcG9uZW50PFQgPSBhbnk+IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xyXG4gICAgQElucHV0KCkgbG9jYXRpb25JZDogQnVsa0FjdGlvbkxvY2F0aW9uSWQ7XHJcbiAgICBASW5wdXQoKSBzZWxlY3Rpb25NYW5hZ2VyOiBTZWxlY3Rpb25NYW5hZ2VyPFQ+O1xyXG4gICAgQElucHV0KCkgaG9zdENvbXBvbmVudDogYW55O1xyXG4gICAgYWN0aW9ucyQ6IE9ic2VydmFibGU8XHJcbiAgICAgICAgQXJyYXk8QnVsa0FjdGlvbjxUPiAmIHsgZGlzcGxheTogYm9vbGVhbjsgdHJhbnNsYXRpb25WYXJzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmcgfCBudW1iZXI+IH0+XHJcbiAgICA+O1xyXG4gICAgdXNlclBlcm1pc3Npb25zOiBzdHJpbmdbXSA9IFtdO1xyXG5cclxuICAgIHByaXZhdGUgc3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XHJcbiAgICBwcml2YXRlIG9uQ2xlYXJTZWxlY3Rpb25GbnM6IEFycmF5PCgpID0+IHZvaWQ+ID0gW107XHJcblxyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcHJpdmF0ZSBidWxrQWN0aW9uUmVnaXN0cnlTZXJ2aWNlOiBCdWxrQWN0aW9uUmVnaXN0cnlTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLFxyXG4gICAgICAgIHByaXZhdGUgcm91dGU6IEFjdGl2YXRlZFJvdXRlLFxyXG4gICAgICAgIHByaXZhdGUgZGF0YVNlcnZpY2U6IERhdGFTZXJ2aWNlLFxyXG4gICAgICAgIHByaXZhdGUgY2hhbmdlRGV0ZWN0b3JSZWY6IENoYW5nZURldGVjdG9yUmVmLFxyXG4gICAgKSB7fVxyXG5cclxuICAgIG5nT25Jbml0KCk6IHZvaWQge1xyXG4gICAgICAgIGNvbnN0IGFjdGlvbnNGb3JMb2NhdGlvbiA9IHRoaXMuYnVsa0FjdGlvblJlZ2lzdHJ5U2VydmljZS5nZXRCdWxrQWN0aW9uc0ZvckxvY2F0aW9uKHRoaXMubG9jYXRpb25JZCk7XHJcbiAgICAgICAgdGhpcy5hY3Rpb25zJCA9IHRoaXMuc2VsZWN0aW9uTWFuYWdlci5zZWxlY3Rpb25DaGFuZ2VzJC5waXBlKFxyXG4gICAgICAgICAgICBzd2l0Y2hNYXAoc2VsZWN0aW9uID0+XHJcbiAgICAgICAgICAgICAgICBQcm9taXNlLmFsbChcclxuICAgICAgICAgICAgICAgICAgICBhY3Rpb25zRm9yTG9jYXRpb24ubWFwKGFzeW5jIGFjdGlvbiA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBkaXNwbGF5ID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHRyYW5zbGF0aW9uVmFycyA9IHt9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1Zpc2libGVGbiA9IGFjdGlvbi5pc1Zpc2libGU7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGdldFRyYW5zbGF0aW9uVmFyc0ZuID0gYWN0aW9uLmdldFRyYW5zbGF0aW9uVmFycztcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZnVuY3Rpb25Db250ZXh0OiBCdWxrQWN0aW9uRnVuY3Rpb25Db250ZXh0PFQsIGFueT4gPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmplY3RvcjogdGhpcy5pbmplY3RvcixcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGhvc3RDb21wb25lbnQ6IHRoaXMuaG9zdENvbXBvbmVudCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvdXRlOiB0aGlzLnJvdXRlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZWN0aW9uLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGlzVmlzaWJsZUZuID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBkaXNwbGF5ID0gYXdhaXQgaXNWaXNpYmxlRm4oZnVuY3Rpb25Db250ZXh0KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGdldFRyYW5zbGF0aW9uVmFyc0ZuID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2xhdGlvblZhcnMgPSBhd2FpdCBnZXRUcmFuc2xhdGlvblZhcnNGbihmdW5jdGlvbkNvbnRleHQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7IC4uLmFjdGlvbiwgZGlzcGxheSwgdHJhbnNsYXRpb25WYXJzIH07XHJcbiAgICAgICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgICAgICApLFxyXG4gICAgICAgICAgICApLFxyXG4gICAgICAgICk7XHJcbiAgICAgICAgdGhpcy5zdWJzY3JpcHRpb24gPSB0aGlzLmRhdGFTZXJ2aWNlLmNsaWVudFxyXG4gICAgICAgICAgICAudXNlclN0YXR1cygpXHJcbiAgICAgICAgICAgIC5tYXBTdHJlYW0oKHsgdXNlclN0YXR1cyB9KSA9PiB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnVzZXJQZXJtaXNzaW9ucyA9IHVzZXJTdGF0dXMucGVybWlzc2lvbnM7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKTtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uRGVzdHJveSgpIHtcclxuICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbj8udW5zdWJzY3JpYmUoKTtcclxuICAgIH1cclxuXHJcbiAgICBoYXNQZXJtaXNzaW9ucyhidWxrQWN0aW9uOiBQaWNrPEJ1bGtBY3Rpb24sICdyZXF1aXJlc1Blcm1pc3Npb24nPikge1xyXG4gICAgICAgIGlmICghdGhpcy51c2VyUGVybWlzc2lvbnMpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoIWJ1bGtBY3Rpb24ucmVxdWlyZXNQZXJtaXNzaW9uKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0cnVlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodHlwZW9mIGJ1bGtBY3Rpb24ucmVxdWlyZXNQZXJtaXNzaW9uID09PSAnc3RyaW5nJykge1xyXG4gICAgICAgICAgICByZXR1cm4gdGhpcy51c2VyUGVybWlzc2lvbnMuaW5jbHVkZXMoYnVsa0FjdGlvbi5yZXF1aXJlc1Blcm1pc3Npb24pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodHlwZW9mIGJ1bGtBY3Rpb24ucmVxdWlyZXNQZXJtaXNzaW9uID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBidWxrQWN0aW9uLnJlcXVpcmVzUGVybWlzc2lvbih0aGlzLnVzZXJQZXJtaXNzaW9ucyk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGFjdGlvbkNsaWNrKGV2ZW50OiBNb3VzZUV2ZW50LCBhY3Rpb246IEJ1bGtBY3Rpb24pIHtcclxuICAgICAgICBhY3Rpb24ub25DbGljayh7XHJcbiAgICAgICAgICAgIGluamVjdG9yOiB0aGlzLmluamVjdG9yLFxyXG4gICAgICAgICAgICBldmVudCxcclxuICAgICAgICAgICAgcm91dGU6IHRoaXMucm91dGUsXHJcbiAgICAgICAgICAgIHNlbGVjdGlvbjogdGhpcy5zZWxlY3Rpb25NYW5hZ2VyLnNlbGVjdGlvbixcclxuICAgICAgICAgICAgaG9zdENvbXBvbmVudDogdGhpcy5ob3N0Q29tcG9uZW50LFxyXG4gICAgICAgICAgICBjbGVhclNlbGVjdGlvbjogKCkgPT4gdGhpcy5zZWxlY3Rpb25NYW5hZ2VyLmNsZWFyU2VsZWN0aW9uKCksXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY2xlYXJTZWxlY3Rpb24oKSB7XHJcbiAgICAgICAgdGhpcy5zZWxlY3Rpb25NYW5hZ2VyLmNsZWFyU2VsZWN0aW9uKCk7XHJcbiAgICAgICAgdGhpcy5jaGFuZ2VEZXRlY3RvclJlZi5tYXJrRm9yQ2hlY2soKTtcclxuICAgICAgICB0aGlzLm9uQ2xlYXJTZWxlY3Rpb25GbnMuZm9yRWFjaChmbiA9PiBmbigpKTtcclxuICAgIH1cclxuXHJcbiAgICBvbkNsZWFyU2VsZWN0aW9uKGNhbGxiYWNrOiAoKSA9PiB2b2lkKSB7XHJcbiAgICAgICAgdGhpcy5vbkNsZWFyU2VsZWN0aW9uRm5zLnB1c2goY2FsbGJhY2spO1xyXG4gICAgfVxyXG59XHJcbiIsIjx2ZHItZHJvcGRvd24gKm5nSWY9XCJhY3Rpb25zJCB8IGFzeW5jIGFzIGFjdGlvbnNcIj5cclxuICAgIDxidXR0b25cclxuICAgICAgICAqbmdJZj1cImFjdGlvbnMubGVuZ3RoXCJcclxuICAgICAgICBjbGFzcz1cImJ0biBidG4tc20gYnRuLW91dGxpbmUgbXItMlwiXHJcbiAgICAgICAgdmRyRHJvcGRvd25UcmlnZ2VyXHJcbiAgICAgICAgW2Rpc2FibGVkXT1cIiFzZWxlY3Rpb25NYW5hZ2VyLnNlbGVjdGlvbj8ubGVuZ3RoXCJcclxuICAgICAgICBbY2xhc3MuaGlkZGVuXT1cIiFzZWxlY3Rpb25NYW5hZ2VyLnNlbGVjdGlvbj8ubGVuZ3RoXCJcclxuICAgID5cclxuICAgICAgICA8Y2xyLWljb24gc2hhcGU9XCJmaWxlLWdyb3VwXCI+PC9jbHItaWNvbj5cclxuICAgICAgICB7eyAnY29tbW9uLndpdGgtc2VsZWN0ZWQnIHwgdHJhbnNsYXRlOiB7IGNvdW50OnNlbGVjdGlvbk1hbmFnZXIuc2VsZWN0aW9uLmxlbmd0aCB9IH19XHJcbiAgICAgICAgPGNsci1pY29uIHNoYXBlPVwiZWxsaXBzaXMtdmVydGljYWxcIj48L2Nsci1pY29uPlxyXG4gICAgPC9idXR0b24+XHJcbiAgICA8dmRyLWRyb3Bkb3duLW1lbnUgdmRyUG9zaXRpb249XCJib3R0b20tbGVmdFwiPlxyXG4gICAgICAgIDxuZy1jb250YWluZXIgKm5nSWY9XCJhY3Rpb25zLmxlbmd0aDsgZWxzZSBub0FjdGlvbnNcIj5cclxuICAgICAgICAgICAgPG5nLWNvbnRhaW5lciAqbmdGb3I9XCJsZXQgYWN0aW9uIG9mIGFjdGlvbnNcIj5cclxuICAgICAgICAgICAgICAgIDxidXR0b25cclxuICAgICAgICAgICAgICAgICAgICAqbmdJZj1cImFjdGlvbi5kaXNwbGF5XCJcclxuICAgICAgICAgICAgICAgICAgICBbZGlzYWJsZWRdPVwiIWhhc1Blcm1pc3Npb25zKGFjdGlvbilcIlxyXG4gICAgICAgICAgICAgICAgICAgIHR5cGU9XCJidXR0b25cIlxyXG4gICAgICAgICAgICAgICAgICAgIHZkckRyb3Bkb3duSXRlbVxyXG4gICAgICAgICAgICAgICAgICAgIChjbGljayk9XCJhY3Rpb25DbGljaygkZXZlbnQsIGFjdGlvbilcIlxyXG4gICAgICAgICAgICAgICAgPlxyXG4gICAgICAgICAgICAgICAgICAgIDxjbHItaWNvblxyXG4gICAgICAgICAgICAgICAgICAgICAgICAqbmdJZj1cImFjdGlvbi5pY29uXCJcclxuICAgICAgICAgICAgICAgICAgICAgICAgW2F0dHIuc2hhcGVdPVwiYWN0aW9uLmljb25cIlxyXG4gICAgICAgICAgICAgICAgICAgICAgICBbbmdDbGFzc109XCJhY3Rpb24uaWNvbkNsYXNzIHx8ICcnXCJcclxuICAgICAgICAgICAgICAgICAgICA+PC9jbHItaWNvbj5cclxuICAgICAgICAgICAgICAgICAgICB7eyBhY3Rpb24ubGFiZWwgfCB0cmFuc2xhdGU6IGFjdGlvbi50cmFuc2xhdGlvblZhcnMgfX1cclxuICAgICAgICAgICAgICAgIDwvYnV0dG9uPlxyXG4gICAgICAgICAgICA8L25nLWNvbnRhaW5lcj5cclxuICAgICAgICA8L25nLWNvbnRhaW5lcj5cclxuICAgICAgICA8bmctdGVtcGxhdGUgI25vQWN0aW9ucz5cclxuICAgICAgICAgICAgPGJ1dHRvbiB0eXBlPVwiYnV0dG9uXCIgZGlzYWJsZWQgdmRyRHJvcGRvd25JdGVtPnt7ICdjb21tb24ubm8tYnVsay1hY3Rpb25zLWF2YWlsYWJsZScgfCB0cmFuc2xhdGUgfX08L2J1dHRvbj5cclxuICAgICAgICA8L25nLXRlbXBsYXRlPlxyXG4gICAgPC92ZHItZHJvcGRvd24tbWVudT5cclxuPC92ZHItZHJvcGRvd24+XHJcbjxidXR0b25cclxuICAgIGNsYXNzPVwiYnV0dG9uLXNtYWxsXCJcclxuICAgIChjbGljayk9XCJjbGVhclNlbGVjdGlvbigpXCJcclxuICAgIFtjbGFzcy5oaWRkZW5dPVwiIXNlbGVjdGlvbk1hbmFnZXIuc2VsZWN0aW9uPy5sZW5ndGhcIlxyXG4+XHJcbiAgICA8c3Bhbj57eyAnY29tbW9uLmNsZWFyLXNlbGVjdGlvbicgfCB0cmFuc2xhdGUgfX08L3NwYW4+XHJcbiAgICA8Y2xyLWljb24gc2hhcGU9XCJ0aW1lc1wiPjwvY2xyLWljb24+XHJcbjwvYnV0dG9uPlxyXG4iXX0=