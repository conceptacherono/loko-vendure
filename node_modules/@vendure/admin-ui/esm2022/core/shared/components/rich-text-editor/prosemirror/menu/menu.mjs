import { toggleMark } from 'prosemirror-commands';
import { redo, undo } from 'prosemirror-history';
import { blockTypeItem, Dropdown, icons, joinUpItem, liftItem, MenuItem, selectParentNodeItem, wrapItem, } from 'prosemirror-menu';
import { wrapInList } from 'prosemirror-schema-list';
import { insertImageItem } from '../plugins/image-plugin';
import { addTable } from '../plugins/tables-plugin';
import { linkItem } from './links';
import { canInsert, IconSize, markActive, renderClarityIcon, wrapInMenuItemWithIcon } from './menu-common';
import { SubMenuWithIcon } from './sub-menu-with-icon';
function cmdItem(cmd, options) {
    const passedOptions = {
        label: options.title,
        run: cmd,
        render: options.iconShape
            ? renderClarityIcon({ shape: options.iconShape, size: IconSize.Large })
            : undefined,
    };
    // eslint-disable-next-line guard-for-in
    for (const prop in options) {
        passedOptions[prop] = options[prop];
    }
    if ((!options.enable || options.enable === true) && !options.select) {
        passedOptions[options.enable ? 'enable' : 'select'] = state => cmd(state);
    }
    return new MenuItem(passedOptions);
}
function markItem(markType, options) {
    const passedOptions = {
        active(state) {
            return markActive(state, markType);
        },
        enable: true,
    };
    // eslint-disable-next-line guard-for-in
    for (const prop in options) {
        passedOptions[prop] = options[prop];
    }
    return cmdItem(toggleMark(markType), passedOptions);
}
function wrapListItem(nodeType, options) {
    return cmdItem(wrapInList(nodeType, options.attrs), options);
}
// :: (Schema) â†’ Object
// Given a schema, look for default mark and node types in it and
// return an object with relevant menu items relating to those marks:
//
// **`toggleStrong`**`: MenuItem`
//   : A menu item to toggle the [strong mark](#schema-basic.StrongMark).
//
// **`toggleEm`**`: MenuItem`
//   : A menu item to toggle the [emphasis mark](#schema-basic.EmMark).
//
// **`toggleCode`**`: MenuItem`
//   : A menu item to toggle the [code font mark](#schema-basic.CodeMark).
//
// **`toggleLink`**`: MenuItem`
//   : A menu item to toggle the [link mark](#schema-basic.LinkMark).
//
// **`insertImage`**`: MenuItem`
//   : A menu item to insert an [image](#schema-basic.Image).
//
// **`wrapBulletList`**`: MenuItem`
//   : A menu item to wrap the selection in a [bullet list](#schema-list.BulletList).
//
// **`wrapOrderedList`**`: MenuItem`
//   : A menu item to wrap the selection in an [ordered list](#schema-list.OrderedList).
//
// **`wrapBlockQuote`**`: MenuItem`
//   : A menu item to wrap the selection in a [block quote](#schema-basic.BlockQuote).
//
// **`makeParagraph`**`: MenuItem`
//   : A menu item to set the current textblock to be a normal
//     [paragraph](#schema-basic.Paragraph).
//
// **`makeCodeBlock`**`: MenuItem`
//   : A menu item to set the current textblock to be a
//     [code block](#schema-basic.CodeBlock).
//
// **`makeHead[N]`**`: MenuItem`
//   : Where _N_ is 1 to 6. Menu items to set the current textblock to
//     be a [heading](#schema-basic.Heading) of level _N_.
//
// **`insertHorizontalRule`**`: MenuItem`
//   : A menu item to insert a horizontal rule.
//
// The return value also contains some prefabricated menu elements and
// menus, that you can use instead of composing your own menu from
// scratch:
//
// **`insertMenu`**`: Dropdown`
//   : A dropdown containing the `insertImage` and
//     `insertHorizontalRule` items.
//
// **`typeMenu`**`: Dropdown`
//   : A dropdown containing the items for making the current
//     textblock a paragraph, code block, or heading.
//
// **`fullMenu`**`: [[MenuElement]]`
//   : An array of arrays of menu elements for use as the full menu
//     for, for example the [menu bar](https://github.com/prosemirror/prosemirror-menu#user-content-menubar).
export function buildMenuItems(schema, modalService) {
    const r = {};
    let type;
    /* eslint-disable no-cond-assign */
    if ((type = schema.marks.strong)) {
        r.toggleStrong = markItem(type, {
            title: 'Toggle strong style',
            iconShape: 'bold',
        });
    }
    if ((type = schema.marks.em)) {
        r.toggleEm = markItem(type, {
            title: 'Toggle emphasis',
            iconShape: 'italic',
        });
    }
    if ((type = schema.marks.code)) {
        r.toggleCode = markItem(type, { title: 'Toggle code font', icon: icons.code });
    }
    if ((type = schema.marks.link)) {
        r.toggleLink = linkItem(type, modalService);
    }
    if ((type = schema.nodes.image)) {
        r.insertImage = insertImageItem(type, modalService);
    }
    if ((type = schema.nodes.bullet_list)) {
        r.wrapBulletList = wrapListItem(type, {
            title: 'Wrap in bullet list',
            iconShape: 'bullet-list',
        });
    }
    if ((type = schema.nodes.ordered_list)) {
        r.wrapOrderedList = wrapListItem(type, {
            title: 'Wrap in ordered list',
            iconShape: 'number-list',
        });
    }
    if ((type = schema.nodes.blockquote)) {
        r.wrapBlockQuote = wrapItem(type, {
            title: 'Wrap in block quote',
            render: renderClarityIcon({ shape: 'block-quote', size: IconSize.Large }),
        });
    }
    if ((type = schema.nodes.paragraph)) {
        r.makeParagraph = blockTypeItem(type, {
            title: 'Change to paragraph',
            render: renderClarityIcon({ shape: 'text', label: 'Plain' }),
        });
    }
    if ((type = schema.nodes.code_block)) {
        r.makeCodeBlock = blockTypeItem(type, {
            title: 'Change to code block',
            render: renderClarityIcon({ shape: 'code', label: 'Code' }),
        });
    }
    if ((type = schema.nodes.heading)) {
        for (let i = 1; i <= 10; i++) {
            r['makeHead' + i] = blockTypeItem(type, {
                title: 'Change to heading ' + i,
                label: 'Level ' + i,
                attrs: { level: i },
            });
        }
    }
    if ((type = schema.nodes.horizontal_rule)) {
        const hr = type;
        r.insertHorizontalRule = new MenuItem({
            title: 'Insert horizontal rule',
            render: view => {
                const icon = document.createElement('div');
                icon.classList.add('custom-icon', 'hr-icon');
                const labelEl = document.createElement('span');
                labelEl.textContent = 'Horizontal rule';
                return wrapInMenuItemWithIcon(icon, labelEl);
            },
            enable(state) {
                return canInsert(state, hr);
            },
            run(state, dispatch) {
                dispatch(state.tr.replaceSelectionWith(hr.create()));
            },
        });
    }
    const cut = (arr) => arr.filter(x => x);
    r.insertMenu = new Dropdown(cut([
        r.insertImage,
        r.insertHorizontalRule,
        new MenuItem({
            run: (state, dispatch) => {
                addTable(state, dispatch, {
                    rowsCount: 2,
                    colsCount: 2,
                    withHeaderRow: true,
                    cellContent: '',
                });
            },
            render: renderClarityIcon({ shape: 'table', label: 'Table' }),
        }),
    ]), { label: 'Insert' });
    r.typeMenu = new Dropdown(cut([
        r.makeParagraph,
        r.makeCodeBlock,
        r.makeHead1 &&
            new SubMenuWithIcon(cut([r.makeHead1, r.makeHead2, r.makeHead3, r.makeHead4, r.makeHead5, r.makeHead6]), {
                label: 'Heading',
                icon: () => {
                    const icon = document.createElement('div');
                    icon.textContent = 'H';
                    icon.classList.add('custom-icon', 'h-icon');
                    return icon;
                },
            }),
    ]), { label: 'Type...' });
    const inlineMenu = cut([r.toggleStrong, r.toggleEm, r.toggleLink]);
    r.inlineMenu = [inlineMenu];
    r.blockMenu = [
        cut([
            r.wrapBulletList,
            r.wrapOrderedList,
            r.wrapBlockQuote,
            joinUpItem,
            liftItem,
            selectParentNodeItem,
        ]),
    ];
    const undoRedo = [
        new MenuItem({
            title: 'Undo last change',
            run: undo,
            enable(state) {
                return undo(state);
            },
            render: renderClarityIcon({ shape: 'undo', size: IconSize.Large }),
        }),
        new MenuItem({
            title: 'Redo last undone change',
            run: redo,
            enable(state) {
                return redo(state);
            },
            render: renderClarityIcon({ shape: 'redo', size: IconSize.Large }),
        }),
    ];
    r.fullMenu = [inlineMenu].concat([[r.insertMenu, r.typeMenu]], [undoRedo], r.blockMenu);
    return r;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVudS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL3NyYy9saWIvY29yZS9zcmMvc2hhcmVkL2NvbXBvbmVudHMvcmljaC10ZXh0LWVkaXRvci9wcm9zZW1pcnJvci9tZW51L21lbnUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ2xELE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDakQsT0FBTyxFQUNILGFBQWEsRUFDYixRQUFRLEVBQ1IsS0FBSyxFQUNMLFVBQVUsRUFDVixRQUFRLEVBQ1IsUUFBUSxFQUNSLG9CQUFvQixFQUNwQixRQUFRLEdBQ1gsTUFBTSxrQkFBa0IsQ0FBQztBQUUxQixPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0seUJBQXlCLENBQUM7QUFJckQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzFELE9BQU8sRUFBRSxRQUFRLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUVwRCxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sU0FBUyxDQUFDO0FBQ25DLE9BQU8sRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLFVBQVUsRUFBRSxpQkFBaUIsRUFBRSxzQkFBc0IsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzRyxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFNdkQsU0FBUyxPQUFPLENBQUMsR0FBNkIsRUFBRSxPQUF1QjtJQUNuRSxNQUFNLGFBQWEsR0FBRztRQUNsQixLQUFLLEVBQUUsT0FBTyxDQUFDLEtBQUs7UUFDcEIsR0FBRyxFQUFFLEdBQUc7UUFDUixNQUFNLEVBQUUsT0FBTyxDQUFDLFNBQVM7WUFDckIsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLEVBQUUsS0FBSyxFQUFFLE9BQU8sQ0FBQyxTQUFTLEVBQUUsSUFB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QixDQUFDO1lBQ0QsTUFBTSxFQUFFLGlCQUFpQixDQUFDLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO1NBQ3JFLENBQUM7UUFDRixJQUFJLFFBQVEsQ0FBQztZQUNULEtBQUssRUFBRSx5QkFBeUI7WUFDaEMsR0FBRyxFQUFFLElBQUk7WUFDVCxNQUFNLENBQUMsS0FBSztnQkFDUixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN2QixDQUFDO1lBQ0QsTUFBTSxFQUFFLGlCQUFpQixDQUFDLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsUUFBUSxDQUFDLEtBQUssRUFBRSxDQUFDO1NBQ3JFLENBQUM7S0FDTCxDQUFDO0lBQ0YsQ0FBQyxDQUFDLFFBQVEsR0FBRyxDQUFDLFVBQVUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUV4RixPQUFPLENBQUMsQ0FBQztBQUNiLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyB0b2dnbGVNYXJrIH0gZnJvbSAncHJvc2VtaXJyb3ItY29tbWFuZHMnO1xyXG5pbXBvcnQgeyByZWRvLCB1bmRvIH0gZnJvbSAncHJvc2VtaXJyb3ItaGlzdG9yeSc7XHJcbmltcG9ydCB7XHJcbiAgICBibG9ja1R5cGVJdGVtLFxyXG4gICAgRHJvcGRvd24sXHJcbiAgICBpY29ucyxcclxuICAgIGpvaW5VcEl0ZW0sXHJcbiAgICBsaWZ0SXRlbSxcclxuICAgIE1lbnVJdGVtLFxyXG4gICAgc2VsZWN0UGFyZW50Tm9kZUl0ZW0sXHJcbiAgICB3cmFwSXRlbSxcclxufSBmcm9tICdwcm9zZW1pcnJvci1tZW51JztcclxuaW1wb3J0IHsgTWFya1R5cGUsIE5vZGVUeXBlLCBTY2hlbWEgfSBmcm9tICdwcm9zZW1pcnJvci1tb2RlbCc7XHJcbmltcG9ydCB7IHdyYXBJbkxpc3QgfSBmcm9tICdwcm9zZW1pcnJvci1zY2hlbWEtbGlzdCc7XHJcbmltcG9ydCB7IEVkaXRvclN0YXRlIH0gZnJvbSAncHJvc2VtaXJyb3Itc3RhdGUnO1xyXG5cclxuaW1wb3J0IHsgTW9kYWxTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vLi4vLi4vcHJvdmlkZXJzL21vZGFsL21vZGFsLnNlcnZpY2UnO1xyXG5pbXBvcnQgeyBpbnNlcnRJbWFnZUl0ZW0gfSBmcm9tICcuLi9wbHVnaW5zL2ltYWdlLXBsdWdpbic7XHJcbmltcG9ydCB7IGFkZFRhYmxlIH0gZnJvbSAnLi4vcGx1Z2lucy90YWJsZXMtcGx1Z2luJztcclxuXHJcbmltcG9ydCB7IGxpbmtJdGVtIH0gZnJvbSAnLi9saW5rcyc7XHJcbmltcG9ydCB7IGNhbkluc2VydCwgSWNvblNpemUsIG1hcmtBY3RpdmUsIHJlbmRlckNsYXJpdHlJY29uLCB3cmFwSW5NZW51SXRlbVdpdGhJY29uIH0gZnJvbSAnLi9tZW51LWNvbW1vbic7XHJcbmltcG9ydCB7IFN1Yk1lbnVXaXRoSWNvbiB9IGZyb20gJy4vc3ViLW1lbnUtd2l0aC1pY29uJztcclxuXHJcbi8vIEhlbHBlcnMgdG8gY3JlYXRlIHNwZWNpZmljIHR5cGVzIG9mIGl0ZW1zXHJcblxyXG50eXBlIENtZEl0ZW1PcHRpb25zID0gUmVjb3JkPHN0cmluZywgYW55PiAmIHsgaWNvblNoYXBlPzogc3RyaW5nIH07XHJcblxyXG5mdW5jdGlvbiBjbWRJdGVtKGNtZDogKC4uLmFyZ3M6IGFueVtdKSA9PiB2b2lkLCBvcHRpb25zOiBDbWRJdGVtT3B0aW9ucykge1xyXG4gICAgY29uc3QgcGFzc2VkT3B0aW9ucyA9IHtcclxuICAgICAgICBsYWJlbDogb3B0aW9ucy50aXRsZSxcclxuICAgICAgICBydW46IGNtZCxcclxuICAgICAgICByZW5kZXI6IG9wdGlvbnMuaWNvblNoYXBlXHJcbiAgICAgICAgICAgID8gcmVuZGVyQ2xhcml0eUljb24oeyBzaGFwZTogb3B0aW9ucy5pY29uU2hhcGUsIHNpemU6IEljb25TaXplLkxhcmdlIH0pXHJcbiAgICAgICAgICAgIDogdW5kZWZpbmVkLFxyXG4gICAgfTtcclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBndWFyZC1mb3ItaW5cclxuICAgIGZvciAoY29uc3QgcHJvcCBpbiBvcHRpb25zKSB7XHJcbiAgICAgICAgcGFzc2VkT3B0aW9uc1twcm9wXSA9IG9wdGlvbnNbcHJvcF07XHJcbiAgICB9XHJcbiAgICBpZiAoKCFvcHRpb25zLmVuYWJsZSB8fCBvcHRpb25zLmVuYWJsZSA9PT0gdHJ1ZSkgJiYgIW9wdGlvbnMuc2VsZWN0KSB7XHJcbiAgICAgICAgcGFzc2VkT3B0aW9uc1tvcHRpb25zLmVuYWJsZSA/ICdlbmFibGUnIDogJ3NlbGVjdCddID0gc3RhdGUgPT4gY21kKHN0YXRlKTtcclxuICAgIH1cclxuXHJcbiAgICByZXR1cm4gbmV3IE1lbnVJdGVtKHBhc3NlZE9wdGlvbnMgYXMgYW55KTtcclxufVxyXG5cclxuZnVuY3Rpb24gbWFya0l0ZW0obWFya1R5cGUsIG9wdGlvbnM6IENtZEl0ZW1PcHRpb25zKSB7XHJcbiAgICBjb25zdCBwYXNzZWRPcHRpb25zID0ge1xyXG4gICAgICAgIGFjdGl2ZShzdGF0ZSkge1xyXG4gICAgICAgICAgICByZXR1cm4gbWFya0FjdGl2ZShzdGF0ZSwgbWFya1R5cGUpO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgZW5hYmxlOiB0cnVlLFxyXG4gICAgfTtcclxuICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBndWFyZC1mb3ItaW5cclxuICAgIGZvciAoY29uc3QgcHJvcCBpbiBvcHRpb25zKSB7XHJcbiAgICAgICAgcGFzc2VkT3B0aW9uc1twcm9wXSA9IG9wdGlvbnNbcHJvcF07XHJcbiAgICB9XHJcbiAgICByZXR1cm4gY21kSXRlbSh0b2dnbGVNYXJrKG1hcmtUeXBlKSwgcGFzc2VkT3B0aW9ucyk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHdyYXBMaXN0SXRlbShub2RlVHlwZSwgb3B0aW9uczogQ21kSXRlbU9wdGlvbnMpIHtcclxuICAgIHJldHVybiBjbWRJdGVtKHdyYXBJbkxpc3Qobm9kZVR5cGUsIG9wdGlvbnMuYXR0cnMpLCBvcHRpb25zKTtcclxufVxyXG5cclxuLy8gOjogKFNjaGVtYSkg4oaSIE9iamVjdFxyXG4vLyBHaXZlbiBhIHNjaGVtYSwgbG9vayBmb3IgZGVmYXVsdCBtYXJrIGFuZCBub2RlIHR5cGVzIGluIGl0IGFuZFxyXG4vLyByZXR1cm4gYW4gb2JqZWN0IHdpdGggcmVsZXZhbnQgbWVudSBpdGVtcyByZWxhdGluZyB0byB0aG9zZSBtYXJrczpcclxuLy9cclxuLy8gKipgdG9nZ2xlU3Ryb25nYCoqYDogTWVudUl0ZW1gXHJcbi8vICAgOiBBIG1lbnUgaXRlbSB0byB0b2dnbGUgdGhlIFtzdHJvbmcgbWFya10oI3NjaGVtYS1iYXNpYy5TdHJvbmdNYXJrKS5cclxuLy9cclxuLy8gKipgdG9nZ2xlRW1gKipgOiBNZW51SXRlbWBcclxuLy8gICA6IEEgbWVudSBpdGVtIHRvIHRvZ2dsZSB0aGUgW2VtcGhhc2lzIG1hcmtdKCNzY2hlbWEtYmFzaWMuRW1NYXJrKS5cclxuLy9cclxuLy8gKipgdG9nZ2xlQ29kZWAqKmA6IE1lbnVJdGVtYFxyXG4vLyAgIDogQSBtZW51IGl0ZW0gdG8gdG9nZ2xlIHRoZSBbY29kZSBmb250IG1hcmtdKCNzY2hlbWEtYmFzaWMuQ29kZU1hcmspLlxyXG4vL1xyXG4vLyAqKmB0b2dnbGVMaW5rYCoqYDogTWVudUl0ZW1gXHJcbi8vICAgOiBBIG1lbnUgaXRlbSB0byB0b2dnbGUgdGhlIFtsaW5rIG1hcmtdKCNzY2hlbWEtYmFzaWMuTGlua01hcmspLlxyXG4vL1xyXG4vLyAqKmBpbnNlcnRJbWFnZWAqKmA6IE1lbnVJdGVtYFxyXG4vLyAgIDogQSBtZW51IGl0ZW0gdG8gaW5zZXJ0IGFuIFtpbWFnZV0oI3NjaGVtYS1iYXNpYy5JbWFnZSkuXHJcbi8vXHJcbi8vICoqYHdyYXBCdWxsZXRMaXN0YCoqYDogTWVudUl0ZW1gXHJcbi8vICAgOiBBIG1lbnUgaXRlbSB0byB3cmFwIHRoZSBzZWxlY3Rpb24gaW4gYSBbYnVsbGV0IGxpc3RdKCNzY2hlbWEtbGlzdC5CdWxsZXRMaXN0KS5cclxuLy9cclxuLy8gKipgd3JhcE9yZGVyZWRMaXN0YCoqYDogTWVudUl0ZW1gXHJcbi8vICAgOiBBIG1lbnUgaXRlbSB0byB3cmFwIHRoZSBzZWxlY3Rpb24gaW4gYW4gW29yZGVyZWQgbGlzdF0oI3NjaGVtYS1saXN0Lk9yZGVyZWRMaXN0KS5cclxuLy9cclxuLy8gKipgd3JhcEJsb2NrUXVvdGVgKipgOiBNZW51SXRlbWBcclxuLy8gICA6IEEgbWVudSBpdGVtIHRvIHdyYXAgdGhlIHNlbGVjdGlvbiBpbiBhIFtibG9jayBxdW90ZV0oI3NjaGVtYS1iYXNpYy5CbG9ja1F1b3RlKS5cclxuLy9cclxuLy8gKipgbWFrZVBhcmFncmFwaGAqKmA6IE1lbnVJdGVtYFxyXG4vLyAgIDogQSBtZW51IGl0ZW0gdG8gc2V0IHRoZSBjdXJyZW50IHRleHRibG9jayB0byBiZSBhIG5vcm1hbFxyXG4vLyAgICAgW3BhcmFncmFwaF0oI3NjaGVtYS1iYXNpYy5QYXJhZ3JhcGgpLlxyXG4vL1xyXG4vLyAqKmBtYWtlQ29kZUJsb2NrYCoqYDogTWVudUl0ZW1gXHJcbi8vICAgOiBBIG1lbnUgaXRlbSB0byBzZXQgdGhlIGN1cnJlbnQgdGV4dGJsb2NrIHRvIGJlIGFcclxuLy8gICAgIFtjb2RlIGJsb2NrXSgjc2NoZW1hLWJhc2ljLkNvZGVCbG9jaykuXHJcbi8vXHJcbi8vICoqYG1ha2VIZWFkW05dYCoqYDogTWVudUl0ZW1gXHJcbi8vICAgOiBXaGVyZSBfTl8gaXMgMSB0byA2LiBNZW51IGl0ZW1zIHRvIHNldCB0aGUgY3VycmVudCB0ZXh0YmxvY2sgdG9cclxuLy8gICAgIGJlIGEgW2hlYWRpbmddKCNzY2hlbWEtYmFzaWMuSGVhZGluZykgb2YgbGV2ZWwgX05fLlxyXG4vL1xyXG4vLyAqKmBpbnNlcnRIb3Jpem9udGFsUnVsZWAqKmA6IE1lbnVJdGVtYFxyXG4vLyAgIDogQSBtZW51IGl0ZW0gdG8gaW5zZXJ0IGEgaG9yaXpvbnRhbCBydWxlLlxyXG4vL1xyXG4vLyBUaGUgcmV0dXJuIHZhbHVlIGFsc28gY29udGFpbnMgc29tZSBwcmVmYWJyaWNhdGVkIG1lbnUgZWxlbWVudHMgYW5kXHJcbi8vIG1lbnVzLCB0aGF0IHlvdSBjYW4gdXNlIGluc3RlYWQgb2YgY29tcG9zaW5nIHlvdXIgb3duIG1lbnUgZnJvbVxyXG4vLyBzY3JhdGNoOlxyXG4vL1xyXG4vLyAqKmBpbnNlcnRNZW51YCoqYDogRHJvcGRvd25gXHJcbi8vICAgOiBBIGRyb3Bkb3duIGNvbnRhaW5pbmcgdGhlIGBpbnNlcnRJbWFnZWAgYW5kXHJcbi8vICAgICBgaW5zZXJ0SG9yaXpvbnRhbFJ1bGVgIGl0ZW1zLlxyXG4vL1xyXG4vLyAqKmB0eXBlTWVudWAqKmA6IERyb3Bkb3duYFxyXG4vLyAgIDogQSBkcm9wZG93biBjb250YWluaW5nIHRoZSBpdGVtcyBmb3IgbWFraW5nIHRoZSBjdXJyZW50XHJcbi8vICAgICB0ZXh0YmxvY2sgYSBwYXJhZ3JhcGgsIGNvZGUgYmxvY2ssIG9yIGhlYWRpbmcuXHJcbi8vXHJcbi8vICoqYGZ1bGxNZW51YCoqYDogW1tNZW51RWxlbWVudF1dYFxyXG4vLyAgIDogQW4gYXJyYXkgb2YgYXJyYXlzIG9mIG1lbnUgZWxlbWVudHMgZm9yIHVzZSBhcyB0aGUgZnVsbCBtZW51XHJcbi8vICAgICBmb3IsIGZvciBleGFtcGxlIHRoZSBbbWVudSBiYXJdKGh0dHBzOi8vZ2l0aHViLmNvbS9wcm9zZW1pcnJvci9wcm9zZW1pcnJvci1tZW51I3VzZXItY29udGVudC1tZW51YmFyKS5cclxuZXhwb3J0IGZ1bmN0aW9uIGJ1aWxkTWVudUl0ZW1zKHNjaGVtYTogU2NoZW1hLCBtb2RhbFNlcnZpY2U6IE1vZGFsU2VydmljZSkge1xyXG4gICAgY29uc3QgcjogUmVjb3JkPHN0cmluZywgYW55PiA9IHt9O1xyXG4gICAgbGV0IHR5cGU6IE1hcmtUeXBlIHwgTm9kZVR5cGU7XHJcbiAgICAvKiBlc2xpbnQtZGlzYWJsZSBuby1jb25kLWFzc2lnbiAqL1xyXG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm1hcmtzLnN0cm9uZykpIHtcclxuICAgICAgICByLnRvZ2dsZVN0cm9uZyA9IG1hcmtJdGVtKHR5cGUsIHtcclxuICAgICAgICAgICAgdGl0bGU6ICdUb2dnbGUgc3Ryb25nIHN0eWxlJyxcclxuICAgICAgICAgICAgaWNvblNoYXBlOiAnYm9sZCcsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBpZiAoKHR5cGUgPSBzY2hlbWEubWFya3MuZW0pKSB7XHJcbiAgICAgICAgci50b2dnbGVFbSA9IG1hcmtJdGVtKHR5cGUsIHtcclxuICAgICAgICAgICAgdGl0bGU6ICdUb2dnbGUgZW1waGFzaXMnLFxyXG4gICAgICAgICAgICBpY29uU2hhcGU6ICdpdGFsaWMnLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm1hcmtzLmNvZGUpKSB7XHJcbiAgICAgICAgci50b2dnbGVDb2RlID0gbWFya0l0ZW0odHlwZSwgeyB0aXRsZTogJ1RvZ2dsZSBjb2RlIGZvbnQnLCBpY29uOiBpY29ucy5jb2RlIH0pO1xyXG4gICAgfVxyXG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm1hcmtzLmxpbmspKSB7XHJcbiAgICAgICAgci50b2dnbGVMaW5rID0gbGlua0l0ZW0odHlwZSwgbW9kYWxTZXJ2aWNlKTtcclxuICAgIH1cclxuXHJcbiAgICBpZiAoKHR5cGUgPSBzY2hlbWEubm9kZXMuaW1hZ2UpKSB7XHJcbiAgICAgICAgci5pbnNlcnRJbWFnZSA9IGluc2VydEltYWdlSXRlbSh0eXBlLCBtb2RhbFNlcnZpY2UpO1xyXG4gICAgfVxyXG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm5vZGVzLmJ1bGxldF9saXN0KSkge1xyXG4gICAgICAgIHIud3JhcEJ1bGxldExpc3QgPSB3cmFwTGlzdEl0ZW0odHlwZSwge1xyXG4gICAgICAgICAgICB0aXRsZTogJ1dyYXAgaW4gYnVsbGV0IGxpc3QnLFxyXG4gICAgICAgICAgICBpY29uU2hhcGU6ICdidWxsZXQtbGlzdCcsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBpZiAoKHR5cGUgPSBzY2hlbWEubm9kZXMub3JkZXJlZF9saXN0KSkge1xyXG4gICAgICAgIHIud3JhcE9yZGVyZWRMaXN0ID0gd3JhcExpc3RJdGVtKHR5cGUsIHtcclxuICAgICAgICAgICAgdGl0bGU6ICdXcmFwIGluIG9yZGVyZWQgbGlzdCcsXHJcbiAgICAgICAgICAgIGljb25TaGFwZTogJ251bWJlci1saXN0JyxcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuICAgIGlmICgodHlwZSA9IHNjaGVtYS5ub2Rlcy5ibG9ja3F1b3RlKSkge1xyXG4gICAgICAgIHIud3JhcEJsb2NrUXVvdGUgPSB3cmFwSXRlbSh0eXBlLCB7XHJcbiAgICAgICAgICAgIHRpdGxlOiAnV3JhcCBpbiBibG9jayBxdW90ZScsXHJcbiAgICAgICAgICAgIHJlbmRlcjogcmVuZGVyQ2xhcml0eUljb24oeyBzaGFwZTogJ2Jsb2NrLXF1b3RlJywgc2l6ZTogSWNvblNpemUuTGFyZ2UgfSksXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBpZiAoKHR5cGUgPSBzY2hlbWEubm9kZXMucGFyYWdyYXBoKSkge1xyXG4gICAgICAgIHIubWFrZVBhcmFncmFwaCA9IGJsb2NrVHlwZUl0ZW0odHlwZSwge1xyXG4gICAgICAgICAgICB0aXRsZTogJ0NoYW5nZSB0byBwYXJhZ3JhcGgnLFxyXG4gICAgICAgICAgICByZW5kZXI6IHJlbmRlckNsYXJpdHlJY29uKHsgc2hhcGU6ICd0ZXh0JywgbGFiZWw6ICdQbGFpbicgfSksXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcbiAgICBpZiAoKHR5cGUgPSBzY2hlbWEubm9kZXMuY29kZV9ibG9jaykpIHtcclxuICAgICAgICByLm1ha2VDb2RlQmxvY2sgPSBibG9ja1R5cGVJdGVtKHR5cGUsIHtcclxuICAgICAgICAgICAgdGl0bGU6ICdDaGFuZ2UgdG8gY29kZSBibG9jaycsXHJcbiAgICAgICAgICAgIHJlbmRlcjogcmVuZGVyQ2xhcml0eUljb24oeyBzaGFwZTogJ2NvZGUnLCBsYWJlbDogJ0NvZGUnIH0pLFxyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG4gICAgaWYgKCh0eXBlID0gc2NoZW1hLm5vZGVzLmhlYWRpbmcpKSB7XHJcbiAgICAgICAgZm9yIChsZXQgaSA9IDE7IGkgPD0gMTA7IGkrKykge1xyXG4gICAgICAgICAgICByWydtYWtlSGVhZCcgKyBpXSA9IGJsb2NrVHlwZUl0ZW0odHlwZSwge1xyXG4gICAgICAgICAgICAgICAgdGl0bGU6ICdDaGFuZ2UgdG8gaGVhZGluZyAnICsgaSxcclxuICAgICAgICAgICAgICAgIGxhYmVsOiAnTGV2ZWwgJyArIGksXHJcbiAgICAgICAgICAgICAgICBhdHRyczogeyBsZXZlbDogaSB9LFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcbiAgICBpZiAoKHR5cGUgPSBzY2hlbWEubm9kZXMuaG9yaXpvbnRhbF9ydWxlKSkge1xyXG4gICAgICAgIGNvbnN0IGhyID0gdHlwZTtcclxuICAgICAgICByLmluc2VydEhvcml6b250YWxSdWxlID0gbmV3IE1lbnVJdGVtKHtcclxuICAgICAgICAgICAgdGl0bGU6ICdJbnNlcnQgaG9yaXpvbnRhbCBydWxlJyxcclxuICAgICAgICAgICAgcmVuZGVyOiB2aWV3ID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGljb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgICAgICAgICAgICAgIGljb24uY2xhc3NMaXN0LmFkZCgnY3VzdG9tLWljb24nLCAnaHItaWNvbicpO1xyXG4gICAgICAgICAgICAgICAgY29uc3QgbGFiZWxFbCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTtcclxuICAgICAgICAgICAgICAgIGxhYmVsRWwudGV4dENvbnRlbnQgPSAnSG9yaXpvbnRhbCBydWxlJztcclxuICAgICAgICAgICAgICAgIHJldHVybiB3cmFwSW5NZW51SXRlbVdpdGhJY29uKGljb24sIGxhYmVsRWwpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICBlbmFibGUoc3RhdGUpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBjYW5JbnNlcnQoc3RhdGUsIGhyKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgcnVuKHN0YXRlOiBFZGl0b3JTdGF0ZSwgZGlzcGF0Y2gpIHtcclxuICAgICAgICAgICAgICAgIGRpc3BhdGNoKHN0YXRlLnRyLnJlcGxhY2VTZWxlY3Rpb25XaXRoKGhyLmNyZWF0ZSgpKSk7XHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgY29uc3QgY3V0ID0gPFQ+KGFycjogVFtdKTogVFtdID0+IGFyci5maWx0ZXIoeCA9PiB4KTtcclxuICAgIHIuaW5zZXJ0TWVudSA9IG5ldyBEcm9wZG93bihcclxuICAgICAgICBjdXQoW1xyXG4gICAgICAgICAgICByLmluc2VydEltYWdlLFxyXG4gICAgICAgICAgICByLmluc2VydEhvcml6b250YWxSdWxlLFxyXG4gICAgICAgICAgICBuZXcgTWVudUl0ZW0oe1xyXG4gICAgICAgICAgICAgICAgcnVuOiAoc3RhdGUsIGRpc3BhdGNoKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgYWRkVGFibGUoc3RhdGUsIGRpc3BhdGNoLCB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJvd3NDb3VudDogMixcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29sc0NvdW50OiAyLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB3aXRoSGVhZGVyUm93OiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjZWxsQ29udGVudDogJycsXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgcmVuZGVyOiByZW5kZXJDbGFyaXR5SWNvbih7IHNoYXBlOiAndGFibGUnLCBsYWJlbDogJ1RhYmxlJyB9KSxcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgXSksXHJcbiAgICAgICAgeyBsYWJlbDogJ0luc2VydCcgfSxcclxuICAgICk7XHJcbiAgICByLnR5cGVNZW51ID0gbmV3IERyb3Bkb3duKFxyXG4gICAgICAgIGN1dChbXHJcbiAgICAgICAgICAgIHIubWFrZVBhcmFncmFwaCxcclxuICAgICAgICAgICAgci5tYWtlQ29kZUJsb2NrLFxyXG4gICAgICAgICAgICByLm1ha2VIZWFkMSAmJlxyXG4gICAgICAgICAgICAgICAgbmV3IFN1Yk1lbnVXaXRoSWNvbihcclxuICAgICAgICAgICAgICAgICAgICBjdXQoW3IubWFrZUhlYWQxLCByLm1ha2VIZWFkMiwgci5tYWtlSGVhZDMsIHIubWFrZUhlYWQ0LCByLm1ha2VIZWFkNSwgci5tYWtlSGVhZDZdKSxcclxuICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiAnSGVhZGluZycsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGljb246ICgpID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGljb24gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGljb24udGV4dENvbnRlbnQgPSAnSCc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpY29uLmNsYXNzTGlzdC5hZGQoJ2N1c3RvbS1pY29uJywgJ2gtaWNvbicpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGljb247XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICksXHJcbiAgICAgICAgXSksXHJcbiAgICAgICAgeyBsYWJlbDogJ1R5cGUuLi4nIH0sXHJcbiAgICApO1xyXG5cclxuICAgIGNvbnN0IGlubGluZU1lbnUgPSBjdXQoW3IudG9nZ2xlU3Ryb25nLCByLnRvZ2dsZUVtLCByLnRvZ2dsZUxpbmtdKTtcclxuICAgIHIuaW5saW5lTWVudSA9IFtpbmxpbmVNZW51XTtcclxuICAgIHIuYmxvY2tNZW51ID0gW1xyXG4gICAgICAgIGN1dChbXHJcbiAgICAgICAgICAgIHIud3JhcEJ1bGxldExpc3QsXHJcbiAgICAgICAgICAgIHIud3JhcE9yZGVyZWRMaXN0LFxyXG4gICAgICAgICAgICByLndyYXBCbG9ja1F1b3RlLFxyXG4gICAgICAgICAgICBqb2luVXBJdGVtLFxyXG4gICAgICAgICAgICBsaWZ0SXRlbSxcclxuICAgICAgICAgICAgc2VsZWN0UGFyZW50Tm9kZUl0ZW0sXHJcbiAgICAgICAgXSksXHJcbiAgICBdO1xyXG4gICAgY29uc3QgdW5kb1JlZG8gPSBbXHJcbiAgICAgICAgbmV3IE1lbnVJdGVtKHtcclxuICAgICAgICAgICAgdGl0bGU6ICdVbmRvIGxhc3QgY2hhbmdlJyxcclxuICAgICAgICAgICAgcnVuOiB1bmRvLFxyXG4gICAgICAgICAgICBlbmFibGUoc3RhdGUpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiB1bmRvKHN0YXRlKTtcclxuICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgcmVuZGVyOiByZW5kZXJDbGFyaXR5SWNvbih7IHNoYXBlOiAndW5kbycsIHNpemU6IEljb25TaXplLkxhcmdlIH0pLFxyXG4gICAgICAgIH0pLFxyXG4gICAgICAgIG5ldyBNZW51SXRlbSh7XHJcbiAgICAgICAgICAgIHRpdGxlOiAnUmVkbyBsYXN0IHVuZG9uZSBjaGFuZ2UnLFxyXG4gICAgICAgICAgICBydW46IHJlZG8sXHJcbiAgICAgICAgICAgIGVuYWJsZShzdGF0ZSkge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHJlZG8oc3RhdGUpO1xyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICByZW5kZXI6IHJlbmRlckNsYXJpdHlJY29uKHsgc2hhcGU6ICdyZWRvJywgc2l6ZTogSWNvblNpemUuTGFyZ2UgfSksXHJcbiAgICAgICAgfSksXHJcbiAgICBdO1xyXG4gICAgci5mdWxsTWVudSA9IFtpbmxpbmVNZW51XS5jb25jYXQoW1tyLmluc2VydE1lbnUsIHIudHlwZU1lbnVdXSwgW3VuZG9SZWRvXSwgci5ibG9ja01lbnUpO1xyXG5cclxuICAgIHJldHVybiByO1xyXG59XHJcbiJdfQ==