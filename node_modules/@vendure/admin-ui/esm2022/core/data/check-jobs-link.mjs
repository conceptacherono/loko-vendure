import { ApolloLink } from '@apollo/client/core';
import { JobQueueService } from '../providers/job-queue/job-queue.service';
/**
 * This link checks each operation and if it is a mutation, it tells the JobQueueService
 * to poll for active jobs. This is because certain mutations trigger background jobs
 * which should be made known in the UI.
 */
export class CheckJobsLink extends ApolloLink {
    get jobQueueService() {
        if (!this._jobQueueService) {
            this._jobQueueService = this.injector.get(JobQueueService);
        }
        return this._jobQueueService;
    }
    /**
     * We inject the Injector rather than the JobQueueService directly in order
     * to avoid a circular dependency error.
     */
    constructor(injector) {
        super((operation, forward) => {
            if (this.isMutation(operation)) {
                this.jobQueueService.checkForJobs();
            }
            return forward ? forward(operation) : null;
        });
        this.injector = injector;
    }
    isMutation(operation) {
        return !!operation.query.definitions.find(d => d.kind === 'OperationDefinition' && d.operation === 'mutation');
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hlY2stam9icy1saW5rLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9jb3JlL3NyYy9kYXRhL2NoZWNrLWpvYnMtbGluay50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFDQSxPQUFPLEVBQUUsVUFBVSxFQUFhLE1BQU0scUJBQXFCLENBQUM7QUFFNUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDBDQUEwQyxDQUFDO0FBRTNFOzs7O0dBSUc7QUFDSCxNQUFNLE9BQU8sYUFBYyxTQUFRLFVBQVU7SUFFekMsSUFBSSxlQUFlO1FBQ2YsSUFBSSxDQUFDLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1lBQ3pCLElBQUksQ0FBQyxnQkFBZ0IsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUMvRCxDQUFDO1FBQ0QsT0FBTyxJQUFJLENBQUMsZ0JBQWdCLENBQUM7SUFDakMsQ0FBQztJQUVEOzs7T0FHRztJQUNILFlBQW9CLFFBQWtCO1FBQ2xDLEtBQUssQ0FBQyxDQUFDLFNBQVMsRUFBRSxPQUFPLEVBQUUsRUFBRTtZQUN6QixJQUFJLElBQUksQ0FBQyxVQUFVLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQztnQkFDN0IsSUFBSSxDQUFDLGVBQWUsQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUN4QyxDQUFDO1lBQ0QsT0FBTyxPQUFPLENBQUMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDO1FBQy9DLENBQUMsQ0FBQyxDQUFDO1FBTmEsYUFBUSxHQUFSLFFBQVEsQ0FBVTtJQU90QyxDQUFDO0lBRU8sVUFBVSxDQUFDLFNBQW9CO1FBQ25DLE9BQU8sQ0FBQyxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLElBQUksQ0FDckMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxLQUFLLHFCQUFxQixJQUFJLENBQUMsQ0FBQyxTQUFTLEtBQUssVUFBVSxDQUN0RSxDQUFDO0lBQ04sQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQXBvbGxvTGluaywgT3BlcmF0aW9uIH0gZnJvbSAnQGFwb2xsby9jbGllbnQvY29yZSc7XHJcblxyXG5pbXBvcnQgeyBKb2JRdWV1ZVNlcnZpY2UgfSBmcm9tICcuLi9wcm92aWRlcnMvam9iLXF1ZXVlL2pvYi1xdWV1ZS5zZXJ2aWNlJztcclxuXHJcbi8qKlxyXG4gKiBUaGlzIGxpbmsgY2hlY2tzIGVhY2ggb3BlcmF0aW9uIGFuZCBpZiBpdCBpcyBhIG11dGF0aW9uLCBpdCB0ZWxscyB0aGUgSm9iUXVldWVTZXJ2aWNlXHJcbiAqIHRvIHBvbGwgZm9yIGFjdGl2ZSBqb2JzLiBUaGlzIGlzIGJlY2F1c2UgY2VydGFpbiBtdXRhdGlvbnMgdHJpZ2dlciBiYWNrZ3JvdW5kIGpvYnNcclxuICogd2hpY2ggc2hvdWxkIGJlIG1hZGUga25vd24gaW4gdGhlIFVJLlxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIENoZWNrSm9ic0xpbmsgZXh0ZW5kcyBBcG9sbG9MaW5rIHtcclxuICAgIHByaXZhdGUgX2pvYlF1ZXVlU2VydmljZTogSm9iUXVldWVTZXJ2aWNlO1xyXG4gICAgZ2V0IGpvYlF1ZXVlU2VydmljZSgpOiBKb2JRdWV1ZVNlcnZpY2Uge1xyXG4gICAgICAgIGlmICghdGhpcy5fam9iUXVldWVTZXJ2aWNlKSB7XHJcbiAgICAgICAgICAgIHRoaXMuX2pvYlF1ZXVlU2VydmljZSA9IHRoaXMuaW5qZWN0b3IuZ2V0KEpvYlF1ZXVlU2VydmljZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0aGlzLl9qb2JRdWV1ZVNlcnZpY2U7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBXZSBpbmplY3QgdGhlIEluamVjdG9yIHJhdGhlciB0aGFuIHRoZSBKb2JRdWV1ZVNlcnZpY2UgZGlyZWN0bHkgaW4gb3JkZXJcclxuICAgICAqIHRvIGF2b2lkIGEgY2lyY3VsYXIgZGVwZW5kZW5jeSBlcnJvci5cclxuICAgICAqL1xyXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBpbmplY3RvcjogSW5qZWN0b3IpIHtcclxuICAgICAgICBzdXBlcigob3BlcmF0aW9uLCBmb3J3YXJkKSA9PiB7XHJcbiAgICAgICAgICAgIGlmICh0aGlzLmlzTXV0YXRpb24ob3BlcmF0aW9uKSkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5qb2JRdWV1ZVNlcnZpY2UuY2hlY2tGb3JKb2JzKCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgcmV0dXJuIGZvcndhcmQgPyBmb3J3YXJkKG9wZXJhdGlvbikgOiBudWxsO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgaXNNdXRhdGlvbihvcGVyYXRpb246IE9wZXJhdGlvbik6IGJvb2xlYW4ge1xyXG4gICAgICAgIHJldHVybiAhIW9wZXJhdGlvbi5xdWVyeS5kZWZpbml0aW9ucy5maW5kKFxyXG4gICAgICAgICAgICBkID0+IGQua2luZCA9PT0gJ09wZXJhdGlvbkRlZmluaXRpb24nICYmIGQub3BlcmF0aW9uID09PSAnbXV0YXRpb24nLFxyXG4gICAgICAgICk7XHJcbiAgICB9XHJcbn1cclxuIl19