import { NetworkStatus } from '@apollo/client/core';
import { notNullOrUndefined } from '@vendure/common/lib/shared-utils';
import { merge, Observable, Subject } from 'rxjs';
import { distinctUntilChanged, filter, finalize, map, shareReplay, skip, startWith, take, takeUntil, } from 'rxjs/operators';
import { GET_USER_STATUS } from './definitions/client-definitions';
import { addCustomFields } from './utils/add-custom-fields';
/**
 * @description
 * This class wraps the Apollo Angular QueryRef object and exposes some getters
 * for convenience.
 *
 * @docsCategory services
 * @docsPage DataService
 */
export class QueryResult {
    constructor(queryRef, apollo, customFieldMap) {
        this.queryRef = queryRef;
        this.apollo = apollo;
        this.customFieldMap = customFieldMap;
        /**
         * Causes any subscriptions to the QueryRef to complete, via the use
         * of the `takeUntil` operator.
         */
        this.completed$ = new Subject();
        /**
         * This Subject is used to emit new values from the QueryRef.valueChanges Observable.
         * We use this rather than directly subscribing to the QueryRef.valueChanges Observable
         * so that we are able to change the QueryRef and re-subscribe when necessary.
         */
        this.valueChangeSubject = new Subject();
        /**
         * We keep track of the QueryRefs which have been subscribed to so that we can avoid
         * re-subscribing to the same QueryRef multiple times.
         */
        this.queryRefSubscribed = new WeakMap();
        this.lastQuery = queryRef.options.query;
    }
    /**
     * @description
     * Re-fetch this query whenever the active Channel changes.
     */
    refetchOnChannelChange() {
        const userStatus$ = this.apollo.watchQuery({
            query: GET_USER_STATUS,
        }).valueChanges;
        const activeChannelId$ = userStatus$.pipe(map(data => data.data.userStatus.activeChannelId), filter(notNullOrUndefined), distinctUntilChanged(), skip(1), takeUntil(this.completed$));
        const loggedOut$ = userStatus$.pipe(map(data => data.data.userStatus.isLoggedIn), distinctUntilChanged(), skip(1), filter(isLoggedIn => !isLoggedIn), takeUntil(this.completed$));
        merge(activeChannelId$, this.valueChangeSubject)
            .pipe(takeUntil(loggedOut$), takeUntil(this.completed$))
            .subscribe(val => {
            if (typeof val === 'string') {
                new Promise(resolve => setTimeout(resolve, 50)).then(() => this.queryRef.refetch());
            }
        });
        return this;
    }
    /**
     * @description
     * Re-fetch this query whenever the custom fields change, updating the query to include the
     * specified custom fields.
     *
     * @since 3.0.4
     */
    refetchOnCustomFieldsChange(customFieldsToInclude$) {
        customFieldsToInclude$
            .pipe(filter(customFields => {
            const newQuery = addCustomFields(this.lastQuery, this.customFieldMap, customFields);
            const hasChanged = JSON.stringify(newQuery) !== JSON.stringify(this.lastQuery);
            return hasChanged;
        }), takeUntil(this.completed$))
            .subscribe(customFields => {
            const newQuery = addCustomFields(this.lastQuery, this.customFieldMap, customFields);
            this.lastQuery = newQuery;
            const queryRef = this.apollo.watchQuery({
                query: newQuery,
                variables: this.queryRef.variables,
                fetchPolicy: this.queryRef.options.fetchPolicy,
            });
            this.queryRef = queryRef;
            this.subscribeToQueryRef(queryRef);
        });
        return this;
    }
    /**
     * @description
     * Returns an Observable which emits a single result and then completes.
     */
    get single$() {
        return this.currentQueryRefValueChanges.pipe(filter(result => result.networkStatus === NetworkStatus.ready), take(1), map(result => result.data), finalize(() => {
            this.completed$.next();
            this.completed$.complete();
        }));
    }
    /**
     * @description
     * Returns an Observable which emits until unsubscribed.
     */
    get stream$() {
        return this.currentQueryRefValueChanges.pipe(filter(result => result.networkStatus === NetworkStatus.ready), map(result => result.data), finalize(() => {
            this.completed$.next();
            this.completed$.complete();
        }));
    }
    get ref() {
        return this.queryRef;
    }
    /**
     * @description
     * Returns a single-result Observable after applying the map function.
     */
    mapSingle(mapFn) {
        return this.single$.pipe(map(mapFn));
    }
    /**
     * @description
     * Returns a multiple-result Observable after applying the map function.
     */
    mapStream(mapFn) {
        return this.stream$.pipe(map(mapFn));
    }
    /**
     * @description
     * Signals to the internal Observable subscriptions that they should complete.
     */
    destroy() {
        this.completed$.next();
        this.completed$.complete();
    }
    /**
     * @description
     * Returns an Observable which emits the current value of the QueryRef.valueChanges Observable.
     *
     * We wrap the valueChanges Observable in a new Observable so that we can have a lazy
     * evaluation of the valueChanges Observable. That is, we only fire the HTTP request when
     * the returned Observable is subscribed to.
     */
    get currentQueryRefValueChanges() {
        return new Observable(subscriber => {
            if (!this.queryRefSubscribed.get(this.queryRef)) {
                this.subscribeToQueryRef(this.queryRef);
                this.queryRefSubscribed.set(this.queryRef, true);
            }
            this.valueChangeSubject
                .pipe(startWith(this.queryRef.getCurrentResult()), shareReplay(1))
                .subscribe(subscriber);
            return () => {
                this.queryRefSubscribed.delete(this.queryRef);
            };
        });
    }
    /**
     * @description
     * Subscribes to the valueChanges Observable of the given QueryRef, and stores the subscription
     * so that it can be unsubscribed from when the QueryRef changes.
     */
    subscribeToQueryRef(queryRef) {
        if (this.valueChangesSubscription) {
            this.valueChangesSubscription.unsubscribe();
        }
        this.valueChangesSubscription = queryRef.valueChanges
            .pipe(takeUntil(this.completed$))
            .subscribe(this.valueChangeSubject);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicXVlcnktcmVzdWx0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9jb3JlL3NyYy9kYXRhL3F1ZXJ5LXJlc3VsdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQXFCLGFBQWEsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3ZFLE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBR3RFLE9BQU8sRUFBRSxLQUFLLEVBQUUsVUFBVSxFQUFFLE9BQU8sRUFBZ0IsTUFBTSxNQUFNLENBQUM7QUFDaEUsT0FBTyxFQUNILG9CQUFvQixFQUNwQixNQUFNLEVBQ04sUUFBUSxFQUNSLEdBQUcsRUFDSCxXQUFXLEVBQ1gsSUFBSSxFQUNKLFNBQVMsRUFDVCxJQUFJLEVBQ0osU0FBUyxHQUNaLE1BQU0sZ0JBQWdCLENBQUM7QUFJeEIsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQ25FLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSwyQkFBMkIsQ0FBQztBQUU1RDs7Ozs7OztHQU9HO0FBQ0gsTUFBTSxPQUFPLFdBQVc7SUFDcEIsWUFDWSxRQUF3QixFQUN4QixNQUFjLEVBQ2QsY0FBZ0Q7UUFGaEQsYUFBUSxHQUFSLFFBQVEsQ0FBZ0I7UUFDeEIsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUNkLG1CQUFjLEdBQWQsY0FBYyxDQUFrQztRQUs1RDs7O1dBR0c7UUFDSyxlQUFVLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQU96Qzs7OztXQUlHO1FBQ0ssdUJBQWtCLEdBQUcsSUFBSSxPQUFPLEVBQXdCLENBQUM7UUFDakU7OztXQUdHO1FBQ0ssdUJBQWtCLEdBQUcsSUFBSSxPQUFPLEVBQTJCLENBQUM7UUF4QmhFLElBQUksQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUM7SUFDNUMsQ0FBQztJQStCRDs7O09BR0c7SUFDSCxzQkFB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QztRQUNoRCxDQUFDO1FBQ0QsSUFBSSxDQUFDLHdCQUF3QixHQUFHLFFBQVEsQ0FBQyxZQUFZO2FBQ2hELElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDO2FBQ2hDLFNBQVMsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQztJQUM1QyxDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBcG9sbG9RdWVyeVJlc3VsdCwgTmV0d29ya1N0YXR1cyB9IGZyb20gJ0BhcG9sbG8vY2xpZW50L2NvcmUnO1xuaW1wb3J0IHsgbm90TnVsbE9yVW5kZWZpbmVkIH0gZnJvbSAnQHZlbmR1cmUvY29tbW9uL2xpYi9zaGFyZWQtdXRpbHMnO1xuaW1wb3J0IHsgQXBvbGxvLCBRdWVyeVJlZiB9IGZyb20gJ2Fwb2xsby1hbmd1bGFyJztcbmltcG9ydCB7IERvY3VtZW50Tm9kZSB9IGZyb20gJ2dyYXBocWwnO1xuaW1wb3J0IHsgbWVyZ2UsIE9ic2VydmFibGUsIFN1YmplY3QsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCxcbiAgICBmaWx0ZXIsXG4gICAgZmluYWxpemUsXG4gICAgbWFwLFxuICAgIHNoYXJlUmVwbGF5LFxuICAgIHNraXAsXG4gICAgc3RhcnRXaXRoLFxuICAgIHRha2UsXG4gICAgdGFrZVVudGlsLFxufSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7IEN1c3RvbUZpZWxkQ29uZmlnLCBHZXRVc2VyU3RhdHVzUXVlcnkgfSBmcm9tICcuLi9jb21tb24vZ2VuZXJhdGVkLXR5cGVzJztcblxuaW1wb3J0IHsgR0VUX1VTRVJfU1RBVFVTIH0gZnJvbSAnLi9kZWZpbml0aW9ucy9jbGllbnQtZGVmaW5pdGlvbnMnO1xuaW1wb3J0IHsgYWRkQ3VzdG9tRmllbGRzIH0gZnJvbSAnLi91dGlscy9hZGQtY3VzdG9tLWZpZWxkcyc7XG5cbi8qKlxuICogQGRlc2NyaXB0aW9uXG4gKiBUaGlzIGNsYXNzIHdyYXBzIHRoZSBBcG9sbG8gQW5ndWxhciBRdWVyeVJlZiBvYmplY3QgYW5kIGV4cG9zZXMgc29tZSBnZXR0ZXJzXG4gKiBmb3IgY29udmVuaWVuY2UuXG4gKlxuICogQGRvY3NDYXRlZ29yeSBzZXJ2aWNlc1xuICogQGRvY3NQYWdlIERhdGFTZXJ2aWNlXG4gKi9cbmV4cG9ydCBjbGFzcyBRdWVyeVJlc3VsdDxULCBWIGV4dGVuZHMgUmVjb3JkPHN0cmluZywgYW55PiA9IFJlY29yZDxzdHJpbmcsIGFueT4+IHtcbiAgICBjb25zdHJ1Y3RvcihcbiAgICAgICAgcHJpdmF0ZSBxdWVyeVJlZjogUXVlcnlSZWY8VCwgVj4sXG4gICAgICAgIHByaXZhdGUgYXBvbGxvOiBBcG9sbG8sXG4gICAgICAgIHByaXZhdGUgY3VzdG9tRmllbGRNYXA6IE1hcDxzdHJpbmcsIEN1c3RvbUZpZWxkQ29uZmlnW10+LFxuICAgICkge1xuICAgICAgICB0aGlzLmxhc3RRdWVyeSA9IHF1ZXJ5UmVmLm9wdGlvbnMucXVlcnk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQ2F1c2VzIGFueSBzdWJzY3JpcHRpb25zIHRvIHRoZSBRdWVyeVJlZiB0byBjb21wbGV0ZSwgdmlhIHRoZSB1c2VcbiAgICAgKiBvZiB0aGUgYHRha2VVbnRpbGAgb3BlcmF0b3IuXG4gICAgICovXG4gICAgcHJpdmF0ZSBjb21wbGV0ZWQkID0gbmV3IFN1YmplY3Q8dm9pZD4oKTtcbiAgICAvKipcbiAgICAgKiBUaGUgc3Vic2NyaXB0aW9uIHRvIHRoZSBjdXJyZW50IFF1ZXJ5UmVmLnZhbHVlQ2hhbmdlcyBPYnNlcnZhYmxlLlxuICAgICAqIFRoaXMgaXMgc3RvcmVkIHNvIHRoYXQgaXQgY2FuIGJlIHVuc3Vic2NyaWJlZCBmcm9tIHdoZW4gdGhlIFF1ZXJ5UmVmXG4gICAgICogY2hhbmdlcy5cbiAgICAgKi9cbiAgICBwcml2YXRlIHZhbHVlQ2hhbmdlc1N1YnNjcmlwdGlvbjogU3Vic2NyaXB0aW9uO1xuICAgIC8qKlxuICAgICAqIFRoaXMgU3ViamVjdCBpcyB1c2VkIHRvIGVtaXQgbmV3IHZhbHVlcyBmcm9tIHRoZSBRdWVyeVJlZi52YWx1ZUNoYW5nZXMgT2JzZXJ2YWJsZS5cbiAgICAgKiBXZSB1c2UgdGhpcyByYXRoZXIgdGhhbiBkaXJlY3RseSBzdWJzY3JpYmluZyB0byB0aGUgUXVlcnlSZWYudmFsdWVDaGFuZ2VzIE9ic2VydmFibGVcbiAgICAgKiBzbyB0aGF0IHdlIGFyZSBhYmxlIHRvIGNoYW5nZSB0aGUgUXVlcnlSZWYgYW5kIHJlLXN1YnNjcmliZSB3aGVuIG5lY2Vzc2FyeS5cbiAgICAgKi9cbiAgICBwcml2YXRlIHZhbHVlQ2hhbmdlU3ViamVjdCA9IG5ldyBTdWJqZWN0PEFwb2xsb1F1ZXJ5UmVzdWx0PFQ+PigpO1xuICAgIC8qKlxuICAgICAqIFdlIGtlZXAgdHJhY2sgb2YgdGhlIFF1ZXJ5UmVmcyB3aGljaCBoYXZlIGJlZW4gc3Vic2NyaWJlZCB0byBzbyB0aGF0IHdlIGNhbiBhdm9pZFxuICAgICAqIHJlLXN1YnNjcmliaW5nIHRvIHRoZSBzYW1lIFF1ZXJ5UmVmIG11bHRpcGxlIHRpbWVzLlxuICAgICAqL1xuICAgIHByaXZhdGUgcXVlcnlSZWZTdWJzY3JpYmVkID0gbmV3IFdlYWtNYXA8UXVlcnlSZWY8VCwgVj4sIGJvb2xlYW4+KCk7XG4gICAgLyoqXG4gICAgICogV2Ugc3RvcmUgYSByZWZlcmVuY2UgdG8gdGhlIGxhc3QgcXVlcnkgc28gdGhhdCB3ZSBjYW4gY29tcGFyZSBpdCB3aXRoIHRoZSBuZXh0IHF1ZXJ5XG4gICAgICogYW5kIGF2b2lkIHJlLWZldGNoaW5nIHRoZSBzYW1lIHF1ZXJ5IG11bHRpcGxlIHRpbWVzLiBUaGlzIGlzIGFwcGxpY2FibGUgdG8gdGhlIGNvZGVcbiAgICAgKiBwYXRocyB0aGF0IGFjdHVhbGx5IGNoYW5nZSB0aGUgcXVlcnksIGkuZS4gcmVmZXRjaE9uQ3VzdG9tRmllbGRzQ2hhbmdlKCkuXG4gICAgICovXG4gICAgcHJpdmF0ZSBsYXN0UXVlcnk6IERvY3VtZW50Tm9kZTtcblxuICAgIC8qKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIFJlLWZldGNoIHRoaXMgcXVlcnkgd2hlbmV2ZXIgdGhlIGFjdGl2ZSBDaGFubmVsIGNoYW5nZXMuXG4gICAgICovXG4gICAgcmVmZXRjaE9uQ2hhbm5lbENoYW5nZSgpOiBRdWVyeVJlc3VsdDxULCBWPiB7XG4gICAgICAgIGNvbnN0IHVzZXJTdGF0dXMkID0gdGhpcy5hcG9sbG8ud2F0Y2hRdWVyeTxHZXRVc2VyU3RhdHVzUXVlcnk+KHtcbiAgICAgICAgICAgIHF1ZXJ5OiBHRVRfVVNFUl9TVEFUVVMsXG4gICAgICAgIH0pLnZhbHVlQ2hhbmdlcztcbiAgICAgICAgY29uc3QgYWN0aXZlQ2hhbm5lbElkJCA9IHVzZXJTdGF0dXMkLnBpcGUoXG4gICAgICAgICAgICBtYXAoZGF0YSA9PiBkYXRhLmRhdGEudXNlclN0YXR1cy5hY3RpdmVDaGFubmVsSWQpLFxuICAgICAgICAgICAgZmlsdGVyKG5vdE51bGxPclVuZGVmaW5lZCksXG4gICAgICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxuICAgICAgICAgICAgc2tpcCgxKSxcbiAgICAgICAgICAgIHRha2VVbnRpbCh0aGlzLmNvbXBsZXRlZCQpLFxuICAgICAgICApO1xuICAgICAgICBjb25zdCBsb2dnZWRPdXQkID0gdXNlclN0YXR1cyQucGlwZShcbiAgICAgICAgICAgIG1hcChkYXRhID0+IGRhdGEuZGF0YS51c2VyU3RhdHVzLmlzTG9nZ2VkSW4pLFxuICAgICAgICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICAgICAgICAgIHNraXAoMSksXG4gICAgICAgICAgICBmaWx0ZXIoaXNMb2dnZWRJbiA9PiAhaXNMb2dnZWRJbiksXG4gICAgICAgICAgICB0YWtlVW50aWwodGhpcy5jb21wbGV0ZWQkKSxcbiAgICAgICAgKTtcblxuICAgICAgICBtZXJnZShhY3RpdmVDaGFubmVsSWQkLCB0aGlzLnZhbHVlQ2hhbmdlU3ViamVjdClcbiAgICAgICAgICAgIC5waXBlKHRha2VVbnRpbChsb2dnZWRPdXQkKSwgdGFrZVVudGlsKHRoaXMuY29tcGxldGVkJCkpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKHZhbCA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWwgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgICAgIG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCA1MCkpLnRoZW4oKCkgPT4gdGhpcy5xdWVyeVJlZi5yZWZldGNoKCkpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAZGVzY3JpcHRpb25cbiAgICAgKiBSZS1mZXRjaCB0aGlzIHF1ZXJ5IHdoZW5ldmVyIHRoZSBjdXN0b20gZmllbGRzIGNoYW5nZSwgdXBkYXRpbmcgdGhlIHF1ZXJ5IHRvIGluY2x1ZGUgdGhlXG4gICAgICogc3BlY2lmaWVkIGN1c3RvbSBmaWVsZHMuXG4gICAgICpcbiAgICAgKiBAc2luY2UgMy4wLjRcbiAgICAgKi9cbiAgICByZWZldGNoT25DdXN0b21GaWVsZHNDaGFuZ2UoY3VzdG9tRmllbGRzVG9JbmNsdWRlJDogT2JzZXJ2YWJsZTxzdHJpbmdbXT4pOiBRdWVyeVJlc3VsdDxULCBWPiB7XG4gICAgICAgIGN1c3RvbUZpZWxkc1RvSW5jbHVkZSRcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICAgIGZpbHRlcihjdXN0b21GaWVsZHMgPT4ge1xuICAgICAgICAgICAgICAgICAgICBjb25zdCBuZXdRdWVyeSA9IGFkZEN1c3RvbUZpZWxkcyh0aGlzLmxhc3RRdWVyeSwgdGhpcy5jdXN0b21GaWVsZE1hcCwgY3VzdG9tRmllbGRzKTtcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaGFzQ2hhbmdlZCA9IEpTT04uc3RyaW5naWZ5KG5ld1F1ZXJ5KSAhPT0gSlNPTi5zdHJpbmdpZnkodGhpcy5sYXN0UXVlcnkpO1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4gaGFzQ2hhbmdlZDtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICB0YWtlVW50aWwodGhpcy5jb21wbGV0ZWQkKSxcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoY3VzdG9tRmllbGRzID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBuZXdRdWVyeSA9IGFkZEN1c3RvbUZpZWxkcyh0aGlzLmxhc3RRdWVyeSwgdGhpcy5jdXN0b21GaWVsZE1hcCwgY3VzdG9tRmllbGRzKTtcbiAgICAgICAgICAgICAgICB0aGlzLmxhc3RRdWVyeSA9IG5ld1F1ZXJ5O1xuICAgICAgICAgICAgICAgIGNvbnN0IHF1ZXJ5UmVmID0gdGhpcy5hcG9sbG8ud2F0Y2hRdWVyeTxULCBWPih7XG4gICAgICAgICAgICAgICAgICAgIHF1ZXJ5OiBuZXdRdWVyeSxcbiAgICAgICAgICAgICAgICAgICAgdmFyaWFibGVzOiB0aGlzLnF1ZXJ5UmVmLnZhcmlhYmxlcyxcbiAgICAgICAgICAgICAgICAgICAgZmV0Y2hQb2xpY3k6IHRoaXMucXVlcnlSZWYub3B0aW9ucy5mZXRjaFBvbGljeSxcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB0aGlzLnF1ZXJ5UmVmID0gcXVlcnlSZWY7XG4gICAgICAgICAgICAgICAgdGhpcy5zdWJzY3JpYmVUb1F1ZXJ5UmVmKHF1ZXJ5UmVmKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gdGhpcztcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAZGVzY3JpcHRpb25cbiAgICAgKiBSZXR1cm5zIGFuIE9ic2VydmFibGUgd2hpY2ggZW1pdHMgYSBzaW5nbGUgcmVzdWx0IGFuZCB0aGVuIGNvbXBsZXRlcy5cbiAgICAgKi9cbiAgICBnZXQgc2luZ2xlJCgpOiBPYnNlcnZhYmxlPFQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudFF1ZXJ5UmVmVmFsdWVDaGFuZ2VzLnBpcGUoXG4gICAgICAgICAgICBmaWx0ZXIocmVzdWx0ID0+IHJlc3VsdC5uZXR3b3JrU3RhdHVzID09PSBOZXR3b3JrU3RhdHVzLnJlYWR5KSxcbiAgICAgICAgICAgIHRha2UoMSksXG4gICAgICAgICAgICBtYXAocmVzdWx0ID0+IHJlc3VsdC5kYXRhKSxcbiAgICAgICAgICAgIGZpbmFsaXplKCgpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmNvbXBsZXRlZCQubmV4dCgpO1xuICAgICAgICAgICAgICAgIHRoaXMuY29tcGxldGVkJC5jb21wbGV0ZSgpO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQGRlc2NyaXB0aW9uXG4gICAgICogUmV0dXJucyBhbiBPYnNlcnZhYmxlIHdoaWNoIGVtaXRzIHVudGlsIHVuc3Vic2NyaWJlZC5cbiAgICAgKi9cbiAgICBnZXQgc3RyZWFtJCgpOiBPYnNlcnZhYmxlPFQ+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudFF1ZXJ5UmVmVmFsdWVDaGFuZ2VzLnBpcGUoXG4gICAgICAgICAgICBmaWx0ZXIocmVzdWx0ID0+IHJlc3VsdC5uZXR3b3JrU3RhdHVzID09PSBOZXR3b3JrU3RhdHVzLnJlYWR5KSxcbiAgICAgICAgICAgIG1hcChyZXN1bHQgPT4gcmVzdWx0LmRhdGEpLFxuICAgICAgICAgICAgZmluYWxpemUoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuY29tcGxldGVkJC5uZXh0KCk7XG4gICAgICAgICAgICAgICAgdGhpcy5jb21wbGV0ZWQkLmNvbXBsZXRlKCk7XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBnZXQgcmVmKCk6IFF1ZXJ5UmVmPFQsIFY+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMucXVlcnlSZWY7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQGRlc2NyaXB0aW9uXG4gICAgICogUmV0dXJucyBhIHNpbmdsZS1yZXN1bHQgT2JzZXJ2YWJsZSBhZnRlciBhcHBseWluZyB0aGUgbWFwIGZ1bmN0aW9uLlxuICAgICAqL1xuICAgIG1hcFNpbmdsZTxSPihtYXBGbjogKGl0ZW06IFQpID0+IFIpOiBPYnNlcnZhYmxlPFI+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2luZ2xlJC5waXBlKG1hcChtYXBGbikpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIFJldHVybnMgYSBtdWx0aXBsZS1yZXN1bHQgT2JzZXJ2YWJsZSBhZnRlciBhcHBseWluZyB0aGUgbWFwIGZ1bmN0aW9uLlxuICAgICAqL1xuICAgIG1hcFN0cmVhbTxSPihtYXBGbjogKGl0ZW06IFQpID0+IFIpOiBPYnNlcnZhYmxlPFI+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc3RyZWFtJC5waXBlKG1hcChtYXBGbikpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIFNpZ25hbHMgdG8gdGhlIGludGVybmFsIE9ic2VydmFibGUgc3Vic2NyaXB0aW9ucyB0aGF0IHRoZXkgc2hvdWxkIGNvbXBsZXRlLlxuICAgICAqL1xuICAgIGRlc3Ryb3koKSB7XG4gICAgICAgIHRoaXMuY29tcGxldGVkJC5uZXh0KCk7XG4gICAgICAgIHRoaXMuY29tcGxldGVkJC5jb21wbGV0ZSgpO1xuICAgIH1cblxuICAgIC8qKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIFJldHVybnMgYW4gT2JzZXJ2YWJsZSB3aGljaCBlbWl0cyB0aGUgY3VycmVudCB2YWx1ZSBvZiB0aGUgUXVlcnlSZWYudmFsdWVDaGFuZ2VzIE9ic2VydmFibGUuXG4gICAgICpcbiAgICAgKiBXZSB3cmFwIHRoZSB2YWx1ZUNoYW5nZXMgT2JzZXJ2YWJsZSBpbiBhIG5ldyBPYnNlcnZhYmxlIHNvIHRoYXQgd2UgY2FuIGhhdmUgYSBsYXp5XG4gICAgICogZXZhbHVhdGlvbiBvZiB0aGUgdmFsdWVDaGFuZ2VzIE9ic2VydmFibGUuIFRoYXQgaXMsIHdlIG9ubHkgZmlyZSB0aGUgSFRUUCByZXF1ZXN0IHdoZW5cbiAgICAgKiB0aGUgcmV0dXJuZWQgT2JzZXJ2YWJsZSBpcyBzdWJzY3JpYmVkIHRvLlxuICAgICAqL1xuICAgIHByaXZhdGUgZ2V0IGN1cnJlbnRRdWVyeVJlZlZhbHVlQ2hhbmdlcygpOiBPYnNlcnZhYmxlPEFwb2xsb1F1ZXJ5UmVzdWx0PFQ+PiB7XG4gICAgICAgIHJldHVybiBuZXcgT2JzZXJ2YWJsZShzdWJzY3JpYmVyID0+IHtcbiAgICAgICAgICAgIGlmICghdGhpcy5xdWVyeVJlZlN1YnNjcmliZWQuZ2V0KHRoaXMucXVlcnlSZWYpKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5zdWJzY3JpYmVUb1F1ZXJ5UmVmKHRoaXMucXVlcnlSZWYpO1xuICAgICAgICAgICAgICAgIHRoaXMucXVlcnlSZWZTdWJzY3JpYmVkLnNldCh0aGlzLnF1ZXJ5UmVmLCB0cnVlKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMudmFsdWVDaGFuZ2VTdWJqZWN0XG4gICAgICAgICAgICAgICAgLnBpcGUoc3RhcnRXaXRoKHRoaXMucXVlcnlSZWYuZ2V0Q3VycmVudFJlc3VsdCgpKSwgc2hhcmVSZXBsYXkoMSkpXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZShzdWJzY3JpYmVyKTtcbiAgICAgICAgICAgIHJldHVybiAoKSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5xdWVyeVJlZlN1YnNjcmliZWQuZGVsZXRlKHRoaXMucXVlcnlSZWYpO1xuICAgICAgICAgICAgfTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQGRlc2NyaXB0aW9uXG4gICAgICogU3Vic2NyaWJlcyB0byB0aGUgdmFsdWVDaGFuZ2VzIE9ic2VydmFibGUgb2YgdGhlIGdpdmVuIFF1ZXJ5UmVmLCBhbmQgc3RvcmVzIHRoZSBzdWJzY3JpcHRpb25cbiAgICAgKiBzbyB0aGF0IGl0IGNhbiBiZSB1bnN1YnNjcmliZWQgZnJvbSB3aGVuIHRoZSBRdWVyeVJlZiBjaGFuZ2VzLlxuICAgICAqL1xuICAgIHByaXZhdGUgc3Vic2NyaWJlVG9RdWVyeVJlZihxdWVyeVJlZjogUXVlcnlSZWY8VCwgVj4pIHtcbiAgICAgICAgaWYgKHRoaXMudmFsdWVDaGFuZ2VzU3Vic2NyaXB0aW9uKSB7XG4gICAgICAgICAgICB0aGlzLnZhbHVlQ2hhbmdlc1N1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMudmFsdWVDaGFuZ2VzU3Vic2NyaXB0aW9uID0gcXVlcnlSZWYudmFsdWVDaGFuZ2VzXG4gICAgICAgICAgICAucGlwZSh0YWtlVW50aWwodGhpcy5jb21wbGV0ZWQkKSlcbiAgICAgICAgICAgIC5zdWJzY3JpYmUodGhpcy52YWx1ZUNoYW5nZVN1YmplY3QpO1xuICAgIH1cbn1cbiJdfQ==