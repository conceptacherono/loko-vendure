import { GET_NEWTORK_STATUS, GET_UI_STATE, GET_USER_STATUS } from '../definitions/client-definitions';
export const clientResolvers = {
    Mutation: {
        requestStarted: (_, args, { cache }) => updateRequestsInFlight(cache, 1),
        requestCompleted: (_, args, { cache }) => updateRequestsInFlight(cache, -1),
        setAsLoggedIn: (_, args, { cache }) => {
            const { input: { username, loginTime, channels, activeChannelId, administratorId }, } = args;
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            const permissions = channels.find(c => c.id === activeChannelId).permissions;
            const data = {
                userStatus: {
                    __typename: 'UserStatus',
                    administratorId,
                    username,
                    loginTime,
                    isLoggedIn: true,
                    permissions,
                    channels,
                    activeChannelId,
                },
            };
            cache.writeQuery({ query: GET_USER_STATUS, data });
            return data.userStatus;
        },
        setAsLoggedOut: (_, args, { cache }) => {
            const data = {
                userStatus: {
                    __typename: 'UserStatus',
                    administratorId: null,
                    username: '',
                    loginTime: '',
                    isLoggedIn: false,
                    permissions: [],
                    channels: [],
                    activeChannelId: null,
                },
            };
            cache.writeQuery({ query: GET_USER_STATUS, data });
            return data.userStatus;
        },
        setUiLanguage: (_, args, { cache }) => {
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            const previous = cache.readQuery({ query: GET_UI_STATE });
            const data = updateUiState(previous, 'language', args.languageCode);
            cache.writeQuery({ query: GET_UI_STATE, data });
            return args.languageCode;
        },
        setUiLocale: (_, args, { cache }) => {
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            const previous = cache.readQuery({ query: GET_UI_STATE });
            const data = updateUiState(previous, 'locale', args.locale);
            cache.writeQuery({ query: GET_UI_STATE, data });
            return args.locale ?? undefined;
        },
        setContentLanguage: (_, args, { cache }) => {
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            const previous = cache.readQuery({ query: GET_UI_STATE });
            const data = updateUiState(previous, 'contentLanguage', args.languageCode);
            cache.writeQuery({ query: GET_UI_STATE, data });
            return args.languageCode;
        },
        setUiTheme: (_, args, { cache }) => {
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            const previous = cache.readQuery({ query: GET_UI_STATE });
            const data = updateUiState(previous, 'theme', args.theme);
            cache.writeQuery({ query: GET_UI_STATE, data });
            return args.theme;
        },
        setDisplayUiExtensionPoints: (_, args, { cache }) => {
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            const previous = cache.readQuery({ query: GET_UI_STATE });
            const data = updateUiState(previous, 'displayUiExtensionPoints', args.display);
            cache.writeQuery({ query: GET_UI_STATE, data });
            return args.display;
        },
        setMainNavExpanded: (_, args, { cache }) => {
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            const previous = cache.readQuery({ query: GET_UI_STATE });
            const data = updateUiState(previous, 'mainNavExpanded', args.expanded);
            cache.writeQuery({ query: GET_UI_STATE, data });
            return args.expanded;
        },
        setActiveChannel: (_, args, { cache }) => {
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            const previous = cache.readQuery({ query: GET_USER_STATUS });
            const activeChannel = previous.userStatus.channels.find(c => c.id === args.channelId);
            if (!activeChannel) {
                throw new Error('setActiveChannel: Could not find Channel with ID ' + args.channelId);
            }
            const permissions = activeChannel.permissions;
            const data = {
                userStatus: {
                    ...previous.userStatus,
                    permissions,
                    activeChannelId: activeChannel.id,
                },
            };
            cache.writeQuery({ query: GET_USER_STATUS, data });
            return data.userStatus;
        },
        updateUserChannels: (_, args, { cache }) => {
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            const previous = cache.readQuery({ query: GET_USER_STATUS });
            const data = {
                userStatus: {
                    ...previous.userStatus,
                    channels: Array.isArray(args.channels) ? args.channels : [args.channels],
                },
            };
            cache.writeQuery({ query: GET_USER_STATUS, data });
            return data.userStatus;
        },
    },
};
function updateUiState(previous, key, value) {
    return {
        uiState: {
            ...previous.uiState,
            [key]: value,
            __typename: 'UiState',
        },
    };
}
function updateRequestsInFlight(cache, increment) {
    const previous = cache.readQuery({ query: GET_NEWTORK_STATUS });
    const inFlightRequests = previous ? previous.networkStatus.inFlightRequests + increment : increment;
    const data = {
        networkStatus: {
            __typename: 'NetworkStatus',
            inFlightRequests,
        },
    };
    cache.writeQuery({ query: GET_NEWTORK_STATUS, data });
    return inFlightRequests;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50LXJlc29sdmVycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9saWIvY29yZS9zcmMvZGF0YS9jbGllbnQtc3RhdGUvY2xpZW50LXJlc29sdmVycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFJQSxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsWUFBWSxFQUFFLGVBQWUsRUFBRSxNQUFNLG1DQUFtQyxDQUFDO0FBY3RHLE1BQU0sQ0FBQyxNQUFNLGVBQWUsR0FBdUI7SUFDL0MsUUFBUSxFQUFFO1FBQ04sY0FBYyxFQUFFLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFVLEVBQUUsQ0FBQyxzQkFBc0IsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQ2hGLGdCQUFnQixFQUFFLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxFQUFFLEtBQUssRUFBRSxFQUFVLEVBQUUsQ0FBQyxzQkFBc0IsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDbkYsYUFBYSxFQUFFLENBQUMsQ0FBQyxFQUFFLElBQTRDLEVBQUUsRUFBRSxLQUFLLEVBQUUsRUFBYyxFQUFFO1lBQ3RGLE1BQU0sRUFDRixLQUFLLEVBQUUsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxlQUFlLEVBQUUsZUFBZSxFQUFFLEdBQzdFLEdBQUcsSUFBSSxDQUFDO1lBQ1Qsb0VBQW9FO1lBQ3BFLE1BQU0sV0FBVyxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsRUFBRSxLQUFLLGVBQWUsQ0FBRSxDQUFDLFdBQVcsQ0FBQztZQUM5RSxNQUFNLElBQUksR0FBK0I7Z0JBQ3JDLFVBQVUsRUFBRTtvQkFDUixVQUFVLEVBQUUsWUFBWTtvQkFDeEIsZUFBZTtvQkFDZixRQUFRO29CQUNSLFNBQVM7b0JBQ1QsVUFBVSxFQUFFLElBQUk7b0JBQ2hCLFdB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QUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUM7aUJBQzNFO2FBQ0osQ0FBQztZQUNGLEtBQUssQ0FBQyxVQUFVLENBQUMsRUFBRSxLQUFLLEVBQUUsZUFBZSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUM7WUFDbkQsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDO1FBQzNCLENBQUM7S0FDSjtDQUNKLENBQUM7QUFFRixTQUFTLGFBQWEsQ0FDbEIsUUFBaUMsRUFDakMsR0FBTSxFQUNOLEtBQTRDO0lBRTVDLE9BQU87UUFDSCxPQUFPLEVBQUU7WUFDTCxHQUFHLFFBQVEsQ0FBQyxPQUFPO1lBQ25CLENBQUMsR0FBRyxDQUFDLEVBQUUsS0FBSztZQUNaLFVBQVUsRUFBRSxTQUFTO1NBQ3hCO0tBQ0osQ0FBQztBQUNOLENBQUM7QUFFRCxTQUFTLHNCQUFzQixDQUFDLEtBQW9CLEVBQUUsU0FBaUI7SUFDbkUsTUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDLFNBQVMsQ0FBZ0MsRUFBRSxLQUFLLEVBQUUsa0JBQWtCLEVBQUUsQ0FBQyxDQUFDO0lBQy9GLE1BQU0sZ0JBQWdCLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsYUFBYSxDQUFDLGdCQUFnQixHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO0lBQ3BHLE1BQU0sSUFBSSxHQUFrQztRQUN4QyxhQUFhLEVBQUU7WUFDWCxVQUFVLEVBQUUsZUFBZTtZQUMzQixnQkFBZ0I7U0FDbkI7S0FDSixDQUFDO0lBQ0YsS0FBSyxDQUFDLFVBQVUsQ0FBQyxFQUFFLEtBQUssRUFBRSxrQkFBa0IsRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDO0lBQ3RELE9BQU8sZ0JBQWdCLENBQUM7QUFDNUIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluTWVtb3J5Q2FjaGUgfSBmcm9tICdAYXBvbGxvL2NsaWVudC9jb3JlJztcclxuXHJcbmltcG9ydCAqIGFzIENvZGVnZW4gZnJvbSAnLi4vLi4vY29tbW9uL2dlbmVyYXRlZC10eXBlcyc7XHJcbmltcG9ydCB7IEdldFVzZXJTdGF0dXNRdWVyeSwgTGFuZ3VhZ2VDb2RlLCBVc2VyU3RhdHVzIH0gZnJvbSAnLi4vLi4vY29tbW9uL2dlbmVyYXRlZC10eXBlcyc7XHJcbmltcG9ydCB7IEdFVF9ORVdUT1JLX1NUQVRVUywgR0VUX1VJX1NUQVRFLCBHRVRfVVNFUl9TVEFUVVMgfSBmcm9tICcuLi9kZWZpbml0aW9ucy9jbGllbnQtZGVmaW5pdGlvbnMnO1xyXG5cclxuZXhwb3J0IHR5cGUgUmVzb2x2ZXJDb250ZXh0ID0ge1xyXG4gICAgY2FjaGU6IEluTWVtb3J5Q2FjaGU7XHJcbiAgICBvcHRpbWlzdGljUmVzcG9uc2U6IGFueTtcclxuICAgIGdldENhY2hlS2V5OiAoc3RvcmVPYmo6IGFueSkgPT4gc3RyaW5nO1xyXG59O1xyXG5cclxuZXhwb3J0IHR5cGUgUmVzb2x2ZXJEZWZpbml0aW9uID0ge1xyXG4gICAgTXV0YXRpb246IHtcclxuICAgICAgICBbbmFtZTogc3RyaW5nXTogKHJvb3RWYWx1ZTogYW55LCBhcmdzOiBhbnksIGNvbnRleHQ6IFJlc29sdmVyQ29udGV4dCwgaW5mbz86IGFueSkgPT4gYW55O1xyXG4gICAgfTtcclxufTtcclxuXHJcbmV4cG9ydCBjb25zdCBjbGllbnRSZXNvbHZlcnM6IFJlc29sdmVyRGVmaW5pdGlvbiA9IHtcclxuICAgIE11dGF0aW9uOiB7XHJcbiAgICAgICAgcmVxdWVzdFN0YXJ0ZWQ6IChfLCBhcmdzLCB7IGNhY2hlIH0pOiBudW1iZXIgPT4gdXBkYXRlUmVxdWVzdHNJbkZsaWdodChjYWNoZSwgMSksXHJcbiAgICAgICAgcmVxdWVzdENvbXBsZXRlZDogKF8sIGFyZ3MsIHsgY2FjaGUgfSk6IG51bWJlciA9PiB1cGRhdGVSZXF1ZXN0c0luRmxpZ2h0KGNhY2hlLCAtMSksXHJcbiAgICAgICAgc2V0QXNMb2dnZWRJbjogKF8sIGFyZ3M6IENvZGVnZW4uU2V0QXNMb2dnZWRJbk11dGF0aW9uVmFyaWFibGVzLCB7IGNhY2hlIH0pOiBVc2VyU3RhdHVzID0+IHtcclxuICAgICAgICAgICAgY29uc3Qge1xyXG4gICAgICAgICAgICAgICAgaW5wdXQ6IHsgdXNlcm5hbWUsIGxvZ2luVGltZSwgY2hhbm5lbHMsIGFjdGl2ZUNoYW5uZWxJZCwgYWRtaW5pc3RyYXRvcklkIH0sXHJcbiAgICAgICAgICAgIH0gPSBhcmdzO1xyXG4gICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW5vbi1udWxsLWFzc2VydGlvblxyXG4gICAgICAgICAgICBjb25zdCBwZXJtaXNzaW9ucyA9IGNoYW5uZWxzLmZpbmQoYyA9PiBjLmlkID09PSBhY3RpdmVDaGFubmVsSWQpIS5wZXJtaXNzaW9ucztcclxuICAgICAgICAgICAgY29uc3QgZGF0YTogeyB1c2VyU3RhdHVzOiBVc2VyU3RhdHVzIH0gPSB7XHJcbiAgICAgICAgICAgICAgICB1c2VyU3RhdHVzOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgX190eXBlbmFtZTogJ1VzZXJTdGF0dXMnLFxyXG4gICAgICAgICAgICAgICAgICAgIGFkbWluaXN0cmF0b3JJZCxcclxuICAgICAgICAgICAgICAgICAgICB1c2VybmFtZSxcclxuICAgICAgICAgICAgICAgICAgICBsb2dpblRpbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgaXNMb2dnZWRJbjogdHJ1ZSxcclxuICAgICAgICAgICAgICAgICAgICBwZXJtaXNzaW9ucyxcclxuICAgICAgICAgICAgICAgICAgICBjaGFubmVscyxcclxuICAgICAgICAgICAgICAgICAgICBhY3RpdmVDaGFubmVsSWQsXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBjYWNoZS53cml0ZVF1ZXJ5KHsgcXVlcnk6IEdFVF9VU0VSX1NUQVRVUywgZGF0YSB9KTtcclxuICAgICAgICAgICAgcmV0dXJuIGRhdGEudXNlclN0YXR1cztcclxuICAgICAgICB9LFxyXG4gICAgICAgIHNldEFzTG9nZ2VkT3V0OiAoXywgYXJncywgeyBjYWNoZSB9KTogVXNlclN0YXR1cyA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGE6IEdldFVzZXJTdGF0dXNRdWVyeSA9IHtcclxuICAgICAgICAgICAgICAgIHVzZXJTdGF0dXM6IHtcclxuICAgICAgICAgICAgICAgICAgICBfX3R5cGVuYW1lOiAnVXNlclN0YXR1cycsXHJcbiAgICAgICAgICAgICAgICAgICAgYWRtaW5pc3RyYXRvcklkOiBudWxsLFxyXG4gICAgICAgICAgICAgICAgICAgIHVzZXJuYW1lOiAnJyxcclxuICAgICAgICAgICAgICAgICAgICBsb2dpblRpbWU6ICcnLFxyXG4gICAgICAgICAgICAgICAgICAgIGlzTG9nZ2VkSW46IGZhbHNlLFxyXG4gICAgICAgICAgICAgICAgICAgIHBlcm1pc3Npb25zOiBbXSxcclxuICAgICAgICAgICAgICAgICAgICBjaGFubmVsczogW10sXHJcbiAgICAgICAgICAgICAgICAgICAgYWN0aXZlQ2hhbm5lbElkOiBudWxsLFxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgY2FjaGUud3JpdGVRdWVyeSh7IHF1ZXJ5OiBHRVRfVVNFUl9TVEFUVVMsIGRhdGEgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiBkYXRhLnVzZXJTdGF0dXM7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzZXRVaUxhbmd1YWdlOiAoXywgYXJnczogQ29kZWdlbi5TZXRVaUxhbmd1YWdlTXV0YXRpb25WYXJpYWJsZXMsIHsgY2FjaGUgfSk6IExhbmd1YWdlQ29kZSA9PiB7XHJcbiAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tbm9uLW51bGwtYXNzZXJ0aW9uXHJcbiAgICAgICAgICAgIGNvbnN0IHByZXZpb3VzID0gY2FjaGUucmVhZFF1ZXJ5PENvZGVnZW4uR2V0VWlTdGF0ZVF1ZXJ5Pih7IHF1ZXJ5OiBHRVRfVUlfU1RBVEUgfSkhO1xyXG4gICAgICAgICAgICBjb25zdCBkYXRhID0gdXBkYXRlVWlTdGF0ZShwcmV2aW91cywgJ2xhbmd1YWdlJywgYXJncy5sYW5ndWFnZUNvZGUpO1xyXG4gICAgICAgICAgICBjYWNoZS53cml0ZVF1ZXJ5KHsgcXVlcnk6IEdFVF9VSV9TVEFURSwgZGF0YSB9KTtcclxuICAgICAgICAgICAgcmV0dXJuIGFyZ3MubGFuZ3VhZ2VDb2RlO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2V0VWlMb2NhbGU6IChfLCBhcmdzOiBDb2RlZ2VuLlNldFVpTG9jYWxlTXV0YXRpb25WYXJpYWJsZXMsIHsgY2FjaGUgfSk6IHN0cmluZyB8IHVuZGVmaW5lZCA9PiB7XHJcbiAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tbm9uLW51bGwtYXNzZXJ0aW9uXHJcbiAgICAgICAgICAgIGNvbnN0IHByZXZpb3VzID0gY2FjaGUucmVhZFF1ZXJ5PENvZGVnZW4uR2V0VWlTdGF0ZVF1ZXJ5Pih7IHF1ZXJ5OiBHRVRfVUlfU1RBVEUgfSkhO1xyXG4gICAgICAgICAgICBjb25zdCBkYXRhID0gdXBkYXRlVWlTdGF0ZShwcmV2aW91cywgJ2xvY2FsZScsIGFyZ3MubG9jYWxlKTtcclxuICAgICAgICAgICAgY2FjaGUud3JpdGVRdWVyeSh7IHF1ZXJ5OiBHRVRfVUlfU1RBVEUsIGRhdGEgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiBhcmdzLmxvY2FsZSA/PyB1bmRlZmluZWQ7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzZXRDb250ZW50TGFuZ3VhZ2U6IChcclxuICAgICAgICAgICAgXyxcclxuICAgICAgICAgICAgYXJnczogQ29kZWdlbi5TZXRDb250ZW50TGFuZ3VhZ2VNdXRhdGlvblZhcmlhYmxlcyxcclxuICAgICAgICAgICAgeyBjYWNoZSB9LFxyXG4gICAgICAgICk6IExhbmd1YWdlQ29kZSA9PiB7XHJcbiAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tbm9uLW51bGwtYXNzZXJ0aW9uXHJcbiAgICAgICAgICAgIGNvbnN0IHByZXZpb3VzID0gY2FjaGUucmVhZFF1ZXJ5PENvZGVnZW4uR2V0VWlTdGF0ZVF1ZXJ5Pih7IHF1ZXJ5OiBHRVRfVUlfU1RBVEUgfSkhO1xyXG4gICAgICAgICAgICBjb25zdCBkYXRhID0gdXBkYXRlVWlTdGF0ZShwcmV2aW91cywgJ2NvbnRlbnRMYW5ndWFnZScsIGFyZ3MubGFuZ3VhZ2VDb2RlKTtcclxuICAgICAgICAgICAgY2FjaGUud3JpdGVRdWVyeSh7IHF1ZXJ5OiBHRVRfVUlfU1RBVEUsIGRhdGEgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiBhcmdzLmxhbmd1YWdlQ29kZTtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHNldFVpVGhlbWU6IChfLCBhcmdzOiBDb2RlZ2VuLlNldFVpVGhlbWVNdXRhdGlvblZhcmlhYmxlcywgeyBjYWNoZSB9KTogc3RyaW5nID0+IHtcclxuICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb25cclxuICAgICAgICAgICAgY29uc3QgcHJldmlvdXMgPSBjYWNoZS5yZWFkUXVlcnk8Q29kZWdlbi5HZXRVaVN0YXRlUXVlcnk+KHsgcXVlcnk6IEdFVF9VSV9TVEFURSB9KSE7XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB1cGRhdGVVaVN0YXRlKHByZXZpb3VzLCAndGhlbWUnLCBhcmdzLnRoZW1lKTtcclxuICAgICAgICAgICAgY2FjaGUud3JpdGVRdWVyeSh7IHF1ZXJ5OiBHRVRfVUlfU1RBVEUsIGRhdGEgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiBhcmdzLnRoZW1lO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgc2V0RGlzcGxheVVpRXh0ZW5zaW9uUG9pbnRzOiAoXHJcbiAgICAgICAgICAgIF8sXHJcbiAgICAgICAgICAgIGFyZ3M6IENvZGVnZW4uU2V0RGlzcGxheVVpRXh0ZW5zaW9uUG9pbnRzTXV0YXRpb25WYXJpYWJsZXMsXHJcbiAgICAgICAgICAgIHsgY2FjaGUgfSxcclxuICAgICAgICApOiBib29sZWFuID0+IHtcclxuICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb25cclxuICAgICAgICAgICAgY29uc3QgcHJldmlvdXMgPSBjYWNoZS5yZWFkUXVlcnk8Q29kZWdlbi5HZXRVaVN0YXRlUXVlcnk+KHsgcXVlcnk6IEdFVF9VSV9TVEFURSB9KSE7XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB1cGRhdGVVaVN0YXRlKHByZXZpb3VzLCAnZGlzcGxheVVpRXh0ZW5zaW9uUG9pbnRzJywgYXJncy5kaXNwbGF5KTtcclxuICAgICAgICAgICAgY2FjaGUud3JpdGVRdWVyeSh7IHF1ZXJ5OiBHRVRfVUlfU1RBVEUsIGRhdGEgfSk7XHJcbiAgICAgICAgICAgIHJldHVybiBhcmdzLmRpc3BsYXk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBzZXRNYWluTmF2RXhwYW5kZWQ6IChfLCBhcmdzOiBDb2RlZ2VuLlNldE1haW5OYXZFeHBhbmRlZE11dGF0aW9uVmFyaWFibGVzLCB7IGNhY2hlIH0pOiBib29sZWFuID0+IHtcclxuICAgICAgICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIEB0eXBlc2NyaXB0LWVzbGludC9uby1ub24tbnVsbC1hc3NlcnRpb25cclxuICAgICAgICAgICAgY29uc3QgcHJldmlvdXMgPSBjYWNoZS5yZWFkUXVlcnk8Q29kZWdlbi5HZXRVaVN0YXRlUXVlcnk+KHsgcXVlcnk6IEdFVF9VSV9TVEFURSB9KSE7XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB1cGRhdGVVaVN0YXRlKHByZXZpb3VzLCAnbWFpbk5hdkV4cGFuZGVkJywgYXJncy5leHBhbmRlZCk7XHJcbiAgICAgICAgICAgIGNhY2hlLndyaXRlUXVlcnkoeyBxdWVyeTogR0VUX1VJX1NUQVRFLCBkYXRhIH0pO1xyXG4gICAgICAgICAgICByZXR1cm4gYXJncy5leHBhbmRlZDtcclxuICAgICAgICB9LFxyXG4gICAgICAgIHNldEFjdGl2ZUNoYW5uZWw6IChfLCBhcmdzOiBDb2RlZ2VuLlNldEFjdGl2ZUNoYW5uZWxNdXRhdGlvblZhcmlhYmxlcywgeyBjYWNoZSB9KTogVXNlclN0YXR1cyA9PiB7XHJcbiAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tbm9uLW51bGwtYXNzZXJ0aW9uXHJcbiAgICAgICAgICAgIGNvbnN0IHByZXZpb3VzID0gY2FjaGUucmVhZFF1ZXJ5PEdldFVzZXJTdGF0dXNRdWVyeT4oeyBxdWVyeTogR0VUX1VTRVJfU1RBVFVTIH0pITtcclxuICAgICAgICAgICAgY29uc3QgYWN0aXZlQ2hhbm5lbCA9IHByZXZpb3VzLnVzZXJTdGF0dXMuY2hhbm5lbHMuZmluZChjID0+IGMuaWQgPT09IGFyZ3MuY2hhbm5lbElkKTtcclxuICAgICAgICAgICAgaWYgKCFhY3RpdmVDaGFubmVsKSB7XHJcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3NldEFjdGl2ZUNoYW5uZWw6IENvdWxkIG5vdCBmaW5kIENoYW5uZWwgd2l0aCBJRCAnICsgYXJncy5jaGFubmVsSWQpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGNvbnN0IHBlcm1pc3Npb25zID0gYWN0aXZlQ2hhbm5lbC5wZXJtaXNzaW9ucztcclxuICAgICAgICAgICAgY29uc3QgZGF0YTogeyB1c2VyU3RhdHVzOiBVc2VyU3RhdHVzIH0gPSB7XHJcbiAgICAgICAgICAgICAgICB1c2VyU3RhdHVzOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgLi4ucHJldmlvdXMudXNlclN0YXR1cyxcclxuICAgICAgICAgICAgICAgICAgICBwZXJtaXNzaW9ucyxcclxuICAgICAgICAgICAgICAgICAgICBhY3RpdmVDaGFubmVsSWQ6IGFjdGl2ZUNoYW5uZWwuaWQsXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBjYWNoZS53cml0ZVF1ZXJ5KHsgcXVlcnk6IEdFVF9VU0VSX1NUQVRVUywgZGF0YSB9KTtcclxuICAgICAgICAgICAgcmV0dXJuIGRhdGEudXNlclN0YXR1cztcclxuICAgICAgICB9LFxyXG4gICAgICAgIHVwZGF0ZVVzZXJDaGFubmVsczogKF8sIGFyZ3M6IENvZGVnZW4uVXBkYXRlVXNlckNoYW5uZWxzTXV0YXRpb25WYXJpYWJsZXMsIHsgY2FjaGUgfSk6IFVzZXJTdGF0dXMgPT4ge1xyXG4gICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L25vLW5vbi1udWxsLWFzc2VydGlvblxyXG4gICAgICAgICAgICBjb25zdCBwcmV2aW91cyA9IGNhY2hlLnJlYWRRdWVyeTxHZXRVc2VyU3RhdHVzUXVlcnk+KHsgcXVlcnk6IEdFVF9VU0VSX1NUQVRVUyB9KSE7XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGEgPSB7XHJcbiAgICAgICAgICAgICAgICB1c2VyU3RhdHVzOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgLi4ucHJldmlvdXMudXNlclN0YXR1cyxcclxuICAgICAgICAgICAgICAgICAgICBjaGFubmVsczogQXJyYXkuaXNBcnJheShhcmdzLmNoYW5uZWxzKSA/IGFyZ3MuY2hhbm5lbHMgOiBbYXJncy5jaGFubmVsc10sXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICBjYWNoZS53cml0ZVF1ZXJ5KHsgcXVlcnk6IEdFVF9VU0VSX1NUQVRVUywgZGF0YSB9KTtcclxuICAgICAgICAgICAgcmV0dXJuIGRhdGEudXNlclN0YXR1cztcclxuICAgICAgICB9LFxyXG4gICAgfSxcclxufTtcclxuXHJcbmZ1bmN0aW9uIHVwZGF0ZVVpU3RhdGU8SyBleHRlbmRzIGtleW9mIENvZGVnZW4uR2V0VWlTdGF0ZVF1ZXJ5Wyd1aVN0YXRlJ10+KFxyXG4gICAgcHJldmlvdXM6IENvZGVnZW4uR2V0VWlTdGF0ZVF1ZXJ5LFxyXG4gICAga2V5OiBLLFxyXG4gICAgdmFsdWU6IENvZGVnZW4uR2V0VWlTdGF0ZVF1ZXJ5Wyd1aVN0YXRlJ11bS10sXHJcbik6IENvZGVnZW4uR2V0VWlTdGF0ZVF1ZXJ5IHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgdWlTdGF0ZToge1xyXG4gICAgICAgICAgICAuLi5wcmV2aW91cy51aVN0YXRlLFxyXG4gICAgICAgICAgICBba2V5XTogdmFsdWUsXHJcbiAgICAgICAgICAgIF9fdHlwZW5hbWU6ICdVaVN0YXRlJyxcclxuICAgICAgICB9LFxyXG4gICAgfTtcclxufVxyXG5cclxuZnVuY3Rpb24gdXBkYXRlUmVxdWVzdHNJbkZsaWdodChjYWNoZTogSW5NZW1vcnlDYWNoZSwgaW5jcmVtZW50OiAxIHwgLTEpOiBudW1iZXIge1xyXG4gICAgY29uc3QgcHJldmlvdXMgPSBjYWNoZS5yZWFkUXVlcnk8Q29kZWdlbi5HZXROZXR3b3JrU3RhdHVzUXVlcnk+KHsgcXVlcnk6IEdFVF9ORVdUT1JLX1NUQVRVUyB9KTtcclxuICAgIGNvbnN0IGluRmxpZ2h0UmVxdWVzdHMgPSBwcmV2aW91cyA/IHByZXZpb3VzLm5ldHdvcmtTdGF0dXMuaW5GbGlnaHRSZXF1ZXN0cyArIGluY3JlbWVudCA6IGluY3JlbWVudDtcclxuICAgIGNvbnN0IGRhdGE6IENvZGVnZW4uR2V0TmV0d29ya1N0YXR1c1F1ZXJ5ID0ge1xyXG4gICAgICAgIG5ldHdvcmtTdGF0dXM6IHtcclxuICAgICAgICAgICAgX190eXBlbmFtZTogJ05ldHdvcmtTdGF0dXMnLFxyXG4gICAgICAgICAgICBpbkZsaWdodFJlcXVlc3RzLFxyXG4gICAgICAgIH0sXHJcbiAgICB9O1xyXG4gICAgY2FjaGUud3JpdGVRdWVyeSh7IHF1ZXJ5OiBHRVRfTkVXVE9SS19TVEFUVVMsIGRhdGEgfSk7XHJcbiAgICByZXR1cm4gaW5GbGlnaHRSZXF1ZXN0cztcclxufVxyXG4iXX0=