import { HTTP_INTERCEPTORS, HttpClientModule } from '@angular/common/http';
import { APP_INITIALIZER, Injector, NgModule } from '@angular/core';
import { InMemoryCache } from '@apollo/client/core';
import { setContext } from '@apollo/client/link/context';
import { ApolloLink } from '@apollo/client/link/core';
import { APOLLO_OPTIONS, ApolloModule } from 'apollo-angular';
import createUploadLink from 'apollo-upload-client/createUploadLink.mjs';
import { getAppConfig } from '../app.config';
import { introspectionResult } from '../common/introspection-result-wrapper';
import { LocalStorageService } from '../providers/local-storage/local-storage.service';
import { CheckJobsLink } from './check-jobs-link';
import { getClientDefaults } from './client-state/client-defaults';
import { clientResolvers } from './client-state/client-resolvers';
import { GET_CLIENT_STATE } from './definitions/client-definitions';
import { OmitTypenameLink } from './omit-typename-link';
import { BaseDataService } from './providers/base-data.service';
import { DataService } from './providers/data.service';
import { FetchAdapter } from './providers/fetch-adapter';
import { DefaultInterceptor } from './providers/interceptor';
import { initializeServerConfigService, ServerConfigService } from './server-config';
import { getServerLocation } from './utils/get-server-location';
import * as i0 from "@angular/core";
export function createApollo(localStorageService, fetchAdapter, injector) {
    const { adminApiPath, tokenMethod, channelTokenKey } = getAppConfig();
    const serverLocation = getServerLocation();
    const apolloCache = new InMemoryCache({
        possibleTypes: introspectionResult.possibleTypes,
        typePolicies: {
            GlobalSettings: {
                fields: {
                    serverConfig: {
                        merge: (existing, incoming) => ({ ...existing, ...incoming }),
                    },
                },
            },
            Facet: {
                fields: {
                    values: {
                        merge: (existing, incoming) => incoming,
                    },
                },
            },
        },
    });
    apolloCache.writeQuery({
        query: GET_CLIENT_STATE,
        data: getClientDefaults(localStorageService),
    });
    if (!false) {
        // TODO: enable only for dev mode
        // make the Apollo Cache inspectable in the console for debug purposes
        window['apolloCache'] = apolloCache;
    }
    return {
        link: ApolloLink.from([
            new OmitTypenameLink(),
            new CheckJobsLink(injector),
            setContext(() => {
                const headers = {};
                const channelToken = localStorageService.get('activeChannelToken');
                if (channelToken) {
                    headers[channelTokenKey ?? 'vendure-token'] = channelToken;
                }
                if (tokenMethod === 'bearer') {
                    const authToken = localStorageService.get('authToken');
                    if (authToken) {
                        headers.authorization = `Bearer ${authToken}`;
                    }
                }
                headers['Apollo-Require-Preflight'] = 'true';
                return { headers };
            }),
            createUploadLink({
                uri: `${serverLocation}/${adminApiPath}`,
                fetch: fetchAdapter.fetch,
            }),
        ]),
        cache: apolloCache,
        resolvers: clientResolvers,
    };
}
// List of all EU countries
/**
 * The DataModule is responsible for all API calls *and* serves as the source of truth for global app
 * state via the apollo-link-state package.
 */
export class DataModule {
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: DataModule, deps: [], target: i0.ɵɵFactoryTarget.NgModule }); }
    static { this.ɵmod = i0.ɵɵngDeclareNgModule({ minVersion: "14.0.0", version: "17.2.4", ngImport: i0, type: DataModule, imports: [HttpClientModule, ApolloModule] }); }
    static { this.ɵinj = i0.ɵɵngDeclareInjector({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: DataModule, providers: [
            BaseDataService,
            DataService,
            FetchAdapter,
            ServerConfigService,
            {
                provide: APOLLO_OPTIONS,
                useFactory: createApollo,
                deps: [LocalStorageService, FetchAdapter, Injector],
            },
            { provide: HTTP_INTERCEPTORS, useClass: DefaultInterceptor, multi: true },
            {
                provide: APP_INITIALIZER,
                multi: true,
                useFactory: initializeServerConfigService,
                deps: [ServerConfigService],
            },
        ], imports: [HttpClientModule, ApolloModule] }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: DataModule, decorators: [{
            type: NgModule,
            args: [{
                    imports: [HttpClientModule, ApolloModule],
                    exports: [],
                    declarations: [],
                    providers: [
                        BaseDataService,
                        DataService,
                        FetchAdapter,
                        ServerConfigService,
                        {
                            provide: APOLLO_OPTIONS,
                            useFactory: createApollo,
                            deps: [LocalStorageService, FetchAdapter, Injector],
                        },
                        { provide: HTTP_INTERCEPTORS, useClass: DefaultInterceptor, multi: true },
                        {
                            provide: APP_INITIALIZER,
                            multi: true,
                            useFactory: initializeServerConfigService,
                            deps: [ServerConfigService],
                        },
                    ],
                }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS5tb2R1bGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9zcmMvbGliL2NvcmUvc3JjL2RhdGEvZGF0YS5tb2R1bGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLGlCQUFpQixFQUFFLGdCQUFnQixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDM0UsT0FBTyxFQUFFLGVBQWUsRUFBRSxRQUFRLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ3BFLE9BQU8sRUFBdUIsYUFBYSxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDekUsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLDZCQUE2QixDQUFDO0FBQ3pELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUN0RCxPQUFPLEVBQUUsY0FBYyxFQUFFLFlBQVksRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzlELE9BQU8sZ0JBQWdCLE1BQU0sMkNBQTJDLENBQUM7QUFFekUsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM3QyxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSx3Q0FBd0MsQ0FBQztBQUM3RSxPQUFPLEVBQUUsbUJBQW1CLEVBQUUsTUFBTSxrREFBa0QsQ0FBQztBQUV2RixPQUFPLEVBQUUsYUFBYSxFQUFFLE1BQU0sbUJBQW1CLENBQUM7QUFDbEQsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0sZ0NBQWdDLENBQUM7QUFDbkUsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQ2xFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGtDQUFrQyxDQUFDO0FBQ3BFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUNoRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0s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cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSFRUUF9JTlRFUkNFUFRPUlMsIEh0dHBDbGllbnRNb2R1bGUgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XHJcbmltcG9ydCB7IEFQUF9JTklUSUFMSVpFUiwgSW5qZWN0b3IsIE5nTW9kdWxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEFwb2xsb0NsaWVudE9wdGlvbnMsIEluTWVtb3J5Q2FjaGUgfSBmcm9tICdAYXBvbGxvL2NsaWVudC9jb3JlJztcclxuaW1wb3J0IHsgc2V0Q29udGV4dCB9IGZyb20gJ0BhcG9sbG8vY2xpZW50L2xpbmsvY29udGV4dCc7XHJcbmltcG9ydCB7IEFwb2xsb0xpbmsgfSBmcm9tICdAYXBvbGxvL2NsaWVudC9saW5rL2NvcmUnO1xyXG5pbXBvcnQgeyBBUE9MTE9fT1BUSU9OUywgQXBvbGxvTW9kdWxlIH0gZnJvbSAnYXBvbGxvLWFuZ3VsYXInO1xyXG5pbXBvcnQgY3JlYXRlVXBsb2FkTGluayBmcm9tICdhcG9sbG8tdXBsb2FkLWNsaWVudC9jcmVhdGVVcGxvYWRMaW5rLm1qcyc7XHJcblxyXG5pbXBvcnQgeyBnZXRBcHBDb25maWcgfSBmcm9tICcuLi9hcHAuY29uZmlnJztcclxuaW1wb3J0IHsgaW50cm9zcGVjdGlvblJlc3VsdCB9IGZyb20gJy4uL2NvbW1vbi9pbnRyb3NwZWN0aW9uLXJlc3VsdC13cmFwcGVyJztcclxuaW1wb3J0IHsgTG9jYWxTdG9yYWdlU2VydmljZSB9IGZyb20gJy4uL3Byb3ZpZGVycy9sb2NhbC1zdG9yYWdlL2xvY2FsLXN0b3JhZ2Uuc2VydmljZSc7XHJcblxyXG5pbXBvcnQgeyBDaGVja0pvYnNMaW5rIH0gZnJvbSAnLi9jaGVjay1qb2JzLWxpbmsnO1xyXG5pbXBvcnQgeyBnZXRDbGllbnREZWZhdWx0cyB9IGZyb20gJy4vY2xpZW50LXN0YXRlL2NsaWVudC1kZWZhdWx0cyc7XHJcbmltcG9ydCB7IGNsaWVudFJlc29sdmVycyB9IGZyb20gJy4vY2xpZW50LXN0YXRlL2NsaWVudC1yZXNvbHZlcnMnO1xyXG5pbXBvcnQgeyBHRVRfQ0xJRU5UX1NUQVRFIH0gZnJvbSAnLi9kZWZpbml0aW9ucy9jbGllbnQtZGVmaW5pdGlvbnMnO1xyXG5pbXBvcnQgeyBPbWl0VHlwZW5hbWVMaW5rIH0gZnJvbSAnLi9vbWl0LXR5cGVuYW1lLWxpbmsnO1xyXG5pbXBvcnQgeyBCYXNlRGF0YVNlcnZpY2UgfSBmcm9tICcuL3Byb3ZpZGVycy9iYXNlLWRhdGEuc2VydmljZSc7XHJcbmltcG9ydCB7IERhdGFTZXJ2aWNlIH0gZnJvbSAnLi9wcm92aWRlcnMvZGF0YS5zZXJ2aWNlJztcclxuaW1wb3J0IHsgRmV0Y2hBZGFwdGVyIH0gZnJvbSAnLi9wcm92aWRlcnMvZmV0Y2gtYWRhcHRlcic7XHJcbmltcG9ydCB7IERlZmF1bHRJbnRlcmNlcHRvciB9IGZyb20gJy4vcHJvdmlkZXJzL2ludGVyY2VwdG9yJztcclxuaW1wb3J0IHsgaW5pdGlhbGl6ZVNlcnZlckNvbmZpZ1NlcnZpY2UsIFNlcnZlckNvbmZpZ1NlcnZpY2UgfSBmcm9tICcuL3NlcnZlci1jb25maWcnO1xyXG5pbXBvcnQgeyBnZXRTZXJ2ZXJMb2NhdGlvbiB9IGZyb20gJy4vdXRpbHMvZ2V0LXNlcnZlci1sb2NhdGlvbic7XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlQXBvbGxvKFxyXG4gICAgbG9jYWxTdG9yYWdlU2VydmljZTogTG9jYWxTdG9yYWdlU2VydmljZSxcclxuICAgIGZldGNoQWRhcHRlcjogRmV0Y2hBZGFwdGVyLFxyXG4gICAgaW5qZWN0b3I6IEluamVjdG9yLFxyXG4pOiBBcG9sbG9DbGllbnRPcHRpb25zPGFueT4ge1xyXG4gICAgY29uc3QgeyBhZG1pbkFwaVBhdGgsIHRva2VuTWV0aG9kLCBjaGFubmVsVG9rZW5LZXkgfSA9IGdldEFwcENvbmZpZygpO1xyXG4gICAgY29uc3Qgc2VydmVyTG9jYXRpb24gPSBnZXRTZXJ2ZXJMb2NhdGlvbigpO1xyXG4gICAgY29uc3QgYXBvbGxvQ2FjaGUgPSBuZXcgSW5NZW1vcnlDYWNoZSh7XHJcbiAgICAgICAgcG9zc2libGVUeXBlczogaW50cm9zcGVjdGlvblJlc3VsdC5wb3NzaWJsZVR5cGVzLFxyXG4gICAgICAgIHR5cGVQb2xpY2llczoge1xyXG4gICAgICAgICAgICBHbG9iYWxTZXR0aW5nczoge1xyXG4gICAgICAgICAgICAgICAgZmllbGRzOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2VydmVyQ29uZmlnOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG1lcmdlOiAoZXhpc3RpbmcsIGluY29taW5nKSA9PiAoeyAuLi5leGlzdGluZywgLi4uaW5jb21pbmcgfSksXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIEZhY2V0OiB7XHJcbiAgICAgICAgICAgICAgICBmaWVsZHM6IHtcclxuICAgICAgICAgICAgICAgICAgICB2YWx1ZXM6IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWVyZ2U6IChleGlzdGluZywgaW5jb21pbmcpID0+IGluY29taW5nLFxyXG4gICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICB9LFxyXG4gICAgICAgIH0sXHJcbiAgICB9KTtcclxuICAgIGFwb2xsb0NhY2hlLndyaXRlUXVlcnkoe1xyXG4gICAgICAgIHF1ZXJ5OiBHRVRfQ0xJRU5UX1NUQVRFLFxyXG4gICAgICAgIGRhdGE6IGdldENsaWVudERlZmF1bHRzKGxvY2FsU3RvcmFnZVNlcnZpY2UpLFxyXG4gICAgfSk7XHJcblxyXG4gICAgaWYgKCFmYWxzZSkge1xyXG4gICAgICAgIC8vIFRPRE86IGVuYWJsZSBvbmx5IGZvciBkZXYgbW9kZVxyXG4gICAgICAgIC8vIG1ha2UgdGhlIEFwb2xsbyBDYWNoZSBpbnNwZWN0YWJsZSBpbiB0aGUgY29uc29sZSBmb3IgZGVidWcgcHVycG9zZXNcclxuICAgICAgICAod2luZG93IGFzIGFueSlbJ2Fwb2xsb0NhY2hlJ10gPSBhcG9sbG9DYWNoZTtcclxuICAgIH1cclxuICAgIHJldHVybiB7XHJcbiAgICAgICAgbGluazogQXBvbGxvTGluay5mcm9tKFtcclxuICAgICAgICAgICAgbmV3IE9taXRUeXBlbmFtZUxpbmsoKSxcclxuICAgICAgICAgICAgbmV3IENoZWNrSm9ic0xpbmsoaW5qZWN0b3IpLFxyXG4gICAgICAgICAgICBzZXRDb250ZXh0KCgpID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGhlYWRlcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNoYW5uZWxUb2tlbiA9IGxvY2FsU3RvcmFnZVNlcnZpY2UuZ2V0KCdhY3RpdmVDaGFubmVsVG9rZW4nKTtcclxuICAgICAgICAgICAgICAgIGlmIChjaGFubmVsVG9rZW4pIHtcclxuICAgICAgICAgICAgICAgICAgICBoZWFkZXJzW2NoYW5uZWxUb2tlbktleSA/PyAndmVuZHVyZS10b2tlbiddID0gY2hhbm5lbFRva2VuO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgaWYgKHRva2VuTWV0aG9kID09PSAnYmVhcmVyJykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGF1dGhUb2tlbiA9IGxvY2FsU3RvcmFnZVNlcnZpY2UuZ2V0KCdhdXRoVG9rZW4nKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoYXV0aFRva2VuKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnMuYXV0aG9yaXphdGlvbiA9IGBCZWFyZXIgJHthdXRoVG9rZW59YDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICBoZWFkZXJzWydBcG9sbG8tUmVxdWlyZS1QcmVmbGlnaHQnXSA9ICd0cnVlJztcclxuICAgICAgICAgICAgICAgIHJldHVybiB7IGhlYWRlcnMgfTtcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgIGNyZWF0ZVVwbG9hZExpbmsoe1xyXG4gICAgICAgICAgICAgICAgdXJpOiBgJHtzZXJ2ZXJMb2NhdGlvbn0vJHthZG1pbkFwaVBhdGh9YCxcclxuICAgICAgICAgICAgICAgIGZldGNoOiBmZXRjaEFkYXB0ZXIuZmV0Y2gsXHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgIF0pLFxyXG4gICAgICAgIGNhY2hlOiBhcG9sbG9DYWNoZSxcclxuICAgICAgICByZXNvbHZlcnM6IGNsaWVudFJlc29sdmVycyxcclxuICAgIH07XHJcbn1cclxuXHJcbi8vIExpc3Qgb2YgYWxsIEVVIGNvdW50cmllc1xyXG5cclxuLyoqXHJcbiAqIFRoZSBEYXRhTW9kdWxlIGlzIHJlc3BvbnNpYmxlIGZvciBhbGwgQVBJIGNhbGxzICphbmQqIHNlcnZlcyBhcyB0aGUgc291cmNlIG9mIHRydXRoIGZvciBnbG9iYWwgYXBwXHJcbiAqIHN0YXRlIHZpYSB0aGUgYXBvbGxvLWxpbmstc3RhdGUgcGFja2FnZS5cclxuICovXHJcbkBOZ01vZHVsZSh7XHJcbiAgICBpbXBvcnRzOiBbSHR0cENsaWVudE1vZHVsZSwgQXBvbGxvTW9kdWxlXSxcclxuICAgIGV4cG9ydHM6IFtdLFxyXG4gICAgZGVjbGFyYXRpb25zOiBbXSxcclxuICAgIHByb3ZpZGVyczogW1xyXG4gICAgICAgIEJhc2VEYXRhU2VydmljZSxcclxuICAgICAgICBEYXRhU2VydmljZSxcclxuICAgICAgICBGZXRjaEFkYXB0ZXIsXHJcbiAgICAgICAgU2VydmVyQ29uZmlnU2VydmljZSxcclxuICAgICAgICB7XHJcbiAgICAgICAgICAgIHByb3ZpZGU6IEFQT0xMT19PUFRJT05TLFxyXG4gICAgICAgICAgICB1c2VGYWN0b3J5OiBjcmVhdGVBcG9sbG8sXHJcbiAgICAgICAgICAgIGRlcHM6IFtMb2NhbFN0b3JhZ2VTZXJ2aWNlLCBGZXRjaEFkYXB0ZXIsIEluamVjdG9yXSxcclxuICAgICAgICB9LFxyXG4gICAgICAgIHsgcHJvdmlkZTogSFRUUF9JTlRFUkNFUFRPUlMsIHVzZUNsYXNzOiBEZWZhdWx0SW50ZXJjZXB0b3IsIG11bHRpOiB0cnVlIH0sXHJcbiAgICAgICAge1xyXG4gICAgICAgICAgICBwcm92aWRlOiBBUFBfSU5JVElBTElaRVIsXHJcbiAgICAgICAgICAgIG11bHRpOiB0cnVlLFxyXG4gICAgICAgICAgICB1c2VGYWN0b3J5OiBpbml0aWFsaXplU2VydmVyQ29uZmlnU2VydmljZSxcclxuICAgICAgICAgICAgZGVwczogW1NlcnZlckNvbmZpZ1NlcnZpY2VdLFxyXG4gICAgICAgIH0sXHJcbiAgICBdLFxyXG59KVxyXG5leHBvcnQgY2xhc3MgRGF0YU1vZHVsZSB7fVxyXG4iXX0=