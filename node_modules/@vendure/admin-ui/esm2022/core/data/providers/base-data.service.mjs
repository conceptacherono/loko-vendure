import { Injectable } from '@angular/core';
import { simpleDeepClone } from '@vendure/common/lib/simple-deep-clone';
import { map } from 'rxjs/operators';
import { QueryResult } from '../query-result';
import { addCustomFields } from '../utils/add-custom-fields';
import { isEntityCreateOrUpdateMutation } from '../utils/is-entity-create-or-update-mutation';
import { removeReadonlyCustomFields } from '../utils/remove-readonly-custom-fields';
import { transformRelationCustomFieldInputs } from '../utils/transform-relation-custom-field-inputs';
import * as i0 from "@angular/core";
import * as i1 from "apollo-angular";
import * as i2 from "../server-config";
export class BaseDataService {
    constructor(apollo, serverConfigService) {
        this.apollo = apollo;
        this.serverConfigService = serverConfigService;
    }
    get customFields() {
        return this.serverConfigService.customFieldsMap;
    }
    /**
     * Performs a GraphQL watch query
     */
    query(query, variables, fetchPolicy = 'cache-and-network', options = {}) {
        const queryRef = this.apollo.watchQuery({
            query: addCustomFields(query, this.customFields, options.includeCustomFields),
            variables,
            fetchPolicy,
        });
        const queryResult = new QueryResult(queryRef, this.apollo, this.customFields);
        return queryResult;
    }
    /**
     * Performs a GraphQL mutation
     */
    mutate(mutation, variables, update, options = {}) {
        const withCustomFields = addCustomFields(mutation, this.customFields, options.includeCustomFields);
        const withoutReadonlyFields = this.prepareCustomFields(mutation, variables);
        return this.apollo
            .mutate({
            mutation: withCustomFields,
            variables: withoutReadonlyFields,
            update,
        })
            .pipe(map(result => result.data));
    }
    prepareCustomFields(mutation, variables) {
        const entity = isEntityCreateOrUpdateMutation(mutation);
        if (entity) {
            const customFieldConfig = this.customFields.get(entity);
            if (variables && customFieldConfig) {
                let variablesClone = simpleDeepClone(variables);
                variablesClone = removeReadonlyCustomFields(variablesClone, customFieldConfig);
                variablesClone = transformRelationCustomFieldInputs(variablesClone, customFieldConfig);
                return variablesClone;
            }
        }
        return variables;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: BaseDataService, deps: [{ token: i1.Apollo }, { token: i2.ServerConfigService }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: BaseDataService }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: BaseDataService, decorators: [{
            type: Injectable
        }], ctorParameters: () => [{ type: i1.Apollo }, { type: i2.ServerConfigService }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS1kYXRhLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvbGliL2NvcmUvc3JjL2RhdGEvcHJvdmlkZXJzL2Jhc2UtZGF0YS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFHM0MsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLHVDQUF1QyxDQUFDO0FBSXhFLE9BQU8sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUdyQyxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFOUMsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLDRCQUE0QixDQUFDO0FBQzdELE9BQU8sRUFBRSw4QkFBOEIsRUFBRSxNQUFNLDhDQUE4QyxDQUFDO0FBQzlGLE9BQU8sRUFBRSwwQkFBMEIsRUFBRSxNQUFNLHdDQUF3QyxDQUFDO0FBQ3BGLE9BQU8sRUFBRSxrQ0FBa0MsRUFBRSxNQUFNLGlEQUFpRCxDQUFDOzs7O0FBcUJyRyxNQUFNLE9BQU8sZUFBZTtJQUN4QixZQUNZLE1BQWMsRUFDZCxtQkFBd0M7UUFEeEMsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUNkLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7SUFDakQsQ0FBQztJQUVKLElBQVksWUFBWTtRQUNwQixPQUFPLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxlQUFlLENBQUM7SUFDcEQsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUNELEtBQTZDLEVBQzdDLFNBQWEsRUFDYixjQUFxQyxtQkFBbUIsRUFDeEQsVUFBZ0MsRUFBRTtRQUVsQyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLFVBQVUsQ0FBTztZQUMxQyxLQUFLLEVBQUUsZUFBZSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsWUFBWSxFQUFFLE9BQU8sQ0FBQyxtQkFBbUIsQ0FBQztZQUM3RSxTQUFTO1lBQ1QsV0FBVztTQUNkLENBQUMsQ0FBQztRQUVILE1BQU0sV0FBVyxHQUFHLElBQUksV0FBVyxDQUFPLFFBQVEsRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQztRQUNwRixPQUFPLFdBQVcsQ0FBQztJQUN2QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQ0YsUUFBZ0QsRUFDaEQsU0FBYSxFQUNiLE1BQTZCLEVBQzdCLFVBQWdDLEVBQUU7UUFFbEMsTUFBTSxnQkFBZ0IsR0FBRyxlQUFlLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxZQUFZLEVBQUUsT0FBTyxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDbkcsTUFBTSxxQkFBcUIsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsUUFBUSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBRTVFLE9BQU8sSUFBSSxDQUFDLE1BQU07YUFDYixNQUFNLENBQU87WUFDVixRQUFRLEVBQUUsZ0JBQWdCO1lBQzFCLFNBQVMsRUFBRSxxQkFBcUI7WUFDaEMsTUFBTTtTQUNULENBQUM7YUFDRCxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUUsTUFBZ0MsQ0FBQyxJQUFTLENBQUMsQ0FBQyxDQUFDO0lBQzFFLENBQUM7SUFFTyxtQkFBbUIsQ0FBSSxRQUFzQixFQUFFLFNBQVk7UUFDL0QsTUFBTSxNQUFNLEdBQUcsOEJBQThCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDeEQsSUFBSSxNQUFNLEVBQUUsQ0FBQztZQUNULE1BQU0saUJBQWlCLEdBQUcsSUFBSSxDQUFDLFlBQVksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDeEQsSUFBSSxTQUFTLElBQUksaUJBQWlCLEVBQUUsQ0FBQztnQkFDakMsSUFBSSxjQUFjLEdBQUcsZUFBZSxDQUFDLFNBQWdCLENBQUMsQ0FBQztnQkFDdkQsY0FBYyxHQUFHLDBCQUEwQixDQUFDLGNBQWMsRUFBRSxpQkFBaUIsQ0FBQyxDQUFDO2dCQUMvRSxjQUFjLEdBQUcsa0NBQWtDLENBQUMsY0FBYyxFQUFFLGlCQUFpQixDQUFDLENBQUM7Z0JBQ3ZGLE9BQU8sY0FBYyxDQUFDO1lBQzFCLENBQUM7UUFDTCxDQUFDO1FBQ0QsT0FBTyxTQUFTLENBQUM7SUFDckIsQ0FBQzs4R0E5RFEsZUFBZTtrSEFBZixlQUFlOzsyRkFBZixlQUFlO2tCQUQzQixVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBNdXRhdGlvblVwZGF0ZXJGbiwgU2luZ2xlRXhlY3V0aW9uUmVzdWx0LCBXYXRjaFF1ZXJ5RmV0Y2hQb2xpY3kgfSBmcm9tICdAYXBvbGxvL2NsaWVudC9jb3JlJztcclxuaW1wb3J0IHsgVHlwZWREb2N1bWVudE5vZGUgfSBmcm9tICdAZ3JhcGhxbC10eXBlZC1kb2N1bWVudC1ub2RlL2NvcmUnO1xyXG5pbXBvcnQgeyBzaW1wbGVEZWVwQ2xvbmUgfSBmcm9tICdAdmVuZHVyZS9jb21tb24vbGliL3NpbXBsZS1kZWVwLWNsb25lJztcclxuaW1wb3J0IHsgQXBvbGxvIH0gZnJvbSAnYXBvbGxvLWFuZ3VsYXInO1xyXG5pbXBvcnQgeyBEb2N1bWVudE5vZGUgfSBmcm9tICdncmFwaHFsL2xhbmd1YWdlL2FzdCc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgbWFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xyXG5cclxuaW1wb3J0IHsgQ3VzdG9tRmllbGRDb25maWcgfSBmcm9tICcuLi8uLi9jb21tb24vZ2VuZXJhdGVkLXR5cGVzJztcclxuaW1wb3J0IHsgUXVlcnlSZXN1bHQgfSBmcm9tICcuLi9xdWVyeS1yZXN1bHQnO1xyXG5pbXBvcnQgeyBTZXJ2ZXJDb25maWdTZXJ2aWNlIH0gZnJvbSAnLi4vc2VydmVyLWNvbmZpZyc7XHJcbmltcG9ydCB7IGFkZEN1c3RvbUZpZWxkcyB9IGZyb20gJy4uL3V0aWxzL2FkZC1jdXN0b20tZmllbGRzJztcclxuaW1wb3J0IHsgaXNFbnRpdHlDcmVhdGVPclVwZGF0ZU11dGF0aW9uIH0gZnJvbSAnLi4vdXRpbHMvaXMtZW50aXR5LWNyZWF0ZS1vci11cGRhdGUtbXV0YXRpb24nO1xyXG5pbXBvcnQgeyByZW1vdmVSZWFkb25seUN1c3RvbUZpZWxkcyB9IGZyb20gJy4uL3V0aWxzL3JlbW92ZS1yZWFkb25seS1jdXN0b20tZmllbGRzJztcclxuaW1wb3J0IHsgdHJhbnNmb3JtUmVsYXRpb25DdXN0b21GaWVsZElucHV0cyB9IGZyb20gJy4uL3V0aWxzL3RyYW5zZm9ybS1yZWxhdGlvbi1jdXN0b20tZmllbGQtaW5wdXRzJztcclxuXHJcbi8qKlxyXG4gKiBAZGVzY3JpcHRpb25cclxuICogQWRkaXRpb25hbCBvcHRpb25zIHRoYXQgY2FuIGJlIHBhc3NlZCB0byB0aGUgYHF1ZXJ5YCBhbmQgYG11dGF0ZWAgbWV0aG9kcy5cclxuICpcclxuICogQHNpbmNlIDMuMC40XHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIEV4dGVuZGVkUXVlcnlPcHRpb25zIHtcclxuICAgIC8qKlxyXG4gICAgICogQGRlc2NyaXB0aW9uXHJcbiAgICAgKiBBbiBhcnJheSBvZiBjdXN0b20gZmllbGQgbmFtZXMgd2hpY2ggc2hvdWxkIGJlIGluY2x1ZGVkIGluIHRoZSBxdWVyeSBvciBtdXRhdGlvblxyXG4gICAgICogcmV0dXJuIGRhdGEuIFRoZSBhdXRvbWF0aWMgaW5jbHVzaW9uIG9mIGN1c3RvbSBmaWVsZHMgaXMgb25seSBzdXBwb3J0ZWQgZm9yXHJcbiAgICAgKiBlbnRpdGllcyB3aGljaCBhcmUgZGVmaW5lZCBhcyBGcmFnbWVudHMgaW4gdGhlIERvY3VtZW50Tm9kZS5cclxuICAgICAqXHJcbiAgICAgKiBAc2luY2UgMy4wLjRcclxuICAgICAqL1xyXG4gICAgaW5jbHVkZUN1c3RvbUZpZWxkcz86IHN0cmluZ1tdO1xyXG59XHJcblxyXG5ASW5qZWN0YWJsZSgpXHJcbmV4cG9ydCBjbGFzcyBCYXNlRGF0YVNlcnZpY2Uge1xyXG4gICAgY29uc3RydWN0b3IoXHJcbiAgICAgICAgcHJpdmF0ZSBhcG9sbG86IEFwb2xsbyxcclxuICAgICAgICBwcml2YXRlIHNlcnZlckNvbmZpZ1NlcnZpY2U6IFNlcnZlckNvbmZpZ1NlcnZpY2UsXHJcbiAgICApIHt9XHJcblxyXG4gICAgcHJpdmF0ZSBnZXQgY3VzdG9tRmllbGRzKCk6IE1hcDxzdHJpbmcsIEN1c3RvbUZpZWxkQ29uZmlnW10+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy5zZXJ2ZXJDb25maWdTZXJ2aWNlLmN1c3RvbUZpZWxkc01hcDtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFBlcmZvcm1zIGEgR3JhcGhRTCB3YXRjaCBxdWVyeVxyXG4gICAgICovXHJcbiAgICBxdWVyeTxULCBWIGV4dGVuZHMgUmVjb3JkPHN0cmluZywgYW55PiA9IFJlY29yZDxzdHJpbmcsIGFueT4+KFxyXG4gICAgICAgIHF1ZXJ5OiBEb2N1bWVudE5vZGUgfCBUeXBlZERvY3VtZW50Tm9kZTxULCBWPixcclxuICAgICAgICB2YXJpYWJsZXM/OiBWLFxyXG4gICAgICAgIGZldGNoUG9saWN5OiBXYXRjaFF1ZXJ5RmV0Y2hQb2xpY3kgPSAnY2FjaGUtYW5kLW5ldHdvcmsnLFxyXG4gICAgICAgIG9wdGlvbnM6IEV4dGVuZGVkUXVlcnlPcHRpb25zID0ge30sXHJcbiAgICApOiBRdWVyeVJlc3VsdDxULCBWPiB7XHJcbiAgICAgICAgY29uc3QgcXVlcnlSZWYgPSB0aGlzLmFwb2xsby53YXRjaFF1ZXJ5PFQsIFY+KHtcclxuICAgICAgICAgICAgcXVlcnk6IGFkZEN1c3RvbUZpZWxkcyhxdWVyeSwgdGhpcy5jdXN0b21GaWVsZHMsIG9wdGlvbnMuaW5jbHVkZUN1c3RvbUZpZWxkcyksXHJcbiAgICAgICAgICAgIHZhcmlhYmxlcyxcclxuICAgICAgICAgICAgZmV0Y2hQb2xpY3ksXHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIGNvbnN0IHF1ZXJ5UmVzdWx0ID0gbmV3IFF1ZXJ5UmVzdWx0PFQsIFY+KHF1ZXJ5UmVmLCB0aGlzLmFwb2xsbywgdGhpcy5jdXN0b21GaWVsZHMpO1xyXG4gICAgICAgIHJldHVybiBxdWVyeVJlc3VsdDtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFBlcmZvcm1zIGEgR3JhcGhRTCBtdXRhdGlvblxyXG4gICAgICovXHJcbiAgICBtdXRhdGU8VCwgViBleHRlbmRzIFJlY29yZDxzdHJpbmcsIGFueT4gPSBSZWNvcmQ8c3RyaW5nLCBhbnk+PihcclxuICAgICAgICBtdXRhdGlvbjogRG9jdW1lbnROb2RlIHwgVHlwZWREb2N1bWVudE5vZGU8VCwgVj4sXHJcbiAgICAgICAgdmFyaWFibGVzPzogVixcclxuICAgICAgICB1cGRhdGU/OiBNdXRhdGlvblVwZGF0ZXJGbjxUPixcclxuICAgICAgICBvcHRpb25zOiBFeHRlbmRlZFF1ZXJ5T3B0aW9ucyA9IHt9LFxyXG4gICAgKTogT2JzZXJ2YWJsZTxUPiB7XHJcbiAgICAgICAgY29uc3Qgd2l0aEN1c3RvbUZpZWxkcyA9IGFkZEN1c3RvbUZpZWxkcyhtdXRhdGlvbiwgdGhpcy5jdXN0b21GaWVsZHMsIG9wdGlvbnMuaW5jbHVkZUN1c3RvbUZpZWxkcyk7XHJcbiAgICAgICAgY29uc3Qgd2l0aG91dFJlYWRvbmx5RmllbGRzID0gdGhpcy5wcmVwYXJlQ3VzdG9tRmllbGRzKG11dGF0aW9uLCB2YXJpYWJsZXMpO1xyXG5cclxuICAgICAgICByZXR1cm4gdGhpcy5hcG9sbG9cclxuICAgICAgICAgICAgLm11dGF0ZTxULCBWPih7XHJcbiAgICAgICAgICAgICAgICBtdXRhdGlvbjogd2l0aEN1c3RvbUZpZWxkcyxcclxuICAgICAgICAgICAgICAgIHZhcmlhYmxlczogd2l0aG91dFJlYWRvbmx5RmllbGRzLFxyXG4gICAgICAgICAgICAgICAgdXBkYXRlLFxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAucGlwZShtYXAocmVzdWx0ID0+IChyZXN1bHQgYXMgU2luZ2xlRXhlY3V0aW9uUmVzdWx0KS5kYXRhIGFzIFQpKTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHByZXBhcmVDdXN0b21GaWVsZHM8Vj4obXV0YXRpb246IERvY3VtZW50Tm9kZSwgdmFyaWFibGVzOiBWKTogViB7XHJcbiAgICAgICAgY29uc3QgZW50aXR5ID0gaXNFbnRpdHlDcmVhdGVPclVwZGF0ZU11dGF0aW9uKG11dGF0aW9uKTtcclxuICAgICAgICBpZiAoZW50aXR5KSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGN1c3RvbUZpZWxkQ29uZmlnID0gdGhpcy5jdXN0b21GaWVsZHMuZ2V0KGVudGl0eSk7XHJcbiAgICAgICAgICAgIGlmICh2YXJpYWJsZXMgJiYgY3VzdG9tRmllbGRDb25maWcpIHtcclxuICAgICAgICAgICAgICAgIGxldCB2YXJpYWJsZXNDbG9uZSA9IHNpbXBsZURlZXBDbG9uZSh2YXJpYWJsZXMgYXMgYW55KTtcclxuICAgICAgICAgICAgICAgIHZhcmlhYmxlc0Nsb25lID0gcmVtb3ZlUmVhZG9ubHlDdXN0b21GaWVsZHModmFyaWFibGVzQ2xvbmUsIGN1c3RvbUZpZWxkQ29uZmlnKTtcclxuICAgICAgICAgICAgICAgIHZhcmlhYmxlc0Nsb25lID0gdHJhbnNmb3JtUmVsYXRpb25DdXN0b21GaWVsZElucHV0cyh2YXJpYWJsZXNDbG9uZSwgY3VzdG9tRmllbGRDb25maWcpO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHZhcmlhYmxlc0Nsb25lO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB2YXJpYWJsZXM7XHJcbiAgICB9XHJcbn1cclxuIl19