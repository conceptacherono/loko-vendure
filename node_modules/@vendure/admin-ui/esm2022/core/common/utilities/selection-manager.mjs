import { Subject } from 'rxjs';
/**
 * @description
 * A helper class used to manage selection of list items. Supports multiple selection via
 * cmd/ctrl/shift key.
 */
export class SelectionManager {
    constructor(options) {
        this.options = options;
        this._selection = [];
        this.items = [];
        this.selectionChangesSubject = new Subject();
        this.selectionChanges$ = this.selectionChangesSubject.asObservable();
    }
    get selection() {
        return this._selection;
    }
    setMultiSelect(isMultiSelect) {
        this.options.multiSelect = isMultiSelect;
    }
    setCurrentItems(items) {
        this.items = items;
    }
    toggleSelection(item, event) {
        const { multiSelect, itemsAreEqual, additiveMode } = this.options;
        const index = this._selection.findIndex(a => itemsAreEqual(a, item));
        if (multiSelect && event?.shiftKey && 1 <= this._selection.length) {
            const lastSelection = this._selection[this._selection.length - 1];
            const lastSelectionIndex = this.items.findIndex(a => itemsAreEqual(a, lastSelection));
            const currentIndex = this.items.findIndex(a => itemsAreEqual(a, item));
            const start = currentIndex < lastSelectionIndex ? currentIndex : lastSelectionIndex;
            const end = currentIndex > lastSelectionIndex ? currentIndex + 1 : lastSelectionIndex;
            this._selection.push(...this.items.slice(start, end).filter(a => !this._selection.find(s => itemsAreEqual(a, s))));
        }
        else if (index === -1) {
            if (multiSelect && ((event?.ctrlKey || event?.metaKey) || event?.shiftKey || additiveMode)) {
                this._selection.push(item);
            }
            else {
                this._selection = [item];
            }
        }
        else {
            if (multiSelect && (event?.ctrlKey || event?.metaKey)) {
                this._selection.splice(index, 1);
            }
            else if (1 < this._selection.length && !additiveMode) {
                this._selection = [item];
            }
            else {
                this._selection.splice(index, 1);
            }
        }
        // Make the selection mutable
        this._selection = this._selection.map(x => ({ ...x }));
        this.invokeOnSelectionChangeHandler();
    }
    selectMultiple(items) {
        this._selection = items;
        this.invokeOnSelectionChangeHandler();
    }
    clearSelection() {
        this._selection = [];
        this.invokeOnSelectionChangeHandler();
    }
    isSelected(item) {
        return !!this._selection.find(a => this.options.itemsAreEqual(a, item));
    }
    areAllCurrentItemsSelected() {
        if (!this.items || this.items.length === 0) {
            return false;
        }
        return this.items.every(a => this._selection.find(b => this.options.itemsAreEqual(a, b)));
    }
    toggleSelectAll() {
        if (this.areAllCurrentItemsSelected()) {
            this._selection = this._selection.filter(a => !this.items.find(b => this.options.itemsAreEqual(a, b)));
        }
        else {
            this._selection = this._selection.slice(0);
            for (const item of this.items) {
                if (!this._selection.find(a => this.options.itemsAreEqual(a, item))) {
                    this._selection.push(item);
                }
            }
        }
        this.invokeOnSelectionChangeHandler();
    }
    lastSelected() {
        return this._selection[this._selection.length - 1];
    }
    invokeOnSelectionChangeHandler() {
        this.selectionChangesSubject.next(this._selection);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VsZWN0aW9uLW1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvbGliL2NvcmUvc3JjL2NvbW1vbi91dGlsaXRpZXMvc2VsZWN0aW9uLW1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFjLE9BQU8sRUFBRSxNQUFNLE1BQU0sQ0FBQztBQVEzQzs7OztHQUlHO0FBQ0gsTUFBTSxPQUFPLGdCQUFnQjtJQUN6QixZQUFvQixPQUFtQztRQUFuQyxZQUFPLEdBQVAsT0FBTyxDQUE0QjtRQVUvQyxlQUFVLEdBQVEsRUFBRSxDQUFDO1FBQ3JCLFVBQUssR0FBUSxFQUFFLENBQUM7UUFDaEIsNEJBQXVCLEdBQUcsSUFBSSxPQUFPLEVBQU8sQ0FBQztRQVhqRCxJQUFJLENBQUMsaUJBQWlCLEdBQUcsSUFBSSxDQUFDLHVCQUF1QixDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ3pFLENBQUM7SUFFRCxJQUFJLFNBQVM7UUFDVCxPQUFPLElBQUksQ0FBQyxVQUFVLENBQUM7SUFDM0IsQ0FBQztJQVFELGNBQWMsQ0FBQyxhQUFzQjtRQUNqQyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsR0FBRyxhQUFhLENBQUM7SUFDN0MsQ0FBQztJQUVELGVBQWUsQ0FBQyxLQUFVO1FBQ3RCLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxlQUFlLENBQUMsSUFBTyxFQUFFLEtBQWtCO1FBQ3ZDLE1BQU0sRUFBRSxXQUFXLEVBQUUsYUFBYSxFQUFFLFlBQVksRUFBRSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7UUFDbEUsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxhQUFhLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDckUsSUFBSSxXQUFXLElBQUksS0FBSyxFQUFFLFFB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QUFDLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxhQUFhLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDLEVBQUUsQ0FBQztvQkFDbEUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQy9CLENBQUM7WUFDTCxDQUFDO1FBQ0wsQ0FBQztRQUNELElBQUksQ0FBQyw4QkFBOEIsRUFBRSxDQUFDO0lBQzFDLENBQUM7SUFFRCxZQUFZO1FBQ1IsT0FBTyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ3ZELENBQUM7SUFFTyw4QkFBOEI7UUFDbEMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDdkQsQ0FBQztDQUNKIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBTZWxlY3Rpb25NYW5hZ2VyT3B0aW9uczxUPiB7XHJcbiAgICBtdWx0aVNlbGVjdDogYm9vbGVhbjtcclxuICAgIGl0ZW1zQXJlRXF1YWw6IChhOiBULCBiOiBUKSA9PiBib29sZWFuO1xyXG4gICAgYWRkaXRpdmVNb2RlOiBib29sZWFuO1xyXG59XHJcblxyXG4vKipcclxuICogQGRlc2NyaXB0aW9uXHJcbiAqIEEgaGVscGVyIGNsYXNzIHVzZWQgdG8gbWFuYWdlIHNlbGVjdGlvbiBvZiBsaXN0IGl0ZW1zLiBTdXBwb3J0cyBtdWx0aXBsZSBzZWxlY3Rpb24gdmlhXHJcbiAqIGNtZC9jdHJsL3NoaWZ0IGtleS5cclxuICovXHJcbmV4cG9ydCBjbGFzcyBTZWxlY3Rpb25NYW5hZ2VyPFQ+IHtcclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgb3B0aW9uczogU2VsZWN0aW9uTWFuYWdlck9wdGlvbnM8VD4pIHtcclxuICAgICAgICB0aGlzLnNlbGVjdGlvbkNoYW5nZXMkID0gdGhpcy5zZWxlY3Rpb25DaGFuZ2VzU3ViamVjdC5hc09ic2VydmFibGUoKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgc2VsZWN0aW9uKCk6IFRbXSB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMuX3NlbGVjdGlvbjtcclxuICAgIH1cclxuXHJcbiAgICBzZWxlY3Rpb25DaGFuZ2VzJDogT2JzZXJ2YWJsZTxUW10+O1xyXG5cclxuICAgIHByaXZhdGUgX3NlbGVjdGlvbjogVFtdID0gW107XHJcbiAgICBwcml2YXRlIGl0ZW1zOiBUW10gPSBbXTtcclxuICAgIHByaXZhdGUgc2VsZWN0aW9uQ2hhbmdlc1N1YmplY3QgPSBuZXcgU3ViamVjdDxUW10+KCk7XHJcblxyXG4gICAgc2V0TXVsdGlTZWxlY3QoaXNNdWx0aVNlbGVjdDogYm9vbGVhbikge1xyXG4gICAgICAgIHRoaXMub3B0aW9ucy5tdWx0aVNlbGVjdCA9IGlzTXVsdGlTZWxlY3Q7XHJcbiAgICB9XHJcblxyXG4gICAgc2V0Q3VycmVudEl0ZW1zKGl0ZW1zOiBUW10pIHtcclxuICAgICAgICB0aGlzLml0ZW1zID0gaXRlbXM7XHJcbiAgICB9XHJcblxyXG4gICAgdG9nZ2xlU2VsZWN0aW9uKGl0ZW06IFQsIGV2ZW50PzogTW91c2VFdmVudCkge1xyXG4gICAgICAgIGNvbnN0IHsgbXVsdGlTZWxlY3QsIGl0ZW1zQXJlRXF1YWwsIGFkZGl0aXZlTW9kZSB9ID0gdGhpcy5vcHRpb25zO1xyXG4gICAgICAgIGNvbnN0IGluZGV4ID0gdGhpcy5fc2VsZWN0aW9uLmZpbmRJbmRleChhID0+IGl0ZW1zQXJlRXF1YWwoYSwgaXRlbSkpO1xyXG4gICAgICAgIGlmIChtdWx0aVNlbGVjdCAmJiBldmVudD8uc2hpZnRLZXkgJiYgMSA8PSB0aGlzLl9zZWxlY3Rpb24ubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgIGNvbnN0IGxhc3RTZWxlY3Rpb24gPSB0aGlzLl9zZWxlY3Rpb25bdGhpcy5fc2VsZWN0aW9uLmxlbmd0aCAtIDFdO1xyXG4gICAgICAgICAgICBjb25zdCBsYXN0U2VsZWN0aW9uSW5kZXggPSB0aGlzLml0ZW1zLmZpbmRJbmRleChhID0+IGl0ZW1zQXJlRXF1YWwoYSwgbGFzdFNlbGVjdGlvbikpO1xyXG4gICAgICAgICAgICBjb25zdCBjdXJyZW50SW5kZXggPSB0aGlzLml0ZW1zLmZpbmRJbmRleChhID0+IGl0ZW1zQXJlRXF1YWwoYSwgaXRlbSkpO1xyXG4gICAgICAgICAgICBjb25zdCBzdGFydCA9IGN1cnJlbnRJbmRleCA8IGxhc3RTZWxlY3Rpb25JbmRleCA/IGN1cnJlbnRJbmRleCA6IGxhc3RTZWxlY3Rpb25JbmRleDtcclxuICAgICAgICAgICAgY29uc3QgZW5kID0gY3VycmVudEluZGV4ID4gbGFzdFNlbGVjdGlvbkluZGV4ID8gY3VycmVudEluZGV4ICsgMSA6IGxhc3RTZWxlY3Rpb25JbmRleDtcclxuICAgICAgICAgICAgdGhpcy5fc2VsZWN0aW9uLnB1c2goXHJcbiAgICAgICAgICAgICAgICAuLi50aGlzLml0ZW1zLnNsaWNlKHN0YXJ0LCBlbmQpLmZpbHRlcihhID0+ICF0aGlzLl9zZWxlY3Rpb24uZmluZChzID0+IGl0ZW1zQXJlRXF1YWwoYSwgcykpKSxcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9IGVsc2UgaWYgKGluZGV4ID09PSAtMSkge1xyXG4gICAgICAgICAgICBpZiAobXVsdGlTZWxlY3QgJiYgKChldmVudD8uY3RybEtleSB8fCBldmVudD8ubWV0YUtleSkgfHwgZXZlbnQ/LnNoaWZ0S2V5IHx8IGFkZGl0aXZlTW9kZSkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3NlbGVjdGlvbi5wdXNoKGl0ZW0pO1xyXG4gICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5fc2VsZWN0aW9uID0gW2l0ZW1dO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgaWYgKG11bHRpU2VsZWN0ICYmIChldmVudD8uY3RybEtleSB8fCBldmVudD8ubWV0YUtleSkpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3NlbGVjdGlvbi5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgICAgICAgICB9IGVsc2UgaWYgKDEgPCB0aGlzLl9zZWxlY3Rpb24ubGVuZ3RoICYmICFhZGRpdGl2ZU1vZGUpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3NlbGVjdGlvbiA9IFtpdGVtXTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMuX3NlbGVjdGlvbi5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIC8vIE1ha2UgdGhlIHNlbGVjdGlvbiBtdXRhYmxlXHJcbiAgICAgICAgdGhpcy5fc2VsZWN0aW9uID0gdGhpcy5fc2VsZWN0aW9uLm1hcCh4ID0+ICh7IC4uLnggfSkpO1xyXG4gICAgICAgIHRoaXMuaW52b2tlT25TZWxlY3Rpb25DaGFuZ2VIYW5kbGVyKCk7XHJcbiAgICB9XHJcblxyXG4gICAgc2VsZWN0TXVsdGlwbGUoaXRlbXM6IFRbXSkge1xyXG4gICAgICAgIHRoaXMuX3NlbGVjdGlvbiA9IGl0ZW1zO1xyXG4gICAgICAgIHRoaXMuaW52b2tlT25TZWxlY3Rpb25DaGFuZ2VIYW5kbGVyKCk7XHJcbiAgICB9XHJcblxyXG4gICAgY2xlYXJTZWxlY3Rpb24oKSB7XHJcbiAgICAgICAgdGhpcy5fc2VsZWN0aW9uID0gW107XHJcbiAgICAgICAgdGhpcy5pbnZva2VPblNlbGVjdGlvbkNoYW5nZUhhbmRsZXIoKTtcclxuICAgIH1cclxuXHJcbiAgICBpc1NlbGVjdGVkKGl0ZW06IFQpOiBib29sZWFuIHtcclxuICAgICAgICByZXR1cm4gISF0aGlzLl9zZWxlY3Rpb24uZmluZChhID0+IHRoaXMub3B0aW9ucy5pdGVtc0FyZUVxdWFsKGEsIGl0ZW0pKTtcclxuICAgIH1cclxuXHJcbiAgICBhcmVBbGxDdXJyZW50SXRlbXNTZWxlY3RlZCgpOiBib29sZWFuIHtcclxuICAgICAgICBpZiAoIXRoaXMuaXRlbXMgfHwgdGhpcy5pdGVtcy5sZW5ndGggPT09IDApIHtcclxuICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcy5pdGVtcy5ldmVyeShhID0+IHRoaXMuX3NlbGVjdGlvbi5maW5kKGIgPT4gdGhpcy5vcHRpb25zLml0ZW1zQXJlRXF1YWwoYSwgYikpKTtcclxuICAgIH1cclxuXHJcbiAgICB0b2dnbGVTZWxlY3RBbGwoKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuYXJlQWxsQ3VycmVudEl0ZW1zU2VsZWN0ZWQoKSkge1xyXG4gICAgICAgICAgICB0aGlzLl9zZWxlY3Rpb24gPSB0aGlzLl9zZWxlY3Rpb24uZmlsdGVyKFxyXG4gICAgICAgICAgICAgICAgYSA9PiAhdGhpcy5pdGVtcy5maW5kKGIgPT4gdGhpcy5vcHRpb25zLml0ZW1zQXJlRXF1YWwoYSwgYikpLFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIHRoaXMuX3NlbGVjdGlvbiA9IHRoaXMuX3NlbGVjdGlvbi5zbGljZSgwKTtcclxuICAgICAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIHRoaXMuaXRlbXMpIHtcclxuICAgICAgICAgICAgICAgIGlmICghdGhpcy5fc2VsZWN0aW9uLmZpbmQoYSA9PiB0aGlzLm9wdGlvbnMuaXRlbXNBcmVFcXVhbChhLCBpdGVtKSkpIHtcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLl9zZWxlY3Rpb24ucHVzaChpdGVtKTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICB0aGlzLmludm9rZU9uU2VsZWN0aW9uQ2hhbmdlSGFuZGxlcigpO1xyXG4gICAgfVxyXG5cclxuICAgIGxhc3RTZWxlY3RlZCgpOiBUIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5fc2VsZWN0aW9uW3RoaXMuX3NlbGVjdGlvbi5sZW5ndGggLSAxXTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGludm9rZU9uU2VsZWN0aW9uQ2hhbmdlSGFuZGxlcigpIHtcclxuICAgICAgICB0aGlzLnNlbGVjdGlvbkNoYW5nZXNTdWJqZWN0Lm5leHQodGhpcy5fc2VsZWN0aW9uKTtcclxuICAgIH1cclxufVxyXG4iXX0=