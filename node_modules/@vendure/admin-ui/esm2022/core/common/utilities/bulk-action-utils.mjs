import { marker as _ } from '@biesbjerg/ngx-translate-extract-marker';
import { DEFAULT_CHANNEL_CODE } from '@vendure/common/lib/shared-constants';
import { EMPTY, from, lastValueFrom, of, switchMap } from 'rxjs';
import { map, mapTo } from 'rxjs/operators';
import { DataService } from '../../data/providers/data.service';
import { ModalService } from '../../providers/modal/modal.service';
import { NotificationService } from '../../providers/notification/notification.service';
import { AssignToChannelDialogComponent } from '../../shared/components/assign-to-channel-dialog/assign-to-channel-dialog.component';
import { DeletionResult } from '../generated-types';
/**
 * @description
 * Resolves to an object containing the Channel code of the given channelId, or if no channelId
 * is supplied, the code of the activeChannel.
 */
export function getChannelCodeFromUserStatus(dataService, channelId) {
    return lastValueFrom(dataService.client.userStatus().mapSingle(({ userStatus }) => {
        const channelCode = userStatus.channels.find(c => c.id === (channelId ?? userStatus.activeChannelId))?.code ??
            'undefined';
        return { channelCode };
    }));
}
/**
 * @description
 * Resolves to `true` if multiple Channels are set up.
 */
export function isMultiChannel(dataService) {
    return lastValueFrom(dataService.client.userStatus().mapSingle(({ userStatus }) => 1 < userStatus.channels.length));
}
/**
 * @description
 * Resolves to `true` if the current active Channel is not the default Channel.
 */
export function currentChannelIsNotDefault(dataService) {
    return lastValueFrom(dataService.client.userStatus().mapSingle(({ userStatus }) => {
        if (userStatus.channels.length === 1) {
            return false;
        }
        const defaultChannelId = userStatus.channels.find(c => c.code === DEFAULT_CHANNEL_CODE)?.id;
        return userStatus.activeChannelId !== defaultChannelId;
    }));
}
/**
 * @description
 * Creates a BulkAction which can be used to delete multiple items.
 */
export function createBulkDeleteAction(config) {
    const bulkDeleteAction = {
        location: config.location,
        label: _('common.delete'),
        icon: 'trash',
        iconClass: 'is-danger',
        requiresPermission: config.requiresPermission,
        onClick: ({ injector, selection, hostComponent, clearSelection }) => {
            const modalService = injector.get(ModalService);
            const dataService = injector.get(DataService);
            const notificationService = injector.get(NotificationService);
            function showModalAndDelete(items, message) {
                const itemNames = items
                    .slice(0, 5)
                    .map(c => config.getItemName(c))
                    .join(', ');
                const nMore = items.length > 5 ? items.length - 5 : 0;
                return modalService
                    .dialog({
                    title: _('common.confirm-bulk-delete'),
                    body: message ? message : nMore ? _('common.list-items-and-n-more') : itemNames,
                    translationVars: { items: itemNames, nMore },
                    buttons: [
                        { type: 'secondary', label: _('common.cancel') },
                        {
                            type: 'danger',
                            label: message ? _('common.force-delete') : _('common.delete'),
                            returnValue: true,
                        },
                    ],
                })
                    .pipe(switchMap(res => res
                    ? config.bulkDelete(dataService, selection.map(c => c.id), message != null)
                    : of([])));
            }
            showModalAndDelete(selection)
                .pipe(switchMap(result => {
                let deletedCount = 0;
                const errors = [];
                let i = 0;
                for (const item of result) {
                    if (item.result === DeletionResult.DELETED) {
                        deletedCount++;
                    }
                    else if (config.shouldRetryItem?.(result[i], selection[i])) {
                        errors.push({ item: selection[i], message: item.message ?? '' });
                    }
                    i++;
                }
                if (0 < errors.length) {
                    return showModalAndDelete(errors.map(e => e.item), errors.map(e => e.message).join('\n')).pipe(map(result2 => {
                        const deletedCount2 = result2.filter(r => r.result === DeletionResult.DELETED).length;
                        return deletedCount + deletedCount2;
                    }));
                }
                else {
                    return of(deletedCount);
                }
            }))
                .subscribe({
                next: deletedCount => {
                    if (deletedCount) {
                        hostComponent.refresh();
                        clearSelection();
                        notificationService.success(_('common.notify-delete-success-with-count'), {
                            count: deletedCount,
                        });
                    }
                    const notDeletedCount = selection.length - deletedCount;
                    if (0 < notDeletedCount && notDeletedCount < selection.length) {
                        notificationService.error(_('common.notify-delete-error-with-count'), {
                            count: notDeletedCount,
                        });
                    }
                    hostComponent.refresh();
                    clearSelection();
                },
                error: err => {
                    notificationService.error(_('common.notify-delete-error'));
                },
            });
        },
    };
    return bulkDeleteAction;
}
export function createBulkAssignToChannelAction(config) {
    const bulkAssignToChannelAction = {
        location: config.location,
        label: _('common.assign-to-channel'),
        icon: 'layers',
        requiresPermission: config.requiresPermission,
        onClick: ({ injector, selection, hostComponent, clearSelection }) => {
            const modalService = injector.get(ModalService);
            const dataService = injector.get(DataService);
            const notificationService = injector.get(NotificationService);
            const itemNames = selection
                .slice(0, 5)
                .map(c => config.getItemName(c))
                .join(', ');
            const nMore = selection.length > 5 ? selection.length - 5 : 0;
            modalService
                .fromComponent(AssignToChannelDialogComponent, {
                size: 'md',
                locals: {
                    itemNames,
                    nMore,
                },
            })
                .pipe(switchMap(result => {
                if (result) {
                    const observables = config.bulkAssignToChannel(dataService, selection.map(c => c.id), result.map(c => c.id));
                    return from(observables).pipe(switchMap(res => res), mapTo(result));
                }
                else {
                    return EMPTY;
                }
            }))
                .subscribe(result => {
                notificationService.success(_('common.notify-assign-to-channel-success-with-count'), {
                    count: selection.length,
                    channelCode: result.map(c => c.code).join(', '),
                });
                clearSelection();
            });
        },
    };
    return bulkAssignToChannelAction;
}
export function createBulkRemoveFromChannelAction(config) {
    const bulkRemoveFromChannelAction = {
        location: config.location,
        label: _('common.remove-from-channel'),
        icon: 'layers',
        iconClass: 'is-warning',
        requiresPermission: config.requiresPermission,
        onClick: ({ injector, selection, hostComponent, clearSelection }) => {
            const modalService = injector.get(ModalService);
            const dataService = injector.get(DataService);
            const notificationService = injector.get(NotificationService);
            const activeChannelId$ = dataService.client
                .userStatus()
                .mapSingle(({ userStatus }) => userStatus.activeChannelId);
            function showModalAndDelete(items, message) {
                const itemNames = items
                    .slice(0, 5)
                    .map(c => config.getItemName(c))
                    .join(', ');
                const nMore = items.length > 5 ? items.length - 5 : 0;
                return modalService
                    .dialog({
                    title: _('common.confirm-bulk-remove-from-channel'),
                    body: message ? message : nMore ? _('common.list-items-and-n-more') : itemNames,
                    translationVars: {
                        count: selection.length,
                        items: itemNames,
                        nMore,
                    },
                    size: message ? 'lg' : 'md',
                    buttons: [
                        { type: 'secondary', label: _('common.cancel') },
                        {
                            type: 'danger',
                            label: message ? _('common.force-remove') : _('common.remove'),
                            returnValue: true,
                        },
                    ],
                })
                    .pipe(switchMap(res => res
                    ? activeChannelId$.pipe(switchMap(activeChannelId => activeChannelId
                        ? config.bulkRemoveFromChannel(dataService, selection.map(c => c.id), activeChannelId, message != null)
                        : EMPTY))
                    : EMPTY));
            }
            showModalAndDelete(selection)
                .pipe(switchMap(result => {
                let removedCount = selection.length;
                const errors = [];
                const errorIds = [];
                let i = 0;
                for (const item of result) {
                    const errorMessage = config.isErrorResult
                        ? config.isErrorResult(item)
                        : undefined;
                    if (errorMessage) {
                        errors.push(errorMessage);
                        errorIds.push(selection[i]?.id);
                        removedCount--;
                    }
                    i++;
                }
                if (0 < errorIds.length) {
                    const errorSelection = selection.filter(s => errorIds.includes(s.id));
                    return showModalAndDelete(errorSelection, errors.join('\n')).pipe(map(result2 => {
                        const notRemovedCount = result2.filter(r => {
                            const secondTryErrorMessage = config.isErrorResult
                                ? config.isErrorResult(r)
                                : undefined;
                            return typeof secondTryErrorMessage === 'string';
                        }).length;
                        return selection.length - notRemovedCount;
                    }));
                }
                else {
                    return of(removedCount);
                }
            }), switchMap(removedCount => removedCount
                ? getChannelCodeFromUserStatus(dataService).then(({ channelCode }) => ({
                    channelCode,
                    removedCount,
                }))
                : EMPTY))
                .subscribe(({ removedCount, channelCode }) => {
                if (removedCount) {
                    hostComponent.refresh();
                    clearSelection();
                    notificationService.success(_('common.notify-remove-from-channel-success-with-count'), {
                        count: removedCount,
                        channelCode,
                    });
                }
            });
        },
    };
    return bulkRemoveFromChannelAction;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVsay1hY3Rpb24tdXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvbGliL2NvcmUvc3JjL2NvbW1vbi91dGlsaXRpZXMvYnVsay1hY3Rpb24tdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sSUFBSSxDQUFDLEVBQUUsTUFBTSx5Q0FBeUMsQ0FBQztBQUN0RSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxzQ0FBc0MsQ0FBQztBQUU1RSxPQUFPLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRSxhQUFhLEVBQWMsRUFBRSxFQUFFLFNBQVMsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM3RSxPQUFPLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTVDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQztBQUVoRSxPQUFPLEVBQUUsWUFBWSxFQUFFLE1BQU0scUNBQXFDLENBQUM7QUFDbkUsT0FBTyxFQUFFLG1CQUFtQixFQUFFLE1BQU0sbURBQW1ELENBQUM7QUFDeEYsT0FBTyxFQUFFLDhCQUE4QixFQUFFLE1BQU0scUZBQXFGLENBQUM7QUFFckksT0FBTyxFQUFvQixjQUFjLEVBQUUsTUFBTSxvQkFBb0IsQ0FBQztBQUV0RTs7OztHQUlHO0FBQ0gsTUFBTSxVQUFVLDRCQUE0QixDQUFDLFdBQXdCLEVBQUUsU0FBa0I7SUFDckYsT0FBTyxhQUFhLENBQ2hCLFdBQVcsQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUMsRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFO1FBQ3pELE1BQU0sV0FBVyxHQUNiLFVBQVUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLFNBQVMsSUFBSSxVQUFVLENBQUMsZUFBZSxDQUFDLENB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QyxPQUFPLEVBQUUsQ0FBQztvQkFDeEIsY0FBYyxFQUFFLENBQUM7b0JBQ2pCLG1CQUFtQixDQUFDLE9BQU8sQ0FDdkIsQ0FBQyxDQUFDLHNEQUFzRCxDQUFDLEVBQ3pEO3dCQUNJLEtBQUssRUFBRSxZQUFZO3dCQUNuQixXQUFXO3FCQUNkLENBQ0osQ0FBQztnQkFDTixDQUFDO1lBQ0wsQ0FBQyxDQUFDLENBQUM7UUFDWCxDQUFDO0tBQ0osQ0FBQztJQUNGLE9BQU8sMkJBQTJCLENBQUM7QUFDdkMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IG1hcmtlciBhcyBfIH0gZnJvbSAnQGJpZXNiamVyZy9uZ3gtdHJhbnNsYXRlLWV4dHJhY3QtbWFya2VyJztcclxuaW1wb3J0IHsgREVGQVVMVF9DSEFOTkVMX0NPREUgfSBmcm9tICdAdmVuZHVyZS9jb21tb24vbGliL3NoYXJlZC1jb25zdGFudHMnO1xyXG5pbXBvcnQgeyB1bmlxdWUgfSBmcm9tICdAdmVuZHVyZS9jb21tb24vbGliL3VuaXF1ZSc7XHJcbmltcG9ydCB7IEVNUFRZLCBmcm9tLCBsYXN0VmFsdWVGcm9tLCBPYnNlcnZhYmxlLCBvZiwgc3dpdGNoTWFwIH0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IG1hcCwgbWFwVG8gfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcblxyXG5pbXBvcnQgeyBEYXRhU2VydmljZSB9IGZyb20gJy4uLy4uL2RhdGEvcHJvdmlkZXJzL2RhdGEuc2VydmljZSc7XHJcbmltcG9ydCB7IEJ1bGtBY3Rpb24gfSBmcm9tICcuLi8uLi9wcm92aWRlcnMvYnVsay1hY3Rpb24tcmVnaXN0cnkvYnVsay1hY3Rpb24tdHlwZXMnO1xyXG5pbXBvcnQgeyBNb2RhbFNlcnZpY2UgfSBmcm9tICcuLi8uLi9wcm92aWRlcnMvbW9kYWwvbW9kYWwuc2VydmljZSc7XHJcbmltcG9ydCB7IE5vdGlmaWNhdGlvblNlcnZpY2UgfSBmcm9tICcuLi8uLi9wcm92aWRlcnMvbm90aWZpY2F0aW9uL25vdGlmaWNhdGlvbi5zZXJ2aWNlJztcclxuaW1wb3J0IHsgQXNzaWduVG9DaGFubmVsRGlhbG9nQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vc2hhcmVkL2NvbXBvbmVudHMvYXNzaWduLXRvLWNoYW5uZWwtZGlhbG9nL2Fzc2lnbi10by1jaGFubmVsLWRpYWxvZy5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBCYXNlTGlzdENvbXBvbmVudCB9IGZyb20gJy4uL2Jhc2UtbGlzdC5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBEZWxldGlvblJlc3BvbnNlLCBEZWxldGlvblJlc3VsdCB9IGZyb20gJy4uL2dlbmVyYXRlZC10eXBlcyc7XHJcblxyXG4vKipcclxuICogQGRlc2NyaXB0aW9uXHJcbiAqIFJlc29sdmVzIHRvIGFuIG9iamVjdCBjb250YWluaW5nIHRoZSBDaGFubmVsIGNvZGUgb2YgdGhlIGdpdmVuIGNoYW5uZWxJZCwgb3IgaWYgbm8gY2hhbm5lbElkXHJcbiAqIGlzIHN1cHBsaWVkLCB0aGUgY29kZSBvZiB0aGUgYWN0aXZlQ2hhbm5lbC5cclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBnZXRDaGFubmVsQ29kZUZyb21Vc2VyU3RhdHVzKGRhdGFTZXJ2aWNlOiBEYXRhU2VydmljZSwgY2hhbm5lbElkPzogc3RyaW5nKSB7XHJcbiAgICByZXR1cm4gbGFzdFZhbHVlRnJvbShcclxuICAgICAgICBkYXRhU2VydmljZS5jbGllbnQudXNlclN0YXR1cygpLm1hcFNpbmdsZSgoeyB1c2VyU3RhdHVzIH0pID0+IHtcclxuICAgICAgICAgICAgY29uc3QgY2hhbm5lbENvZGUgPVxyXG4gICAgICAgICAgICAgICAgdXNlclN0YXR1cy5jaGFubmVscy5maW5kKGMgPT4gYy5pZCA9PT0gKGNoYW5uZWxJZCA/PyB1c2VyU3RhdHVzLmFjdGl2ZUNoYW5uZWxJZCkpPy5jb2RlID8/XHJcbiAgICAgICAgICAgICAgICAndW5kZWZpbmVkJztcclxuICAgICAgICAgICAgcmV0dXJuIHsgY2hhbm5lbENvZGUgfTtcclxuICAgICAgICB9KSxcclxuICAgICk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBAZGVzY3JpcHRpb25cclxuICogUmVzb2x2ZXMgdG8gYHRydWVgIGlmIG11bHRpcGxlIENoYW5uZWxzIGFyZSBzZXQgdXAuXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gaXNNdWx0aUNoYW5uZWwoZGF0YVNlcnZpY2U6IERhdGFTZXJ2aWNlKSB7XHJcbiAgICByZXR1cm4gbGFzdFZhbHVlRnJvbShcclxuICAgICAgICBkYXRhU2VydmljZS5jbGllbnQudXNlclN0YXR1cygpLm1hcFNpbmdsZSgoeyB1c2VyU3RhdHVzIH0pID0+IDEgPCB1c2VyU3RhdHVzLmNoYW5uZWxzLmxlbmd0aCksXHJcbiAgICApO1xyXG59XHJcblxyXG4vKipcclxuICogQGRlc2NyaXB0aW9uXHJcbiAqIFJlc29sdmVzIHRvIGB0cnVlYCBpZiB0aGUgY3VycmVudCBhY3RpdmUgQ2hhbm5lbCBpcyBub3QgdGhlIGRlZmF1bHQgQ2hhbm5lbC5cclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiBjdXJyZW50Q2hhbm5lbElzTm90RGVmYXVsdChkYXRhU2VydmljZTogRGF0YVNlcnZpY2UpIHtcclxuICAgIHJldHVybiBsYXN0VmFsdWVGcm9tKFxyXG4gICAgICAgIGRhdGFTZXJ2aWNlLmNsaWVudC51c2VyU3RhdHVzKCkubWFwU2luZ2xlKCh7IHVzZXJTdGF0dXMgfSkgPT4ge1xyXG4gICAgICAgICAgICBpZiAodXNlclN0YXR1cy5jaGFubmVscy5sZW5ndGggPT09IDEpIHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjb25zdCBkZWZhdWx0Q2hhbm5lbElkID0gdXNlclN0YXR1cy5jaGFubmVscy5maW5kKGMgPT4gYy5jb2RlID09PSBERUZBVUxUX0NIQU5ORUxfQ09ERSk/LmlkO1xyXG4gICAgICAgICAgICByZXR1cm4gdXNlclN0YXR1cy5hY3RpdmVDaGFubmVsSWQgIT09IGRlZmF1bHRDaGFubmVsSWQ7XHJcbiAgICAgICAgfSksXHJcbiAgICApO1xyXG59XHJcblxyXG5leHBvcnQgdHlwZSBDcmVhdGVCdWxrRGVsZXRlQWN0aW9uQ29uZmlnPEl0ZW1UeXBlPiA9IFBpY2s8QnVsa0FjdGlvbiwgJ2xvY2F0aW9uJyB8ICdyZXF1aXJlc1Blcm1pc3Npb24nPiAmIHtcclxuICAgIGdldEl0ZW1OYW1lOiAoaXRlbTogSXRlbVR5cGUpID0+IHN0cmluZztcclxuICAgIHNob3VsZFJldHJ5SXRlbT86IChyZXNwb25zZTogRGVsZXRpb25SZXNwb25zZSwgaXRlbTogSXRlbVR5cGUpID0+IGJvb2xlYW47XHJcbiAgICBidWxrRGVsZXRlOiAoXHJcbiAgICAgICAgZGF0YVNlcnZpY2U6IERhdGFTZXJ2aWNlLFxyXG4gICAgICAgIGlkczogc3RyaW5nW10sXHJcbiAgICAgICAgcmV0cnlpbmc6IGJvb2xlYW4sXHJcbiAgICApID0+IE9ic2VydmFibGU8RGVsZXRpb25SZXNwb25zZVtdPjtcclxufTtcclxuXHJcbi8qKlxyXG4gKiBAZGVzY3JpcHRpb25cclxuICogQ3JlYXRlcyBhIEJ1bGtBY3Rpb24gd2hpY2ggY2FuIGJlIHVzZWQgdG8gZGVsZXRlIG11bHRpcGxlIGl0ZW1zLlxyXG4gKi9cclxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUJ1bGtEZWxldGVBY3Rpb248SXRlbVR5cGU+KGNvbmZpZzogQ3JlYXRlQnVsa0RlbGV0ZUFjdGlvbkNvbmZpZzxJdGVtVHlwZT4pIHtcclxuICAgIGNvbnN0IGJ1bGtEZWxldGVBY3Rpb246IEJ1bGtBY3Rpb248YW55LCBCYXNlTGlzdENvbXBvbmVudDxhbnksIGFueT4+ID0ge1xyXG4gICAgICAgIGxvY2F0aW9uOiBjb25maWcubG9jYXRpb24sXHJcbiAgICAgICAgbGFiZWw6IF8oJ2NvbW1vbi5kZWxldGUnKSxcclxuICAgICAgICBpY29uOiAndHJhc2gnLFxyXG4gICAgICAgIGljb25DbGFzczogJ2lzLWRhbmdlcicsXHJcbiAgICAgICAgcmVxdWlyZXNQZXJtaXNzaW9uOiBjb25maWcucmVxdWlyZXNQZXJtaXNzaW9uLFxyXG4gICAgICAgIG9uQ2xpY2s6ICh7IGluamVjdG9yLCBzZWxlY3Rpb24sIGhvc3RDb21wb25lbnQsIGNsZWFyU2VsZWN0aW9uIH0pID0+IHtcclxuICAgICAgICAgICAgY29uc3QgbW9kYWxTZXJ2aWNlID0gaW5qZWN0b3IuZ2V0KE1vZGFsU2VydmljZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGRhdGFTZXJ2aWNlID0gaW5qZWN0b3IuZ2V0KERhdGFTZXJ2aWNlKTtcclxuICAgICAgICAgICAgY29uc3Qgbm90aWZpY2F0aW9uU2VydmljZSA9IGluamVjdG9yLmdldChOb3RpZmljYXRpb25TZXJ2aWNlKTtcclxuXHJcbiAgICAgICAgICAgIGZ1bmN0aW9uIHNob3dNb2RhbEFuZERlbGV0ZShpdGVtczogSXRlbVR5cGVbXSwgbWVzc2FnZT86IHN0cmluZykge1xyXG4gICAgICAgICAgICAgICAgY29uc3QgaXRlbU5hbWVzID0gaXRlbXNcclxuICAgICAgICAgICAgICAgICAgICAuc2xpY2UoMCwgNSlcclxuICAgICAgICAgICAgICAgICAgICAubWFwKGMgPT4gY29uZmlnLmdldEl0ZW1OYW1lKGMpKVxyXG4gICAgICAgICAgICAgICAgICAgIC5qb2luKCcsICcpO1xyXG4gICAgICAgICAgICAgICAgY29uc3Qgbk1vcmUgPSBpdGVtcy5sZW5ndGggPiA1ID8gaXRlbXMubGVuZ3RoIC0gNSA6IDA7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbW9kYWxTZXJ2aWNlXHJcbiAgICAgICAgICAgICAgICAgICAgLmRpYWxvZyh7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRpdGxlOiBfKCdjb21tb24uY29uZmlybS1idWxrLWRlbGV0ZScpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBib2R5OiBtZXNzYWdlID8gbWVzc2FnZSA6IG5Nb3JlID8gXygnY29tbW9uLmxpc3QtaXRlbXMtYW5kLW4tbW9yZScpIDogaXRlbU5hbWVzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0cmFuc2xhdGlvblZhcnM6IHsgaXRlbXM6IGl0ZW1OYW1lcywgbk1vcmUgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uczogW1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyB0eXBlOiAnc2Vjb25kYXJ5JywgbGFiZWw6IF8oJ2NvbW1vbi5jYW5jZWwnKSB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdkYW5nZXInLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiBtZXNzYWdlID8gXygnY29tbW9uLmZvcmNlLWRlbGV0ZScpIDogXygnY29tbW9uLmRlbGV0ZScpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVyblZhbHVlOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgXSxcclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgIC5waXBlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2hNYXAocmVzID0+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGNvbmZpZy5idWxrRGVsZXRlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGRhdGFTZXJ2aWNlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGVjdGlvbi5tYXAoYyA9PiBjLmlkKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlICE9IG51bGwsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBvZihbXSksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICksXHJcbiAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgc2hvd01vZGFsQW5kRGVsZXRlKHNlbGVjdGlvbilcclxuICAgICAgICAgICAgICAgIC5waXBlKFxyXG4gICAgICAgICAgICAgICAgICAgIHN3aXRjaE1hcChyZXN1bHQgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBsZXQgZGVsZXRlZENvdW50ID0gMDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXJyb3JzOiBBcnJheTx7IGl0ZW06IEl0ZW1UeXBlOyBtZXNzYWdlOiBzdHJpbmcgfT4gPSBbXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IGkgPSAwO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgcmVzdWx0KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbS5yZXN1bHQgPT09IERlbGV0aW9uUmVzdWx0LkRFTEVURUQpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGVkQ291bnQrKztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY29uZmlnLnNob3VsZFJldHJ5SXRlbT8uKHJlc3VsdFtpXSwgc2VsZWN0aW9uW2ldKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9ycy5wdXNoKHsgaXRlbTogc2VsZWN0aW9uW2ldLCBtZXNzYWdlOiBpdGVtLm1lc3NhZ2UgPz8gJycgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpKys7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKDAgPCBlcnJvcnMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2hvd01vZGFsQW5kRGVsZXRlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9ycy5tYXAoZSA9PiBlLml0ZW0pLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9ycy5tYXAoZSA9PiBlLm1lc3NhZ2UpLmpvaW4oJ1xcbicpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKS5waXBlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcChyZXN1bHQyID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZGVsZXRlZENvdW50MiA9IHJlc3VsdDIuZmlsdGVyKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgciA9PiByLnJlc3VsdCA9PT0gRGVsZXRpb25SZXN1bHQuREVMRVRFRCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKS5sZW5ndGg7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBkZWxldGVkQ291bnQgKyBkZWxldGVkQ291bnQyO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZihkZWxldGVkQ291bnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgICAgICApXHJcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKHtcclxuICAgICAgICAgICAgICAgICAgICBuZXh0OiBkZWxldGVkQ291bnQgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoZGVsZXRlZENvdW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBob3N0Q29tcG9uZW50LnJlZnJlc2goKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyU2VsZWN0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3RpZmljYXRpb25TZXJ2aWNlLnN1Y2Nlc3MoXygnY29tbW9uLm5vdGlmeS1kZWxldGUtc3VjY2Vzcy13aXRoLWNvdW50JyksIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3VudDogZGVsZXRlZENvdW50LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgbm90RGVsZXRlZENvdW50ID0gc2VsZWN0aW9uLmxlbmd0aCAtIGRlbGV0ZWRDb3VudDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKDAgPCBub3REZWxldGVkQ291bnQgJiYgbm90RGVsZXRlZENvdW50IDwgc2VsZWN0aW9uLmxlbmd0aCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbm90aWZpY2F0aW9uU2VydmljZS5lcnJvcihfKCdjb21tb24ubm90aWZ5LWRlbGV0ZS1lcnJvci13aXRoLWNvdW50JyksIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3VudDogbm90RGVsZXRlZENvdW50LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgaG9zdENvbXBvbmVudC5yZWZyZXNoKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNsZWFyU2VsZWN0aW9uKCk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbm90aWZpY2F0aW9uU2VydmljZS5lcnJvcihfKCdjb21tb24ubm90aWZ5LWRlbGV0ZS1lcnJvcicpKTtcclxuICAgICAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSxcclxuICAgIH07XHJcbiAgICByZXR1cm4gYnVsa0RlbGV0ZUFjdGlvbjtcclxufVxyXG5cclxuZXhwb3J0IHR5cGUgQ3JlYXRlQnVsa0Fzc2lnblRvQ2hhbm5lbEFjdGlvbkNvbmZpZzxJdGVtVHlwZT4gPSBQaWNrPFxyXG4gICAgQnVsa0FjdGlvbixcclxuICAgICdsb2NhdGlvbicgfCAncmVxdWlyZXNQZXJtaXNzaW9uJ1xyXG4+ICYge1xyXG4gICAgZ2V0SXRlbU5hbWU6IChpdGVtOiBJdGVtVHlwZSkgPT4gc3RyaW5nO1xyXG4gICAgYnVsa0Fzc2lnblRvQ2hhbm5lbDogKFxyXG4gICAgICAgIGRhdGFTZXJ2aWNlOiBEYXRhU2VydmljZSxcclxuICAgICAgICBpZHM6IHN0cmluZ1tdLFxyXG4gICAgICAgIGNoYW5uZWxJZHM6IHN0cmluZ1tdLFxyXG4gICAgKSA9PiBBcnJheTxPYnNlcnZhYmxlPEFycmF5PFBhcnRpYWw8SXRlbVR5cGU+Pj4+O1xyXG59O1xyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUJ1bGtBc3NpZ25Ub0NoYW5uZWxBY3Rpb248SXRlbVR5cGU+KFxyXG4gICAgY29uZmlnOiBDcmVhdGVCdWxrQXNzaWduVG9DaGFubmVsQWN0aW9uQ29uZmlnPEl0ZW1UeXBlPixcclxuKSB7XHJcbiAgICBjb25zdCBidWxrQXNzaWduVG9DaGFubmVsQWN0aW9uOiBCdWxrQWN0aW9uPGFueSwgQmFzZUxpc3RDb21wb25lbnQ8YW55LCBhbnk+PiA9IHtcclxuICAgICAgICBsb2NhdGlvbjogY29uZmlnLmxvY2F0aW9uLFxyXG4gICAgICAgIGxhYmVsOiBfKCdjb21tb24uYXNzaWduLXRvLWNoYW5uZWwnKSxcclxuICAgICAgICBpY29uOiAnbGF5ZXJzJyxcclxuICAgICAgICByZXF1aXJlc1Blcm1pc3Npb246IGNvbmZpZy5yZXF1aXJlc1Blcm1pc3Npb24sXHJcbiAgICAgICAgb25DbGljazogKHsgaW5qZWN0b3IsIHNlbGVjdGlvbiwgaG9zdENvbXBvbmVudCwgY2xlYXJTZWxlY3Rpb24gfSkgPT4ge1xyXG4gICAgICAgICAgICBjb25zdCBtb2RhbFNlcnZpY2UgPSBpbmplY3Rvci5nZXQoTW9kYWxTZXJ2aWNlKTtcclxuICAgICAgICAgICAgY29uc3QgZGF0YVNlcnZpY2UgPSBpbmplY3Rvci5nZXQoRGF0YVNlcnZpY2UpO1xyXG4gICAgICAgICAgICBjb25zdCBub3RpZmljYXRpb25TZXJ2aWNlID0gaW5qZWN0b3IuZ2V0KE5vdGlmaWNhdGlvblNlcnZpY2UpO1xyXG4gICAgICAgICAgICBjb25zdCBpdGVtTmFtZXMgPSBzZWxlY3Rpb25cclxuICAgICAgICAgICAgICAgIC5zbGljZSgwLCA1KVxyXG4gICAgICAgICAgICAgICAgLm1hcChjID0+IGNvbmZpZy5nZXRJdGVtTmFtZShjKSlcclxuICAgICAgICAgICAgICAgIC5qb2luKCcsICcpO1xyXG4gICAgICAgICAgICBjb25zdCBuTW9yZSA9IHNlbGVjdGlvbi5sZW5ndGggPiA1ID8gc2VsZWN0aW9uLmxlbmd0aCAtIDUgOiAwO1xyXG4gICAgICAgICAgICBtb2RhbFNlcnZpY2VcclxuICAgICAgICAgICAgICAgIC5mcm9tQ29tcG9uZW50KEFzc2lnblRvQ2hhbm5lbERpYWxvZ0NvbXBvbmVudCwge1xyXG4gICAgICAgICAgICAgICAgICAgIHNpemU6ICdtZCcsXHJcbiAgICAgICAgICAgICAgICAgICAgbG9jYWxzOiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1OYW1lcyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgbk1vcmUsXHJcbiAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgICAgICAucGlwZShcclxuICAgICAgICAgICAgICAgICAgICBzd2l0Y2hNYXAocmVzdWx0ID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJlc3VsdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2JzZXJ2YWJsZXMgPSBjb25maWcuYnVsa0Fzc2lnblRvQ2hhbm5lbChcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkYXRhU2VydmljZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3Rpb24ubWFwKGMgPT4gYy5pZCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0Lm1hcChjID0+IGMuaWQpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZnJvbShvYnNlcnZhYmxlcykucGlwZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2hNYXAocmVzID0+IHJlcyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwVG8ocmVzdWx0KSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gRU1QVFk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUocmVzdWx0ID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBub3RpZmljYXRpb25TZXJ2aWNlLnN1Y2Nlc3MoXygnY29tbW9uLm5vdGlmeS1hc3NpZ24tdG8tY2hhbm5lbC1zdWNjZXNzLXdpdGgtY291bnQnKSwge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb3VudDogc2VsZWN0aW9uLmxlbmd0aCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbENvZGU6IHJlc3VsdC5tYXAoYyA9PiBjLmNvZGUpLmpvaW4oJywgJyksXHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgY2xlYXJTZWxlY3Rpb24oKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcbiAgICB9O1xyXG4gICAgcmV0dXJuIGJ1bGtBc3NpZ25Ub0NoYW5uZWxBY3Rpb247XHJcbn1cclxuXHJcbmV4cG9ydCB0eXBlIENyZWF0ZUJ1bGtSZW1vdmVGcm9tQ2hhbm5lbEFjdGlvbkNvbmZpZzxJdGVtVHlwZSwgUmVtb3ZlUmVzdWx0ID0gUGFydGlhbDxJdGVtVHlwZT4+ID0gUGljazxcclxuICAgIEJ1bGtBY3Rpb24sXHJcbiAgICAnbG9jYXRpb24nIHwgJ3JlcXVpcmVzUGVybWlzc2lvbidcclxuPiAmIHtcclxuICAgIGdldEl0ZW1OYW1lOiAoaXRlbTogSXRlbVR5cGUpID0+IHN0cmluZztcclxuICAgIGJ1bGtSZW1vdmVGcm9tQ2hhbm5lbDogKFxyXG4gICAgICAgIGRhdGFTZXJ2aWNlOiBEYXRhU2VydmljZSxcclxuICAgICAgICBpZHM6IHN0cmluZ1tdLFxyXG4gICAgICAgIGNoYW5uZWxJZDogc3RyaW5nLFxyXG4gICAgICAgIHJldHJ5aW5nOiBib29sZWFuLFxyXG4gICAgKSA9PiBPYnNlcnZhYmxlPFJlbW92ZVJlc3VsdFtdPjtcclxuICAgIC8qKlxyXG4gICAgICogQW4gb3B0aW9uYWwgdGVzdCBvZiB3aGV0aGVyIHRoZSByZW1vdmFsIHN1Y2NlZWRlZCBmb3IgdGhlIGdpdmVuIGl0ZW0uIElmIHRoaXNcclxuICAgICAqIGZ1bmN0aW9uIHJldHVybnMgYSBzdHJpbmcsIHRoYXQgaXMgdGFrZW4gdG8gYmUgYW4gZXJyb3IgbWVzc2FnZSB3aGljaCB3aWxsIGJlXHJcbiAgICAgKiBkaXNwbGF5ZWQgdG8gdGhlIHVzZXIuXHJcbiAgICAgKi9cclxuICAgIGlzRXJyb3JSZXN1bHQ/OiAocmVzdWx0OiBSZW1vdmVSZXN1bHQpID0+IHN0cmluZyB8IHVuZGVmaW5lZDtcclxufTtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVCdWxrUmVtb3ZlRnJvbUNoYW5uZWxBY3Rpb248SXRlbVR5cGUsIFJlc3VsdFR5cGUgPSBQYXJ0aWFsPEl0ZW1UeXBlPj4oXHJcbiAgICBjb25maWc6IENyZWF0ZUJ1bGtSZW1vdmVGcm9tQ2hhbm5lbEFjdGlvbkNvbmZpZzxJdGVtVHlwZSwgUmVzdWx0VHlwZT4sXHJcbikge1xyXG4gICAgY29uc3QgYnVsa1JlbW92ZUZyb21DaGFubmVsQWN0aW9uOiBCdWxrQWN0aW9uPGFueSwgQmFzZUxpc3RDb21wb25lbnQ8YW55LCBhbnk+PiA9IHtcclxuICAgICAgICBsb2NhdGlvbjogY29uZmlnLmxvY2F0aW9uLFxyXG4gICAgICAgIGxhYmVsOiBfKCdjb21tb24ucmVtb3ZlLWZyb20tY2hhbm5lbCcpLFxyXG4gICAgICAgIGljb246ICdsYXllcnMnLFxyXG4gICAgICAgIGljb25DbGFzczogJ2lzLXdhcm5pbmcnLFxyXG4gICAgICAgIHJlcXVpcmVzUGVybWlzc2lvbjogY29uZmlnLnJlcXVpcmVzUGVybWlzc2lvbixcclxuICAgICAgICBvbkNsaWNrOiAoeyBpbmplY3Rvciwgc2VsZWN0aW9uLCBob3N0Q29tcG9uZW50LCBjbGVhclNlbGVjdGlvbiB9KSA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IG1vZGFsU2VydmljZSA9IGluamVjdG9yLmdldChNb2RhbFNlcnZpY2UpO1xyXG4gICAgICAgICAgICBjb25zdCBkYXRhU2VydmljZSA9IGluamVjdG9yLmdldChEYXRhU2VydmljZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IG5vdGlmaWNhdGlvblNlcnZpY2UgPSBpbmplY3Rvci5nZXQoTm90aWZpY2F0aW9uU2VydmljZSk7XHJcbiAgICAgICAgICAgIGNvbnN0IGFjdGl2ZUNoYW5uZWxJZCQgPSBkYXRhU2VydmljZS5jbGllbnRcclxuICAgICAgICAgICAgICAgIC51c2VyU3RhdHVzKClcclxuICAgICAgICAgICAgICAgIC5tYXBTaW5nbGUoKHsgdXNlclN0YXR1cyB9KSA9PiB1c2VyU3RhdHVzLmFjdGl2ZUNoYW5uZWxJZCk7XHJcblxyXG4gICAgICAgICAgICBmdW5jdGlvbiBzaG93TW9kYWxBbmREZWxldGUoaXRlbXM6IEl0ZW1UeXBlW10sIG1lc3NhZ2U/OiBzdHJpbmcpIHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGl0ZW1OYW1lcyA9IGl0ZW1zXHJcbiAgICAgICAgICAgICAgICAgICAgLnNsaWNlKDAsIDUpXHJcbiAgICAgICAgICAgICAgICAgICAgLm1hcChjID0+IGNvbmZpZy5nZXRJdGVtTmFtZShjKSlcclxuICAgICAgICAgICAgICAgICAgICAuam9pbignLCAnKTtcclxuICAgICAgICAgICAgICAgIGNvbnN0IG5Nb3JlID0gaXRlbXMubGVuZ3RoID4gNSA/IGl0ZW1zLmxlbmd0aCAtIDUgOiAwO1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG1vZGFsU2VydmljZVxyXG4gICAgICAgICAgICAgICAgICAgIC5kaWFsb2coe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB0aXRsZTogXygnY29tbW9uLmNvbmZpcm0tYnVsay1yZW1vdmUtZnJvbS1jaGFubmVsJyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJvZHk6IG1lc3NhZ2UgPyBtZXNzYWdlIDogbk1vcmUgPyBfKCdjb21tb24ubGlzdC1pdGVtcy1hbmQtbi1tb3JlJykgOiBpdGVtTmFtZXMsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyYW5zbGF0aW9uVmFyczoge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY291bnQ6IHNlbGVjdGlvbi5sZW5ndGgsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtczogaXRlbU5hbWVzLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgbk1vcmUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHNpemU6IG1lc3NhZ2UgPyAnbGcnIDogJ21kJyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgYnV0dG9uczogW1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgeyB0eXBlOiAnc2Vjb25kYXJ5JywgbGFiZWw6IF8oJ2NvbW1vbi5jYW5jZWwnKSB9LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdkYW5nZXInLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiBtZXNzYWdlID8gXygnY29tbW9uLmZvcmNlLXJlbW92ZScpIDogXygnY29tbW9uLnJlbW92ZScpLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVyblZhbHVlOiB0cnVlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgXSxcclxuICAgICAgICAgICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAgICAgICAgIC5waXBlKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2hNYXAocmVzID0+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXNcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGFjdGl2ZUNoYW5uZWxJZCQucGlwZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzd2l0Y2hNYXAoYWN0aXZlQ2hhbm5lbElkID0+XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2ZUNoYW5uZWxJZFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBjb25maWcuYnVsa1JlbW92ZUZyb21DaGFubmVsKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGF0YVNlcnZpY2UsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxlY3Rpb24ubWFwKGMgPT4gYy5pZCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3RpdmVDaGFubmVsSWQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBtZXNzYWdlICE9IG51bGwsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogRU1QVFksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIClcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA6IEVNUFRZLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICApLFxyXG4gICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHNob3dNb2RhbEFuZERlbGV0ZShzZWxlY3Rpb24pXHJcbiAgICAgICAgICAgICAgICAucGlwZShcclxuICAgICAgICAgICAgICAgICAgICBzd2l0Y2hNYXAocmVzdWx0ID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJlbW92ZWRDb3VudCA9IHNlbGVjdGlvbi5sZW5ndGg7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXJyb3JJZHM6IHN0cmluZ1tdID0gW107XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpID0gMDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIHJlc3VsdCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXJyb3JNZXNzYWdlID0gY29uZmlnLmlzRXJyb3JSZXN1bHRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA/IGNvbmZpZy5pc0Vycm9yUmVzdWx0KGl0ZW0pXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgOiB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXJyb3JNZXNzYWdlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3JzLnB1c2goZXJyb3JNZXNzYWdlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcklkcy5wdXNoKHNlbGVjdGlvbltpXT8uaWQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbW92ZWRDb3VudC0tO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaSsrO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgwIDwgZXJyb3JJZHMubGVuZ3RoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlcnJvclNlbGVjdGlvbiA9IHNlbGVjdGlvbi5maWx0ZXIocyA9PiBlcnJvcklkcy5pbmNsdWRlcyhzLmlkKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2hvd01vZGFsQW5kRGVsZXRlKGVycm9yU2VsZWN0aW9uLCBlcnJvcnMuam9pbignXFxuJykpLnBpcGUoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwKHJlc3VsdDIgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBub3RSZW1vdmVkQ291bnQgPSByZXN1bHQyLmZpbHRlcihyID0+IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHNlY29uZFRyeUVycm9yTWVzc2FnZSA9IGNvbmZpZy5pc0Vycm9yUmVzdWx0XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPyBjb25maWcuaXNFcnJvclJlc3VsdChyKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDogdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHR5cGVvZiBzZWNvbmRUcnlFcnJvck1lc3NhZ2UgPT09ICdzdHJpbmcnO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KS5sZW5ndGg7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBzZWxlY3Rpb24ubGVuZ3RoIC0gbm90UmVtb3ZlZENvdW50O1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvZihyZW1vdmVkQ291bnQpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgfSksXHJcbiAgICAgICAgICAgICAgICAgICAgc3dpdGNoTWFwKHJlbW92ZWRDb3VudCA9PlxyXG4gICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVkQ291bnRcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gZ2V0Q2hhbm5lbENvZGVGcm9tVXNlclN0YXR1cyhkYXRhU2VydmljZSkudGhlbigoeyBjaGFubmVsQ29kZSB9KSA9PiAoe1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbm5lbENvZGUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVkQ291bnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBFTVBUWSxcclxuICAgICAgICAgICAgICAgICAgICApLFxyXG4gICAgICAgICAgICAgICAgKVxyXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZSgoeyByZW1vdmVkQ291bnQsIGNoYW5uZWxDb2RlIH0pID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAocmVtb3ZlZENvdW50KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhvc3RDb21wb25lbnQucmVmcmVzaCgpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjbGVhclNlbGVjdGlvbigpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBub3RpZmljYXRpb25TZXJ2aWNlLnN1Y2Nlc3MoXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfKCdjb21tb24ubm90aWZ5LXJlbW92ZS1mcm9tLWNoYW5uZWwtc3VjY2Vzcy13aXRoLWNvdW50JyksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY291bnQ6IHJlbW92ZWRDb3VudCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjaGFubmVsQ29kZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSxcclxuICAgIH07XHJcbiAgICByZXR1cm4gYnVsa1JlbW92ZUZyb21DaGFubmVsQWN0aW9uO1xyXG59XHJcbiJdfQ==