import { Injectable } from '@angular/core';
import { notNullOrUndefined } from '@vendure/common/lib/shared-utils';
import * as i0 from "@angular/core";
/**
 * Responsible for registering dashboard widget components and querying for layouts.
 */
export class DashboardWidgetService {
    constructor() {
        this.registry = new Map();
        this.layoutDef = [];
    }
    registerWidget(id, config) {
        if (this.registry.has(id)) {
            throw new Error(`A dashboard widget with the id "${id}" already exists`);
        }
        this.registry.set(id, config);
    }
    getAvailableWidgets(currentUserPermissions) {
        const hasAllPermissions = (requiredPerms, userPerms) => requiredPerms.every(p => userPerms.includes(p));
        return [...this.registry.entries()]
            .filter(([id, config]) => !config.requiresPermissions ||
            hasAllPermissions(config.requiresPermissions, currentUserPermissions))
            .map(([id, config]) => ({ id, config }));
    }
    getWidgetById(id) {
        return this.registry.get(id);
    }
    setDefaultLayout(layout) {
        this.layoutDef = layout;
    }
    getDefaultLayout() {
        return this.layoutDef;
    }
    getWidgetLayout(layoutDef) {
        const intermediateLayout = (layoutDef || this.layoutDef)
            .map(({ id, width }) => {
            const config = this.registry.get(id);
            if (!config) {
                return this.idNotFound(id);
            }
            return { id, config, width: this.getValidWidth(id, config, width) };
        })
            .filter(notNullOrUndefined);
        return this.buildLayout(intermediateLayout);
    }
    idNotFound(id) {
        // eslint-disable-next-line no-console
        console.error(`No dashboard widget was found with the id "${id}"\nAvailable ids: ${[...this.registry.keys()]
            .map(_id => `"${_id}"`)
            .join(', ')}`);
        return;
    }
    getValidWidth(id, config, targetWidth) {
        let adjustedWidth = targetWidth;
        const supportedWidths = config.supportedWidths?.length
            ? config.supportedWidths
            : [3, 4, 6, 8, 12];
        if (!supportedWidths.includes(targetWidth)) {
            // Fall back to the largest supported width
            const sortedWidths = supportedWidths.sort((a, b) => a - b);
            const fallbackWidth = supportedWidths[sortedWidths.length - 1];
            // eslint-disable-next-line no-console
            console.error(`The "${id}" widget does not support the specified width (${targetWidth}).\nSupported widths are: [${sortedWidths.join(', ')}].\nUsing (${fallbackWidth}) instead.`);
            adjustedWidth = fallbackWidth;
        }
        return adjustedWidth;
    }
    buildLayout(intermediateLayout) {
        const layout = [];
        let row = [];
        for (const { id, config, width } of intermediateLayout) {
            const rowSize = row.reduce((size, c) => size + c.width, 0);
            if (12 < rowSize + width) {
                layout.push(row);
                row = [];
            }
            row.push({ id, config, width });
        }
        layout.push(row);
        return layout;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: DashboardWidgetService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: DashboardWidgetService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: DashboardWidgetService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGFzaGJvYXJkLXdpZGdldC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2xpYi9jb3JlL3NyYy9wcm92aWRlcnMvZGFzaGJvYXJkLXdpZGdldC9kYXNoYm9hcmQtd2lkZ2V0LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUMzQyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQzs7QUFXdEU7O0dBRUc7QUFJSCxNQUFNLE9BQU8sc0JBQXNCO0lBSG5DO1FBSVksYUFBUSxHQUFHLElBQUksR0FBRyxFQUFpQyxDQUFDO1FBQ3BELGNBQVMsR0FBMkIsRUFBRSxDQUFDO0tBbUdsRDtJQWpHRyxjQUFjLENBQUMsRUFBVSxFQUFFLE1BQTZCO1FBQ3BELElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQztZQUN4QixNQUFNLElBQUksS0FBSyxDQUFDLG1DQUFtQyxFQUFFLGtCQUFrQixDQUFDLENBQUM7UUFDN0UsQ0FBQztRQUVELElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUUsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBRUQsbUJBQW1CLENBQ2Ysc0JBQW9DO1FBRXBDLE1BQU0saUJBQWlCLEdBQUcsQ0FBQyxhQUF1QixFQUFFLFNBQW1CLEVBQVcsRUFBRSxDQUNoRixhQUFhLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRXBELE9BQU8sQ0FBQyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsT0FBTyxFQUFFLENBQUM7YUFDOUIsTUFBTSxDQUNILENBQUMsQ0FBQyxFQUFFLEVBQUUsTUFBTSxDQUFDLEVBQUUsRUFBRSxDQUNiLENB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QUM7SUFFTyxXQUFXLENBQUMsa0JBQXdDO1FBQ3hELE1BQU0sTUFBTSxHQUFpQixFQUFFLENBQUM7UUFDaEMsSUFBSSxHQUFHLEdBQXlCLEVBQUUsQ0FBQztRQUNuQyxLQUFLLE1BQU0sRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLEtBQUssRUFBRSxJQUFJLGtCQUFrQixFQUFFLENBQUM7WUFDckQsTUFBTSxPQUFPLEdBQUcsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQzNELElBQUksRUFBRSxHQUFHLE9BQU8sR0FBRyxLQUFLLEVBQUUsQ0FBQztnQkFDdkIsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztnQkFDakIsR0FBRyxHQUFHLEVBQUUsQ0FBQztZQUNiLENBQUM7WUFDRCxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxLQUFLLEVBQUUsQ0FBQyxDQUFDO1FBQ3BDLENBQUM7UUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2pCLE9BQU8sTUFBTSxDQUFDO0lBQ2xCLENBQUM7OEdBcEdRLHNCQUFzQjtrSEFBdEIsc0JBQXNCLGNBRm5CLE1BQU07OzJGQUVULHNCQUFzQjtrQkFIbEMsVUFBVTttQkFBQztvQkFDUixVQUFVLEVBQUUsTUFBTTtpQkFDckIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IG5vdE51bGxPclVuZGVmaW5lZCB9IGZyb20gJ0B2ZW5kdXJlL2NvbW1vbi9saWIvc2hhcmVkLXV0aWxzJztcclxuXHJcbmltcG9ydCB7IFBlcm1pc3Npb24gfSBmcm9tICcuLi8uLi9jb21tb24vZ2VuZXJhdGVkLXR5cGVzJztcclxuXHJcbmltcG9ydCB7XHJcbiAgICBEYXNoYm9hcmRXaWRnZXRDb25maWcsXHJcbiAgICBEYXNoYm9hcmRXaWRnZXRXaWR0aCxcclxuICAgIFdpZGdldExheW91dCxcclxuICAgIFdpZGdldExheW91dERlZmluaXRpb24sXHJcbn0gZnJvbSAnLi9kYXNoYm9hcmQtd2lkZ2V0LXR5cGVzJztcclxuXHJcbi8qKlxyXG4gKiBSZXNwb25zaWJsZSBmb3IgcmVnaXN0ZXJpbmcgZGFzaGJvYXJkIHdpZGdldCBjb21wb25lbnRzIGFuZCBxdWVyeWluZyBmb3IgbGF5b3V0cy5cclxuICovXHJcbkBJbmplY3RhYmxlKHtcclxuICAgIHByb3ZpZGVkSW46ICdyb290JyxcclxufSlcclxuZXhwb3J0IGNsYXNzIERhc2hib2FyZFdpZGdldFNlcnZpY2Uge1xyXG4gICAgcHJpdmF0ZSByZWdpc3RyeSA9IG5ldyBNYXA8c3RyaW5nLCBEYXNoYm9hcmRXaWRnZXRDb25maWc+KCk7XHJcbiAgICBwcml2YXRlIGxheW91dERlZjogV2lkZ2V0TGF5b3V0RGVmaW5pdGlvbiA9IFtdO1xyXG5cclxuICAgIHJlZ2lzdGVyV2lkZ2V0KGlkOiBzdHJpbmcsIGNvbmZpZzogRGFzaGJvYXJkV2lkZ2V0Q29uZmlnKSB7XHJcbiAgICAgICAgaWYgKHRoaXMucmVnaXN0cnkuaGFzKGlkKSkge1xyXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEEgZGFzaGJvYXJkIHdpZGdldCB3aXRoIHRoZSBpZCBcIiR7aWR9XCIgYWxyZWFkeSBleGlzdHNgKTtcclxuICAgICAgICB9XHJcblxyXG4gICAgICAgIHRoaXMucmVnaXN0cnkuc2V0KGlkLCBjb25maWcpO1xyXG4gICAgfVxyXG5cclxuICAgIGdldEF2YWlsYWJsZVdpZGdldHMoXHJcbiAgICAgICAgY3VycmVudFVzZXJQZXJtaXNzaW9uczogUGVybWlzc2lvbltdLFxyXG4gICAgKTogQXJyYXk8eyBpZDogc3RyaW5nOyBjb25maWc6IERhc2hib2FyZFdpZGdldENvbmZpZyB9PiB7XHJcbiAgICAgICAgY29uc3QgaGFzQWxsUGVybWlzc2lvbnMgPSAocmVxdWlyZWRQZXJtczogc3RyaW5nW10sIHVzZXJQZXJtczogc3RyaW5nW10pOiBib29sZWFuID0+XHJcbiAgICAgICAgICAgIHJlcXVpcmVkUGVybXMuZXZlcnkocCA9PiB1c2VyUGVybXMuaW5jbHVkZXMocCkpO1xyXG5cclxuICAgICAgICByZXR1cm4gWy4uLnRoaXMucmVnaXN0cnkuZW50cmllcygpXVxyXG4gICAgICAgICAgICAuZmlsdGVyKFxyXG4gICAgICAgICAgICAgICAgKFtpZCwgY29uZmlnXSkgPT5cclxuICAgICAgICAgICAgICAgICAgICAhY29uZmlnLnJlcXVpcmVzUGVybWlzc2lvbnMgfHxcclxuICAgICAgICAgICAgICAgICAgICBoYXNBbGxQZXJtaXNzaW9ucyhjb25maWcucmVxdWlyZXNQZXJtaXNzaW9ucywgY3VycmVudFVzZXJQZXJtaXNzaW9ucyksXHJcbiAgICAgICAgICAgIClcclxuICAgICAgICAgICAgLm1hcCgoW2lkLCBjb25maWddKSA9PiAoeyBpZCwgY29uZmlnIH0pKTtcclxuICAgIH1cclxuXHJcbiAgICBnZXRXaWRnZXRCeUlkKGlkOiBzdHJpbmcpIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5yZWdpc3RyeS5nZXQoaWQpO1xyXG4gICAgfVxyXG5cclxuICAgIHNldERlZmF1bHRMYXlvdXQobGF5b3V0OiBXaWRnZXRMYXlvdXREZWZpbml0aW9uKSB7XHJcbiAgICAgICAgdGhpcy5sYXlvdXREZWYgPSBsYXlvdXQ7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0RGVmYXVsdExheW91dCgpOiBXaWRnZXRMYXlvdXREZWZpbml0aW9uIHtcclxuICAgICAgICByZXR1cm4gdGhpcy5sYXlvdXREZWY7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0V2lkZ2V0TGF5b3V0KGxheW91dERlZj86IFdpZGdldExheW91dERlZmluaXRpb24pOiBXaWRnZXRMYXlvdXQge1xyXG4gICAgICAgIGNvbnN0IGludGVybWVkaWF0ZUxheW91dCA9IChsYXlvdXREZWYgfHwgdGhpcy5sYXlvdXREZWYpXHJcbiAgICAgICAgICAgIC5tYXAoKHsgaWQsIHdpZHRoIH0pID0+IHtcclxuICAgICAgICAgICAgICAgIGNvbnN0IGNvbmZpZyA9IHRoaXMucmVnaXN0cnkuZ2V0KGlkKTtcclxuICAgICAgICAgICAgICAgIGlmICghY29uZmlnKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuaWROb3RGb3VuZChpZCk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4geyBpZCwgY29uZmlnLCB3aWR0aDogdGhpcy5nZXRWYWxpZFdpZHRoKGlkLCBjb25maWcsIHdpZHRoKSB9O1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuZmlsdGVyKG5vdE51bGxPclVuZGVmaW5lZCk7XHJcblxyXG4gICAgICAgIHJldHVybiB0aGlzLmJ1aWxkTGF5b3V0KGludGVybWVkaWF0ZUxheW91dCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBpZE5vdEZvdW5kKGlkOiBzdHJpbmcpOiB1bmRlZmluZWQge1xyXG4gICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlXHJcbiAgICAgICAgY29uc29sZS5lcnJvcihcclxuICAgICAgICAgICAgYE5vIGRhc2hib2FyZCB3aWRnZXQgd2FzIGZvdW5kIHdpdGggdGhlIGlkIFwiJHtpZH1cIlxcbkF2YWlsYWJsZSBpZHM6ICR7Wy4uLnRoaXMucmVnaXN0cnkua2V5cygpXVxyXG4gICAgICAgICAgICAgICAgLm1hcChfaWQgPT4gYFwiJHtfaWR9XCJgKVxyXG4gICAgICAgICAgICAgICAgLmpvaW4oJywgJyl9YCxcclxuICAgICAgICApO1xyXG4gICAgICAgIHJldHVybjtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIGdldFZhbGlkV2lkdGgoXHJcbiAgICAgICAgaWQ6IHN0cmluZyxcclxuICAgICAgICBjb25maWc6IERhc2hib2FyZFdpZGdldENvbmZpZyxcclxuICAgICAgICB0YXJnZXRXaWR0aDogRGFzaGJvYXJkV2lkZ2V0V2lkdGgsXHJcbiAgICApOiBEYXNoYm9hcmRXaWRnZXRXaWR0aCB7XHJcbiAgICAgICAgbGV0IGFkanVzdGVkV2lkdGggPSB0YXJnZXRXaWR0aDtcclxuICAgICAgICBjb25zdCBzdXBwb3J0ZWRXaWR0aHMgPSBjb25maWcuc3VwcG9ydGVkV2lkdGhzPy5sZW5ndGhcclxuICAgICAgICAgICAgPyBjb25maWcuc3VwcG9ydGVkV2lkdGhzXHJcbiAgICAgICAgICAgIDogKFszLCA0LCA2LCA4LCAxMl0gYXMgRGFzaGJvYXJkV2lkZ2V0V2lkdGhbXSk7XHJcbiAgICAgICAgaWYgKCFzdXBwb3J0ZWRXaWR0aHMuaW5jbHVkZXModGFyZ2V0V2lkdGgpKSB7XHJcbiAgICAgICAgICAgIC8vIEZhbGwgYmFjayB0byB0aGUgbGFyZ2VzdCBzdXBwb3J0ZWQgd2lkdGhcclxuICAgICAgICAgICAgY29uc3Qgc29ydGVkV2lkdGhzID0gc3VwcG9ydGVkV2lkdGhzLnNvcnQoKGEsIGIpID0+IGEgLSBiKTtcclxuICAgICAgICAgICAgY29uc3QgZmFsbGJhY2tXaWR0aCA9IHN1cHBvcnRlZFdpZHRoc1tzb3J0ZWRXaWR0aHMubGVuZ3RoIC0gMV07XHJcbiAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBuby1jb25zb2xlXHJcbiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoXHJcbiAgICAgICAgICAgICAgICBgVGhlIFwiJHtpZH1cIiB3aWRnZXQgZG9lcyBub3Qgc3VwcG9ydCB0aGUgc3BlY2lmaWVkIHdpZHRoICgke3RhcmdldFdpZHRofSkuXFxuU3VwcG9ydGVkIHdpZHRocyBhcmU6IFske3NvcnRlZFdpZHRocy5qb2luKFxyXG4gICAgICAgICAgICAgICAgICAgICcsICcsXHJcbiAgICAgICAgICAgICAgICApfV0uXFxuVXNpbmcgKCR7ZmFsbGJhY2tXaWR0aH0pIGluc3RlYWQuYCxcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgYWRqdXN0ZWRXaWR0aCA9IGZhbGxiYWNrV2lkdGg7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBhZGp1c3RlZFdpZHRoO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgYnVpbGRMYXlvdXQoaW50ZXJtZWRpYXRlTGF5b3V0OiBXaWRnZXRMYXlvdXRbbnVtYmVyXSk6IFdpZGdldExheW91dCB7XHJcbiAgICAgICAgY29uc3QgbGF5b3V0OiBXaWRnZXRMYXlvdXQgPSBbXTtcclxuICAgICAgICBsZXQgcm93OiBXaWRnZXRMYXlvdXRbbnVtYmVyXSA9IFtdO1xyXG4gICAgICAgIGZvciAoY29uc3QgeyBpZCwgY29uZmlnLCB3aWR0aCB9IG9mIGludGVybWVkaWF0ZUxheW91dCkge1xyXG4gICAgICAgICAgICBjb25zdCByb3dTaXplID0gcm93LnJlZHVjZSgoc2l6ZSwgYykgPT4gc2l6ZSArIGMud2lkdGgsIDApO1xyXG4gICAgICAgICAgICBpZiAoMTIgPCByb3dTaXplICsgd2lkdGgpIHtcclxuICAgICAgICAgICAgICAgIGxheW91dC5wdXNoKHJvdyk7XHJcbiAgICAgICAgICAgICAgICByb3cgPSBbXTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICByb3cucHVzaCh7IGlkLCBjb25maWcsIHdpZHRoIH0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsYXlvdXQucHVzaChyb3cpO1xyXG4gICAgICAgIHJldHVybiBsYXlvdXQ7XHJcbiAgICB9XHJcbn1cclxuIl19