import { Injectable } from '@angular/core';
import { notNullOrUndefined } from '@vendure/common/lib/shared-utils';
import { BehaviorSubject, combineLatest, of } from 'rxjs';
import { map, shareReplay } from 'rxjs/operators';
import { Permission } from '../../common/generated-types';
import * as i0 from "@angular/core";
/**
 * This service is used to define the contents of configurable menus in the application.
 */
export class NavBuilderService {
    constructor() {
        this.sectionBadges = {};
        this.initialNavMenuConfig$ = new BehaviorSubject([]);
        this.addedNavMenuSections = [];
        this.addedNavMenuItems = [];
        this.addedActionBarItems = [];
        this.addedActionBarDropdownMenuItems = [];
        this.setupStreams();
    }
    /**
     * Used to define the initial sections and items of the main nav menu.
     */
    defineNavMenuSections(config) {
        this.initialNavMenuConfig$.next(config);
    }
    /**
     * Add a section to the main nav menu. Providing the `before` argument will
     * move the section before any existing section with the specified id. If
     * omitted (or if the id is not found) the section will be appended to the
     * existing set of sections.
     *
     * Providing the `id` of an existing section will replace that section.
     */
    addNavMenuSection(config, before) {
        this.addedNavMenuSections.push({ config, before });
    }
    /**
     * Add a menu item to an existing section specified by `sectionId`. The id of the section
     * can be found by inspecting the DOM and finding the `data-section-id` attribute.
     * Providing the `before` argument will move the item before any existing item with the specified id.
     * If omitted (or if the name is not found) the item will be appended to the
     * end of the section.
     *
     * Providing the `id` of an existing item in that section will replace
     * that item.
     */
    addNavMenuItem(config, sectionId, before) {
        this.addedNavMenuItems.push({ config, sectionId, before });
    }
    /**
     * Adds a button to the ActionBar at the top right of each list or detail view. The locationId can
     * be determined by inspecting the DOM and finding the `<vdr-action-bar>` element and its
     * `data-location-id` attribute.
     */
    addActionBarItem(config) {
        if (!this.addedActionBarItems.find(item => item.id === config.id)) {
            this.addedActionBarItems.push({
                requiresPermission: Permission.Authenticated,
                ...config,
            });
        }
    }
    /**
     * Adds a dropdown menu to the ActionBar at the top right of each list or detail view. The locationId can
     * be determined by inspecting the DOM and finding the `<vdr-action-bar>` element and its
     * `data-location-id` attribute.
     */
    addActionBarDropdownMenuItem(config) {
        if (!this.addedActionBarDropdownMenuItems.find(item => item.id === config.id)) {
            this.addedActionBarDropdownMenuItems.push({
                requiresPermission: Permission.Authenticated,
                ...config,
            });
        }
    }
    getRouterLink(config, route) {
        if (typeof config.routerLink === 'function') {
            return config.routerLink(route, config.context);
        }
        if (Array.isArray(config.routerLink)) {
            return config.routerLink;
        }
        return null;
    }
    setupStreams() {
        const sectionAdditions$ = of(this.addedNavMenuSections);
        const itemAdditions$ = of(this.addedNavMenuItems);
        const combinedConfig$ = combineLatest(this.initialNavMenuConfig$, sectionAdditions$).pipe(map(([initialConfig, additions]) => {
            for (const { config, before } of additions) {
                if (!config.requiresPermission) {
                    config.requiresPermission = Permission.Authenticated;
                }
                const existingIndex = initialConfig.findIndex(c => c.id === config.id);
                if (-1 < existingIndex) {
                    initialConfig[existingIndex] = config;
                }
                const beforeIndex = initialConfig.findIndex(c => c.id === before);
                if (-1 < beforeIndex) {
                    if (-1 < existingIndex) {
                        initialConfig.splice(existingIndex, 1);
                    }
                    initialConfig.splice(beforeIndex, 0, config);
                }
                else if (existingIndex === -1) {
                    initialConfig.push(config);
                }
            }
            return initialConfig;
        }), shareReplay(1));
        this.menuConfig$ = combineLatest(combinedConfig$, itemAdditions$).pipe(map(([sections, additionalItems]) => {
            for (const item of additionalItems) {
                const section = sections.find(s => s.id === item.sectionId);
                if (!section) {
                    // eslint-disable-next-line no-console
                    console.error(`Could not add menu item "${item.config.id}", section "${item.sectionId}" does not exist`);
                }
                else {
                    const { config, sectionId, before } = item;
                    const existingIndex = section.items.findIndex(i => i.id === config.id);
                    if (-1 < existingIndex) {
                        section.items[existingIndex] = config;
                    }
                    const beforeIndex = section.items.findIndex(i => i.id === before);
                    if (-1 < beforeIndex) {
                        if (-1 < existingIndex) {
                            section.items.splice(existingIndex, 1);
                        }
                        section.items.splice(beforeIndex, 0, config);
                    }
                    else if (existingIndex === -1) {
                        section.items.push(config);
                    }
                }
            }
            // Aggregate any badges defined for the nav items in each section
            for (const section of sections) {
                const itemBadgeStatuses = section.items
                    .map(i => i.statusBadge)
                    .filter(notNullOrUndefined);
                this.sectionBadges[section.id] = combineLatest(itemBadgeStatuses).pipe(map(badges => {
                    const propagatingBadges = badges.filter(b => b.propagateToSection);
                    if (propagatingBadges.length === 0) {
                        return 'none';
                    }
                    const statuses = propagatingBadges.map(b => b.type);
                    if (statuses.includes('error')) {
                        return 'error';
                    }
                    else if (statuses.includes('warning')) {
                        return 'warning';
                    }
                    else if (statuses.includes('info')) {
                        return 'info';
                    }
                    else {
                        return 'none';
                    }
                }));
            }
            return sections;
        }));
        this.actionBarConfig$ = of(this.addedActionBarItems);
        this.actionBarDropdownConfig$ = of(this.addedActionBarDropdownMenuItems);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: NavBuilderService, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: NavBuilderService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: NavBuilderService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: () => [] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmF2LWJ1aWxkZXIuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3NyYy9saWIvY29yZS9zcmMvcHJvdmlkZXJzL25hdi1idWlsZGVyL25hdi1idWlsZGVyLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUUzQyxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUN0RSxPQUFPLEVBQUUsZUFBZSxFQUFFLGFBQWEsRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEUsT0FBTyxFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUVsRCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sOEJBQThCLENBQUM7O0FBWTFEOztHQUVHO0FBSUgsTUFBTSxPQUFPLGlCQUFpQjtJQWdCMUI7UUFaQSxrQkFBYSxHQUEwRCxFQUFFLENBQUM7UUFFbEUsMEJBQXFCLEdBQUcsSUFBSSxlQUFlLENBQW1CLEVBQUUsQ0FBQyxDQUFDO1FBQ2xFLHlCQUFvQixHQUF1RCxFQUFFLENBQUM7UUFDOUUsc0JBQWlCLEdBSXBCLEVBQUUsQ0FBQztRQUNBLHdCQUFtQixHQUFvQixFQUFFLENBQUM7UUFDMUMsb0NBQStCLEdBQWdDLEVBQUUsQ0FBQztRQUd0RSxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7SUFDeEIsQ0FBQztJQUVEOztPQUVHO0lBQ0gscUJBQXFCLENBQUMsTUFBd0I7UUFDMUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM1QyxDQUFDO0lBRUQ7Ozs7Ozs7T0FPRztJQUNILGlCQUFpQixDQUFDLE1BQXNCLEVBQUUsTUFBZTtRQUNyRCxJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFB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RUFBRSxNQUFNO2lCQUNyQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgQWN0aXZhdGVkUm91dGUgfSBmcm9tICdAYW5ndWxhci9yb3V0ZXInO1xyXG5pbXBvcnQgeyBub3ROdWxsT3JVbmRlZmluZWQgfSBmcm9tICdAdmVuZHVyZS9jb21tb24vbGliL3NoYXJlZC11dGlscyc7XHJcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgY29tYmluZUxhdGVzdCwgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgbWFwLCBzaGFyZVJlcGxheSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuXHJcbmltcG9ydCB7IFBlcm1pc3Npb24gfSBmcm9tICcuLi8uLi9jb21tb24vZ2VuZXJhdGVkLXR5cGVzJztcclxuXHJcbmltcG9ydCB7XHJcbiAgICBBY3Rpb25CYXJDb250ZXh0LFxyXG4gICAgQWN0aW9uQmFyRHJvcGRvd25NZW51SXRlbSxcclxuICAgIEFjdGlvbkJhckl0ZW0sXHJcbiAgICBOYXZNZW51QmFkZ2VUeXBlLFxyXG4gICAgTmF2TWVudUl0ZW0sXHJcbiAgICBOYXZNZW51U2VjdGlvbixcclxuICAgIFJvdXRlckxpbmtEZWZpbml0aW9uLFxyXG59IGZyb20gJy4vbmF2LWJ1aWxkZXItdHlwZXMnO1xyXG5cclxuLyoqXHJcbiAqIFRoaXMgc2VydmljZSBpcyB1c2VkIHRvIGRlZmluZSB0aGUgY29udGVudHMgb2YgY29uZmlndXJhYmxlIG1lbnVzIGluIHRoZSBhcHBsaWNhdGlvbi5cclxuICovXHJcbkBJbmplY3RhYmxlKHtcclxuICAgIHByb3ZpZGVkSW46ICdyb290JyxcclxufSlcclxuZXhwb3J0IGNsYXNzIE5hdkJ1aWxkZXJTZXJ2aWNlIHtcclxuICAgIG1lbnVDb25maWckOiBPYnNlcnZhYmxlPE5hdk1lbnVTZWN0aW9uW10+O1xyXG4gICAgYWN0aW9uQmFyQ29uZmlnJDogT2JzZXJ2YWJsZTxBY3Rpb25CYXJJdGVtW10+O1xyXG4gICAgYWN0aW9uQmFyRHJvcGRvd25Db25maWckOiBPYnNlcnZhYmxlPEFjdGlvbkJhckRyb3Bkb3duTWVudUl0ZW1bXT47XHJcbiAgICBzZWN0aW9uQmFkZ2VzOiB7IFtzZWN0aW9uSWQ6IHN0cmluZ106IE9ic2VydmFibGU8TmF2TWVudUJhZGdlVHlwZT4gfSA9IHt9O1xyXG5cclxuICAgIHByaXZhdGUgaW5pdGlhbE5hdk1lbnVDb25maWckID0gbmV3IEJlaGF2aW9yU3ViamVjdDxOYXZNZW51U2VjdGlvbltdPihbXSk7XHJcbiAgICBwcml2YXRlIGFkZGVkTmF2TWVudVNlY3Rpb25zOiBBcnJheTx7IGNvbmZpZzogTmF2TWVudVNlY3Rpb247IGJlZm9yZT86IHN0cmluZyB9PiA9IFtdO1xyXG4gICAgcHJpdmF0ZSBhZGRlZE5hdk1lbnVJdGVtczogQXJyYXk8e1xyXG4gICAgICAgIGNvbmZpZzogTmF2TWVudUl0ZW07XHJcbiAgICAgICAgc2VjdGlvbklkOiBzdHJpbmc7XHJcbiAgICAgICAgYmVmb3JlPzogc3RyaW5nO1xyXG4gICAgfT4gPSBbXTtcclxuICAgIHByaXZhdGUgYWRkZWRBY3Rpb25CYXJJdGVtczogQWN0aW9uQmFySXRlbVtdID0gW107XHJcbiAgICBwcml2YXRlIGFkZGVkQWN0aW9uQmFyRHJvcGRvd25NZW51SXRlbXM6IEFjdGlvbkJhckRyb3Bkb3duTWVudUl0ZW1bXSA9IFtdO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKCkge1xyXG4gICAgICAgIHRoaXMuc2V0dXBTdHJlYW1zKCk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBVc2VkIHRvIGRlZmluZSB0aGUgaW5pdGlhbCBzZWN0aW9ucyBhbmQgaXRlbXMgb2YgdGhlIG1haW4gbmF2IG1lbnUuXHJcbiAgICAgKi9cclxuICAgIGRlZmluZU5hdk1lbnVTZWN0aW9ucyhjb25maWc6IE5hdk1lbnVTZWN0aW9uW10pIHtcclxuICAgICAgICB0aGlzLmluaXRpYWxOYXZNZW51Q29uZmlnJC5uZXh0KGNvbmZpZyk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBBZGQgYSBzZWN0aW9uIHRvIHRoZSBtYWluIG5hdiBtZW51LiBQcm92aWRpbmcgdGhlIGBiZWZvcmVgIGFyZ3VtZW50IHdpbGxcclxuICAgICAqIG1vdmUgdGhlIHNlY3Rpb24gYmVmb3JlIGFueSBleGlzdGluZyBzZWN0aW9uIHdpdGggdGhlIHNwZWNpZmllZCBpZC4gSWZcclxuICAgICAqIG9taXR0ZWQgKG9yIGlmIHRoZSBpZCBpcyBub3QgZm91bmQpIHRoZSBzZWN0aW9uIHdpbGwgYmUgYXBwZW5kZWQgdG8gdGhlXHJcbiAgICAgKiBleGlzdGluZyBzZXQgb2Ygc2VjdGlvbnMuXHJcbiAgICAgKlxyXG4gICAgICogUHJvdmlkaW5nIHRoZSBgaWRgIG9mIGFuIGV4aXN0aW5nIHNlY3Rpb24gd2lsbCByZXBsYWNlIHRoYXQgc2VjdGlvbi5cclxuICAgICAqL1xyXG4gICAgYWRkTmF2TWVudVNlY3Rpb24oY29uZmlnOiBOYXZNZW51U2VjdGlvbiwgYmVmb3JlPzogc3RyaW5nKSB7XHJcbiAgICAgICAgdGhpcy5hZGRlZE5hdk1lbnVTZWN0aW9ucy5wdXNoKHsgY29uZmlnLCBiZWZvcmUgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBBZGQgYSBtZW51IGl0ZW0gdG8gYW4gZXhpc3Rpbmcgc2VjdGlvbiBzcGVjaWZpZWQgYnkgYHNlY3Rpb25JZGAuIFRoZSBpZCBvZiB0aGUgc2VjdGlvblxyXG4gICAgICogY2FuIGJlIGZvdW5kIGJ5IGluc3BlY3RpbmcgdGhlIERPTSBhbmQgZmluZGluZyB0aGUgYGRhdGEtc2VjdGlvbi1pZGAgYXR0cmlidXRlLlxyXG4gICAgICogUHJvdmlkaW5nIHRoZSBgYmVmb3JlYCBhcmd1bWVudCB3aWxsIG1vdmUgdGhlIGl0ZW0gYmVmb3JlIGFueSBleGlzdGluZyBpdGVtIHdpdGggdGhlIHNwZWNpZmllZCBpZC5cclxuICAgICAqIElmIG9taXR0ZWQgKG9yIGlmIHRoZSBuYW1lIGlzIG5vdCBmb3VuZCkgdGhlIGl0ZW0gd2lsbCBiZSBhcHBlbmRlZCB0byB0aGVcclxuICAgICAqIGVuZCBvZiB0aGUgc2VjdGlvbi5cclxuICAgICAqXHJcbiAgICAgKiBQcm92aWRpbmcgdGhlIGBpZGAgb2YgYW4gZXhpc3RpbmcgaXRlbSBpbiB0aGF0IHNlY3Rpb24gd2lsbCByZXBsYWNlXHJcbiAgICAgKiB0aGF0IGl0ZW0uXHJcbiAgICAgKi9cclxuICAgIGFkZE5hdk1lbnVJdGVtKGNvbmZpZzogTmF2TWVudUl0ZW0sIHNlY3Rpb25JZDogc3RyaW5nLCBiZWZvcmU/OiBzdHJpbmcpIHtcclxuICAgICAgICB0aGlzLmFkZGVkTmF2TWVudUl0ZW1zLnB1c2goeyBjb25maWcsIHNlY3Rpb25JZCwgYmVmb3JlIH0pO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogQWRkcyBhIGJ1dHRvbiB0byB0aGUgQWN0aW9uQmFyIGF0IHRoZSB0b3AgcmlnaHQgb2YgZWFjaCBsaXN0IG9yIGRldGFpbCB2aWV3LiBUaGUgbG9jYXRpb25JZCBjYW5cclxuICAgICAqIGJlIGRldGVybWluZWQgYnkgaW5zcGVjdGluZyB0aGUgRE9NIGFuZCBmaW5kaW5nIHRoZSBgPHZkci1hY3Rpb24tYmFyPmAgZWxlbWVudCBhbmQgaXRzXHJcbiAgICAgKiBgZGF0YS1sb2NhdGlvbi1pZGAgYXR0cmlidXRlLlxyXG4gICAgICovXHJcbiAgICBhZGRBY3Rpb25CYXJJdGVtKGNvbmZpZzogQWN0aW9uQmFySXRlbSkge1xyXG4gICAgICAgIGlmICghdGhpcy5hZGRlZEFjdGlvbkJhckl0ZW1zLmZpbmQoaXRlbSA9PiBpdGVtLmlkID09PSBjb25maWcuaWQpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYWRkZWRBY3Rpb25CYXJJdGVtcy5wdXNoKHtcclxuICAgICAgICAgICAgICAgIHJlcXVpcmVzUGVybWlzc2lvbjogUGVybWlzc2lvbi5BdXRoZW50aWNhdGVkLFxyXG4gICAgICAgICAgICAgICAgLi4uY29uZmlnLFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBBZGRzIGEgZHJvcGRvd24gbWVudSB0byB0aGUgQWN0aW9uQmFyIGF0IHRoZSB0b3AgcmlnaHQgb2YgZWFjaCBsaXN0IG9yIGRldGFpbCB2aWV3LiBUaGUgbG9jYXRpb25JZCBjYW5cclxuICAgICAqIGJlIGRldGVybWluZWQgYnkgaW5zcGVjdGluZyB0aGUgRE9NIGFuZCBmaW5kaW5nIHRoZSBgPHZkci1hY3Rpb24tYmFyPmAgZWxlbWVudCBhbmQgaXRzXHJcbiAgICAgKiBgZGF0YS1sb2NhdGlvbi1pZGAgYXR0cmlidXRlLlxyXG4gICAgICovXHJcbiAgICBhZGRBY3Rpb25CYXJEcm9wZG93bk1lbnVJdGVtKGNvbmZpZzogQWN0aW9uQmFyRHJvcGRvd25NZW51SXRlbSkge1xyXG4gICAgICAgIGlmICghdGhpcy5hZGRlZEFjdGlvbkJhckRyb3Bkb3duTWVudUl0ZW1zLmZpbmQoaXRlbSA9PiBpdGVtLmlkID09PSBjb25maWcuaWQpKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYWRkZWRBY3Rpb25CYXJEcm9wZG93bk1lbnVJdGVtcy5wdXNoKHtcclxuICAgICAgICAgICAgICAgIHJlcXVpcmVzUGVybWlzc2lvbjogUGVybWlzc2lvbi5BdXRoZW50aWNhdGVkLFxyXG4gICAgICAgICAgICAgICAgLi4uY29uZmlnLFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0Um91dGVyTGluayhcclxuICAgICAgICBjb25maWc6IHsgcm91dGVyTGluaz86IFJvdXRlckxpbmtEZWZpbml0aW9uOyBjb250ZXh0OiBBY3Rpb25CYXJDb250ZXh0IH0sXHJcbiAgICAgICAgcm91dGU6IEFjdGl2YXRlZFJvdXRlLFxyXG4gICAgKTogc3RyaW5nW10gfCBudWxsIHtcclxuICAgICAgICBpZiAodHlwZW9mIGNvbmZpZy5yb3V0ZXJMaW5rID09PSAnZnVuY3Rpb24nKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBjb25maWcucm91dGVyTGluayhyb3V0ZSwgY29uZmlnLmNvbnRleHQpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShjb25maWcucm91dGVyTGluaykpIHtcclxuICAgICAgICAgICAgcmV0dXJuIGNvbmZpZy5yb3V0ZXJMaW5rO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNldHVwU3RyZWFtcygpIHtcclxuICAgICAgICBjb25zdCBzZWN0aW9uQWRkaXRpb25zJCA9IG9mKHRoaXMuYWRkZWROYXZNZW51U2VjdGlvbnMpO1xyXG4gICAgICAgIGNvbnN0IGl0ZW1BZGRpdGlvbnMkID0gb2YodGhpcy5hZGRlZE5hdk1lbnVJdGVtcyk7XHJcblxyXG4gICAgICAgIGNvbnN0IGNvbWJpbmVkQ29uZmlnJCA9IGNvbWJpbmVMYXRlc3QodGhpcy5pbml0aWFsTmF2TWVudUNvbmZpZyQsIHNlY3Rpb25BZGRpdGlvbnMkKS5waXBlKFxyXG4gICAgICAgICAgICBtYXAoKFtpbml0aWFsQ29uZmlnLCBhZGRpdGlvbnNdKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHsgY29uZmlnLCBiZWZvcmUgfSBvZiBhZGRpdGlvbnMpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoIWNvbmZpZy5yZXF1aXJlc1Blcm1pc3Npb24pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uZmlnLnJlcXVpcmVzUGVybWlzc2lvbiA9IFBlcm1pc3Npb24uQXV0aGVudGljYXRlZDtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhpc3RpbmdJbmRleCA9IGluaXRpYWxDb25maWcuZmluZEluZGV4KGMgPT4gYy5pZCA9PT0gY29uZmlnLmlkKTtcclxuICAgICAgICAgICAgICAgICAgICBpZiAoLTEgPCBleGlzdGluZ0luZGV4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGluaXRpYWxDb25maWdbZXhpc3RpbmdJbmRleF0gPSBjb25maWc7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGJlZm9yZUluZGV4ID0gaW5pdGlhbENvbmZpZy5maW5kSW5kZXgoYyA9PiBjLmlkID09PSBiZWZvcmUpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICgtMSA8IGJlZm9yZUluZGV4KSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgtMSA8IGV4aXN0aW5nSW5kZXgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluaXRpYWxDb25maWcuc3BsaWNlKGV4aXN0aW5nSW5kZXgsIDEpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGluaXRpYWxDb25maWcuc3BsaWNlKGJlZm9yZUluZGV4LCAwLCBjb25maWcpO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZXhpc3RpbmdJbmRleCA9PT0gLTEpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaW5pdGlhbENvbmZpZy5wdXNoKGNvbmZpZyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGluaXRpYWxDb25maWc7XHJcbiAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICBzaGFyZVJlcGxheSgxKSxcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICB0aGlzLm1lbnVDb25maWckID0gY29tYmluZUxhdGVzdChjb21iaW5lZENvbmZpZyQsIGl0ZW1BZGRpdGlvbnMkKS5waXBlKFxyXG4gICAgICAgICAgICBtYXAoKFtzZWN0aW9ucywgYWRkaXRpb25hbEl0ZW1zXSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIGFkZGl0aW9uYWxJdGVtcykge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHNlY3Rpb24gPSBzZWN0aW9ucy5maW5kKHMgPT4gcy5pZCA9PT0gaXRlbS5zZWN0aW9uSWQpO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmICghc2VjdGlvbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYENvdWxkIG5vdCBhZGQgbWVudSBpdGVtIFwiJHtpdGVtLmNvbmZpZy5pZH1cIiwgc2VjdGlvbiBcIiR7aXRlbS5zZWN0aW9uSWR9XCIgZG9lcyBub3QgZXhpc3RgLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICApO1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgY29uZmlnLCBzZWN0aW9uSWQsIGJlZm9yZSB9ID0gaXRlbTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXhpc3RpbmdJbmRleCA9IHNlY3Rpb24uaXRlbXMuZmluZEluZGV4KGkgPT4gaS5pZCA9PT0gY29uZmlnLmlkKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKC0xIDwgZXhpc3RpbmdJbmRleCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VjdGlvbi5pdGVtc1tleGlzdGluZ0luZGV4XSA9IGNvbmZpZztcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBiZWZvcmVJbmRleCA9IHNlY3Rpb24uaXRlbXMuZmluZEluZGV4KGkgPT4gaS5pZCA9PT0gYmVmb3JlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKC0xIDwgYmVmb3JlSW5kZXgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgtMSA8IGV4aXN0aW5nSW5kZXgpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWN0aW9uLml0ZW1zLnNwbGljZShleGlzdGluZ0luZGV4LCAxKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlY3Rpb24uaXRlbXMuc3BsaWNlKGJlZm9yZUluZGV4LCAwLCBjb25maWcpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGV4aXN0aW5nSW5kZXggPT09IC0xKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWN0aW9uLml0ZW1zLnB1c2goY29uZmlnKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAvLyBBZ2dyZWdhdGUgYW55IGJhZGdlcyBkZWZpbmVkIGZvciB0aGUgbmF2IGl0ZW1zIGluIGVhY2ggc2VjdGlvblxyXG4gICAgICAgICAgICAgICAgZm9yIChjb25zdCBzZWN0aW9uIG9mIHNlY3Rpb25zKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaXRlbUJhZGdlU3RhdHVzZXMgPSBzZWN0aW9uLml0ZW1zXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAoaSA9PiBpLnN0YXR1c0JhZGdlKVxyXG4gICAgICAgICAgICAgICAgICAgICAgICAuZmlsdGVyKG5vdE51bGxPclVuZGVmaW5lZCk7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5zZWN0aW9uQmFkZ2VzW3NlY3Rpb24uaWRdID0gY29tYmluZUxhdGVzdChpdGVtQmFkZ2VTdGF0dXNlcykucGlwZShcclxuICAgICAgICAgICAgICAgICAgICAgICAgbWFwKGJhZGdlcyA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwcm9wYWdhdGluZ0JhZGdlcyA9IGJhZGdlcy5maWx0ZXIoYiA9PiBiLnByb3BhZ2F0ZVRvU2VjdGlvbik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocHJvcGFnYXRpbmdCYWRnZXMubGVuZ3RoID09PSAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICdub25lJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXR1c2VzID0gcHJvcGFnYXRpbmdCYWRnZXMubWFwKGIgPT4gYi50eXBlKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzdGF0dXNlcy5pbmNsdWRlcygnZXJyb3InKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnZXJyb3InO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGF0dXNlcy5pbmNsdWRlcygnd2FybmluZycpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICd3YXJuaW5nJztcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhdHVzZXMuaW5jbHVkZXMoJ2luZm8nKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnaW5mbyc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnbm9uZSc7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pLFxyXG4gICAgICAgICAgICAgICAgICAgICk7XHJcbiAgICAgICAgICAgICAgICB9XHJcblxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHNlY3Rpb25zO1xyXG4gICAgICAgICAgICB9KSxcclxuICAgICAgICApO1xyXG5cclxuICAgICAgICB0aGlzLmFjdGlvbkJhckNvbmZpZyQgPSBvZih0aGlzLmFkZGVkQWN0aW9uQmFySXRlbXMpO1xyXG4gICAgICAgIHRoaXMuYWN0aW9uQmFyRHJvcGRvd25Db25maWckID0gb2YodGhpcy5hZGRlZEFjdGlvbkJhckRyb3Bkb3duTWVudUl0ZW1zKTtcclxuICAgIH1cclxufVxyXG4iXX0=