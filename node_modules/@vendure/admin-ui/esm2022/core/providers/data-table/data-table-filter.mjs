import { assertNever } from '@vendure/common/lib/shared-utils';
import dayjs from 'dayjs';
export class DataTableFilter {
    constructor(options, onActivate) {
        this.options = options;
        this.onActivate = onActivate;
    }
    get name() {
        return this.options.name;
    }
    get type() {
        return this.options.type;
    }
    get label() {
        return this.options.label;
    }
    getFilterOperator(value) {
        const type = this.options.type;
        switch (type.kind) {
            case 'boolean':
                return {
                    eq: !!value,
                };
            case 'dateRange': {
                let dateOperators;
                const mode = value.mode ?? 'relative';
                if (mode === 'relative') {
                    const relativeValue = value.relativeValue ?? 30;
                    const relativeUnit = value.relativeUnit ?? 'day';
                    dateOperators = {
                        after: dayjs().subtract(relativeValue, relativeUnit).startOf('day').toISOString(),
                    };
                }
                else {
                    const start = value.start ?? undefined;
                    const end = value.end ?? undefined;
                    if (start && end) {
                        dateOperators = {
                            between: { start, end },
                        };
                    }
                    else if (start) {
                        dateOperators = {
                            after: start,
                        };
                    }
                    else {
                        dateOperators = {
                            before: end,
                        };
                    }
                }
                return dateOperators;
            }
            case 'number':
                return {
                    [value.operator]: Number(value.amount),
                };
            case 'select':
                return { in: value };
            case 'text':
                return {
                    [value.operator]: value.term,
                };
            case 'id':
                return {
                    [value.operator]: value.term,
                };
            case 'custom': {
                return value;
            }
            default:
                assertNever(type);
        }
    }
    toFilterInput(value) {
        if (this.options.toFilterInput) {
            return this.options.toFilterInput(value);
        }
        if (this.options.filterField) {
            return { [this.options.filterField]: this.getFilterOperator(value) };
        }
        else {
            throw new Error(`Either "filterField" or "toFilterInput" must be provided (for filter "${this.name}"))`);
        }
    }
    activate(value) {
        if (this.onActivate) {
            this.onActivate(this, value);
        }
    }
    isId() {
        return this.type.kind === 'id';
    }
    isText() {
        return this.type.kind === 'text';
    }
    isNumber() {
        return this.type.kind === 'number';
    }
    isBoolean() {
        return this.type.kind === 'boolean';
    }
    isSelect() {
        return this.type.kind === 'select';
    }
    isDateRange() {
        return this.type.kind === 'dateRange';
    }
    isCustom() {
        return this.type.kind === 'custom';
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS10YWJsZS1maWx0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvbGliL2NvcmUvc3JjL3Byb3ZpZGVycy9kYXRhLXRhYmxlL2RhdGEtdGFibGUtZmlsdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUMvRCxPQUFPLEtBQUssTUFBTSxPQUFPLENBQUM7QUFrRzFCLE1BQU0sT0FBTyxlQUFlO0lBSXhCLFlBQ3FCLE9BQWtELEVBQzNELFVBR0M7UUFKUSxZQUFPLEdBQVAsT0FBTyxDQUEyQztRQUMzRCxlQUFVLEdBQVYsVUFBVSxDQUdUO0lBQ1YsQ0FBQztJQUVKLElBQUksSUFBSTtRQUNKLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7SUFDN0IsQ0FBQztJQUVELElBQUksSUFBSTtRQUNKLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7SUFDN0IsQ0FBQztJQUVELElBQUksS0FBSztRQUNMLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUM7SUFDOUIsQ0FBQztJQUVELGlCQUFpQixDQUFDLEtBQVU7UUFDeEIsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUM7UUFDL0IsUUFBUSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7WUFDaEIsS0FBSyxTQUFTO2dCQUNWLE9BQU87b0JBQ0gsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLO2lCQUNkLENBQUM7WUFDTixLQUFLLFdBQVcsQ0FBQyxDQUFDLENBQUM7Z0JBQ2YsSUFBSSxhQUE0QixDQUFDO2dCQUNqQyxNQUFNLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxJQUFJLFVBQVUsQ0FBQztnQkFDdEMsSUFBSSxJQUFJLEtBQUssVUFBVSxFQUFFLENBQUM7b0JBQ3RCLE1BQU0sYUFBYSxHQUFHLEtBQUss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QUksS0FBSyxRQUFRLENBQUM7SUFDdkMsQ0FBQztJQUVELFNBQVM7UUFDTCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLFNBQVMsQ0FBQztJQUN4QyxDQUFDO0lBRUQsUUFBUTtRQUNKLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEtBQUssUUFBUSxDQUFDO0lBQ3ZDLENBQUM7SUFFRCxXQUFXO1FBQ1AsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksS0FBSyxXQUFXLENBQUM7SUFDMUMsQ0FBQztJQUVELFFBQVE7UUFDSixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxLQUFLLFFBQVEsQ0FBQztJQUN2QyxDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBUeXBlIGFzIENvbXBvbmVudFR5cGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgTG9jYWxpemVkU3RyaW5nIH0gZnJvbSAnQHZlbmR1cmUvY29tbW9uL2xpYi9nZW5lcmF0ZWQtdHlwZXMnO1xyXG5pbXBvcnQgeyBhc3NlcnROZXZlciB9IGZyb20gJ0B2ZW5kdXJlL2NvbW1vbi9saWIvc2hhcmVkLXV0aWxzJztcclxuaW1wb3J0IGRheWpzIGZyb20gJ2RheWpzJztcclxuaW1wb3J0IHsgRm9ybUlucHV0Q29tcG9uZW50IH0gZnJvbSAnLi4vLi4vY29tbW9uL2NvbXBvbmVudC1yZWdpc3RyeS10eXBlcyc7XHJcbmltcG9ydCB7XHJcbiAgICBCb29sZWFuT3BlcmF0b3JzLFxyXG4gICAgRGF0ZU9wZXJhdG9ycyxcclxuICAgIElkT3BlcmF0b3JzLFxyXG4gICAgTnVtYmVyT3BlcmF0b3JzLFxyXG4gICAgU3RyaW5nT3BlcmF0b3JzLFxyXG59IGZyb20gJy4uLy4uL2NvbW1vbi9nZW5lcmF0ZWQtdHlwZXMnO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBEYXRhVGFibGVGaWx0ZXJJRFR5cGUge1xyXG4gICAga2luZDogJ2lkJztcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBEYXRhVGFibGVGaWx0ZXJUZXh0VHlwZSB7XHJcbiAgICBraW5kOiAndGV4dCc7XHJcbiAgICBwbGFjZWhvbGRlcj86IHN0cmluZztcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBEYXRhVGFibGVGaWx0ZXJTZWxlY3RUeXBlIHtcclxuICAgIGtpbmQ6ICdzZWxlY3QnO1xyXG4gICAgb3B0aW9uczogQXJyYXk8eyB2YWx1ZTogYW55OyBsYWJlbDogc3RyaW5nIH0+O1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIERhdGFUYWJsZUZpbHRlckJvb2xlYW5UeXBlIHtcclxuICAgIGtpbmQ6ICdib29sZWFuJztcclxufVxyXG5cclxuZXhwb3J0IGludGVyZmFjZSBEYXRhVGFibGVGaWx0ZXJOdW1iZXJUeXBlIHtcclxuICAgIGtpbmQ6ICdudW1iZXInO1xyXG4gICAgaW5wdXRUeXBlPzogJ251bWJlcicgfCAnY3VycmVuY3knO1xyXG59XHJcblxyXG5leHBvcnQgaW50ZXJmYWNlIERhdGFUYWJsZUZpbHRlckRhdGVSYW5nZVR5cGUge1xyXG4gICAga2luZDogJ2RhdGVSYW5nZSc7XHJcbn1cclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgRGF0YVRhYmxlRmlsdGVyQ3VzdG9tVHlwZSB7XHJcbiAgICBraW5kOiAnY3VzdG9tJztcclxuICAgIGNvbXBvbmVudDogQ29tcG9uZW50VHlwZTxGb3JtSW5wdXRDb21wb25lbnQ+O1xyXG4gICAgc2VyaWFsaXplVmFsdWU6ICh2YWx1ZTogYW55KSA9PiBzdHJpbmc7XHJcbiAgICBkZXNlcmlhbGl6ZVZhbHVlOiAoc2VyaWFsaXplZDogc3RyaW5nKSA9PiBhbnk7XHJcbiAgICBnZXRMYWJlbCh2YWx1ZTogYW55KTogc3RyaW5nIHwgUHJvbWlzZTxzdHJpbmc+O1xyXG59XHJcblxyXG5leHBvcnQgdHlwZSBLaW5kVmFsdWVNYXAgPSB7XHJcbiAgICBpZDoge1xyXG4gICAgICAgIHJhdzoge1xyXG4gICAgICAgICAgICBvcGVyYXRvcjoga2V5b2YgSWRPcGVyYXRvcnM7XHJcbiAgICAgICAgICAgIHRlcm06IHN0cmluZztcclxuICAgICAgICB9O1xyXG4gICAgICAgIGlucHV0OiBJZE9wZXJhdG9ycztcclxuICAgIH07XHJcbiAgICB0ZXh0OiB7XHJcbiAgICAgICAgcmF3OiB7XHJcbiAgICAgICAgICAgIG9wZXJhdG9yOiBrZXlvZiBTdHJpbmdPcGVyYXRvcnM7XHJcbiAgICAgICAgICAgIHRlcm06IHN0cmluZztcclxuICAgICAgICB9O1xyXG4gICAgICAgIGlucHV0OiBTdHJpbmdPcGVyYXRvcnM7XHJcbiAgICB9O1xyXG4gICAgc2VsZWN0OiB7IHJhdzogc3RyaW5nW107IGlucHV0OiBTdHJpbmdPcGVyYXRvcnMgfTtcclxuICAgIGJvb2xlYW46IHsgcmF3OiBib29sZWFuOyBpbnB1dDogQm9vbGVhbk9wZXJhdG9ycyB9O1xyXG4gICAgZGF0ZVJhbmdlOiB7XHJcbiAgICAgICAgcmF3OiB7XHJcbiAgICAgICAgICAgIG1vZGU6ICdyZWxhdGl2ZScgfCAncmFuZ2UnO1xyXG4gICAgICAgICAgICByZWxhdGl2ZVZhbHVlOiBudW1iZXI7XHJcbiAgICAgICAgICAgIHJlbGF0aXZlVW5pdDogJ2RheScgfCAnbW9udGgnIHwgJ3llYXInO1xyXG4gICAgICAgICAgICBzdGFydD86IHN0cmluZztcclxuICAgICAgICAgICAgZW5kPzogc3RyaW5nO1xyXG4gICAgICAgIH07XHJcbiAgICAgICAgaW5wdXQ6IERhdGVPcGVyYXRvcnM7XHJcbiAgICB9O1xyXG4gICAgbnVtYmVyOiB7IHJhdzogeyBvcGVyYXRvcjoga2V5b2YgTnVtYmVyT3BlcmF0b3JzOyBhbW91bnQ6IG51bWJlciB9OyBpbnB1dDogTnVtYmVyT3BlcmF0b3JzIH07XHJcbiAgICBjdXN0b206IHsgcmF3OiBhbnk7IGlucHV0OiBhbnkgfTtcclxufTtcclxuZXhwb3J0IHR5cGUgRGF0YVRhYmxlRmlsdGVyVHlwZSA9XHJcbiAgICB8IERhdGFUYWJsZUZpbHRlcklEVHlwZVxyXG4gICAgfCBEYXRhVGFibGVGaWx0ZXJUZXh0VHlwZVxyXG4gICAgfCBEYXRhVGFibGVGaWx0ZXJTZWxlY3RUeXBlXHJcbiAgICB8IERhdGFUYWJsZUZpbHRlckJvb2xlYW5UeXBlXHJcbiAgICB8IERhdGFUYWJsZUZpbHRlckRhdGVSYW5nZVR5cGVcclxuICAgIHwgRGF0YVRhYmxlRmlsdGVyTnVtYmVyVHlwZVxyXG4gICAgfCBEYXRhVGFibGVGaWx0ZXJDdXN0b21UeXBlO1xyXG5cclxuZXhwb3J0IGludGVyZmFjZSBEYXRhVGFibGVGaWx0ZXJPcHRpb25zPFxyXG4gICAgRmlsdGVySW5wdXQgZXh0ZW5kcyBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0gYW55LFxyXG4gICAgVHlwZSBleHRlbmRzIERhdGFUYWJsZUZpbHRlclR5cGUgPSBEYXRhVGFibGVGaWx0ZXJUeXBlLFxyXG4+IHtcclxuICAgIHJlYWRvbmx5IG5hbWU6IHN0cmluZztcclxuICAgIHJlYWRvbmx5IHR5cGU6IFR5cGU7XHJcbiAgICByZWFkb25seSBsYWJlbDogc3RyaW5nIHwgTG9jYWxpemVkU3RyaW5nW107XHJcbiAgICByZWFkb25seSBmaWx0ZXJGaWVsZD86IGtleW9mIEZpbHRlcklucHV0O1xyXG4gICAgcmVhZG9ubHkgdG9GaWx0ZXJJbnB1dD86ICh2YWx1ZTogRGF0YVRhYmxlRmlsdGVyVmFsdWU8VHlwZT4pID0+IFBhcnRpYWw8RmlsdGVySW5wdXQ+O1xyXG59XHJcblxyXG5leHBvcnQgdHlwZSBEYXRhVGFibGVGaWx0ZXJWYWx1ZTxUeXBlIGV4dGVuZHMgRGF0YVRhYmxlRmlsdGVyVHlwZT4gPSBLaW5kVmFsdWVNYXBbVHlwZVsna2luZCddXVsncmF3J107XHJcbmV4cG9ydCB0eXBlIERhdGFUYWJsZUZpbHRlck9wZXJhdG9yPFR5cGUgZXh0ZW5kcyBEYXRhVGFibGVGaWx0ZXJUeXBlPiA9IEtpbmRWYWx1ZU1hcFtUeXBlWydraW5kJ11dWydpbnB1dCddO1xyXG5cclxuZXhwb3J0IGNsYXNzIERhdGFUYWJsZUZpbHRlcjxcclxuICAgIEZpbHRlcklucHV0IGV4dGVuZHMgUmVjb3JkPHN0cmluZywgYW55PiA9IGFueSxcclxuICAgIFR5cGUgZXh0ZW5kcyBEYXRhVGFibGVGaWx0ZXJUeXBlID0gRGF0YVRhYmxlRmlsdGVyVHlwZSxcclxuPiB7XHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBwcml2YXRlIHJlYWRvbmx5IG9wdGlvbnM6IERhdGFUYWJsZUZpbHRlck9wdGlvbnM8RmlsdGVySW5wdXQsIFR5cGU+LFxyXG4gICAgICAgIHByaXZhdGUgb25BY3RpdmF0ZT86IChcclxuICAgICAgICAgICAgZmlsdGVyOiBEYXRhVGFibGVGaWx0ZXI8RmlsdGVySW5wdXQsIFR5cGU+LFxyXG4gICAgICAgICAgICB2YWx1ZTogRGF0YVRhYmxlRmlsdGVyVmFsdWU8VHlwZT4gfCB1bmRlZmluZWQsXHJcbiAgICAgICAgKSA9PiB2b2lkLFxyXG4gICAgKSB7fVxyXG5cclxuICAgIGdldCBuYW1lKCk6IHN0cmluZyB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMub3B0aW9ucy5uYW1lO1xyXG4gICAgfVxyXG5cclxuICAgIGdldCB0eXBlKCk6IFR5cGUge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMudHlwZTtcclxuICAgIH1cclxuXHJcbiAgICBnZXQgbGFiZWwoKTogc3RyaW5nIHwgTG9jYWxpemVkU3RyaW5nW10ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMubGFiZWw7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0RmlsdGVyT3BlcmF0b3IodmFsdWU6IGFueSk6IERhdGFUYWJsZUZpbHRlck9wZXJhdG9yPFR5cGU+IHtcclxuICAgICAgICBjb25zdCB0eXBlID0gdGhpcy5vcHRpb25zLnR5cGU7XHJcbiAgICAgICAgc3dpdGNoICh0eXBlLmtpbmQpIHtcclxuICAgICAgICAgICAgY2FzZSAnYm9vbGVhbic6XHJcbiAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgIGVxOiAhIXZhbHVlLFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgY2FzZSAnZGF0ZVJhbmdlJzoge1xyXG4gICAgICAgICAgICAgICAgbGV0IGRhdGVPcGVyYXRvcnM6IERhdGVPcGVyYXRvcnM7XHJcbiAgICAgICAgICAgICAgICBjb25zdCBtb2RlID0gdmFsdWUubW9kZSA/PyAncmVsYXRpdmUnO1xyXG4gICAgICAgICAgICAgICAgaWYgKG1vZGUgPT09ICdyZWxhdGl2ZScpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCByZWxhdGl2ZVZhbHVlID0gdmFsdWUucmVsYXRpdmVWYWx1ZSA/PyAzMDtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCByZWxhdGl2ZVVuaXQgPSB2YWx1ZS5yZWxhdGl2ZVVuaXQgPz8gJ2RheSc7XHJcbiAgICAgICAgICAgICAgICAgICAgZGF0ZU9wZXJhdG9ycyA9IHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXI6IGRheWpzKCkuc3VidHJhY3QocmVsYXRpdmVWYWx1ZSwgcmVsYXRpdmVVbml0KS5zdGFydE9mKCdkYXknKS50b0lTT1N0cmluZygpLFxyXG4gICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gdmFsdWUuc3RhcnQgPz8gdW5kZWZpbmVkO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvbnN0IGVuZCA9IHZhbHVlLmVuZCA/PyB1bmRlZmluZWQ7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXJ0ICYmIGVuZCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRlT3BlcmF0b3JzID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYmV0d2VlbjogeyBzdGFydCwgZW5kIH0sXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzdGFydCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRlT3BlcmF0b3JzID0ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYWZ0ZXI6IHN0YXJ0LFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGVPcGVyYXRvcnMgPSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZWZvcmU6IGVuZCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZGF0ZU9wZXJhdG9ycztcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBjYXNlICdudW1iZXInOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICBbdmFsdWUub3BlcmF0b3JdOiBOdW1iZXIodmFsdWUuYW1vdW50KSxcclxuICAgICAgICAgICAgICAgIH07XHJcblxyXG4gICAgICAgICAgICBjYXNlICdzZWxlY3QnOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHsgaW46IHZhbHVlIH07XHJcbiAgICAgICAgICAgIGNhc2UgJ3RleHQnOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICBbdmFsdWUub3BlcmF0b3JdOiB2YWx1ZS50ZXJtLFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgY2FzZSAnaWQnOlxyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcclxuICAgICAgICAgICAgICAgICAgICBbdmFsdWUub3BlcmF0b3JdOiB2YWx1ZS50ZXJtLFxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgY2FzZSAnY3VzdG9tJzoge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICAgICAgICBhc3NlcnROZXZlcih0eXBlKTtcclxuICAgICAgICB9XHJcbiAgICB9XHJcblxyXG4gICAgdG9GaWx0ZXJJbnB1dCh2YWx1ZTogRGF0YVRhYmxlRmlsdGVyVmFsdWU8VHlwZT4pOiBQYXJ0aWFsPEZpbHRlcklucHV0PiB7XHJcbiAgICAgICAgaWYgKHRoaXMub3B0aW9ucy50b0ZpbHRlcklucHV0KSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLm9wdGlvbnMudG9GaWx0ZXJJbnB1dCh2YWx1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLm9wdGlvbnMuZmlsdGVyRmllbGQpIHtcclxuICAgICAgICAgICAgcmV0dXJuIHsgW3RoaXMub3B0aW9ucy5maWx0ZXJGaWVsZF06IHRoaXMuZ2V0RmlsdGVyT3BlcmF0b3IodmFsdWUpIH0gYXMgUGFydGlhbDxGaWx0ZXJJbnB1dD47XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxyXG4gICAgICAgICAgICAgICAgYEVpdGhlciBcImZpbHRlckZpZWxkXCIgb3IgXCJ0b0ZpbHRlcklucHV0XCIgbXVzdCBiZSBwcm92aWRlZCAoZm9yIGZpbHRlciBcIiR7dGhpcy5uYW1lfVwiKSlgLFxyXG4gICAgICAgICAgICApO1xyXG4gICAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBhY3RpdmF0ZSh2YWx1ZTogRGF0YVRhYmxlRmlsdGVyVmFsdWU8VHlwZT4pIHtcclxuICAgICAgICBpZiAodGhpcy5vbkFjdGl2YXRlKSB7XHJcbiAgICAgICAgICAgIHRoaXMub25BY3RpdmF0ZSh0aGlzLCB2YWx1ZSk7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG5cclxuICAgIGlzSWQoKTogdGhpcyBpcyBEYXRhVGFibGVGaWx0ZXI8RmlsdGVySW5wdXQsIERhdGFUYWJsZUZpbHRlcklEVHlwZT4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnR5cGUua2luZCA9PT0gJ2lkJztcclxuICAgIH1cclxuXHJcbiAgICBpc1RleHQoKTogdGhpcyBpcyBEYXRhVGFibGVGaWx0ZXI8RmlsdGVySW5wdXQsIERhdGFUYWJsZUZpbHRlclRleHRUeXBlPiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudHlwZS5raW5kID09PSAndGV4dCc7XHJcbiAgICB9XHJcblxyXG4gICAgaXNOdW1iZXIoKTogdGhpcyBpcyBEYXRhVGFibGVGaWx0ZXI8RmlsdGVySW5wdXQsIERhdGFUYWJsZUZpbHRlck51bWJlclR5cGU+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy50eXBlLmtpbmQgPT09ICdudW1iZXInO1xyXG4gICAgfVxyXG5cclxuICAgIGlzQm9vbGVhbigpOiB0aGlzIGlzIERhdGFUYWJsZUZpbHRlcjxGaWx0ZXJJbnB1dCwgRGF0YVRhYmxlRmlsdGVyQm9vbGVhblR5cGU+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy50eXBlLmtpbmQgPT09ICdib29sZWFuJztcclxuICAgIH1cclxuXHJcbiAgICBpc1NlbGVjdCgpOiB0aGlzIGlzIERhdGFUYWJsZUZpbHRlcjxGaWx0ZXJJbnB1dCwgRGF0YVRhYmxlRmlsdGVyU2VsZWN0VHlwZT4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLnR5cGUua2luZCA9PT0gJ3NlbGVjdCc7XHJcbiAgICB9XHJcblxyXG4gICAgaXNEYXRlUmFuZ2UoKTogdGhpcyBpcyBEYXRhVGFibGVGaWx0ZXI8RmlsdGVySW5wdXQsIERhdGFUYWJsZUZpbHRlckRhdGVSYW5nZVR5cGU+IHtcclxuICAgICAgICByZXR1cm4gdGhpcy50eXBlLmtpbmQgPT09ICdkYXRlUmFuZ2UnO1xyXG4gICAgfVxyXG5cclxuICAgIGlzQ3VzdG9tKCk6IHRoaXMgaXMgRGF0YVRhYmxlRmlsdGVyPEZpbHRlcklucHV0LCBEYXRhVGFibGVGaWx0ZXJDdXN0b21UeXBlPiB7XHJcbiAgICAgICAgcmV0dXJuIHRoaXMudHlwZS5raW5kID09PSAnY3VzdG9tJztcclxuICAgIH1cclxufVxyXG4iXX0=