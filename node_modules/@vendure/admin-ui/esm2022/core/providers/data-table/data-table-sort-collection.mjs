import { assertNever } from '@vendure/common/lib/shared-utils';
import { Subject } from 'rxjs';
import { takeUntil } from 'rxjs/operators';
import { DataTableSort } from './data-table-sort';
export class DataTableSortCollection {
    #sorts;
    #valueChanges$;
    #connectedToRouter;
    #sortQueryParamName;
    #defaultSort;
    constructor(router) {
        this.router = router;
        this.#sorts = [];
        this.#valueChanges$ = new Subject();
        this.#connectedToRouter = false;
        this.valueChanges = this.#valueChanges$.asObservable();
        this.#sortQueryParamName = 'sort';
        this.destroy$ = new Subject();
    }
    get length() {
        return this.#sorts.length;
    }
    destroy() {
        this.destroy$.next();
        this.destroy$.complete();
    }
    addSort(config) {
        if (this.#connectedToRouter) {
            throw new Error('Cannot add sort after connecting to router. Make sure to call addSort() before connectToRoute()');
        }
        this.#sorts.push(new DataTableSort(config, () => this.onSetValue()));
        return this;
    }
    addSorts(configs) {
        for (const config of configs) {
            this.addSort(config);
        }
        return this;
    }
    addCustomFieldSorts(customFields) {
        for (const config of customFields) {
            const type = config.type;
            if (config.list) {
                continue;
            }
            switch (type) {
                case 'string':
                case 'localeString':
                case 'boolean':
                case 'int':
                case 'float':
                case 'datetime':
                case 'localeText':
                case 'text':
                    this.addSort({ name: config.name });
                    break;
                case 'relation':
                case 'struct':
                    // Cannot sort relations
                    break;
                default:
                    assertNever(type);
            }
        }
        return this;
    }
    defaultSort(name, sortOrder) {
        this.#defaultSort = { name, sortOrder };
        return this;
    }
    get(name) {
        return this.#sorts.find(s => s.name === name);
    }
    connectToRoute(route) {
        this.valueChanges.pipe(takeUntil(this.destroy$)).subscribe(() => {
            this.router.navigate(['./'], {
                queryParams: { [this.#sortQueryParamName]: this.serialize() },
                relativeTo: route,
                queryParamsHandling: 'merge',
            });
        });
        const filterQueryParams = (route.snapshot.queryParamMap.get(this.#sortQueryParamName) ?? '')
            .split(';')
            .map(value => value.split(':'))
            .map(([name, value]) => ({ name, value }));
        for (const { name, value } of filterQueryParams) {
            const sort = this.get(name);
            if (sort) {
                sort.setSortOrder(value);
            }
        }
        this.#connectedToRouter = true;
        return this;
    }
    createSortInput() {
        const activeSorts = this.#sorts.filter(s => s.sortOrder !== undefined);
        let sortInput = {};
        if (activeSorts.length === 0 && this.#defaultSort) {
            return { [this.#defaultSort.name]: this.#defaultSort.sortOrder };
        }
        for (const sort of activeSorts) {
            sortInput = { ...sortInput, [sort.name]: sort.sortOrder };
        }
        return sortInput;
    }
    serialize() {
        const activeSorts = this.#sorts.filter(s => s.sortOrder !== undefined);
        return activeSorts.map(s => `${s.name}:${s.sortOrder}`).join(';');
    }
    onSetValue() {
        this.#valueChanges$.next(this.#sorts
            .filter(f => f.sortOrder !== undefined)
            .map(s => ({ name: s.name, sortOrder: s.sortOrder })));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGF0YS10YWJsZS1zb3J0LWNvbGxlY3Rpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvbGliL2NvcmUvc3JjL3Byb3ZpZGVycy9kYXRhLXRhYmxlL2RhdGEtdGFibGUtc29ydC1jb2xsZWN0aW9uLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUVBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUMvRCxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQy9CLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUUzQyxPQUFPLEVBQUUsYUFBYSxFQUE0QyxNQUFNLG1CQUFtQixDQUFDO0FBRTVGLE1BQU0sT0FBTyx1QkFBdUI7SUFJdkIsTUFBTSxDQUF1QztJQUN0RCxjQUFjLENBQXFGO0lBQ25HLGtCQUFrQixDQUFTO0lBRWxCLG1CQUFtQixDQUFVO0lBQ3RDLFlBQVksQ0FBdUU7SUFHbkYsWUFBb0IsTUFBYztRQUFkLFdBQU0sR0FBTixNQUFNLENBQVE7UUFSekIsV0FBTSxHQUFvQyxFQUFFLENBQUM7UUFDdEQsbUJBQWMsR0FBRyxJQUFJLE9BQU8sRUFBc0UsQ0FBQztRQUNuRyx1QkFBa0IsR0FBRyxLQUFLLENBQUM7UUFDM0IsaUJBQVksR0FBRyxJQUFJLENBQUMsY0FBYyxDQUFDLFlBQVksRUFBRSxDQUFDO1FBQ3pDLHdCQUFtQixHQUFHLE1BQU0sQ0FBQztRQUVyQixhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztJQUVYLENBQUM7SUFFdEMsSUFBSSxNQUFNO1FBQ04sT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQztJQUM5QixDQUFDO0lBRUQsT0FBTztRQUNILElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7UUFDckIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUM3QixDQUFDO0lB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Q0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUyxLQUFLLFNBQVMsQ0FBQyxDQUFDO1FBQ3ZFLE9BQU8sV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQWMsSUFBSSxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDaEYsQ0FBQztJQUVPLFVBQVU7UUFDZCxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FDcEIsSUFBSSxDQUFDLE1BQU07YUFDTixNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsU0FBUyxLQUFLLFNBQVMsQ0FBQzthQUN0QyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFXLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQyxDQUFDLENBQ25FLENBQUM7SUFDTixDQUFDO0NBQ0oiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZSwgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcclxuaW1wb3J0IHsgQ3VzdG9tRmllbGRUeXBlIH0gZnJvbSAnQHZlbmR1cmUvY29tbW9uL2xpYi9zaGFyZWQtdHlwZXMnO1xyXG5pbXBvcnQgeyBhc3NlcnROZXZlciB9IGZyb20gJ0B2ZW5kdXJlL2NvbW1vbi9saWIvc2hhcmVkLXV0aWxzJztcclxuaW1wb3J0IHsgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEN1c3RvbUZpZWxkQ29uZmlnIH0gZnJvbSAnLi4vLi4vY29tbW9uL2dlbmVyYXRlZC10eXBlcyc7XHJcbmltcG9ydCB7IERhdGFUYWJsZVNvcnQsIERhdGFUYWJsZVNvcnRPcHRpb25zLCBEYXRhVGFibGVTb3J0T3JkZXIgfSBmcm9tICcuL2RhdGEtdGFibGUtc29ydCc7XHJcblxyXG5leHBvcnQgY2xhc3MgRGF0YVRhYmxlU29ydENvbGxlY3Rpb248XHJcbiAgICBTb3J0SW5wdXQgZXh0ZW5kcyBSZWNvcmQ8c3RyaW5nLCAnQVNDJyB8ICdERVNDJz4sXHJcbiAgICBOYW1lcyBleHRlbmRzIFsuLi5BcnJheTxrZXlvZiBTb3J0SW5wdXQ+XSA9IFtdLFxyXG4+IHtcclxuICAgIHJlYWRvbmx5ICNzb3J0czogQXJyYXk8RGF0YVRhYmxlU29ydDxTb3J0SW5wdXQ+PiA9IFtdO1xyXG4gICAgI3ZhbHVlQ2hhbmdlcyQgPSBuZXcgU3ViamVjdDxBcnJheTx7IG5hbWU6IHN0cmluZzsgc29ydE9yZGVyOiBEYXRhVGFibGVTb3J0T3JkZXIgfCB1bmRlZmluZWQgfT4+KCk7XHJcbiAgICAjY29ubmVjdGVkVG9Sb3V0ZXIgPSBmYWxzZTtcclxuICAgIHZhbHVlQ2hhbmdlcyA9IHRoaXMuI3ZhbHVlQ2hhbmdlcyQuYXNPYnNlcnZhYmxlKCk7XHJcbiAgICByZWFkb25seSAjc29ydFF1ZXJ5UGFyYW1OYW1lID0gJ3NvcnQnO1xyXG4gICAgI2RlZmF1bHRTb3J0OiB7IG5hbWU6IGtleW9mIFNvcnRJbnB1dDsgc29ydE9yZGVyOiBEYXRhVGFibGVTb3J0T3JkZXIgfSB8IHVuZGVmaW5lZDtcclxuICAgIHByaXZhdGUgcmVhZG9ubHkgZGVzdHJveSQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcm91dGVyOiBSb3V0ZXIpIHt9XHJcblxyXG4gICAgZ2V0IGxlbmd0aCgpOiBudW1iZXIge1xyXG4gICAgICAgIHJldHVybiB0aGlzLiNzb3J0cy5sZW5ndGg7XHJcbiAgICB9XHJcblxyXG4gICAgZGVzdHJveSgpIHtcclxuICAgICAgICB0aGlzLmRlc3Ryb3kkLm5leHQoKTtcclxuICAgICAgICB0aGlzLmRlc3Ryb3kkLmNvbXBsZXRlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgYWRkU29ydDxOYW1lIGV4dGVuZHMga2V5b2YgU29ydElucHV0PihcclxuICAgICAgICBjb25maWc6IERhdGFUYWJsZVNvcnRPcHRpb25zPFNvcnRJbnB1dCwgTmFtZT4sXHJcbiAgICApOiBEYXRhVGFibGVTb3J0Q29sbGVjdGlvbjxTb3J0SW5wdXQsIFsuLi5OYW1lcywgTmFtZV0+IHtcclxuICAgICAgICBpZiAodGhpcy4jY29ubmVjdGVkVG9Sb3V0ZXIpIHtcclxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxyXG4gICAgICAgICAgICAgICAgJ0Nhbm5vdCBhZGQgc29ydCBhZnRlciBjb25uZWN0aW5nIHRvIHJvdXRlci4gTWFrZSBzdXJlIHRvIGNhbGwgYWRkU29ydCgpIGJlZm9yZSBjb25uZWN0VG9Sb3V0ZSgpJyxcclxuICAgICAgICAgICAgKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgdGhpcy4jc29ydHMucHVzaChuZXcgRGF0YVRhYmxlU29ydDxTb3J0SW5wdXQ+KGNvbmZpZywgKCkgPT4gdGhpcy5vblNldFZhbHVlKCkpKTtcclxuICAgICAgICByZXR1cm4gdGhpcyBhcyB1bmtub3duIGFzIERhdGFUYWJsZVNvcnRDb2xsZWN0aW9uPFNvcnRJbnB1dCwgWy4uLk5hbWVzLCBOYW1lXT47XHJcbiAgICB9XHJcblxyXG4gICAgYWRkU29ydHM8TmFtZSBleHRlbmRzIGtleW9mIFNvcnRJbnB1dD4oXHJcbiAgICAgICAgY29uZmlnczogQXJyYXk8RGF0YVRhYmxlU29ydE9wdGlvbnM8U29ydElucHV0LCBOYW1lPj4sXHJcbiAgICApOiBEYXRhVGFibGVTb3J0Q29sbGVjdGlvbjxTb3J0SW5wdXQsIFsuLi5OYW1lcywgTmFtZV0+IHtcclxuICAgICAgICBmb3IgKGNvbnN0IGNvbmZpZyBvZiBjb25maWdzKSB7XHJcbiAgICAgICAgICAgIHRoaXMuYWRkU29ydChjb25maWcpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gdGhpcyBhcyB1bmtub3duIGFzIERhdGFUYWJsZVNvcnRDb2xsZWN0aW9uPFNvcnRJbnB1dCwgWy4uLk5hbWVzLCBOYW1lXT47XHJcbiAgICB9XHJcblxyXG4gICAgYWRkQ3VzdG9tRmllbGRTb3J0cyhjdXN0b21GaWVsZHM6IEN1c3RvbUZpZWxkQ29uZmlnW10pIHtcclxuICAgICAgICBmb3IgKGNvbnN0IGNvbmZpZyBvZiBjdXN0b21GaWVsZHMpIHtcclxuICAgICAgICAgICAgY29uc3QgdHlwZSA9IGNvbmZpZy50eXBlIGFzIEN1c3RvbUZpZWxkVHlwZTtcclxuICAgICAgICAgICAgaWYgKGNvbmZpZy5saXN0KSB7XHJcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICBzd2l0Y2ggKHR5cGUpIHtcclxuICAgICAgICAgICAgICAgIGNhc2UgJ3N0cmluZyc6XHJcbiAgICAgICAgICAgICAgICBjYXNlICdsb2NhbGVTdHJpbmcnOlxyXG4gICAgICAgICAgICAgICAgY2FzZSAnYm9vbGVhbic6XHJcbiAgICAgICAgICAgICAgICBjYXNlICdpbnQnOlxyXG4gICAgICAgICAgICAgICAgY2FzZSAnZmxvYXQnOlxyXG4gICAgICAgICAgICAgICAgY2FzZSAnZGF0ZXRpbWUnOlxyXG4gICAgICAgICAgICAgICAgY2FzZSAnbG9jYWxlVGV4dCc6XHJcbiAgICAgICAgICAgICAgICBjYXNlICd0ZXh0JzpcclxuICAgICAgICAgICAgICAgICAgICB0aGlzLmFkZFNvcnQoeyBuYW1lOiBjb25maWcubmFtZSB9KTtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIGNhc2UgJ3JlbGF0aW9uJzpcclxuICAgICAgICAgICAgICAgIGNhc2UgJ3N0cnVjdCc6XHJcbiAgICAgICAgICAgICAgICAgICAgLy8gQ2Fubm90IHNvcnQgcmVsYXRpb25zXHJcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XHJcbiAgICAgICAgICAgICAgICBkZWZhdWx0OlxyXG4gICAgICAgICAgICAgICAgICAgIGFzc2VydE5ldmVyKHR5cGUpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0aGlzO1xyXG4gICAgfVxyXG5cclxuICAgIGRlZmF1bHRTb3J0KG5hbWU6IGtleW9mIFNvcnRJbnB1dCwgc29ydE9yZGVyOiBEYXRhVGFibGVTb3J0T3JkZXIpIHtcclxuICAgICAgICB0aGlzLiNkZWZhdWx0U29ydCA9IHsgbmFtZSwgc29ydE9yZGVyIH07XHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9XHJcblxyXG4gICAgZ2V0KG5hbWU6IE5hbWVzW251bWJlcl0pOiBEYXRhVGFibGVTb3J0PFNvcnRJbnB1dD4gfCB1bmRlZmluZWQge1xyXG4gICAgICAgIHJldHVybiB0aGlzLiNzb3J0cy5maW5kKHMgPT4gcy5uYW1lID09PSBuYW1lKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25uZWN0VG9Sb3V0ZShyb3V0ZTogQWN0aXZhdGVkUm91dGUpIHtcclxuICAgICAgICB0aGlzLnZhbHVlQ2hhbmdlcy5waXBlKHRha2VVbnRpbCh0aGlzLmRlc3Ryb3kkKSkuc3Vic2NyaWJlKCgpID0+IHtcclxuICAgICAgICAgICAgdGhpcy5yb3V0ZXIubmF2aWdhdGUoWycuLyddLCB7XHJcbiAgICAgICAgICAgICAgICBxdWVyeVBhcmFtczogeyBbdGhpcy4jc29ydFF1ZXJ5UGFyYW1OYW1lXTogdGhpcy5zZXJpYWxpemUoKSB9LFxyXG4gICAgICAgICAgICAgICAgcmVsYXRpdmVUbzogcm91dGUsXHJcbiAgICAgICAgICAgICAgICBxdWVyeVBhcmFtc0hhbmRsaW5nOiAnbWVyZ2UnLFxyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICB9KTtcclxuICAgICAgICBjb25zdCBmaWx0ZXJRdWVyeVBhcmFtcyA9IChyb3V0ZS5zbmFwc2hvdC5xdWVyeVBhcmFtTWFwLmdldCh0aGlzLiNzb3J0UXVlcnlQYXJhbU5hbWUpID8/ICcnKVxyXG4gICAgICAgICAgICAuc3BsaXQoJzsnKVxyXG4gICAgICAgICAgICAubWFwKHZhbHVlID0+IHZhbHVlLnNwbGl0KCc6JykpXHJcbiAgICAgICAgICAgIC5tYXAoKFtuYW1lLCB2YWx1ZV0pID0+ICh7IG5hbWUsIHZhbHVlIH0pKTtcclxuICAgICAgICBmb3IgKGNvbnN0IHsgbmFtZSwgdmFsdWUgfSBvZiBmaWx0ZXJRdWVyeVBhcmFtcykge1xyXG4gICAgICAgICAgICBjb25zdCBzb3J0ID0gdGhpcy5nZXQobmFtZSk7XHJcbiAgICAgICAgICAgIGlmIChzb3J0KSB7XHJcbiAgICAgICAgICAgICAgICBzb3J0LnNldFNvcnRPcmRlcih2YWx1ZSBhcyBhbnkpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHRoaXMuI2Nvbm5lY3RlZFRvUm91dGVyID0gdHJ1ZTtcclxuICAgICAgICByZXR1cm4gdGhpcztcclxuICAgIH1cclxuXHJcbiAgICBjcmVhdGVTb3J0SW5wdXQoKTogU29ydElucHV0IHtcclxuICAgICAgICBjb25zdCBhY3RpdmVTb3J0cyA9IHRoaXMuI3NvcnRzLmZpbHRlcihzID0+IHMuc29ydE9yZGVyICE9PSB1bmRlZmluZWQpO1xyXG4gICAgICAgIGxldCBzb3J0SW5wdXQgPSB7fSBhcyBTb3J0SW5wdXQ7XHJcbiAgICAgICAgaWYgKGFjdGl2ZVNvcnRzLmxlbmd0aCA9PT0gMCAmJiB0aGlzLiNkZWZhdWx0U29ydCkge1xyXG4gICAgICAgICAgICByZXR1cm4geyBbdGhpcy4jZGVmYXVsdFNvcnQubmFtZV06IHRoaXMuI2RlZmF1bHRTb3J0LnNvcnRPcmRlciB9IGFzIFNvcnRJbnB1dDtcclxuICAgICAgICB9XHJcbiAgICAgICAgZm9yIChjb25zdCBzb3J0IG9mIGFjdGl2ZVNvcnRzKSB7XHJcbiAgICAgICAgICAgIHNvcnRJbnB1dCA9IHsgLi4uc29ydElucHV0LCBbc29ydC5uYW1lXTogc29ydC5zb3J0T3JkZXIgfTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHNvcnRJbnB1dDtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHNlcmlhbGl6ZSgpOiBzdHJpbmcge1xyXG4gICAgICAgIGNvbnN0IGFjdGl2ZVNvcnRzID0gdGhpcy4jc29ydHMuZmlsdGVyKHMgPT4gcy5zb3J0T3JkZXIgIT09IHVuZGVmaW5lZCk7XHJcbiAgICAgICAgcmV0dXJuIGFjdGl2ZVNvcnRzLm1hcChzID0+IGAke3MubmFtZSBhcyBzdHJpbmd9OiR7cy5zb3J0T3JkZXJ9YCkuam9pbignOycpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgb25TZXRWYWx1ZSgpIHtcclxuICAgICAgICB0aGlzLiN2YWx1ZUNoYW5nZXMkLm5leHQoXHJcbiAgICAgICAgICAgIHRoaXMuI3NvcnRzXHJcbiAgICAgICAgICAgICAgICAuZmlsdGVyKGYgPT4gZi5zb3J0T3JkZXIgIT09IHVuZGVmaW5lZClcclxuICAgICAgICAgICAgICAgIC5tYXAocyA9PiAoeyBuYW1lOiBzLm5hbWUgYXMgYW55LCBzb3J0T3JkZXI6IHMuc29ydE9yZGVyIH0pKSxcclxuICAgICAgICApO1xyXG4gICAgfVxyXG59XHJcbiJdfQ==