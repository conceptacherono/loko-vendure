import { Injectable } from '@angular/core';
import { NavigationEnd, PRIMARY_OUTLET } from '@angular/router';
import { flatten } from 'lodash';
import { combineLatest as observableCombineLatest, isObservable, of as observableOf, Subject, } from 'rxjs';
import { filter, map, shareReplay, startWith, switchMap, takeUntil } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@angular/router";
import * as i2 from "../../data/providers/data.service";
export class BreadcrumbService {
    constructor(router, route, dataService) {
        this.router = router;
        this.route = route;
        this.dataService = dataService;
        this.destroy$ = new Subject();
        this.breadcrumbs$ = this.router.events.pipe(filter(event => event instanceof NavigationEnd), takeUntil(this.destroy$), startWith(true), switchMap(() => this.generateBreadcrumbs(this.route.root)), shareReplay(1));
    }
    ngOnDestroy() {
        this.destroy$.next();
        this.destroy$.complete();
    }
    generateBreadcrumbs(rootRoute) {
        const breadcrumbParts = this.assembleBreadcrumbParts(rootRoute);
        const breadcrumbObservables$ = breadcrumbParts.map(({ value$, path }) => value$.pipe(map(value => {
            if (isBreadcrumbLabelLinkPair(value)) {
                return {
                    label: value.label,
                    link: this.normalizeRelativeLinks(value.link, path),
                };
            }
            else if (isBreadcrumbPairArray(value)) {
                return value.map(val => ({
                    label: val.label,
                    link: this.normalizeRelativeLinks(val.link, path),
                }));
            }
            else {
                return {
                    label: value,
                    link: '/' + path.join('/'),
                };
            }
        })));
        return observableCombineLatest(breadcrumbObservables$).pipe(map(links => flatten(links)));
    }
    /**
     * Walks the route definition tree to assemble an array from which the breadcrumbs can be derived.
     */
    assembleBreadcrumbParts(rootRoute) {
        const breadcrumbParts = [];
        const segmentPaths = [];
        let currentRoute = rootRoute;
        do {
            const childRoutes = currentRoute.children;
            currentRoute = null;
            childRoutes.forEach((route) => {
                if (route.outlet === PRIMARY_OUTLET) {
                    const routeSnapshot = route.snapshot;
                    let breadcrumbDef = route.routeConfig && route.routeConfig.data && route.routeConfig.data['breadcrumb'];
                    segmentPaths.push(routeSnapshot.url.map(segment => segment.path).join('/'));
                    if (breadcrumbDef) {
                        if (isBreadcrumbFunction(breadcrumbDef)) {
                            breadcrumbDef = breadcrumbDef(routeSnapshot.data, routeSnapshot.params, this.dataService);
                        }
                        const observableValue = isObservable(breadcrumbDef)
                            ? breadcrumbDef
                            : observableOf(breadcrumbDef);
                        breadcrumbParts.push({ value$: observableValue, path: segmentPaths.slice() });
                    }
                    currentRoute = route;
                }
            });
        } while (currentRoute);
        return breadcrumbParts;
    }
    /**
     * Accounts for relative routes in the link array, i.e. arrays whose first element is either:
     * * `./`   - this appends the rest of the link segments to the current active route
     * * `../`  - this removes the last segment of the current active route, and appends the link segments
     *            to the parent route.
     */
    normalizeRelativeLinks(link, segmentPaths) {
        const clone = link.slice();
        if (clone[0] === './') {
            clone[0] = segmentPaths.join('/');
        }
        if (clone[0] === '../') {
            clone[0] = segmentPaths.slice(0, -1).join('/');
        }
        return clone.filter(segment => segment !== '');
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: BreadcrumbService, deps: [{ token: i1.Router }, { token: i1.ActivatedRoute }, { token: i2.DataService }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: BreadcrumbService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: BreadcrumbService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: () => [{ type: i1.Router }, { type: i1.ActivatedRoute }, { type: i2.DataService }] });
function isBreadcrumbFunction(value) {
    return typeof value === 'function';
}
function isBreadcrumbLabelLinkPair(value) {
    return value.hasOwnProperty('label') && value.hasOwnProperty('link');
}
function isBreadcrumbPairArray(value) {
    return Array.isArray(value) && isBreadcrumbLabelLinkPair(value[0]);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnJlYWRjcnVtYi5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vc3JjL2xpYi9jb3JlL3NyYy9wcm92aWRlcnMvYnJlYWRjcnVtYi9icmVhZGNydW1iLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBYSxNQUFNLGVBQWUsQ0FBQztBQUN0RCxPQUFPLEVBQXdCLGFBQWEsRUFBVSxjQUFjLEVBQVUsTUFBTSxpQkFBaUIsQ0FBQztBQUN0RyxPQUFPLEVBQUUsT0FBTyxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBQ2pDLE9BQU8sRUFDSCxhQUFhLElBQUksdUJBQXVCLEVBQ3hDLFlBQVksRUFFWixFQUFFLElBQUksWUFBWSxFQUNsQixPQUFPLEdBQ1YsTUFBTSxNQUFNLENBQUM7QUFDZCxPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxXQUFXLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7OztBQXFCM0YsTUFBTSxPQUFPLGlCQUFpQjtJQUkxQixZQUFvQixNQUFjLEVBQVUsS0FBcUIsRUFBVSxXQUF3QjtRQUEvRSxXQUFNLEdBQU4sTUFBTSxDQUFRO1FBQVUsVUFBSyxHQUFMLEtBQUssQ0FBZ0I7UUFBVSxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUYzRixhQUFRLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQUduQyxJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FDdkMsTUFBTSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsS0FBSyxZQUFZLGFBQWEsQ0FBQyxFQUMvQyxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUN4QixTQUFTLENBQUMsSUFBSSxDQUFDLEVBQ2YsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxtQkFBbUIs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RmQsTUFBTTs7MkZBRVQsaUJBQWlCO2tCQUg3QixVQUFVO21CQUFDO29CQUNSLFVBQVUsRUFBRSxNQUFNO2lCQUNyQjs7QUE2R0QsU0FBUyxvQkFBb0IsQ0FBQyxLQUEyQjtJQUNyRCxPQUFPLE9BQU8sS0FBSyxLQUFLLFVBQVUsQ0FBQztBQUN2QyxDQUFDO0FBRUQsU0FBUyx5QkFBeUIsQ0FBQyxLQUFzQjtJQUNyRCxPQUFPLEtBQUssQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLElBQUksS0FBSyxDQUFDLGNBQWMsQ0FBQyxNQUFNLENBQUMsQ0FBQztBQUN6RSxDQUFDO0FBRUQsU0FBUyxxQkFBcUIsQ0FBQyxLQUFzQjtJQUNqRCxPQUFPLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLElBQUkseUJBQXlCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDdkUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUsIE9uRGVzdHJveSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBBY3RpdmF0ZWRSb3V0ZSwgRGF0YSwgTmF2aWdhdGlvbkVuZCwgUGFyYW1zLCBQUklNQVJZX09VVExFVCwgUm91dGVyIH0gZnJvbSAnQGFuZ3VsYXIvcm91dGVyJztcclxuaW1wb3J0IHsgZmxhdHRlbiB9IGZyb20gJ2xvZGFzaCc7XHJcbmltcG9ydCB7XHJcbiAgICBjb21iaW5lTGF0ZXN0IGFzIG9ic2VydmFibGVDb21iaW5lTGF0ZXN0LFxyXG4gICAgaXNPYnNlcnZhYmxlLFxyXG4gICAgT2JzZXJ2YWJsZSxcclxuICAgIG9mIGFzIG9ic2VydmFibGVPZixcclxuICAgIFN1YmplY3QsXHJcbn0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7IGZpbHRlciwgbWFwLCBzaGFyZVJlcGxheSwgc3RhcnRXaXRoLCBzd2l0Y2hNYXAsIHRha2VVbnRpbCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcclxuaW1wb3J0IHsgRGF0YVNlcnZpY2UgfSBmcm9tICcuLi8uLi9kYXRhL3Byb3ZpZGVycy9kYXRhLnNlcnZpY2UnO1xyXG5cclxuZXhwb3J0IHR5cGUgQnJlYWRjcnVtYlN0cmluZyA9IHN0cmluZztcclxuXHJcbmV4cG9ydCBpbnRlcmZhY2UgQnJlYWRjcnVtYkxhYmVsTGlua1BhaXIge1xyXG4gICAgbGFiZWw6IHN0cmluZztcclxuICAgIGxpbms6IGFueVtdO1xyXG59XHJcblxyXG5leHBvcnQgdHlwZSBCcmVhZGNydW1iVmFsdWUgPSBCcmVhZGNydW1iU3RyaW5nIHwgQnJlYWRjcnVtYkxhYmVsTGlua1BhaXIgfCBCcmVhZGNydW1iTGFiZWxMaW5rUGFpcltdO1xyXG5leHBvcnQgdHlwZSBCcmVhZGNydW1iRnVuY3Rpb24gPSAoXHJcbiAgICBkYXRhOiBEYXRhLFxyXG4gICAgcGFyYW1zOiBQYXJhbXMsXHJcbiAgICBkYXRhU2VydmljZTogRGF0YVNlcnZpY2UsXHJcbikgPT4gQnJlYWRjcnVtYlZhbHVlIHwgT2JzZXJ2YWJsZTxCcmVhZGNydW1iVmFsdWU+O1xyXG5leHBvcnQgdHlwZSBCcmVhZGNydW1iRGVmaW5pdGlvbiA9IEJyZWFkY3J1bWJWYWx1ZSB8IEJyZWFkY3J1bWJGdW5jdGlvbiB8IE9ic2VydmFibGU8QnJlYWRjcnVtYlZhbHVlPjtcclxuXHJcbkBJbmplY3RhYmxlKHtcclxuICAgIHByb3ZpZGVkSW46ICdyb290JyxcclxufSlcclxuZXhwb3J0IGNsYXNzIEJyZWFkY3J1bWJTZXJ2aWNlIGltcGxlbWVudHMgT25EZXN0cm95IHtcclxuICAgIGJyZWFkY3J1bWJzJDogT2JzZXJ2YWJsZTxBcnJheTx7IGxpbms6IHN0cmluZyB8IGFueVtdOyBsYWJlbDogc3RyaW5nIH0+PjtcclxuICAgIHByaXZhdGUgZGVzdHJveSQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgcm91dGVyOiBSb3V0ZXIsIHByaXZhdGUgcm91dGU6IEFjdGl2YXRlZFJvdXRlLCBwcml2YXRlIGRhdGFTZXJ2aWNlOiBEYXRhU2VydmljZSkge1xyXG4gICAgICAgIHRoaXMuYnJlYWRjcnVtYnMkID0gdGhpcy5yb3V0ZXIuZXZlbnRzLnBpcGUoXHJcbiAgICAgICAgICAgIGZpbHRlcihldmVudCA9PiBldmVudCBpbnN0YW5jZW9mIE5hdmlnYXRpb25FbmQpLFxyXG4gICAgICAgICAgICB0YWtlVW50aWwodGhpcy5kZXN0cm95JCksXHJcbiAgICAgICAgICAgIHN0YXJ0V2l0aCh0cnVlKSxcclxuICAgICAgICAgICAgc3dpdGNoTWFwKCgpID0+IHRoaXMuZ2VuZXJhdGVCcmVhZGNydW1icyh0aGlzLnJvdXRlLnJvb3QpKSxcclxuICAgICAgICAgICAgc2hhcmVSZXBsYXkoMSksXHJcbiAgICAgICAgKTtcclxuICAgIH1cclxuXHJcbiAgICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcclxuICAgICAgICB0aGlzLmRlc3Ryb3kkLm5leHQoKTtcclxuICAgICAgICB0aGlzLmRlc3Ryb3kkLmNvbXBsZXRlKCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBnZW5lcmF0ZUJyZWFkY3J1bWJzKFxyXG4gICAgICAgIHJvb3RSb3V0ZTogQWN0aXZhdGVkUm91dGUsXHJcbiAgICApOiBPYnNlcnZhYmxlPEFycmF5PHsgbGluazogQXJyYXk8c3RyaW5nIHwgYW55PjsgbGFiZWw6IHN0cmluZyB9Pj4ge1xyXG4gICAgICAgIGNvbnN0IGJyZWFkY3J1bWJQYXJ0cyA9IHRoaXMuYXNzZW1ibGVCcmVhZGNydW1iUGFydHMocm9vdFJvdXRlKTtcclxuICAgICAgICBjb25zdCBicmVhZGNydW1iT2JzZXJ2YWJsZXMkID0gYnJlYWRjcnVtYlBhcnRzLm1hcChcclxuICAgICAgICAgICAgKHsgdmFsdWUkLCBwYXRoIH0pID0+XHJcbiAgICAgICAgICAgICAgICB2YWx1ZSQucGlwZShcclxuICAgICAgICAgICAgICAgICAgICBtYXAodmFsdWUgPT4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNCcmVhZGNydW1iTGFiZWxMaW5rUGFpcih2YWx1ZSkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWw6IHZhbHVlLmxhYmVsLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbms6IHRoaXMubm9ybWFsaXplUmVsYXRpdmVMaW5rcyh2YWx1ZS5saW5rLCBwYXRoKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNCcmVhZGNydW1iUGFpckFycmF5KHZhbHVlKSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlLm1hcCh2YWwgPT4gKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbDogdmFsLmxhYmVsLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbms6IHRoaXMubm9ybWFsaXplUmVsYXRpdmVMaW5rcyh2YWwubGluaywgcGF0aCksXHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhYmVsOiB2YWx1ZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5rOiAnLycgKyBwYXRoLmpvaW4oJy8nKSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgICAgICkgYXMgT2JzZXJ2YWJsZTxCcmVhZGNydW1iTGFiZWxMaW5rUGFpciB8IEJyZWFkY3J1bWJMYWJlbExpbmtQYWlyW10+LFxyXG4gICAgICAgICk7XHJcblxyXG4gICAgICAgIHJldHVybiBvYnNlcnZhYmxlQ29tYmluZUxhdGVzdChicmVhZGNydW1iT2JzZXJ2YWJsZXMkKS5waXBlKG1hcChsaW5rcyA9PiBmbGF0dGVuKGxpbmtzKSkpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogV2Fsa3MgdGhlIHJvdXRlIGRlZmluaXRpb24gdHJlZSB0byBhc3NlbWJsZSBhbiBhcnJheSBmcm9tIHdoaWNoIHRoZSBicmVhZGNydW1icyBjYW4gYmUgZGVyaXZlZC5cclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBhc3NlbWJsZUJyZWFkY3J1bWJQYXJ0cyhcclxuICAgICAgICByb290Um91dGU6IEFjdGl2YXRlZFJvdXRlLFxyXG4gICAgKTogQXJyYXk8eyB2YWx1ZSQ6IE9ic2VydmFibGU8QnJlYWRjcnVtYlZhbHVlPjsgcGF0aDogc3RyaW5nW10gfT4ge1xyXG4gICAgICAgIGNvbnN0IGJyZWFkY3J1bWJQYXJ0czogQXJyYXk8eyB2YWx1ZSQ6IE9ic2VydmFibGU8QnJlYWRjcnVtYlZhbHVlPjsgcGF0aDogc3RyaW5nW10gfT4gPSBbXTtcclxuICAgICAgICBjb25zdCBzZWdtZW50UGF0aHM6IHN0cmluZ1tdID0gW107XHJcbiAgICAgICAgbGV0IGN1cnJlbnRSb3V0ZTogQWN0aXZhdGVkUm91dGUgfCBudWxsID0gcm9vdFJvdXRlO1xyXG4gICAgICAgIGRvIHtcclxuICAgICAgICAgICAgY29uc3QgY2hpbGRSb3V0ZXMgPSBjdXJyZW50Um91dGUuY2hpbGRyZW47XHJcbiAgICAgICAgICAgIGN1cnJlbnRSb3V0ZSA9IG51bGw7XHJcbiAgICAgICAgICAgIGNoaWxkUm91dGVzLmZvckVhY2goKHJvdXRlOiBBY3RpdmF0ZWRSb3V0ZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgaWYgKHJvdXRlLm91dGxldCA9PT0gUFJJTUFSWV9PVVRMRVQpIHtcclxuICAgICAgICAgICAgICAgICAgICBjb25zdCByb3V0ZVNuYXBzaG90ID0gcm91dGUuc25hcHNob3Q7XHJcbiAgICAgICAgICAgICAgICAgICAgbGV0IGJyZWFkY3J1bWJEZWY6IEJyZWFkY3J1bWJEZWZpbml0aW9uIHwgdW5kZWZpbmVkID1cclxuICAgICAgICAgICAgICAgICAgICAgICAgcm91dGUucm91dGVDb25maWcgJiYgcm91dGUucm91dGVDb25maWcuZGF0YSAmJiByb3V0ZS5yb3V0ZUNvbmZpZy5kYXRhWydicmVhZGNydW1iJ107XHJcbiAgICAgICAgICAgICAgICAgICAgc2VnbWVudFBhdGhzLnB1c2gocm91dGVTbmFwc2hvdC51cmwubWFwKHNlZ21lbnQgPT4gc2VnbWVudC5wYXRoKS5qb2luKCcvJykpO1xyXG5cclxuICAgICAgICAgICAgICAgICAgICBpZiAoYnJlYWRjcnVtYkRlZikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXNCcmVhZGNydW1iRnVuY3Rpb24oYnJlYWRjcnVtYkRlZikpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFkY3J1bWJEZWYgPSBicmVhZGNydW1iRGVmKFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJvdXRlU25hcHNob3QuZGF0YSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByb3V0ZVNuYXBzaG90LnBhcmFtcyxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmRhdGFTZXJ2aWNlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvYnNlcnZhYmxlVmFsdWUgPSBpc09ic2VydmFibGUoYnJlYWRjcnVtYkRlZilcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgID8gYnJlYWRjcnVtYkRlZlxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgOiBvYnNlcnZhYmxlT2YoYnJlYWRjcnVtYkRlZik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFkY3J1bWJQYXJ0cy5wdXNoKHsgdmFsdWUkOiBvYnNlcnZhYmxlVmFsdWUsIHBhdGg6IHNlZ21lbnRQYXRocy5zbGljZSgpIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBjdXJyZW50Um91dGUgPSByb3V0ZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSB3aGlsZSAoY3VycmVudFJvdXRlKTtcclxuXHJcbiAgICAgICAgcmV0dXJuIGJyZWFkY3J1bWJQYXJ0cztcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEFjY291bnRzIGZvciByZWxhdGl2ZSByb3V0ZXMgaW4gdGhlIGxpbmsgYXJyYXksIGkuZS4gYXJyYXlzIHdob3NlIGZpcnN0IGVsZW1lbnQgaXMgZWl0aGVyOlxyXG4gICAgICogKiBgLi9gICAgLSB0aGlzIGFwcGVuZHMgdGhlIHJlc3Qgb2YgdGhlIGxpbmsgc2VnbWVudHMgdG8gdGhlIGN1cnJlbnQgYWN0aXZlIHJvdXRlXHJcbiAgICAgKiAqIGAuLi9gICAtIHRoaXMgcmVtb3ZlcyB0aGUgbGFzdCBzZWdtZW50IG9mIHRoZSBjdXJyZW50IGFjdGl2ZSByb3V0ZSwgYW5kIGFwcGVuZHMgdGhlIGxpbmsgc2VnbWVudHNcclxuICAgICAqICAgICAgICAgICAgdG8gdGhlIHBhcmVudCByb3V0ZS5cclxuICAgICAqL1xyXG4gICAgcHJpdmF0ZSBub3JtYWxpemVSZWxhdGl2ZUxpbmtzKGxpbms6IGFueVtdLCBzZWdtZW50UGF0aHM6IHN0cmluZ1tdKTogYW55W10ge1xyXG4gICAgICAgIGNvbnN0IGNsb25lID0gbGluay5zbGljZSgpO1xyXG4gICAgICAgIGlmIChjbG9uZVswXSA9PT0gJy4vJykge1xyXG4gICAgICAgICAgICBjbG9uZVswXSA9IHNlZ21lbnRQYXRocy5qb2luKCcvJyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmIChjbG9uZVswXSA9PT0gJy4uLycpIHtcclxuICAgICAgICAgICAgY2xvbmVbMF0gPSBzZWdtZW50UGF0aHMuc2xpY2UoMCwgLTEpLmpvaW4oJy8nKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIGNsb25lLmZpbHRlcihzZWdtZW50ID0+IHNlZ21lbnQgIT09ICcnKTtcclxuICAgIH1cclxufVxyXG5cclxuZnVuY3Rpb24gaXNCcmVhZGNydW1iRnVuY3Rpb24odmFsdWU6IEJyZWFkY3J1bWJEZWZpbml0aW9uKTogdmFsdWUgaXMgQnJlYWRjcnVtYkZ1bmN0aW9uIHtcclxuICAgIHJldHVybiB0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbic7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzQnJlYWRjcnVtYkxhYmVsTGlua1BhaXIodmFsdWU6IEJyZWFkY3J1bWJWYWx1ZSk6IHZhbHVlIGlzIEJyZWFkY3J1bWJMYWJlbExpbmtQYWlyIHtcclxuICAgIHJldHVybiB2YWx1ZS5oYXNPd25Qcm9wZXJ0eSgnbGFiZWwnKSAmJiB2YWx1ZS5oYXNPd25Qcm9wZXJ0eSgnbGluaycpO1xyXG59XHJcblxyXG5mdW5jdGlvbiBpc0JyZWFkY3J1bWJQYWlyQXJyYXkodmFsdWU6IEJyZWFkY3J1bWJWYWx1ZSk6IHZhbHVlIGlzIEJyZWFkY3J1bWJMYWJlbExpbmtQYWlyW10ge1xyXG4gICAgcmV0dXJuIEFycmF5LmlzQXJyYXkodmFsdWUpICYmIGlzQnJlYWRjcnVtYkxhYmVsTGlua1BhaXIodmFsdWVbMF0pO1xyXG59XHJcbiJdfQ==