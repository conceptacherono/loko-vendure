import { Injectable } from '@angular/core';
import { NotificationComponent } from '../../components/notification/notification.component';
import * as i0 from "@angular/core";
import * as i1 from "../i18n/i18n.service";
import * as i2 from "../overlay-host/overlay-host.service";
// How many ms before the toast is dismissed.
const TOAST_DURATION = 3000;
/**
 * @description
 * Provides toast notification functionality.
 *
 * @example
 * ```ts
 * class MyComponent {
 *   constructor(private notificationService: NotificationService) {}
 *
 *   save() {
 *     this.notificationService
 *         .success(_('asset.notify-create-assets-success'), {
 *           count: successCount,
 *         });
 *   }
 * }
 *
 * @docsCategory services
 * @docsPage NotificationService
 * @docsWeight 0
 */
export class NotificationService {
    get hostView() {
        return this.overlayHostService.getHostView();
    }
    constructor(i18nService, resolver, overlayHostService) {
        this.i18nService = i18nService;
        this.resolver = resolver;
        this.overlayHostService = overlayHostService;
        this.openToastRefs = [];
    }
    /**
     * @description
     * Display a success toast notification
     */
    success(message, translationVars) {
        this.notify({
            message,
            translationVars,
            type: 'success',
        });
    }
    /**
     * @description
     * Display an info toast notification
     */
    info(message, translationVars) {
        this.notify({
            message,
            translationVars,
            type: 'info',
        });
    }
    /**
     * @description
     * Display a warning toast notification
     */
    warning(message, translationVars) {
        this.notify({
            message,
            translationVars,
            type: 'warning',
        });
    }
    /**
     * @description
     * Display an error toast notification
     */
    error(message, translationVars) {
        this.notify({
            message,
            translationVars,
            type: 'error',
            duration: 20000,
        });
    }
    /**
     * @description
     * Display a toast notification.
     */
    notify(config) {
        this.createToast(config);
    }
    /**
     * Load a ToastComponent into the DOM host location.
     */
    async createToast(config) {
        const toastFactory = this.resolver.resolveComponentFactory(NotificationComponent);
        const hostView = await this.hostView;
        const ref = hostView.createComponent(toastFactory);
        const toast = ref.instance;
        const dismissFn = this.createDismissFunction(ref);
        toast.type = config.type || 'info';
        toast.message = config.message;
        toast.translationVars = this.translateTranslationVars(config.translationVars || {});
        toast.registerOnClickFn(dismissFn);
        let timerId;
        if (!config.duration || 0 < config.duration) {
            timerId = setTimeout(dismissFn, config.duration || TOAST_DURATION);
        }
        this.openToastRefs.unshift({ ref, timerId });
        setTimeout(() => this.calculatePositions());
    }
    /**
     * Returns a function which will destroy the toast component and
     * remove it from the openToastRefs array.
     */
    createDismissFunction(ref) {
        return () => {
            const toast = ref.instance;
            const index = this.openToastRefs.map(o => o.ref).indexOf(ref);
            if (this.openToastRefs[index]) {
                clearTimeout(this.openToastRefs[index].timerId);
            }
            toast.fadeOut().then(() => {
                ref.destroy();
                this.openToastRefs.splice(index, 1);
                this.calculatePositions();
            });
        };
    }
    /**
     * Calculate and set the top offsets for each of the open toasts.
     */
    calculatePositions() {
        let cumulativeHeight = 10;
        this.openToastRefs.forEach(obj => {
            const toast = obj.ref.instance;
            toast.offsetTop = cumulativeHeight;
            cumulativeHeight += toast.getHeight() + 6;
        });
    }
    translateTranslationVars(translationVars) {
        for (const [key, val] of Object.entries(translationVars)) {
            if (typeof val === 'string') {
                translationVars[key] = this.i18nService.translate(val);
            }
        }
        return translationVars;
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: NotificationService, deps: [{ token: i1.I18nService }, { token: i0.ComponentFactoryResolver }, { token: i2.OverlayHostService }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: NotificationService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: NotificationService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: () => [{ type: i1.I18nService }, { type: i0.ComponentFactoryResolver }, { type: i2.OverlayHostService }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibm90aWZpY2F0aW9uLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvbGliL2NvcmUvc3JjL3Byb3ZpZGVycy9ub3RpZmljYXRpb24vbm90aWZpY2F0aW9uLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUEwQyxVQUFVLEVBQW9CLE1BQU0sZUFBZSxDQUFDO0FBRXJHLE9BQU8sRUFBRSxxQkFBcUIsRUFBRSxNQUFNLHNEQUFzRCxDQUFDOzs7O0FBMkI3Riw2Q0FBNkM7QUFDN0MsTUFBTSxjQUFjLEdBQUcsSUFBSSxDQUFDO0FBRTVCOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQW9CRztBQUlILE1BQU0sT0FBTyxtQkFBbUI7SUFDNUIsSUFBWSxRQUFRO1FBQ2hCLE9BQU8sSUFBSSxDQUFDLGtCQUFrQixDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ2pELENBQUM7SUFJRCxZQUNZLFdBQXdCLEVBQ3hCLFFBQWtDLEVBQ2xDLGtCQUFzQztRQUZ0QyxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4QixhQUFRLEdBQVIsUUFBUSxDQUEwQjtRQUNsQyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBTDFDLGtCQUFhLEdBQXNFLEVBQUUsQ0FBQztJQU0zRixDQUFDO0lBRUo7OztPQUdHO0lBQ0gsT0FBTyxDQUFDLE9BQWUsRUFBRSxlQUFvRDtRQUN6RSxJQUFJLENBQUMsTUFBTSxDQUFDO1lBQ1IsT0FBTztZQUNQLGVBQWU7WUFDZixJQUFJLEVBQUUsU0FBUztTQUNsQixDQUFDLENBQUM7SUFDUCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsSUFBSSxDQUFDLE9BQWUsRUFBRSxlQUFvRDtRQUN0RSxJQUFJLENBQUMsTUFBTSxDQUFDO1lBQ1IsT0FBTztZQUNQLGVBQWU7WUFDZixJQUFJLEVBQUUsTUFBTTtTQUNmLENBQUMsQ0FBQztJQUNQLENBQUM7SUFFRDs7O09BR0c7SUFDSCxPQUFPLENB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QWtCO1FBQ3RCLElBQUksZ0JBQWdCLEdBQUcsRUFBRSxDQUFDO1FBRTFCLElBQUksQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQzdCLE1BQU0sS0FBSyxHQUEwQixHQUFHLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQztZQUN0RCxLQUFLLENBQUMsU0FBUyxHQUFHLGdCQUFnQixDQUFDO1lBQ25DLGdCQUFnQixJQUFJLEtBQUssQ0FBQyxTQUFTLEVBQUUsR0FBRyxDQUFDLENBQUM7UUFDOUMsQ0FBQyxDQUFDLENBQUM7SUFDUCxDQUFDO0lBRU8sd0JBQXdCLENBQUMsZUFBbUQ7UUFHaEYsS0FBSyxNQUFNLENBQUMsR0FBRyxFQUFFLEdBQUcsQ0FBQyxJQUFJLE1BQU0sQ0FBQyxPQUFPLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQztZQUN2RCxJQUFJLE9BQU8sR0FBRyxLQUFLLFFBQVEsRUFBRSxDQUFDO2dCQUMxQixlQUFlLENBQUMsR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDM0QsQ0FBQztRQUNMLENBQUM7UUFDRCxPQUFPLGVBQWUsQ0FBQztJQUMzQixDQUFDOzhHQXhJUSxtQkFBbUI7a0hBQW5CLG1CQUFtQixjQUZoQixNQUFNOzsyRkFFVCxtQkFBbUI7a0JBSC9CLFVBQVU7bUJBQUM7b0JBQ1IsVUFBVSxFQUFFLE1BQU07aUJBQ3JCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50RmFjdG9yeVJlc29sdmVyLCBDb21wb25lbnRSZWYsIEluamVjdGFibGUsIFZpZXdDb250YWluZXJSZWYgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuXHJcbmltcG9ydCB7IE5vdGlmaWNhdGlvbkNvbXBvbmVudCB9IGZyb20gJy4uLy4uL2NvbXBvbmVudHMvbm90aWZpY2F0aW9uL25vdGlmaWNhdGlvbi5jb21wb25lbnQnO1xyXG5pbXBvcnQgeyBJMThuU2VydmljZSB9IGZyb20gJy4uL2kxOG4vaTE4bi5zZXJ2aWNlJztcclxuaW1wb3J0IHsgT3ZlcmxheUhvc3RTZXJ2aWNlIH0gZnJvbSAnLi4vb3ZlcmxheS1ob3N0L292ZXJsYXktaG9zdC5zZXJ2aWNlJztcclxuXHJcbi8qKlxyXG4gKiBAZGVzY3JpcHRpb25cclxuICogVGhlIHR5cGVzIG9mIG5vdGlmaWNhdGlvbiBhdmFpbGFibGUuXHJcbiAqXHJcbiAqIEBkb2NzQ2F0ZWdvcnkgc2VydmljZXNcclxuICogQGRvY3NQYWdlIE5vdGlmaWNhdGlvblNlcnZpY2VcclxuICovXHJcbmV4cG9ydCB0eXBlIE5vdGlmaWNhdGlvblR5cGUgPSAnaW5mbycgfCAnc3VjY2VzcycgfCAnZXJyb3InIHwgJ3dhcm5pbmcnO1xyXG5cclxuLyoqXHJcbiAqIEBkZXNjcmlwdGlvblxyXG4gKiBDb25maWd1cmF0aW9uIGZvciBhIHRvYXN0IG5vdGlmaWNhdGlvbi5cclxuICpcclxuICogQGRvY3NDYXRlZ29yeSBzZXJ2aWNlc1xyXG4gKiBAZG9jc1BhZ2UgTm90aWZpY2F0aW9uU2VydmljZVxyXG4gKi9cclxuZXhwb3J0IGludGVyZmFjZSBUb2FzdENvbmZpZyB7XHJcbiAgICBtZXNzYWdlOiBzdHJpbmc7XHJcbiAgICB0cmFuc2xhdGlvblZhcnM/OiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB8IG51bWJlciB9O1xyXG4gICAgdHlwZT86IE5vdGlmaWNhdGlvblR5cGU7XHJcbiAgICBkdXJhdGlvbj86IG51bWJlcjtcclxufVxyXG5cclxuLy8gSG93IG1hbnkgbXMgYmVmb3JlIHRoZSB0b2FzdCBpcyBkaXNtaXNzZWQuXHJcbmNvbnN0IFRPQVNUX0RVUkFUSU9OID0gMzAwMDtcclxuXHJcbi8qKlxyXG4gKiBAZGVzY3JpcHRpb25cclxuICogUHJvdmlkZXMgdG9hc3Qgbm90aWZpY2F0aW9uIGZ1bmN0aW9uYWxpdHkuXHJcbiAqXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYHRzXHJcbiAqIGNsYXNzIE15Q29tcG9uZW50IHtcclxuICogICBjb25zdHJ1Y3Rvcihwcml2YXRlIG5vdGlmaWNhdGlvblNlcnZpY2U6IE5vdGlmaWNhdGlvblNlcnZpY2UpIHt9XHJcbiAqXHJcbiAqICAgc2F2ZSgpIHtcclxuICogICAgIHRoaXMubm90aWZpY2F0aW9uU2VydmljZVxyXG4gKiAgICAgICAgIC5zdWNjZXNzKF8oJ2Fzc2V0Lm5vdGlmeS1jcmVhdGUtYXNzZXRzLXN1Y2Nlc3MnKSwge1xyXG4gKiAgICAgICAgICAgY291bnQ6IHN1Y2Nlc3NDb3VudCxcclxuICogICAgICAgICB9KTtcclxuICogICB9XHJcbiAqIH1cclxuICpcclxuICogQGRvY3NDYXRlZ29yeSBzZXJ2aWNlc1xyXG4gKiBAZG9jc1BhZ2UgTm90aWZpY2F0aW9uU2VydmljZVxyXG4gKiBAZG9jc1dlaWdodCAwXHJcbiAqL1xyXG5ASW5qZWN0YWJsZSh7XHJcbiAgICBwcm92aWRlZEluOiAncm9vdCcsXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBOb3RpZmljYXRpb25TZXJ2aWNlIHtcclxuICAgIHByaXZhdGUgZ2V0IGhvc3RWaWV3KCk6IFByb21pc2U8Vmlld0NvbnRhaW5lclJlZj4ge1xyXG4gICAgICAgIHJldHVybiB0aGlzLm92ZXJsYXlIb3N0U2VydmljZS5nZXRIb3N0VmlldygpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgb3BlblRvYXN0UmVmczogQXJyYXk8eyByZWY6IENvbXBvbmVudFJlZjxOb3RpZmljYXRpb25Db21wb25lbnQ+OyB0aW1lcklkOiBhbnkgfT4gPSBbXTtcclxuXHJcbiAgICBjb25zdHJ1Y3RvcihcclxuICAgICAgICBwcml2YXRlIGkxOG5TZXJ2aWNlOiBJMThuU2VydmljZSxcclxuICAgICAgICBwcml2YXRlIHJlc29sdmVyOiBDb21wb25lbnRGYWN0b3J5UmVzb2x2ZXIsXHJcbiAgICAgICAgcHJpdmF0ZSBvdmVybGF5SG9zdFNlcnZpY2U6IE92ZXJsYXlIb3N0U2VydmljZSxcclxuICAgICkge31cclxuXHJcbiAgICAvKipcclxuICAgICAqIEBkZXNjcmlwdGlvblxyXG4gICAgICogRGlzcGxheSBhIHN1Y2Nlc3MgdG9hc3Qgbm90aWZpY2F0aW9uXHJcbiAgICAgKi9cclxuICAgIHN1Y2Nlc3MobWVzc2FnZTogc3RyaW5nLCB0cmFuc2xhdGlvblZhcnM/OiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB8IG51bWJlciB9KTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5ub3RpZnkoe1xyXG4gICAgICAgICAgICBtZXNzYWdlLFxyXG4gICAgICAgICAgICB0cmFuc2xhdGlvblZhcnMsXHJcbiAgICAgICAgICAgIHR5cGU6ICdzdWNjZXNzJyxcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIEBkZXNjcmlwdGlvblxyXG4gICAgICogRGlzcGxheSBhbiBpbmZvIHRvYXN0IG5vdGlmaWNhdGlvblxyXG4gICAgICovXHJcbiAgICBpbmZvKG1lc3NhZ2U6IHN0cmluZywgdHJhbnNsYXRpb25WYXJzPzogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfCBudW1iZXIgfSk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMubm90aWZ5KHtcclxuICAgICAgICAgICAgbWVzc2FnZSxcclxuICAgICAgICAgICAgdHJhbnNsYXRpb25WYXJzLFxyXG4gICAgICAgICAgICB0eXBlOiAnaW5mbycsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBAZGVzY3JpcHRpb25cclxuICAgICAqIERpc3BsYXkgYSB3YXJuaW5nIHRvYXN0IG5vdGlmaWNhdGlvblxyXG4gICAgICovXHJcbiAgICB3YXJuaW5nKG1lc3NhZ2U6IHN0cmluZywgdHJhbnNsYXRpb25WYXJzPzogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfCBudW1iZXIgfSk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMubm90aWZ5KHtcclxuICAgICAgICAgICAgbWVzc2FnZSxcclxuICAgICAgICAgICAgdHJhbnNsYXRpb25WYXJzLFxyXG4gICAgICAgICAgICB0eXBlOiAnd2FybmluZycsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBAZGVzY3JpcHRpb25cclxuICAgICAqIERpc3BsYXkgYW4gZXJyb3IgdG9hc3Qgbm90aWZpY2F0aW9uXHJcbiAgICAgKi9cclxuICAgIGVycm9yKG1lc3NhZ2U6IHN0cmluZywgdHJhbnNsYXRpb25WYXJzPzogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfCBudW1iZXIgfSk6IHZvaWQge1xyXG4gICAgICAgIHRoaXMubm90aWZ5KHtcclxuICAgICAgICAgICAgbWVzc2FnZSxcclxuICAgICAgICAgICAgdHJhbnNsYXRpb25WYXJzLFxyXG4gICAgICAgICAgICB0eXBlOiAnZXJyb3InLFxyXG4gICAgICAgICAgICBkdXJhdGlvbjogMjAwMDAsXHJcbiAgICAgICAgfSk7XHJcbiAgICB9XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBAZGVzY3JpcHRpb25cclxuICAgICAqIERpc3BsYXkgYSB0b2FzdCBub3RpZmljYXRpb24uXHJcbiAgICAgKi9cclxuICAgIG5vdGlmeShjb25maWc6IFRvYXN0Q29uZmlnKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy5jcmVhdGVUb2FzdChjb25maWcpO1xyXG4gICAgfVxyXG5cclxuICAgIC8qKlxyXG4gICAgICogTG9hZCBhIFRvYXN0Q29tcG9uZW50IGludG8gdGhlIERPTSBob3N0IGxvY2F0aW9uLlxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGFzeW5jIGNyZWF0ZVRvYXN0KGNvbmZpZzogVG9hc3RDb25maWcpOiBQcm9taXNlPHZvaWQ+IHtcclxuICAgICAgICBjb25zdCB0b2FzdEZhY3RvcnkgPSB0aGlzLnJlc29sdmVyLnJlc29sdmVDb21wb25lbnRGYWN0b3J5KE5vdGlmaWNhdGlvbkNvbXBvbmVudCk7XHJcbiAgICAgICAgY29uc3QgaG9zdFZpZXcgPSBhd2FpdCB0aGlzLmhvc3RWaWV3O1xyXG4gICAgICAgIGNvbnN0IHJlZiA9IGhvc3RWaWV3LmNyZWF0ZUNvbXBvbmVudDxOb3RpZmljYXRpb25Db21wb25lbnQ+KHRvYXN0RmFjdG9yeSk7XHJcbiAgICAgICAgY29uc3QgdG9hc3Q6IE5vdGlmaWNhdGlvbkNvbXBvbmVudCA9IHJlZi5pbnN0YW5jZTtcclxuICAgICAgICBjb25zdCBkaXNtaXNzRm4gPSB0aGlzLmNyZWF0ZURpc21pc3NGdW5jdGlvbihyZWYpO1xyXG4gICAgICAgIHRvYXN0LnR5cGUgPSBjb25maWcudHlwZSB8fCAnaW5mbyc7XHJcbiAgICAgICAgdG9hc3QubWVzc2FnZSA9IGNvbmZpZy5tZXNzYWdlO1xyXG4gICAgICAgIHRvYXN0LnRyYW5zbGF0aW9uVmFycyA9IHRoaXMudHJhbnNsYXRlVHJhbnNsYXRpb25WYXJzKGNvbmZpZy50cmFuc2xhdGlvblZhcnMgfHwge30pO1xyXG4gICAgICAgIHRvYXN0LnJlZ2lzdGVyT25DbGlja0ZuKGRpc21pc3NGbik7XHJcblxyXG4gICAgICAgIGxldCB0aW1lcklkO1xyXG4gICAgICAgIGlmICghY29uZmlnLmR1cmF0aW9uIHx8IDAgPCBjb25maWcuZHVyYXRpb24pIHtcclxuICAgICAgICAgICAgdGltZXJJZCA9IHNldFRpbWVvdXQoZGlzbWlzc0ZuLCBjb25maWcuZHVyYXRpb24gfHwgVE9BU1RfRFVSQVRJT04pO1xyXG4gICAgICAgIH1cclxuXHJcbiAgICAgICAgdGhpcy5vcGVuVG9hc3RSZWZzLnVuc2hpZnQoeyByZWYsIHRpbWVySWQgfSk7XHJcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiB0aGlzLmNhbGN1bGF0ZVBvc2l0aW9ucygpKTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIFJldHVybnMgYSBmdW5jdGlvbiB3aGljaCB3aWxsIGRlc3Ryb3kgdGhlIHRvYXN0IGNvbXBvbmVudCBhbmRcclxuICAgICAqIHJlbW92ZSBpdCBmcm9tIHRoZSBvcGVuVG9hc3RSZWZzIGFycmF5LlxyXG4gICAgICovXHJcbiAgICBwcml2YXRlIGNyZWF0ZURpc21pc3NGdW5jdGlvbihyZWY6IENvbXBvbmVudFJlZjxOb3RpZmljYXRpb25Db21wb25lbnQ+KTogKCkgPT4gdm9pZCB7XHJcbiAgICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICAgICAgY29uc3QgdG9hc3Q6IE5vdGlmaWNhdGlvbkNvbXBvbmVudCA9IHJlZi5pbnN0YW5jZTtcclxuICAgICAgICAgICAgY29uc3QgaW5kZXggPSB0aGlzLm9wZW5Ub2FzdFJlZnMubWFwKG8gPT4gby5yZWYpLmluZGV4T2YocmVmKTtcclxuXHJcbiAgICAgICAgICAgIGlmICh0aGlzLm9wZW5Ub2FzdFJlZnNbaW5kZXhdKSB7XHJcbiAgICAgICAgICAgICAgICBjbGVhclRpbWVvdXQodGhpcy5vcGVuVG9hc3RSZWZzW2luZGV4XS50aW1lcklkKTtcclxuICAgICAgICAgICAgfVxyXG5cclxuICAgICAgICAgICAgdG9hc3QuZmFkZU91dCgpLnRoZW4oKCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmVmLmRlc3Ryb3koKTtcclxuICAgICAgICAgICAgICAgIHRoaXMub3BlblRvYXN0UmVmcy5zcGxpY2UoaW5kZXgsIDEpO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jYWxjdWxhdGVQb3NpdGlvbnMoKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfTtcclxuICAgIH1cclxuXHJcbiAgICAvKipcclxuICAgICAqIENhbGN1bGF0ZSBhbmQgc2V0IHRoZSB0b3Agb2Zmc2V0cyBmb3IgZWFjaCBvZiB0aGUgb3BlbiB0b2FzdHMuXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgY2FsY3VsYXRlUG9zaXRpb25zKCk6IHZvaWQge1xyXG4gICAgICAgIGxldCBjdW11bGF0aXZlSGVpZ2h0ID0gMTA7XHJcblxyXG4gICAgICAgIHRoaXMub3BlblRvYXN0UmVmcy5mb3JFYWNoKG9iaiA9PiB7XHJcbiAgICAgICAgICAgIGNvbnN0IHRvYXN0OiBOb3RpZmljYXRpb25Db21wb25lbnQgPSBvYmoucmVmLmluc3RhbmNlO1xyXG4gICAgICAgICAgICB0b2FzdC5vZmZzZXRUb3AgPSBjdW11bGF0aXZlSGVpZ2h0O1xyXG4gICAgICAgICAgICBjdW11bGF0aXZlSGVpZ2h0ICs9IHRvYXN0LmdldEhlaWdodCgpICsgNjtcclxuICAgICAgICB9KTtcclxuICAgIH1cclxuXHJcbiAgICBwcml2YXRlIHRyYW5zbGF0ZVRyYW5zbGF0aW9uVmFycyh0cmFuc2xhdGlvblZhcnM6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIHwgbnVtYmVyIH0pOiB7XHJcbiAgICAgICAgW2tleTogc3RyaW5nXTogc3RyaW5nIHwgbnVtYmVyO1xyXG4gICAgfSB7XHJcbiAgICAgICAgZm9yIChjb25zdCBba2V5LCB2YWxdIG9mIE9iamVjdC5lbnRyaWVzKHRyYW5zbGF0aW9uVmFycykpIHtcclxuICAgICAgICAgICAgaWYgKHR5cGVvZiB2YWwgPT09ICdzdHJpbmcnKSB7XHJcbiAgICAgICAgICAgICAgICB0cmFuc2xhdGlvblZhcnNba2V5XSA9IHRoaXMuaTE4blNlcnZpY2UudHJhbnNsYXRlKHZhbCk7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRyYW5zbGF0aW9uVmFycztcclxuICAgIH1cclxufVxyXG4iXX0=