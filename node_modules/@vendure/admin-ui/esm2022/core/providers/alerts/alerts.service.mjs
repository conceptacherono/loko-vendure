import { Injectable } from '@angular/core';
import { notNullOrUndefined } from '@vendure/common/lib/shared-utils';
import { BehaviorSubject, combineLatest, first, isObservable, of, Subject, switchMap, } from 'rxjs';
import { filter, map, startWith, take } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "../permissions/permissions.service";
import * as i2 from "../../data/providers/data.service";
import * as i3 from "../notification/notification.service";
import * as i4 from "../modal/modal.service";
export class Alert {
    constructor(config, context) {
        this.config = config;
        this.context = context;
        this.hasRun$ = new BehaviorSubject(false);
        this.data$ = new BehaviorSubject(undefined);
        if (this.config.recheck) {
            this.subscription = this.config.recheck(this.context).subscribe(() => this.runCheck());
        }
        this.activeAlert$ = combineLatest([this.data$, this.hasRun$]).pipe(map(([data, hasRun]) => {
            if (!data) {
                return;
            }
            const isAlert = this.config.isAlert(data, this.context);
            if (!isAlert) {
                return;
            }
            return {
                id: this.config.id,
                runAction: () => {
                    if (!hasRun) {
                        this.config.action(data, this.context);
                        this.hasRun$.next(true);
                    }
                },
                hasRun,
                label: this.config.label(data, this.context),
            };
        }));
    }
    get id() {
        return this.config.id;
    }
    runCheck() {
        const result = this.config.check(this.context);
        if (result instanceof Promise) {
            result.then(data => this.data$.next(data));
        }
        else if (isObservable(result)) {
            result.pipe(take(1)).subscribe(data => this.data$.next(data));
        }
        else {
            this.data$.next(result);
        }
        this.hasRun$.next(false);
    }
    destroy() {
        if (this.subscription) {
            this.subscription.unsubscribe();
        }
    }
}
export class AlertsService {
    constructor(permissionsService, injector, dataService, notificationService, modalService) {
        this.permissionsService = permissionsService;
        this.injector = injector;
        this.dataService = dataService;
        this.notificationService = notificationService;
        this.modalService = modalService;
        this.alertsMap = new Map();
        this.configUpdated = new Subject();
        const alerts$ = this.configUpdated.pipe(map(() => [...this.alertsMap.values()]), startWith([...this.alertsMap.values()]));
        this.activeAlerts$ = alerts$.pipe(switchMap(() => {
            const alerts = [...this.alertsMap.values()];
            const isAlertStreams = alerts.map(alert => alert.activeAlert$);
            return combineLatest(isAlertStreams);
        }), map(alertStates => alertStates.filter(notNullOrUndefined)));
    }
    configureAlert(config) {
        this.hasSufficientPermissions(config.requiredPermissions)
            .pipe(first())
            .subscribe(hasPermissions => {
            if (hasPermissions) {
                this.alertsMap.set(config.id, new Alert(config, this.createContext()));
                this.configUpdated.next();
            }
        });
    }
    hasSufficientPermissions(permissions) {
        if (!permissions || permissions.length === 0) {
            return of(true);
        }
        return this.permissionsService.currentUserPermissions$.pipe(filter(permissions => permissions.length > 0), map(() => this.permissionsService.userHasPermissions(permissions)));
    }
    refresh(id) {
        if (id) {
            this.alertsMap.get(id)?.runCheck();
        }
        else {
            this.alertsMap.forEach(config => config.runCheck());
        }
    }
    clearAlerts() {
        this.alertsMap.forEach(alert => alert.destroy());
        this.alertsMap.clear();
        this.configUpdated.next();
    }
    createContext() {
        return {
            injector: this.injector,
            dataService: this.dataService,
            notificationService: this.notificationService,
            modalService: this.modalService,
        };
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: AlertsService, deps: [{ token: i1.PermissionsService }, { token: i0.Injector }, { token: i2.DataService }, { token: i3.NotificationService }, { token: i4.ModalService }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: AlertsService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.2.4", ngImport: i0, type: AlertsService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: () => [{ type: i1.PermissionsService }, { type: i0.Injector }, { type: i2.DataService }, { type: i3.NotificationService }, { type: i4.ModalService }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxlcnRzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9zcmMvbGliL2NvcmUvc3JjL3Byb3ZpZGVycy9hbGVydHMvYWxlcnRzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFVBQVUsRUFBWSxNQUFNLGVBQWUsQ0FBQztBQUNyRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxrQ0FBa0MsQ0FBQztBQUN0RSxPQUFPLEVBQ0gsZUFBZSxFQUNmLGFBQWEsRUFDYixLQUFLLEVBQ0wsWUFBWSxFQUVaLEVBQUUsRUFDRixPQUFPLEVBRVAsU0FBUyxHQUNaLE1BQU0sTUFBTSxDQUFDO0FBQ2QsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7Ozs7QUFzSDlELE1BQU0sT0FBTyxLQUFLO0lBS2QsWUFDWSxNQUFzQixFQUN0QixPQUFxQjtRQURyQixXQUFNLEdBQU4sTUFBTSxDQUFnQjtRQUN0QixZQUFPLEdBQVAsT0FBTyxDQUFjO1FBTHpCLFlBQU8sR0FBRyxJQUFJLGVBQWUsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNyQyxVQUFLLEdBQUcsSUFBSSxlQUFlLENBQWdCLFNBQVMsQ0FBQyxDQUFDO1FBTTFELElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUN0QixJQUFJLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDM0YsQ0FBQztRQUNELElBQUksQ0FBQyxZQUFZLEdBQUcsYUFBYSxDQUFDLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQzlELEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxFQUFFLE1BQU0sQ0FBQyxFQUFFLEVBQUU7WUFDbkIsSUFBSSxDQUFDLElBQUksRUFBRSxDQUFDO2dCQUNSLE9BQU87WUFDWCxDQUFDO1lBQ0QsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUN4RCxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7Z0JBQ1gsT0FBTztZQUNYLENBQUM7WUFDRCxPQUFPO2dCQUNILEVBQUUsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUU7Z0JBQ2xCLFNBQVMsRUFBRSxHQUFHLEVBQUU7b0JBQ1osSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDO3dCQUNWLElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7d0JBQ3ZDLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO29CQUM1QixDQUFDO2dCQUNMLENBQUM7Z0JBQ0QsTUFBTTtnQkFDTixLQUFLLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxPQUFPLENBQUM7YUFDL0MsQ0FBQztRQUNOLENBQUMsQ0FBQyxDQUNMLENBQUM7SUFDTixDQUFDO0lBQ0QsSUFBSSxFQUFFO1FBQ0YsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztJQUMxQixDQUFDO0lBQ0QsUUFBUTtRQUNKLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztRQUMvQyxJQUFJLE1BQU0sWUFBWSxPQUFPLEVBQUUsQ0FBQztZQUM1QixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUMvQyxDQUFDO2FBQU0sSUFBSSxZQUFZLENBQUMsTUFBTSxDQUFDLEVBQUUsQ0FBQztZQUM5QixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDbEUsQ0FBQzthQUFNLENBQUM7WUFDSixJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUM1QixDQUFDO1FBQ0QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDN0IsQ0FBQztJQUVELE9BQU87UUFDSCxJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztZQUNwQixJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ3BDLENBQUM7SUFDTCxDQUFDO0NBQ0o7QUFLRCxNQUFNLE9BQU8sYUFBYTtJQUt0QixZQUNZLGtCQUFzQyxFQUN0QyxRQUFrQixFQUNsQixXQUF3QixFQUN4QixtQkFBd0MsRUFDeEMsWUFBMEI7UUFKMUIsdUJBQWtCLEdBQWxCLGtCQUFrQixDQUFvQjtRQUN0QyxhQUFRLEdBQVIsUUFBUSxDQUFVO1FBQ2xCLGdCQUFXLEdBQVgsV0FBVyxDQUFhO1FBQ3hCLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUFDeEMsaUJBQVksR0FBWixZQUFZLENBQWM7UUFSOUIsY0FBUyxHQUFHLElBQUksR0FBRyxFQUFzQixDQUFDO1FBQzFDLGtCQUFhLEdBQUcsSUFBSSxPQUFPLEVBQVEsQ0FBQztRQVN4QyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FDbkMsR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsRUFDdkMsU0FBUyxDQUFDLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsQ0FDMUMsQ0FBQztRQUVGLElBQUksQ0FBQyxhQUFhLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FDN0IsU0FBUyxDQUFDLEdBQUcsRUFBRTtZQUNYLE1BQU0sTUFBTSxHQUFHLENBQUMsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUM7WUFDNUMsTUFBTSxjQUFjLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUMvRCxPQUFPLGFBQWEsQ0FBQyxjQUFjLENBQUMsQ0FBQztRQUN6QyxDQUFDLENBQUMsRUFDRixHQUFHLENBQUMsV0FBVyxDQUFDLEVBQUUsQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLGtCQUFrQixDQUFDLENBQUMsQ0FDN0QsQ0FBQztJQUNOLENBQUM7SUFFRCxjQUFjLENBQUksTUFBc0I7UUFDcEMsSUFBSSxDQUFDLHdCQUF3QixDQUFDLE1BQU0sQ0FBQyxtQkFBbUIsQ0FBQzthQUNwRCxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7YUFDYixTQUFTLENBQUMsY0FBYyxDQUFDLEVBQUU7WUFDeEIsSUFBSSxjQUFjLEVBQUUsQ0FBQztnQkFDakIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLEVBQUUsRUFBRSxJQUFJLEtBQUssQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDdkUsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUM5QixDQUFDO1FBQ0wsQ0FBQyxDQUFDLENBQUM7SUFDWCxDQUFDO0lBRUQsd0JBQXdCLENBQUMsV0FBMEI7UUFDL0MsSUFBSSxDQUFDLFdBQVcsSUFBSSxXQUFXLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQzNDLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ3BCLENBQUM7UUFDRCxPQUFPLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyx1QkFBdUIsQ0FBQyxJQUFJLENBQ3ZELE1BQU0sQ0FBQyxXQUFXLENBQUMsRUFBRSxDQUFDLFdBQVcsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLEVBQzdDLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsa0JBQWtCLENBQUMsa0JBQWtCLENBQUMsV0FBVyxDQUFDLENBQUMsQ0FDckUsQ0FBQztJQUNOLENBQUM7SUFFRCxPQUFPLENBQUMsRUFBVztRQUNmLElBQUksRUFBRSxFQUFFLENBQUM7WUFDTCxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsRUFBRSxRQUFRLEVBQUUsQ0FBQztRQUN2QyxDQUFDO2FBQU0sQ0FBQztZQUNKLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFDeEQsQ0FBQztJQUNMLENBQUM7SUFFRCxXQUFXO1FBQ1AsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztRQUNqRCxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDOUIsQ0FBQztJQUVTLGFBQWE7UUFDbkIsT0FBTztZQUNILFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtZQUN2QixXQUFXLEVBQUUsSUFBSSxDQUFDLFdBQVc7WUFDN0IsbUJBQW1CLEVBQUUsSUFBSSxDQUFDLG1CQUFtQjtZQUM3QyxZQUFZLEVBQUUsSUFBSSxDQUFDLFlBQVk7U0FDbEMsQ0FBQztJQUNOLENBQUM7OEdBckVRLGFBQWE7a0hBQWIsYUFBYSxjQUZWLE1BQU07OzJGQUVULGFBQWE7a0JBSHpCLFVBQVU7bUJBQUM7b0JBQ1IsVUFBVSxFQUFFLE1BQU07aUJBQ3JCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSwgSW5qZWN0b3IgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IG5vdE51bGxPclVuZGVmaW5lZCB9IGZyb20gJ0B2ZW5kdXJlL2NvbW1vbi9saWIvc2hhcmVkLXV0aWxzJztcbmltcG9ydCB7XG4gICAgQmVoYXZpb3JTdWJqZWN0LFxuICAgIGNvbWJpbmVMYXRlc3QsXG4gICAgZmlyc3QsXG4gICAgaXNPYnNlcnZhYmxlLFxuICAgIE9ic2VydmFibGUsXG4gICAgb2YsXG4gICAgU3ViamVjdCxcbiAgICBTdWJzY3JpcHRpb24sXG4gICAgc3dpdGNoTWFwLFxufSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpbHRlciwgbWFwLCBzdGFydFdpdGgsIHRha2UgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBQZXJtaXNzaW9uIH0gZnJvbSAnLi4vLi4vY29tbW9uL2dlbmVyYXRlZC10eXBlcyc7XG5pbXBvcnQgeyBEYXRhU2VydmljZSB9IGZyb20gJy4uLy4uL2RhdGEvcHJvdmlkZXJzL2RhdGEuc2VydmljZSc7XG5pbXBvcnQgeyBNb2RhbFNlcnZpY2UgfSBmcm9tICcuLi9tb2RhbC9tb2RhbC5zZXJ2aWNlJztcbmltcG9ydCB7IE5vdGlmaWNhdGlvblNlcnZpY2UgfSBmcm9tICcuLi9ub3RpZmljYXRpb24vbm90aWZpY2F0aW9uLnNlcnZpY2UnO1xuaW1wb3J0IHsgUGVybWlzc2lvbnNTZXJ2aWNlIH0gZnJvbSAnLi4vcGVybWlzc2lvbnMvcGVybWlzc2lvbnMuc2VydmljZSc7XG5cbi8qKlxuICogQGRlc2NyaXB0aW9uXG4gKiBUaGUgY29udGV4dCBvYmplY3Qgd2hpY2ggaXMgcGFzc2VkIHRvIHRoZSBgY2hlY2tgLCBgaXNBbGVydGAsIGBsYWJlbGAgYW5kIGBhY3Rpb25gIGZ1bmN0aW9ucyBvZiBhblxuICoge0BsaW5rIEFsZXJ0Q29uZmlnfSBvYmplY3QuXG4gKlxuICogQHNpbmNlIDIuMi4wXG4gKiBAZG9jc0NhdGVnb3J5IGFsZXJ0c1xuICovXG5leHBvcnQgaW50ZXJmYWNlIEFsZXJ0Q29udGV4dCB7XG4gICAgLyoqXG4gICAgICogQGRlc2NyaXB0aW9uXG4gICAgICogVGhlIEFuZ3VsYXIgW0luamVjdG9yXShodHRwczovL2FuZ3VsYXIuZGV2L2FwaS9jb3JlL0luamVjdG9yKSB3aGljaCBjYW4gYmUgdXNlZCB0byBnZXQgaW5zdGFuY2VzXG4gICAgICogb2Ygc2VydmljZXMgYW5kIG90aGVyIHByb3ZpZGVycyBhdmFpbGFibGUgaW4gdGhlIGFwcGxpY2F0aW9uLlxuICAgICAqL1xuICAgIGluamVjdG9yOiBJbmplY3RvcjtcbiAgICAvKipcbiAgICAgKiBAZGVzY3JpcHRpb25cbiAgICAgKiBUaGUgW0RhdGFTZXJ2aWNlXSgvcmVmZXJlbmNlL2FkbWluLXVpLWFwaS9zZXJ2aWNlcy9kYXRhLXNlcnZpY2UpLCB3aGljaCBwcm92aWRlcyBtZXRob2RzIGZvciBxdWVyeWluZyB0aGVcbiAgICAgKiBzZXJ2ZXItc2lkZSBkYXRhLlxuICAgICAqL1xuICAgIGRhdGFTZXJ2aWNlOiBEYXRhU2VydmljZTtcbiAgICAvKipcbiAgICAgKiBAZGVzY3JpcHRpb25cbiAgICAgKiBUaGUgW05vdGlmaWNhdGlvblNlcnZpY2VdKC9yZWZlcmVuY2UvYWRtaW4tdWktYXBpL3NlcnZpY2VzL25vdGlmaWNhdGlvbi1zZXJ2aWNlKSwgd2hpY2ggcHJvdmlkZXMgbWV0aG9kcyBmb3JcbiAgICAgKiBkaXNwbGF5aW5nIG5vdGlmaWNhdGlvbnMgdG8gdGhlIHVzZXIuXG4gICAgICovXG4gICAgbm90aWZpY2F0aW9uU2VydmljZTogTm90aWZpY2F0aW9uU2VydmljZTtcbiAgICAvKipcbiAgICAgKiBAZGVzY3JpcHRpb25cbiAgICAgKiBUaGUgW01vZGFsU2VydmljZV0oL3JlZmVyZW5jZS9hZG1pbi11aS1hcGkvc2VydmljZXMvbW9kYWwtc2VydmljZSksIHdoaWNoIHByb3ZpZGVzIG1ldGhvZHMgZm9yXG4gICAgICogb3BlbmluZyBtb2RhbCBkaWFsb2dzLlxuICAgICAqL1xuICAgIG1vZGFsU2VydmljZTogTW9kYWxTZXJ2aWNlO1xufVxuXG4vKipcbiAqIEBkZXNjcmlwdGlvblxuICogQSBjb25maWd1cmF0aW9uIG9iamVjdCBmb3IgYW4gQWRtaW4gVUkgYWxlcnQuXG4gKlxuICogQHNpbmNlIDIuMi4wXG4gKiBAZG9jc0NhdGVnb3J5IGFsZXJ0c1xuICovXG5leHBvcnQgaW50ZXJmYWNlIEFsZXJ0Q29uZmlnPFQgPSBhbnk+IHtcbiAgICAvKipcbiAgICAgKiBAZGVzY3JpcHRpb25cbiAgICAgKiBBIHVuaXF1ZSBpZGVudGlmaWVyIGZvciB0aGUgYWxlcnQuXG4gICAgICovXG4gICAgaWQ6IHN0cmluZztcbiAgICAvKipcbiAgICAgKiBAZGVzY3JpcHRpb25cbiAgICAgKiBBIGZ1bmN0aW9uIHdoaWNoIGlzIGdldHMgdGhlIGRhdGEgdXNlZCB0byBkZXRlcm1pbmUgd2hldGhlciB0aGUgYWxlcnQgc2hvdWxkIGJlIHNob3duLlxuICAgICAqIFR5cGljYWxseSwgdGhpcyBmdW5jdGlvbiB3aWxsIHF1ZXJ5IHRoZSBzZXJ2ZXIgb3Igc29tZSBvdGhlciByZW1vdGUgZGF0YSBzb3VyY2UuXG4gICAgICpcbiAgICAgKiBUaGlzIGZ1bmN0aW9uIHdpbGwgYmUgY2FsbGVkIG9uY2Ugd2hlbiB0aGUgQWRtaW4gVUkgYXBwIGJvb3RzdHJhcHMsIGFuZCBjYW4gYmUgYWxzb1xuICAgICAqIHNldCB0byBydW4gYXQgcmVndWxhciBpbnRlcnZhbHMgYnkgc2V0dGluZyB0aGUgYHJlY2hlY2tJbnRlcnZhbE1zYCBwcm9wZXJ0eS5cbiAgICAgKi9cbiAgICBjaGVjazogKGNvbnRleHQ6IEFsZXJ0Q29udGV4dCkgPT4gVCB8IFByb21pc2U8VD4gfCBPYnNlcnZhYmxlPFQ+O1xuICAgIC8qKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIEEgZnVuY3Rpb24gd2hpY2ggcmV0dXJucyBhbiBPYnNlcnZhYmxlIHdoaWNoIGlzIHVzZWQgdG8gZGV0ZXJtaW5lIHdoZW4gdG8gcmUtcnVuIHRoZSBgY2hlY2tgXG4gICAgICogZnVuY3Rpb24uIFdoZW5ldmVyIHRoZSBvYnNlcnZhYmxlIGVtaXRzLCB0aGUgYGNoZWNrYCBmdW5jdGlvbiB3aWxsIGJlIGNhbGxlZCBhZ2Fpbi5cbiAgICAgKlxuICAgICAqIEEgYmFzaWMgdGltZS1pbnRlcnZhbC1iYXNlZCByZWNoZWNrIGNhbiBiZSBhY2hpZXZlZCBieSB1c2luZyB0aGUgYGludGVydmFsYCBmdW5jdGlvbiBmcm9tIFJ4SlMuXG4gICAgICpcbiAgICAgKiBAZXhhbXBsZVxuICAgICAqIGBgYHRzXG4gICAgICogaW1wb3J0IHsgaW50ZXJ2YWwgfSBmcm9tICdyeGpzJztcbiAgICAgKlxuICAgICAqIC8vIC4uLlxuICAgICAqIHJlY2hlY2s6ICgpID0+IGludGVydmFsKDYwXzAwMClcbiAgICAgKiBgYGBcbiAgICAgKlxuICAgICAqIElmIHRoaXMgaXMgbm90IHNldCwgdGhlIGBjaGVja2AgZnVuY3Rpb24gd2lsbCBvbmx5IGJlIGNhbGxlZCBvbmNlIHdoZW4gdGhlIEFkbWluIFVJIGFwcCBib290c3RyYXBzLlxuICAgICAqXG4gICAgICogQGRlZmF1bHQgdW5kZWZpbmVkXG4gICAgICovXG4gICAgcmVjaGVjaz86IChjb250ZXh0OiBBbGVydENvbnRleHQpID0+IE9ic2VydmFibGU8YW55PjtcbiAgICAvKipcbiAgICAgKiBAZGVzY3JpcHRpb25cbiAgICAgKiBBIGZ1bmN0aW9uIHdoaWNoIGRldGVybWluZXMgd2hldGhlciB0aGUgYWxlcnQgc2hvdWxkIGJlIHNob3duIGJhc2VkIG9uIHRoZSBkYXRhIHJldHVybmVkIGJ5IHRoZSBgY2hlY2tgXG4gICAgICogZnVuY3Rpb24uXG4gICAgICovXG4gICAgaXNBbGVydDogKGRhdGE6IFQsIGNvbnRleHQ6IEFsZXJ0Q29udGV4dCkgPT4gYm9vbGVhbjtcbiAgICAvKipcbiAgICAgKiBAZGVzY3JpcHRpb25cbiAgICAgKiBBIGZ1bmN0aW9uIHdoaWNoIGlzIGNhbGxlZCB3aGVuIHRoZSBhbGVydCBpcyBjbGlja2VkIGluIHRoZSBBZG1pbiBVSS5cbiAgICAgKi9cbiAgICBhY3Rpb246IChkYXRhOiBULCBjb250ZXh0OiBBbGVydENvbnRleHQpID0+IHZvaWQ7XG4gICAgLyoqXG4gICAgICogQGRlc2NyaXB0aW9uXG4gICAgICogQSBmdW5jdGlvbiB3aGljaCByZXR1cm5zIHRoZSB0ZXh0IHVzZWQgaW4gdGhlIFVJIHRvIGRlc2NyaWJlIHRoZSBhbGVydC5cbiAgICAgKi9cbiAgICBsYWJlbDogKFxuICAgICAgICBkYXRhOiBULFxuICAgICAgICBjb250ZXh0OiBBbGVydENvbnRleHQsXG4gICAgKSA9PiB7IHRleHQ6IHN0cmluZzsgdHJhbnNsYXRpb25WYXJzPzogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfCBudW1iZXIgfSB9O1xuICAgIC8qKlxuICAgICAqIEBkZXNjcmlwdGlvblxuICAgICAqIEEgbGlzdCBvZiBwZXJtaXNzaW9ucyB3aGljaCB0aGUgY3VycmVudCBBZG1pbmlzdHJhdG9yIG11c3QgaGF2ZSBpbiBvcmRlci4gSWYgdGhlIGN1cnJlbnRcbiAgICAgKiBBZG1pbmlzdHJhdG9yIGRvZXMgbm90IGhhdmUgdGhlc2UgcGVybWlzc2lvbnMsIG5vbmUgb2YgdGhlIG90aGVyIGFsZXJ0IGZ1bmN0aW9ucyB3aWxsIGJlIGNhbGxlZC5cbiAgICAgKi9cbiAgICByZXF1aXJlZFBlcm1pc3Npb25zPzogUGVybWlzc2lvbltdO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFjdGl2ZUFsZXJ0IHtcbiAgICBpZDogc3RyaW5nO1xuICAgIHJ1bkFjdGlvbjogKCkgPT4gdm9pZDtcbiAgICBoYXNSdW46IGJvb2xlYW47XG4gICAgbGFiZWw6IHsgdGV4dDogc3RyaW5nOyB0cmFuc2xhdGlvblZhcnM/OiB7IFtrZXk6IHN0cmluZ106IHN0cmluZyB8IG51bWJlciB9IH07XG59XG5cbmV4cG9ydCBjbGFzcyBBbGVydDxUPiB7XG4gICAgYWN0aXZlQWxlcnQkOiBPYnNlcnZhYmxlPEFjdGl2ZUFsZXJ0IHwgdW5kZWZpbmVkPjtcbiAgICBwcml2YXRlIGhhc1J1biQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0KGZhbHNlKTtcbiAgICBwcml2YXRlIGRhdGEkID0gbmV3IEJlaGF2aW9yU3ViamVjdDxUIHwgdW5kZWZpbmVkPih1bmRlZmluZWQpO1xuICAgIHByaXZhdGUgcmVhZG9ubHkgc3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb247XG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgY29uZmlnOiBBbGVydENvbmZpZzxUPixcbiAgICAgICAgcHJpdmF0ZSBjb250ZXh0OiBBbGVydENvbnRleHQsXG4gICAgKSB7XG4gICAgICAgIGlmICh0aGlzLmNvbmZpZy5yZWNoZWNrKSB7XG4gICAgICAgICAgICB0aGlzLnN1YnNjcmlwdGlvbiA9IHRoaXMuY29uZmlnLnJlY2hlY2sodGhpcy5jb250ZXh0KS5zdWJzY3JpYmUoKCkgPT4gdGhpcy5ydW5DaGVjaygpKTtcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmFjdGl2ZUFsZXJ0JCA9IGNvbWJpbmVMYXRlc3QoW3RoaXMuZGF0YSQsIHRoaXMuaGFzUnVuJF0pLnBpcGUoXG4gICAgICAgICAgICBtYXAoKFtkYXRhLCBoYXNSdW5dKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKCFkYXRhKSB7XG4gICAgICAgICAgICAgICAgICAgIHJldHVybjtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgY29uc3QgaXNBbGVydCA9IHRoaXMuY29uZmlnLmlzQWxlcnQoZGF0YSwgdGhpcy5jb250ZXh0KTtcbiAgICAgICAgICAgICAgICBpZiAoIWlzQWxlcnQpIHtcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICBpZDogdGhpcy5jb25maWcuaWQsXG4gICAgICAgICAgICAgICAgICAgIHJ1bkFjdGlvbjogKCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFoYXNSdW4pIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZy5hY3Rpb24oZGF0YSwgdGhpcy5jb250ZXh0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmhhc1J1biQubmV4dCh0cnVlKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgICAgICAgaGFzUnVuLFxuICAgICAgICAgICAgICAgICAgICBsYWJlbDogdGhpcy5jb25maWcubGFiZWwoZGF0YSwgdGhpcy5jb250ZXh0KSxcbiAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgfSksXG4gICAgICAgICk7XG4gICAgfVxuICAgIGdldCBpZCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY29uZmlnLmlkO1xuICAgIH1cbiAgICBydW5DaGVjaygpIHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5jb25maWcuY2hlY2sodGhpcy5jb250ZXh0KTtcbiAgICAgICAgaWYgKHJlc3VsdCBpbnN0YW5jZW9mIFByb21pc2UpIHtcbiAgICAgICAgICAgIHJlc3VsdC50aGVuKGRhdGEgPT4gdGhpcy5kYXRhJC5uZXh0KGRhdGEpKTtcbiAgICAgICAgfSBlbHNlIGlmIChpc09ic2VydmFibGUocmVzdWx0KSkge1xuICAgICAgICAgICAgcmVzdWx0LnBpcGUodGFrZSgxKSkuc3Vic2NyaWJlKGRhdGEgPT4gdGhpcy5kYXRhJC5uZXh0KGRhdGEpKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHRoaXMuZGF0YSQubmV4dChyZXN1bHQpO1xuICAgICAgICB9XG4gICAgICAgIHRoaXMuaGFzUnVuJC5uZXh0KGZhbHNlKTtcbiAgICB9XG5cbiAgICBkZXN0cm95KCkge1xuICAgICAgICBpZiAodGhpcy5zdWJzY3JpcHRpb24pIHtcbiAgICAgICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gICAgICAgIH1cbiAgICB9XG59XG5cbkBJbmplY3RhYmxlKHtcbiAgICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuZXhwb3J0IGNsYXNzIEFsZXJ0c1NlcnZpY2Uge1xuICAgIGFjdGl2ZUFsZXJ0cyQ6IE9ic2VydmFibGU8QWN0aXZlQWxlcnRbXT47XG4gICAgcHJpdmF0ZSBhbGVydHNNYXAgPSBuZXcgTWFwPHN0cmluZywgQWxlcnQ8YW55Pj4oKTtcbiAgICBwcml2YXRlIGNvbmZpZ1VwZGF0ZWQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuXG4gICAgY29uc3RydWN0b3IoXG4gICAgICAgIHByaXZhdGUgcGVybWlzc2lvbnNTZXJ2aWNlOiBQZXJtaXNzaW9uc1NlcnZpY2UsXG4gICAgICAgIHByaXZhdGUgaW5qZWN0b3I6IEluamVjdG9yLFxuICAgICAgICBwcml2YXRlIGRhdGFTZXJ2aWNlOiBEYXRhU2VydmljZSxcbiAgICAgICAgcHJpdmF0ZSBub3RpZmljYXRpb25TZXJ2aWNlOiBOb3RpZmljYXRpb25TZXJ2aWNlLFxuICAgICAgICBwcml2YXRlIG1vZGFsU2VydmljZTogTW9kYWxTZXJ2aWNlLFxuICAgICkge1xuICAgICAgICBjb25zdCBhbGVydHMkID0gdGhpcy5jb25maWdVcGRhdGVkLnBpcGUoXG4gICAgICAgICAgICBtYXAoKCkgPT4gWy4uLnRoaXMuYWxlcnRzTWFwLnZhbHVlcygpXSksXG4gICAgICAgICAgICBzdGFydFdpdGgoWy4uLnRoaXMuYWxlcnRzTWFwLnZhbHVlcygpXSksXG4gICAgICAgICk7XG5cbiAgICAgICAgdGhpcy5hY3RpdmVBbGVydHMkID0gYWxlcnRzJC5waXBlKFxuICAgICAgICAgICAgc3dpdGNoTWFwKCgpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCBhbGVydHMgPSBbLi4udGhpcy5hbGVydHNNYXAudmFsdWVzKCldO1xuICAgICAgICAgICAgICAgIGNvbnN0IGlzQWxlcnRTdHJlYW1zID0gYWxlcnRzLm1hcChhbGVydCA9PiBhbGVydC5hY3RpdmVBbGVydCQpO1xuICAgICAgICAgICAgICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KGlzQWxlcnRTdHJlYW1zKTtcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgbWFwKGFsZXJ0U3RhdGVzID0+IGFsZXJ0U3RhdGVzLmZpbHRlcihub3ROdWxsT3JVbmRlZmluZWQpKSxcbiAgICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25maWd1cmVBbGVydDxUPihjb25maWc6IEFsZXJ0Q29uZmlnPFQ+KSB7XG4gICAgICAgIHRoaXMuaGFzU3VmZmljaWVudFBlcm1pc3Npb25zKGNvbmZpZy5yZXF1aXJlZFBlcm1pc3Npb25zKVxuICAgICAgICAgICAgLnBpcGUoZmlyc3QoKSlcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoaGFzUGVybWlzc2lvbnMgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChoYXNQZXJtaXNzaW9ucykge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFsZXJ0c01hcC5zZXQoY29uZmlnLmlkLCBuZXcgQWxlcnQoY29uZmlnLCB0aGlzLmNyZWF0ZUNvbnRleHQoKSkpO1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmNvbmZpZ1VwZGF0ZWQubmV4dCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0pO1xuICAgIH1cblxuICAgIGhhc1N1ZmZpY2llbnRQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucz86IFBlcm1pc3Npb25bXSkge1xuICAgICAgICBpZiAoIXBlcm1pc3Npb25zIHx8IHBlcm1pc3Npb25zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgICAgcmV0dXJuIG9mKHRydWUpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0aGlzLnBlcm1pc3Npb25zU2VydmljZS5jdXJyZW50VXNlclBlcm1pc3Npb25zJC5waXBlKFxuICAgICAgICAgICAgZmlsdGVyKHBlcm1pc3Npb25zID0+IHBlcm1pc3Npb25zLmxlbmd0aCA+IDApLFxuICAgICAgICAgICAgbWFwKCgpID0+IHRoaXMucGVybWlzc2lvbnNTZXJ2aWNlLnVzZXJIYXNQZXJtaXNzaW9ucyhwZXJtaXNzaW9ucykpLFxuICAgICAgICApO1xuICAgIH1cblxuICAgIHJlZnJlc2goaWQ/OiBzdHJpbmcpIHtcbiAgICAgICAgaWYgKGlkKSB7XG4gICAgICAgICAgICB0aGlzLmFsZXJ0c01hcC5nZXQoaWQpPy5ydW5DaGVjaygpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy5hbGVydHNNYXAuZm9yRWFjaChjb25maWcgPT4gY29uZmlnLnJ1bkNoZWNrKCkpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgY2xlYXJBbGVydHMoKSB7XG4gICAgICAgIHRoaXMuYWxlcnRzTWFwLmZvckVhY2goYWxlcnQgPT4gYWxlcnQuZGVzdHJveSgpKTtcbiAgICAgICAgdGhpcy5hbGVydHNNYXAuY2xlYXIoKTtcbiAgICAgICAgdGhpcy5jb25maWdVcGRhdGVkLm5leHQoKTtcbiAgICB9XG5cbiAgICBwcm90ZWN0ZWQgY3JlYXRlQ29udGV4dCgpOiBBbGVydENvbnRleHQge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgaW5qZWN0b3I6IHRoaXMuaW5qZWN0b3IsXG4gICAgICAgICAgICBkYXRhU2VydmljZTogdGhpcy5kYXRhU2VydmljZSxcbiAgICAgICAgICAgIG5vdGlmaWNhdGlvblNlcnZpY2U6IHRoaXMubm90aWZpY2F0aW9uU2VydmljZSxcbiAgICAgICAgICAgIG1vZGFsU2VydmljZTogdGhpcy5tb2RhbFNlcnZpY2UsXG4gICAgICAgIH07XG4gICAgfVxufVxuIl19