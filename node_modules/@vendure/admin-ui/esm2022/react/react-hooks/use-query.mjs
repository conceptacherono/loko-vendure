import { DataService } from '@vendure/admin-ui/core';
import { useCallback, useContext, useEffect, useState } from 'react';
import { firstValueFrom } from 'rxjs';
import { tap } from 'rxjs/operators';
import { HostedComponentContext } from '../directives/react-component-host.directive';
/**
 * @description
 * A React hook which provides access to the results of a GraphQL query.
 *
 * @example
 * ```ts
 * import { useQuery } from '\@vendure/admin-ui/react';
 * import { gql } from 'graphql-tag';
 *
 * const GET_PRODUCT = gql`
 *    query GetProduct($id: ID!) {
 *      product(id: $id) {
 *        id
 *        name
 *        description
 *      }
 *    }`;
 *
 * export const MyComponent = () => {
 *     const { data, loading, error } = useQuery(GET_PRODUCT, { id: '1' }, { refetchOnChannelChange: true });
 *
 *     if (loading) return <div>Loading...</div>;
 *     if (error) return <div>Error! { error }</div>;
 *     return (
 *         <div>
 *             <h1>{data.product.name}</h1>
 *             <p>{data.product.description}</p>
 *         </div>
 *     );
 * };
 * ```
 *
 * @docsCategory react-hooks
 */
export function useQuery(query, variables, options = { refetchOnChannelChange: false }) {
    const { refetchOnChannelChange } = options;
    const { data, loading, error, runQuery } = useDataService((dataService, vars) => {
        let queryFn = dataService.query(query, vars);
        if (refetchOnChannelChange) {
            queryFn = queryFn.refetchOnChannelChange();
        }
        return queryFn.stream$;
    });
    useEffect(() => {
        const subscription = runQuery(variables).subscribe();
        return () => subscription.unsubscribe();
    }, [runQuery]);
    const refetch = (variables) => firstValueFrom(runQuery(variables));
    return { data, loading, error, refetch };
}
/**
 * @description
 * A React hook which allows you to execute a GraphQL query lazily.
 *
 * @example
 * ```ts
 * import { useLazyQuery } from '\@vendure/admin-ui/react';
 * import { gql } from 'graphql-tag';
 *
 * const GET_PRODUCT = gql`
 *    query GetProduct($id: ID!) {
 *      product(id: $id) {
 *        id
 *        name
 *        description
 *      }
 *    }`;
 * type ProductResponse = {
 *     product: {
 *         name: string
 *         description: string
 *     }
 * }
 *
 * export const MyComponent = () => {
 *     const [getProduct, { data, loading, error }] = useLazyQuery<ProductResponse>(GET_PRODUCT, { refetchOnChannelChange: true });
 *
 *    const handleClick = () => {
 *         getProduct({
 *              id: '1',
 *         }).then(result => {
 *             // do something with the result
 *         });
 *     };
 *
 *     if (loading) return <div>Loading...</div>;
 *     if (error) return <div>Error! { error }</div>;
 *
 *     return (
 *     <div>
 *         <button onClick={handleClick}>Get product</button>
 *         {data && (
 *              <div>
 *                  <h1>{data.product.name}</h1>
 *                  <p>{data.product.description}</p>
 *              </div>)}
 *     </div>
 *     );
 * };
 * ```
 *
 * @since 2.2.0
 * @docsCategory react-hooks
 */
export function useLazyQuery(query, options = { refetchOnChannelChange: false }) {
    const { refetchOnChannelChange } = options;
    const { data, loading, error, runQuery } = useDataService((dataService, vars) => {
        let queryFn = dataService.query(query, vars);
        if (refetchOnChannelChange) {
            queryFn = queryFn.refetchOnChannelChange();
        }
        return queryFn.stream$;
    });
    const rest = { data, loading, error };
    const execute = (variables) => firstValueFrom(runQuery(variables));
    return [execute, rest];
}
/**
 * @description
 * A React hook which allows you to execute a GraphQL mutation.
 *
 * @example
 * ```ts
 * import { useMutation } from '\@vendure/admin-ui/react';
 * import { gql } from 'graphql-tag';
 *
 * const UPDATE_PRODUCT = gql`
 *   mutation UpdateProduct($input: UpdateProductInput!) {
 *     updateProduct(input: $input) {
 *     id
 *     name
 *   }
 * }`;
 *
 * export const MyComponent = () => {
 *     const [updateProduct, { data, loading, error }] = useMutation(UPDATE_PRODUCT);
 *
 *     const handleClick = () => {
 *         updateProduct({
 *             input: {
 *                 id: '1',
 *                 name: 'New name',
 *             },
 *         }).then(result => {
 *             // do something with the result
 *         });
 *     };
 *
 *     if (loading) return <div>Loading...</div>;
 *     if (error) return <div>Error! { error }</div>;
 *
 *     return (
 *     <div>
 *         <button onClick={handleClick}>Update product</button>
 *         {data && <div>Product updated!</div>}
 *     </div>
 *     );
 * };
 * ```
 *
 * @docsCategory react-hooks
 */
export function useMutation(mutation) {
    const { data, loading, error, runQuery } = useDataService((dataService, variables) => dataService.mutate(mutation, variables));
    const rest = { data, loading, error };
    const execute = (variables) => firstValueFrom(runQuery(variables));
    return [execute, rest];
}
export function useDataService(operation) {
    const context = useContext(HostedComponentContext);
    const dataService = context?.injector.get(DataService);
    if (!dataService) {
        throw new Error('No DataService found in HostedComponentContext');
    }
    const [data, setData] = useState();
    const [error, setError] = useState();
    const [loading, setLoading] = useState(false);
    const runQuery = useCallback((variables) => {
        setLoading(true);
        return operation(dataService, variables).pipe(tap({
            next: res => {
                setData(res);
                setLoading(false);
            },
            error: err => {
                setError(err.message);
                setLoading(false);
            },
        }));
    }, []);
    return { data, loading, error, runQuery };
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlLXF1ZXJ5LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vc3JjL2xpYi9yZWFjdC9zcmMvcmVhY3QtaG9va3MvdXNlLXF1ZXJ5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUVyRCxPQUFPLEVBQUUsV0FBVyxFQUFFLFVBQVUsRUFBRSxTQUFTLEVBQUUsUUFBUSxFQUFFLE1BQU0sT0FBTyxDQUFDO0FBQ3JFLE9BQU8sRUFBRSxjQUFjLEVBQWMsTUFBTSxNQUFNLENBQUM7QUFDbEQsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JDLE9BQU8sRUFBRSxzQkFBc0IsRUFBRSxNQUFNLDhDQUE4QyxDQUFDO0FBRXRGOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7R0FpQ0c7QUFDSCxNQUFNLFVBQVUsUUFBUSxDQUNwQixLQUE2QyxFQUM3QyxTQUFhLEVBQ2IsVUFBK0MsRUFBRSxzQkFBc0IsRUFBRSxLQUFLLEVBQUU7SUFFaEYsTUFBTSxFQUFFLHNCQUFzQixFQUFFLEdBQUcsT0FBTyxDQUFDO0lBQzNDLE1BQU0sRUFBRSxJQUFJLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRSxRQUFRLEVBQUUsR0FBRyxjQUFjLENBQU8sQ0FBQyxXQUFXLEVBQUUsSUFBSSxFQUFFLEVBQUU7UUFDbEYsSUFBSSxPQUFPLEdBQUcsV0FBVyxDQUFDLEtBQUssQ0FBQyxLQUFLLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDN0MsSUFBSSxzQkFBc0IsRUFBRSxDQUFDO1lBQ3pCLE9BQU8sR0FBRyxPQUFPLENBQUMsc0JBQXNCLEVBQUUsQ0FBQztRQUMvQyxDQUFDO1FBQ0QsT0FBTyxPQUFPLENBQUMsT0FBTyxDQUFDO0lBQzNCLENBQUMsQ0FBQyxDQUFDO0lBQ0gsU0FBUyxDQUFDLEdBQUcsRUFBRTtRQUNYLE1BQU0sWUFBWSxHQUFHLFFB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QUssQ0FBQyxDQUFDO0lBRTlDLE1BQU0sUUFBUSxHQUFHLFdBQVcsQ0FBQyxDQUFDLFNBQWEsRUFBRSxFQUFFO1FBQzNDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNqQixPQUFPLFNBQVMsQ0FBQyxXQUFXLEVBQUUsU0FBUyxDQUFDLENBQUMsSUFBSSxDQUN6QyxHQUFHLENBQUM7WUFDQSxJQUFJLEVBQUUsR0FBRyxDQUFDLEVBQUU7Z0JBQ1IsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUNiLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN0QixDQUFDO1lBQ0QsS0FBSyxFQUFFLEdBQUcsQ0FBQyxFQUFFO2dCQUNULFFBQVEsQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUM7Z0JBQ3RCLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztZQUN0QixDQUFDO1NBQ0osQ0FBQyxDQUNMLENBQUM7SUFDTixDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUM7SUFFUCxPQUFPLEVBQUUsSUFBSSxFQUFFLE9BQU8sRUFBRSxLQUFLLEVBQUUsUUFBUSxFQUFFLENBQUM7QUFDOUMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFR5cGVkRG9jdW1lbnROb2RlIH0gZnJvbSAnQGdyYXBocWwtdHlwZWQtZG9jdW1lbnQtbm9kZS9jb3JlJztcclxuaW1wb3J0IHsgRGF0YVNlcnZpY2UgfSBmcm9tICdAdmVuZHVyZS9hZG1pbi11aS9jb3JlJztcclxuaW1wb3J0IHsgRG9jdW1lbnROb2RlIH0gZnJvbSAnZ3JhcGhxbC9pbmRleCc7XHJcbmltcG9ydCB7IHVzZUNhbGxiYWNrLCB1c2VDb250ZXh0LCB1c2VFZmZlY3QsIHVzZVN0YXRlIH0gZnJvbSAncmVhY3QnO1xyXG5pbXBvcnQgeyBmaXJzdFZhbHVlRnJvbSwgT2JzZXJ2YWJsZSB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCB7IEhvc3RlZENvbXBvbmVudENvbnRleHQgfSBmcm9tICcuLi9kaXJlY3RpdmVzL3JlYWN0LWNvbXBvbmVudC1ob3N0LmRpcmVjdGl2ZSc7XHJcblxyXG4vKipcclxuICogQGRlc2NyaXB0aW9uXHJcbiAqIEEgUmVhY3QgaG9vayB3aGljaCBwcm92aWRlcyBhY2Nlc3MgdG8gdGhlIHJlc3VsdHMgb2YgYSBHcmFwaFFMIHF1ZXJ5LlxyXG4gKlxyXG4gKiBAZXhhbXBsZVxyXG4gKiBgYGB0c1xyXG4gKiBpbXBvcnQgeyB1c2VRdWVyeSB9IGZyb20gJ1xcQHZlbmR1cmUvYWRtaW4tdWkvcmVhY3QnO1xyXG4gKiBpbXBvcnQgeyBncWwgfSBmcm9tICdncmFwaHFsLXRhZyc7XHJcbiAqXHJcbiAqIGNvbnN0IEdFVF9QUk9EVUNUID0gZ3FsYFxyXG4gKiAgICBxdWVyeSBHZXRQcm9kdWN0KCRpZDogSUQhKSB7XHJcbiAqICAgICAgcHJvZHVjdChpZDogJGlkKSB7XHJcbiAqICAgICAgICBpZFxyXG4gKiAgICAgICAgbmFtZVxyXG4gKiAgICAgICAgZGVzY3JpcHRpb25cclxuICogICAgICB9XHJcbiAqICAgIH1gO1xyXG4gKlxyXG4gKiBleHBvcnQgY29uc3QgTXlDb21wb25lbnQgPSAoKSA9PiB7XHJcbiAqICAgICBjb25zdCB7IGRhdGEsIGxvYWRpbmcsIGVycm9yIH0gPSB1c2VRdWVyeShHRVRfUFJPRFVDVCwgeyBpZDogJzEnIH0sIHsgcmVmZXRjaE9uQ2hhbm5lbENoYW5nZTogdHJ1ZSB9KTtcclxuICpcclxuICogICAgIGlmIChsb2FkaW5nKSByZXR1cm4gPGRpdj5Mb2FkaW5nLi4uPC9kaXY+O1xyXG4gKiAgICAgaWYgKGVycm9yKSByZXR1cm4gPGRpdj5FcnJvciEgeyBlcnJvciB9PC9kaXY+O1xyXG4gKiAgICAgcmV0dXJuIChcclxuICogICAgICAgICA8ZGl2PlxyXG4gKiAgICAgICAgICAgICA8aDE+e2RhdGEucHJvZHVjdC5uYW1lfTwvaDE+XHJcbiAqICAgICAgICAgICAgIDxwPntkYXRhLnByb2R1Y3QuZGVzY3JpcHRpb259PC9wPlxyXG4gKiAgICAgICAgIDwvZGl2PlxyXG4gKiAgICAgKTtcclxuICogfTtcclxuICogYGBgXHJcbiAqXHJcbiAqIEBkb2NzQ2F0ZWdvcnkgcmVhY3QtaG9va3NcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiB1c2VRdWVyeTxULCBWIGV4dGVuZHMgUmVjb3JkPHN0cmluZywgYW55PiA9IFJlY29yZDxzdHJpbmcsIGFueT4+KFxyXG4gICAgcXVlcnk6IERvY3VtZW50Tm9kZSB8IFR5cGVkRG9jdW1lbnROb2RlPFQsIFY+LFxyXG4gICAgdmFyaWFibGVzPzogVixcclxuICAgIG9wdGlvbnM6IHsgcmVmZXRjaE9uQ2hhbm5lbENoYW5nZTogYm9vbGVhbiB9ID0geyByZWZldGNoT25DaGFubmVsQ2hhbmdlOiBmYWxzZSB9LFxyXG4pIHtcclxuICAgIGNvbnN0IHsgcmVmZXRjaE9uQ2hhbm5lbENoYW5nZSB9ID0gb3B0aW9ucztcclxuICAgIGNvbnN0IHsgZGF0YSwgbG9hZGluZywgZXJyb3IsIHJ1blF1ZXJ5IH0gPSB1c2VEYXRhU2VydmljZTxULCBWPigoZGF0YVNlcnZpY2UsIHZhcnMpID0+IHtcclxuICAgICAgICBsZXQgcXVlcnlGbiA9IGRhdGFTZXJ2aWNlLnF1ZXJ5KHF1ZXJ5LCB2YXJzKTtcclxuICAgICAgICBpZiAocmVmZXRjaE9uQ2hhbm5lbENoYW5nZSkge1xyXG4gICAgICAgICAgICBxdWVyeUZuID0gcXVlcnlGbi5yZWZldGNoT25DaGFubmVsQ2hhbmdlKCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiBxdWVyeUZuLnN0cmVhbSQ7XHJcbiAgICB9KTtcclxuICAgIHVzZUVmZmVjdCgoKSA9PiB7XHJcbiAgICAgICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gcnVuUXVlcnkodmFyaWFibGVzKS5zdWJzY3JpYmUoKTtcclxuICAgICAgICByZXR1cm4gKCkgPT4gc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgICB9LCBbcnVuUXVlcnldKTtcclxuXHJcbiAgICBjb25zdCByZWZldGNoID0gKHZhcmlhYmxlcz86IFYpID0+IGZpcnN0VmFsdWVGcm9tKHJ1blF1ZXJ5KHZhcmlhYmxlcykpO1xyXG4gICAgcmV0dXJuIHsgZGF0YSwgbG9hZGluZywgZXJyb3IsIHJlZmV0Y2ggfSBhcyBjb25zdDtcclxufVxyXG5cclxuLyoqXHJcbiAqIEBkZXNjcmlwdGlvblxyXG4gKiBBIFJlYWN0IGhvb2sgd2hpY2ggYWxsb3dzIHlvdSB0byBleGVjdXRlIGEgR3JhcGhRTCBxdWVyeSBsYXppbHkuXHJcbiAqXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYHRzXHJcbiAqIGltcG9ydCB7IHVzZUxhenlRdWVyeSB9IGZyb20gJ1xcQHZlbmR1cmUvYWRtaW4tdWkvcmVhY3QnO1xyXG4gKiBpbXBvcnQgeyBncWwgfSBmcm9tICdncmFwaHFsLXRhZyc7XHJcbiAqXHJcbiAqIGNvbnN0IEdFVF9QUk9EVUNUID0gZ3FsYFxyXG4gKiAgICBxdWVyeSBHZXRQcm9kdWN0KCRpZDogSUQhKSB7XHJcbiAqICAgICAgcHJvZHVjdChpZDogJGlkKSB7XHJcbiAqICAgICAgICBpZFxyXG4gKiAgICAgICAgbmFtZVxyXG4gKiAgICAgICAgZGVzY3JpcHRpb25cclxuICogICAgICB9XHJcbiAqICAgIH1gO1xyXG4gKiB0eXBlIFByb2R1Y3RSZXNwb25zZSA9IHtcclxuICogICAgIHByb2R1Y3Q6IHtcclxuICogICAgICAgICBuYW1lOiBzdHJpbmdcclxuICogICAgICAgICBkZXNjcmlwdGlvbjogc3RyaW5nXHJcbiAqICAgICB9XHJcbiAqIH1cclxuICpcclxuICogZXhwb3J0IGNvbnN0IE15Q29tcG9uZW50ID0gKCkgPT4ge1xyXG4gKiAgICAgY29uc3QgW2dldFByb2R1Y3QsIHsgZGF0YSwgbG9hZGluZywgZXJyb3IgfV0gPSB1c2VMYXp5UXVlcnk8UHJvZHVjdFJlc3BvbnNlPihHRVRfUFJPRFVDVCwgeyByZWZldGNoT25DaGFubmVsQ2hhbmdlOiB0cnVlIH0pO1xyXG4gKlxyXG4gKiAgICBjb25zdCBoYW5kbGVDbGljayA9ICgpID0+IHtcclxuICogICAgICAgICBnZXRQcm9kdWN0KHtcclxuICogICAgICAgICAgICAgIGlkOiAnMScsXHJcbiAqICAgICAgICAgfSkudGhlbihyZXN1bHQgPT4ge1xyXG4gKiAgICAgICAgICAgICAvLyBkbyBzb21ldGhpbmcgd2l0aCB0aGUgcmVzdWx0XHJcbiAqICAgICAgICAgfSk7XHJcbiAqICAgICB9O1xyXG4gKlxyXG4gKiAgICAgaWYgKGxvYWRpbmcpIHJldHVybiA8ZGl2PkxvYWRpbmcuLi48L2Rpdj47XHJcbiAqICAgICBpZiAoZXJyb3IpIHJldHVybiA8ZGl2PkVycm9yISB7IGVycm9yIH08L2Rpdj47XHJcbiAqXHJcbiAqICAgICByZXR1cm4gKFxyXG4gKiAgICAgPGRpdj5cclxuICogICAgICAgICA8YnV0dG9uIG9uQ2xpY2s9e2hhbmRsZUNsaWNrfT5HZXQgcHJvZHVjdDwvYnV0dG9uPlxyXG4gKiAgICAgICAgIHtkYXRhICYmIChcclxuICogICAgICAgICAgICAgIDxkaXY+XHJcbiAqICAgICAgICAgICAgICAgICAgPGgxPntkYXRhLnByb2R1Y3QubmFtZX08L2gxPlxyXG4gKiAgICAgICAgICAgICAgICAgIDxwPntkYXRhLnByb2R1Y3QuZGVzY3JpcHRpb259PC9wPlxyXG4gKiAgICAgICAgICAgICAgPC9kaXY+KX1cclxuICogICAgIDwvZGl2PlxyXG4gKiAgICAgKTtcclxuICogfTtcclxuICogYGBgXHJcbiAqXHJcbiAqIEBzaW5jZSAyLjIuMFxyXG4gKiBAZG9jc0NhdGVnb3J5IHJlYWN0LWhvb2tzXHJcbiAqL1xyXG5leHBvcnQgZnVuY3Rpb24gdXNlTGF6eVF1ZXJ5PFQsIFYgZXh0ZW5kcyBSZWNvcmQ8c3RyaW5nLCBhbnk+ID0gUmVjb3JkPHN0cmluZywgYW55Pj4oXHJcbiAgICBxdWVyeTogRG9jdW1lbnROb2RlIHwgVHlwZWREb2N1bWVudE5vZGU8VCwgVj4sXHJcbiAgICBvcHRpb25zOiB7IHJlZmV0Y2hPbkNoYW5uZWxDaGFuZ2U6IGJvb2xlYW4gfSA9IHsgcmVmZXRjaE9uQ2hhbm5lbENoYW5nZTogZmFsc2UgfSxcclxuKSB7XHJcbiAgICBjb25zdCB7IHJlZmV0Y2hPbkNoYW5uZWxDaGFuZ2UgfSA9IG9wdGlvbnM7XHJcbiAgICBjb25zdCB7IGRhdGEsIGxvYWRpbmcsIGVycm9yLCBydW5RdWVyeSB9ID0gdXNlRGF0YVNlcnZpY2U8VCwgVj4oKGRhdGFTZXJ2aWNlLCB2YXJzKSA9PiB7XHJcbiAgICAgICAgbGV0IHF1ZXJ5Rm4gPSBkYXRhU2VydmljZS5xdWVyeShxdWVyeSwgdmFycyk7XHJcbiAgICAgICAgaWYgKHJlZmV0Y2hPbkNoYW5uZWxDaGFuZ2UpIHtcclxuICAgICAgICAgICAgcXVlcnlGbiA9IHF1ZXJ5Rm4ucmVmZXRjaE9uQ2hhbm5lbENoYW5nZSgpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcXVlcnlGbi5zdHJlYW0kO1xyXG4gICAgfSk7XHJcbiAgICBjb25zdCByZXN0ID0geyBkYXRhLCBsb2FkaW5nLCBlcnJvciB9O1xyXG4gICAgY29uc3QgZXhlY3V0ZSA9ICh2YXJpYWJsZXM/OiBWKSA9PiBmaXJzdFZhbHVlRnJvbShydW5RdWVyeSh2YXJpYWJsZXMpKTtcclxuICAgIHJldHVybiBbZXhlY3V0ZSwgcmVzdF0gYXMgW3R5cGVvZiBleGVjdXRlLCB0eXBlb2YgcmVzdF07XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBAZGVzY3JpcHRpb25cclxuICogQSBSZWFjdCBob29rIHdoaWNoIGFsbG93cyB5b3UgdG8gZXhlY3V0ZSBhIEdyYXBoUUwgbXV0YXRpb24uXHJcbiAqXHJcbiAqIEBleGFtcGxlXHJcbiAqIGBgYHRzXHJcbiAqIGltcG9ydCB7IHVzZU11dGF0aW9uIH0gZnJvbSAnXFxAdmVuZHVyZS9hZG1pbi11aS9yZWFjdCc7XHJcbiAqIGltcG9ydCB7IGdxbCB9IGZyb20gJ2dyYXBocWwtdGFnJztcclxuICpcclxuICogY29uc3QgVVBEQVRFX1BST0RVQ1QgPSBncWxgXHJcbiAqICAgbXV0YXRpb24gVXBkYXRlUHJvZHVjdCgkaW5wdXQ6IFVwZGF0ZVByb2R1Y3RJbnB1dCEpIHtcclxuICogICAgIHVwZGF0ZVByb2R1Y3QoaW5wdXQ6ICRpbnB1dCkge1xyXG4gKiAgICAgaWRcclxuICogICAgIG5hbWVcclxuICogICB9XHJcbiAqIH1gO1xyXG4gKlxyXG4gKiBleHBvcnQgY29uc3QgTXlDb21wb25lbnQgPSAoKSA9PiB7XHJcbiAqICAgICBjb25zdCBbdXBkYXRlUHJvZHVjdCwgeyBkYXRhLCBsb2FkaW5nLCBlcnJvciB9XSA9IHVzZU11dGF0aW9uKFVQREFURV9QUk9EVUNUKTtcclxuICpcclxuICogICAgIGNvbnN0IGhhbmRsZUNsaWNrID0gKCkgPT4ge1xyXG4gKiAgICAgICAgIHVwZGF0ZVByb2R1Y3Qoe1xyXG4gKiAgICAgICAgICAgICBpbnB1dDoge1xyXG4gKiAgICAgICAgICAgICAgICAgaWQ6ICcxJyxcclxuICogICAgICAgICAgICAgICAgIG5hbWU6ICdOZXcgbmFtZScsXHJcbiAqICAgICAgICAgICAgIH0sXHJcbiAqICAgICAgICAgfSkudGhlbihyZXN1bHQgPT4ge1xyXG4gKiAgICAgICAgICAgICAvLyBkbyBzb21ldGhpbmcgd2l0aCB0aGUgcmVzdWx0XHJcbiAqICAgICAgICAgfSk7XHJcbiAqICAgICB9O1xyXG4gKlxyXG4gKiAgICAgaWYgKGxvYWRpbmcpIHJldHVybiA8ZGl2PkxvYWRpbmcuLi48L2Rpdj47XHJcbiAqICAgICBpZiAoZXJyb3IpIHJldHVybiA8ZGl2PkVycm9yISB7IGVycm9yIH08L2Rpdj47XHJcbiAqXHJcbiAqICAgICByZXR1cm4gKFxyXG4gKiAgICAgPGRpdj5cclxuICogICAgICAgICA8YnV0dG9uIG9uQ2xpY2s9e2hhbmRsZUNsaWNrfT5VcGRhdGUgcHJvZHVjdDwvYnV0dG9uPlxyXG4gKiAgICAgICAgIHtkYXRhICYmIDxkaXY+UHJvZHVjdCB1cGRhdGVkITwvZGl2Pn1cclxuICogICAgIDwvZGl2PlxyXG4gKiAgICAgKTtcclxuICogfTtcclxuICogYGBgXHJcbiAqXHJcbiAqIEBkb2NzQ2F0ZWdvcnkgcmVhY3QtaG9va3NcclxuICovXHJcbmV4cG9ydCBmdW5jdGlvbiB1c2VNdXRhdGlvbjxULCBWIGV4dGVuZHMgUmVjb3JkPHN0cmluZywgYW55PiA9IFJlY29yZDxzdHJpbmcsIGFueT4+KFxyXG4gICAgbXV0YXRpb246IERvY3VtZW50Tm9kZSB8IFR5cGVkRG9jdW1lbnROb2RlPFQsIFY+LFxyXG4pIHtcclxuICAgIGNvbnN0IHsgZGF0YSwgbG9hZGluZywgZXJyb3IsIHJ1blF1ZXJ5IH0gPSB1c2VEYXRhU2VydmljZTxULCBWPigoZGF0YVNlcnZpY2UsIHZhcmlhYmxlcykgPT5cclxuICAgICAgICBkYXRhU2VydmljZS5tdXRhdGUobXV0YXRpb24sIHZhcmlhYmxlcyksXHJcbiAgICApO1xyXG4gICAgY29uc3QgcmVzdCA9IHsgZGF0YSwgbG9hZGluZywgZXJyb3IgfTtcclxuICAgIGNvbnN0IGV4ZWN1dGUgPSAodmFyaWFibGVzPzogVikgPT4gZmlyc3RWYWx1ZUZyb20ocnVuUXVlcnkodmFyaWFibGVzKSk7XHJcbiAgICByZXR1cm4gW2V4ZWN1dGUsIHJlc3RdIGFzIFt0eXBlb2YgZXhlY3V0ZSwgdHlwZW9mIHJlc3RdO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gdXNlRGF0YVNlcnZpY2U8VCwgViBleHRlbmRzIFJlY29yZDxzdHJpbmcsIGFueT4gPSBSZWNvcmQ8c3RyaW5nLCBhbnk+PihcclxuICAgIG9wZXJhdGlvbjogKGRhdGFTZXJ2aWNlOiBEYXRhU2VydmljZSwgdmFyaWFibGVzPzogVikgPT4gT2JzZXJ2YWJsZTxUPixcclxuKSB7XHJcbiAgICBjb25zdCBjb250ZXh0ID0gdXNlQ29udGV4dChIb3N0ZWRDb21wb25lbnRDb250ZXh0KTtcclxuICAgIGNvbnN0IGRhdGFTZXJ2aWNlID0gY29udGV4dD8uaW5qZWN0b3IuZ2V0KERhdGFTZXJ2aWNlKTtcclxuICAgIGlmICghZGF0YVNlcnZpY2UpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIERhdGFTZXJ2aWNlIGZvdW5kIGluIEhvc3RlZENvbXBvbmVudENvbnRleHQnKTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBbZGF0YSwgc2V0RGF0YV0gPSB1c2VTdGF0ZTxUPigpO1xyXG4gICAgY29uc3QgW2Vycm9yLCBzZXRFcnJvcl0gPSB1c2VTdGF0ZTxzdHJpbmc+KCk7XHJcbiAgICBjb25zdCBbbG9hZGluZywgc2V0TG9hZGluZ10gPSB1c2VTdGF0ZShmYWxzZSk7XHJcblxyXG4gICAgY29uc3QgcnVuUXVlcnkgPSB1c2VDYWxsYmFjaygodmFyaWFibGVzPzogVikgPT4ge1xyXG4gICAgICAgIHNldExvYWRpbmcodHJ1ZSk7XHJcbiAgICAgICAgcmV0dXJuIG9wZXJhdGlvbihkYXRhU2VydmljZSwgdmFyaWFibGVzKS5waXBlKFxyXG4gICAgICAgICAgICB0YXAoe1xyXG4gICAgICAgICAgICAgICAgbmV4dDogcmVzID0+IHtcclxuICAgICAgICAgICAgICAgICAgICBzZXREYXRhKHJlcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0TG9hZGluZyhmYWxzZSk7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgZXJyb3I6IGVyciA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgc2V0RXJyb3IoZXJyLm1lc3NhZ2UpO1xyXG4gICAgICAgICAgICAgICAgICAgIHNldExvYWRpbmcoZmFsc2UpO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgfSksXHJcbiAgICAgICAgKTtcclxuICAgIH0sIFtdKTtcclxuXHJcbiAgICByZXR1cm4geyBkYXRhLCBsb2FkaW5nLCBlcnJvciwgcnVuUXVlcnkgfTtcclxufVxyXG4iXX0=